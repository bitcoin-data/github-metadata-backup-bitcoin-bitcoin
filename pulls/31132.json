{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132",
    "id": 2138649533,
    "node_id": "PR_kwDOABII585_eTO9",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31132",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31132.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31132.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/d6fac85ee4465cce8e81e36cdfd46636d34725fa",
    "number": 31132,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "validation: fetch block inputs on parallel threads >20% faster IBD",
    "user": {
      "login": "andrewtoth",
      "id": 237213,
      "node_id": "MDQ6VXNlcjIzNzIxMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andrewtoth",
      "html_url": "https://github.com/andrewtoth",
      "followers_url": "https://api.github.com/users/andrewtoth/followers",
      "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
      "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
      "repos_url": "https://api.github.com/users/andrewtoth/repos",
      "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "body": "This PR parallelizes fetching all input prevouts of a block right before block connection, achieving up to 31% faster IBD performance[^1][^2][^3].\r\n\r\n### Problem\r\n\r\nCurrently, when fetching inputs in `ConnectBlock`, each input is fetched from the cache sequentially. A cache miss requires a round trip to the disk database to fetch the outpoint and insert it into the cache. Since the database is read-only during `ConnectTip`, we can fetch all inputs of a block in parallel on multiple threads before entering `ConnectBlock`.\r\n\r\n### Solution\r\n\r\nWe introduce a new `InputFetcher` utility that manages worker threads to fetch block inputs in parallel. The main thread processes inputs sequentially as they become available, inserting fetched coins into the temporary `CCoinsViewCache`. This parallelizes expensive disk lookups, significantly improving block connection performance.\r\n\r\n### Implementation Details\r\n\r\nThe `InputFetcher` implements a lock-free MPSC (Multiple Producer, Single Consumer) queue design:\r\n\r\n- **Work Distribution**: Collects all input prevouts into a queue and uses a barrier to start all worker threads simultaneously\r\n- **Synchronization**: Worker threads use an atomic counter to claim which inputs to fetch, and each input has an atomic flag to signal completion to the main thread\r\n- **Main Thread Processing**: The main thread waits for inputs in order and inserts them into the temporary cache as they become ready\r\n- **Work Stealing**: If the main thread catches up to the workers, it assists with fetching to maximize parallelism\r\n- **Completion**: All threads synchronize on a barrier after completion to ensure all work is finished before proceeding\r\n\r\n### Configuration\r\n\r\nThis PR uses the `-par` value for the number of threads, which defaults to the number of vcores on the machine or 15, whichever is fewer. This is the same value used for `CCheckQueue`, so any users that specifically have multi-threaded validation disabled by using `-par=1` will also have this feature disabled. This also means the maximum number of input fetching threads is capped at 15.\r\n\r\n### Safety and Correctness\r\n\r\n- The `InputFetcher` works on a block that has not been fully validated, but it does not interfere or modify any of the validation before or during `ConnectBlock`\r\n- It simply inserts inputs into the temporary cache, which must be fetched before a transaction is validated anyways\r\n- **Invalid blocks**: If an invalid block is mined, the temporary cache is discarded without being flushed. This is an improvement over the current behavior, where inputs are inserted into the main `CoinsTip()` cache when pulled through for an invalid block\r\n\r\n### Performance\r\n\r\nBenchmarks show up to 31% faster IBD performance[^1][^2][^3]. The parallelization of expensive disk lookups provides significant speedup.\r\n\r\n### Future Work\r\n\r\nSince the input fetcher is blocking and all threads are only used before connecting a block, future work could combine the `CCheckQueue` validation threads and the `InputFetcher` threads into a shared thread pool.\r\n\r\n[^1]: https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3463894000\r\n[^2]: https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3347436866\r\n[^3]: https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3488760623",
    "labels": [
      {
        "id": 118379652,
        "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
        "name": "Validation",
        "color": "6060aa",
        "default": false
      }
    ],
    "created_at": "2024-10-22T14:40:28Z",
    "updated_at": "2025-11-15T17:42:15Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "1033257205ae55243343ef8e88ea3d813c3e3f3c",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "andrewtoth:threaded-inputs",
      "ref": "threaded-inputs",
      "sha": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 156145027,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNTYxNDUwMjc=",
        "name": "bitcoin",
        "full_name": "andrewtoth/bitcoin",
        "owner": {
          "login": "andrewtoth",
          "id": 237213,
          "node_id": "MDQ6VXNlcjIzNzIxMw==",
          "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/andrewtoth",
          "html_url": "https://github.com/andrewtoth",
          "followers_url": "https://api.github.com/users/andrewtoth/followers",
          "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
          "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
          "repos_url": "https://api.github.com/users/andrewtoth/repos",
          "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
          "type": "User",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/andrewtoth/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/andrewtoth/bitcoin",
        "archive_url": "https://api.github.com/repos/andrewtoth/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/andrewtoth/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/andrewtoth/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/andrewtoth/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/andrewtoth/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/andrewtoth/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/andrewtoth/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/andrewtoth/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/andrewtoth/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/andrewtoth/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/andrewtoth/bitcoin/events",
        "forks_url": "https://api.github.com/repos/andrewtoth/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/andrewtoth/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/andrewtoth/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/andrewtoth/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/andrewtoth/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/andrewtoth/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/andrewtoth/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/andrewtoth/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/andrewtoth/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/andrewtoth/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:andrewtoth/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/andrewtoth/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/andrewtoth/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/andrewtoth/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/andrewtoth/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/andrewtoth/bitcoin/hooks",
        "svn_url": "https://github.com/andrewtoth/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 288689,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-11-14T01:39:58Z",
        "created_at": "2018-11-05T01:43:59Z",
        "updated_at": "2025-11-13T15:07:23Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 38203,
        "stargazers_count": 86808,
        "watchers_count": 86808,
        "size": 296021,
        "default_branch": "master",
        "open_issues_count": 734,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-11-15T16:20:03Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-11-15T16:20:11Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 613,
    "deletions": 1,
    "changed_files": 11,
    "commits": 3,
    "review_comments": 268,
    "comments": 43
  },
  "events": [
    {
      "event": "commented",
      "id": 2429478185,
      "node_id": "IC_kwDOABII586QzuUp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2429478185",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:40:31Z",
      "updated_at": "2025-11-13T20:38:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31132.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ismaelsadeeq](https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2462618817), [Raimo33](https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3356601737), [l0rinc](https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3389779624) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33512](https://github.com/bitcoin/bitcoin/pull/33512) (coins: use number of dirty cache entries in flush warnings/logs by l0rinc)\n* [#32317](https://github.com/bitcoin/bitcoin/pull/32317) (kernel: Separate UTXO set access from validation functions by TheCharlatan)\n* [#30342](https://github.com/bitcoin/bitcoin/pull/30342) (kernel, logging: Pass Logger instances to kernel objects by ryanofsky)\n* [#29700](https://github.com/bitcoin/bitcoin/pull/29700) (kernel, refactor: return error status on all fatal errors by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2429478185",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 14786916578,
      "node_id": "LE_lADOABII586bT0I_zwAAAANxXnDi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14786916578",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:40:34Z",
      "label": {
        "name": "Validation",
        "color": "6060aa"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14787017217,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxX_oB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787017217",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9fcd08ea0e440c89c1a34aec9e31aaab53f559c4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9fcd08ea0e440c89c1a34aec9e31aaab53f559c4",
      "created_at": "2024-10-22T14:45:41Z"
    },
    {
      "event": "commented",
      "id": 2429491813,
      "node_id": "IC_kwDOABII586Qzxpl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2429491813",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:45:47Z",
      "updated_at": "2024-10-22T14:45:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/31894441286</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2429491813",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 14787019013,
      "node_id": "LE_lADOABII586bT0I_zwAAAANxYAEF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787019013",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:45:47Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "renamed",
      "id": 14787094471,
      "node_id": "RTE_lADOABII586bT0I_zwAAAANxYSfH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787094471",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:49:35Z",
      "rename": {
        "from": "validation: fetch block inputs parallel threads ~17% faster IBD",
        "to": "validation: fetch block inputs on parallel threads ~17% faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14787303983,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxZFov",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787303983",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "fe0fe597cd0e510ae104fbce5823bc13e04bec82",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/fe0fe597cd0e510ae104fbce5823bc13e04bec82",
      "created_at": "2024-10-22T14:59:45Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14788613835,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxeFbL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14788613835",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e2feb0cc7c62338c2f06c1da638818594f68ad32",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/e2feb0cc7c62338c2f06c1da638818594f68ad32",
      "created_at": "2024-10-22T16:12:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14790893735,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxmyCn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14790893735",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "created_at": "2024-10-22T18:46:51Z"
    },
    {
      "event": "unlabeled",
      "id": 14792905981,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAANxudT9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14792905981",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T21:09:47Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2388117544,
      "node_id": "PRR_kwDOABII586OV8go",
      "url": null,
      "actor": null,
      "commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-10-23T13:15:17Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nI'm still missing tests and benchmarks here and I think we need to find better default values for SSD and HDD parallelism, and I'd be interested in how coroutines would perform here instead of trying to find the best batching size manually.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2388117544",
      "submitted_at": "2024-10-23T12:44:26Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 2388943653,
      "node_id": "PRR_kwDOABII586OZGMl",
      "url": null,
      "actor": null,
      "commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-10-23T14:27:10Z",
      "author_association": "MEMBER",
      "body": "Cool idea.\r\n\r\nSince the inputs fetcher call is blocking, instead of creating a new set of worker threads, what do you think about re-using the existing script validation ones (or any other unused worker threads) by implementing a general-purpose thread pool shared among the validation checks? \r\nThe script validation checks and the inputs fetching mechanism are never done concurrently because you need the inputs in order to verify the scripts. So, they could share workers.\r\n\r\nThis should be benchmarked because it might add some overhead but, #26966 introduces such structure inside 401f21bfd72f32a28147677af542887518a4dbff, which we could pull off and use for validation.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2388943653",
      "submitted_at": "2024-10-23T14:25:41Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "commented",
      "id": 2432481201,
      "node_id": "IC_kwDOABII586Q_Lex",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2432481201",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-23T14:48:28Z",
      "updated_at": "2024-10-23T14:48:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "> implementing a general-purpose thread pool shared among the validation checks?\r\n\r\nNice, yes that would be great! That would simplify this PR a lot if it could just schedule tasks on worker threads and receive the responses, instead of implementing all the sync code itself.\r\n\r\n> https://github.com/bitcoin/bitcoin/pull/26966 introduces such structure inside https://github.com/bitcoin/bitcoin/commit/401f21bfd72f32a28147677af542887518a4dbff, which we could pull off and use for validation.\r\n\r\nConcept ACK!",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2432481201",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 2436046062,
      "node_id": "IC_kwDOABII586RMxzu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2436046062",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T18:12:38Z",
      "updated_at": "2024-10-26T15:04:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "Finished benching on a HDD until 860k on Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz, CPU = 8:\r\n\r\n```bash\r\nSummary\r\n'COMMIT=f278ca4ec3f0a90c285e640f1a270869ca594d20 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0' ran\r\n 1.02 times faster than 'COMMIT=e9e23b59f8eedb8dfae75aa660328299fba92b50 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=\r\n0'\r\n```\r\n\r\n> f278ca4ec3 coins: allow emplacing non-dirty coins internally (39993.343777768874 seconds = 11.1 hours)\r\n> e9e23b59f8 validation: fetch block inputs in parallel (40929.84310861388 seconds = 11.3 hours)\r\n\r\n-----\r\n\r\n~So likely on HDD we shouldn't use so many threads, apparently it slows down IBD.~\r\nMaybe we could add a new config option (`iothreads` or `iothreadmultiplier` or something).\r\nThe defaults should likely depend on whether it's an SSD or HDD.\r\n\r\n-----\r\n\r\nEdit:\r\n\r\n<details>\r\n<summary>Previous results</summary>\r\n\r\n```bash\r\n\"command\": \"COMMIT=f278ca4ec3f0a90c285e640f1a270869ca594d20 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0\",\r\n\"times\": [39993.343777768874],\r\n\r\n\"command\": \"COMMIT=e9e23b59f8eedb8dfae75aa660328299fba92b50 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0\",\r\n\"times\": [40929.84310861388],\r\n```\r\n\r\n</details>\r\n\r\nI have retried the same with half the parallelism (rebased, but no other change in the end, otherwise the results would be hard to interpret):\r\n```bash\r\n\"command\": \"COMMIT=8207d372b2fac24af0f8999b30e71e88d40b3a13 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0\",\r\n\"times\": [40579.00445769842],\r\n``` \r\n\r\nSo it's a tiny bit faster than before (surprisingly stable for an actual IBD with real peers), but still slower-than/same-as before, so not sure why it's not faster.\r\n\r\n----\r\n\r\nEdit:\r\n\r\nRunning it on a HDD with a low dbcache value reproduces the original result:\r\n\r\n<details>\r\n<summary>benchmark</summary>\r\n\r\n```bash\r\nhyperfine --runs 1 --show-output --export-json /mnt/my_storage/ibd_full-threaded-inputs-3.json --parameter-list COMMIT 92fc718592be55812b2c73a3bf57599fc81425fa,8207d372b2fac24af0f8999b30e71e88d40b3a13 --prepare 'rm -rf /mnt/my_storage/BitcoinData/* && git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_UTIL=OFF -DBUILD_TX=OFF -DBUILD_TESTS=OFF -DENABLE_WALLET=OFF -DINSTALL_MAN=OFF && cmake --build build -j$(nproc)' 'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=1000 -printtoconsole=0'\r\n```\r\n\r\n</details>\r\n\r\n```bash\r\n8207d372b2 validation: fetch block inputs in parallel\r\n92fc718592 coins: allow emplacing non-dirty coins internally\r\nSummary\r\n  'COMMIT=8207d372b2fac24af0f8999b30e71e88d40b3a13 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=1000 -printtoconsole=0' ran\r\n    1.16 times faster than 'COMMIT=92fc718592be55812b2c73a3bf57599fc81425fa ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=1000 -printtoconsole=0'\r\n```",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2436046062",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 2436080216,
      "node_id": "IC_kwDOABII586RM6JY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2436080216",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T18:31:14Z",
      "updated_at": "2024-10-24T18:31:14Z",
      "author_association": "CONTRIBUTOR",
      "body": "> So likely on HDD we shouldn't use so many threads, apparently it slows down IBD.\r\n\r\nI'm not sure we can conclude that from your benchmark. It used a very high dbcache setting, which makes the effect of this change less important. It also is syncing from untrusted network peers, so there is some variance which could also account for the 2% difference.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2436080216",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14856978808,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN1i4F4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14856978808",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "942f3006fcc85be70fb174c99b73e7b9022cfcdb",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/942f3006fcc85be70fb174c99b73e7b9022cfcdb",
      "created_at": "2024-10-24T18:40:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14857622714,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN1lVS6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14857622714",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "8207d372b2fac24af0f8999b30e71e88d40b3a13",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8207d372b2fac24af0f8999b30e71e88d40b3a13",
      "created_at": "2024-10-24T19:25:33Z"
    },
    {
      "event": "commented",
      "id": 2436178257,
      "node_id": "IC_kwDOABII586RNSFR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2436178257",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T19:25:38Z",
      "updated_at": "2024-10-24T19:25:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/32027275494</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2436178257",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 14857623683,
      "node_id": "LE_lADOABII586bT0I_zwAAAAN1lViD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14857623683",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T19:25:38Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 14869493997,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAN2Snjt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14869493997",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-25T09:58:21Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14910229658,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4uAya",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14910229658",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a0f6902ad1b965a42d5362329910eb6c1c9adfa1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a0f6902ad1b965a42d5362329910eb6c1c9adfa1",
      "created_at": "2024-10-26T18:47:56Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14910333712,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4uaMQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14910333712",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a00dbc56fa29bc2c138b97e478517260cda99f7f",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a00dbc56fa29bc2c138b97e478517260cda99f7f",
      "created_at": "2024-10-26T18:51:56Z"
    },
    {
      "event": "labeled",
      "id": 14910335810,
      "node_id": "LE_lADOABII586bT0I_zwAAAAN4uatC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14910335810",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-26T18:52:00Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2439692907,
      "node_id": "IC_kwDOABII586RasJr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2439692907",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-26T18:52:01Z",
      "updated_at": "2024-10-26T18:52:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/32107893176</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2439692907",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14911794047,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4z-t_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14911794047",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "54b3b484af9775c8bcd3ca47f50ae23b2fc18955",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/54b3b484af9775c8bcd3ca47f50ae23b2fc18955",
      "created_at": "2024-10-26T20:01:06Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14914596074,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4-qzq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14914596074",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d5b9484f623133d7f5396fb84b36450c3dcdc689",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d5b9484f623133d7f5396fb84b36450c3dcdc689",
      "created_at": "2024-10-26T22:14:00Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14914980894,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5AIwe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14914980894",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7115abe5140c7cba2c1f31f531ff8ac48ebe5d11",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7115abe5140c7cba2c1f31f531ff8ac48ebe5d11",
      "created_at": "2024-10-26T22:31:02Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14915740952,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5DCUY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14915740952",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "f7ab210e5437674193ac21274fa6dbee77acc6cf",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/f7ab210e5437674193ac21274fa6dbee77acc6cf",
      "created_at": "2024-10-26T23:07:17Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14917256589,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5I0WN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14917256589",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "893c0b9c8f7d37caa69b409cc43a261bf3c04988",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/893c0b9c8f7d37caa69b409cc43a261bf3c04988",
      "created_at": "2024-10-27T00:11:36Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14920099117,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5TqUt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14920099117",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "3f58a51e0881c511f4ce1550581e0b7eb2bd7396",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/3f58a51e0881c511f4ce1550581e0b7eb2bd7396",
      "created_at": "2024-10-27T04:45:57Z"
    },
    {
      "event": "convert_to_draft",
      "id": 14925130762,
      "node_id": "CTDE_lADOABII586bT0I_zwAAAAN5m2wK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14925130762",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-27T13:28:41Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14925301705,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5ngfJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14925301705",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "5a79235454ada6e08ada95a07bbd01c42689ee29",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5a79235454ada6e08ada95a07bbd01c42689ee29",
      "created_at": "2024-10-27T13:40:24Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14926730470,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5s9Tm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14926730470",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ab6fbdf698e595758d6d43c512bc3dc6754e4803",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ab6fbdf698e595758d6d43c512bc3dc6754e4803",
      "created_at": "2024-10-27T15:15:00Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14926840604,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5tYMc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14926840604",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "4ae00c48add4f6e74dccf2339f41968a57ecd5c1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/4ae00c48add4f6e74dccf2339f41968a57ecd5c1",
      "created_at": "2024-10-27T15:21:57Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14927991893,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5xxRV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14927991893",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ee5b899ef80b1e78741aed54d583ba40d8402cc9",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ee5b899ef80b1e78741aed54d583ba40d8402cc9",
      "created_at": "2024-10-27T16:37:26Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14928181449,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5yfjJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14928181449",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "2eb2872524cc8e4156179180e8f770092b762b31",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/2eb2872524cc8e4156179180e8f770092b762b31",
      "created_at": "2024-10-27T16:51:17Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14928621817,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN50LD5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14928621817",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7e7e4092551ebaface97b945cd70c46448915245",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7e7e4092551ebaface97b945cd70c46448915245",
      "created_at": "2024-10-27T17:19:53Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14931091175,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN59l7n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14931091175",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0d1c6375579985dc214bfc00b4eff67b87782ede",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0d1c6375579985dc214bfc00b4eff67b87782ede",
      "created_at": "2024-10-27T19:55:53Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15163921481,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOH1xRJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15163921481",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ccbde0f075ad9ab259b2225b9b56d98593b73f60",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ccbde0f075ad9ab259b2225b9b56d98593b73f60",
      "created_at": "2024-11-07T00:54:22Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15164034996,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOH2M-0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15164034996",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "89b1a1d830bff178ac1ee35ff39ed6b55bb5aa1a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/89b1a1d830bff178ac1ee35ff39ed6b55bb5aa1a",
      "created_at": "2024-11-07T00:59:53Z"
    },
    {
      "event": "unlabeled",
      "id": 15165724918,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOH8pj2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15165724918",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T02:25:20Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15169496211,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOILCST",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15169496211",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1a4ad617529fa0d1833c0c260b0429a948e0374e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1a4ad617529fa0d1833c0c260b0429a948e0374e",
      "created_at": "2024-11-07T05:22:21Z"
    },
    {
      "event": "ready_for_review",
      "id": 15183787339,
      "node_id": "RFRE_lADOABII586bT0I_zwAAAAOJBjVL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15183787339",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:01:24Z"
    },
    {
      "event": "commented",
      "id": 2462468543,
      "node_id": "IC_kwDOABII586Sxkm_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2462468543",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:05:31Z",
      "updated_at": "2024-11-07T15:05:31Z",
      "author_association": "CONTRIBUTOR",
      "body": "@furszy I tried to switch to using a shared threadpool, but it is much slower that way. We need a way to have shared state between threads for this, instead of just scheduling tasks. I suppose the generic threadpool is great for scheduling independent tasks like indexing an individual block, but for quickly pulling outpoints off a shared vector it is not optimized well.\r\n\r\nFrom https://github.com/bitcoin/bitcoin/issues/29386:\r\n> I just [noticed the comment in the code](https://github.com/bitcoin/bitcoin/blob/9eeee7caa3f95ee17a645e12d330261f8e3c2dbf/doc/reduce-memory.md?plain=1#L37C1-L39C15):\r\n>>    For each thread a thread stack needs to be allocated. By default on Linux,\r\n    threads take up 8MiB for the thread stack on a 64-bit system, and 4MiB in a\r\n    32-bit system.\r\n\r\n> Only 8MiB of Virtual Memory is allocated, which doesn't really mean anything. Due to CoW mechanism, only the parts of stack that are being used will be allocated as Physical Memory which is the one that actually matters.\r\n\r\nSo, I don't think it matters much to have an extra threadpool owned by the input fetcher.\r\n\r\nI think this is ready for more review. I also added tests and a benchmark.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2462468543",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 15183942257,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAOJCJJx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15183942257",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:05:32Z"
    },
    {
      "event": "subscribed",
      "id": 15183942283,
      "node_id": "SE_lADOABII586bT0I_zwAAAAOJCJKL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15183942283",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:05:32Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15189550538,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOJXiXK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15189550538",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "910bf42e0065d205b50c2e1960c63e5f9b867d3a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/910bf42e0065d205b50c2e1960c63e5f9b867d3a",
      "created_at": "2024-11-07T18:38:49Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15239155612,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOMUw-c",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15239155612",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "66bbde0ec074c68ddc4145e2d3c33e877a8a132c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/66bbde0ec074c68ddc4145e2d3c33e877a8a132c",
      "created_at": "2024-11-09T18:21:42Z"
    },
    {
      "event": "commented",
      "id": 2473948407,
      "node_id": "IC_kwDOABII586TdXT3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2473948407",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-13T15:28:15Z",
      "updated_at": "2024-11-13T15:28:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "For later blocks where cache misses are much more common, this change has an even bigger impact.\r\nThis benchmark report shows a 40% speedup measuring from blocks 840k to 850k. Also, compare flamegraphs of master and this branch, where the latter has 15 worker threads fetching coins from disk.\r\nhttps://bitcoin-dev-tools.github.io/benchcoin/results/pr-19/11798124132/index.html",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2473948407",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 2480372333,
      "node_id": "IC_kwDOABII586T13pt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2480372333",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T03:35:49Z",
      "updated_at": "2024-11-16T03:35:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "Even with just 2 worker threads, there is significant (~30%) speed improvement for syncing recent blocks.\r\nhttps://bitcoin-dev-tools.github.io/benchcoin/results/pr-19/11865650166/index.html",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2480372333",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15320436676,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORK0_E",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15320436676",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "97e90b5ac5a5a83a9305b8c9573760996b069419",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/97e90b5ac5a5a83a9305b8c9573760996b069419",
      "created_at": "2024-11-16T03:40:41Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15320841157,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORMXvF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15320841157",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c38cf8f92fff1df5c40b3c10e699726adc68b535",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c38cf8f92fff1df5c40b3c10e699726adc68b535",
      "created_at": "2024-11-16T07:52:02Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322202672,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORRkIw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322202672",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "faf19f18031ead55b1d441444a1b30b8de8bbfab",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/faf19f18031ead55b1d441444a1b30b8de8bbfab",
      "created_at": "2024-11-16T19:35:04Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322230462,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORRq6-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322230462",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ea8e67ca7d8a76c87f9df3617ea287f339b3f44b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ea8e67ca7d8a76c87f9df3617ea287f339b3f44b",
      "created_at": "2024-11-16T19:45:00Z"
    },
    {
      "event": "commented",
      "id": 2480756343,
      "node_id": "IC_kwDOABII586T3VZ3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2480756343",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T19:45:10Z",
      "updated_at": "2024-11-16T19:45:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33086747731</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2480756343",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15322230898,
      "node_id": "LE_lADOABII586bT0I_zwAAAAORRrBy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322230898",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T19:45:10Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322459653,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORSi4F",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322459653",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "887ab0c0a12a12e5ebc91a98c6b3972a6bc29af4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/887ab0c0a12a12e5ebc91a98c6b3972a6bc29af4",
      "created_at": "2024-11-16T20:56:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322466773,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORSknV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322466773",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7ff688350de239d752a42d216b44fad75ec698a6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7ff688350de239d752a42d216b44fad75ec698a6",
      "created_at": "2024-11-16T20:58:46Z"
    },
    {
      "event": "unlabeled",
      "id": 15322621035,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAORTKRr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322621035",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T21:38:17Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15323161161,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORVOJJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15323161161",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "created_at": "2024-11-17T00:02:59Z"
    },
    {
      "event": "reviewed",
      "id": 2442755733,
      "node_id": "PRR_kwDOABII586RmX6V",
      "url": null,
      "actor": null,
      "commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-11-18T14:22:14Z",
      "author_association": "MEMBER",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2442755733",
      "submitted_at": "2024-11-18T14:22:14Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15335691084,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSFBNM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15335691084",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1fe34824cf75628e6b180e9ed5e6eb1b9ba98709",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1fe34824cf75628e6b180e9ed5e6eb1b9ba98709",
      "created_at": "2024-11-18T14:54:05Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15336267654,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSHN-G",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15336267654",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "8b813495d132ff2390e039ac6cb321b82b51efd6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8b813495d132ff2390e039ac6cb321b82b51efd6",
      "created_at": "2024-11-18T15:33:59Z"
    },
    {
      "event": "commented",
      "id": 2483393645,
      "node_id": "IC_kwDOABII586UBZRt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2483393645",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-18T15:34:04Z",
      "updated_at": "2024-11-18T15:34:04Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33143571653</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2483393645",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15336268823,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOSHOQX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15336268823",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-18T15:34:04Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15337346046,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSLVP-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15337346046",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "992c76f3bb1a2d091f7604208a09f94ceff75509",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/992c76f3bb1a2d091f7604208a09f94ceff75509",
      "created_at": "2024-11-18T16:49:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15338125165,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSOTdt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15338125165",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "5e05539ee48d3d4786f573d05a6ba9e89a8e74f6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5e05539ee48d3d4786f573d05a6ba9e89a8e74f6",
      "created_at": "2024-11-18T17:54:07Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15338487303,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSPr4H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15338487303",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0875e93322ae53b2ac7d9418501f002da73b258b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0875e93322ae53b2ac7d9418501f002da73b258b",
      "created_at": "2024-11-18T18:25:49Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15338614667,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSQK-L",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15338614667",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "28e739e557de92b287546b211f763bd890d00c2d",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/28e739e557de92b287546b211f763bd890d00c2d",
      "created_at": "2024-11-18T18:37:06Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15339145882,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSSMqa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15339145882",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "04b3f4529e804cfcdc79135a1929535b578860cd",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/04b3f4529e804cfcdc79135a1929535b578860cd",
      "created_at": "2024-11-18T19:26:05Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15339688166,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSURDm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15339688166",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "created_at": "2024-11-18T20:08:53Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15340495444,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSXWJU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15340495444",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "3a9553dbd55836c1a17583b4421f4dd9c8bd65cf",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/3a9553dbd55836c1a17583b4421f4dd9c8bd65cf",
      "created_at": "2024-11-18T21:24:26Z"
    },
    {
      "event": "unlabeled",
      "id": 15340858532,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOSYuyk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15340858532",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-18T22:03:21Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15349486168,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOS5pJY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15349486168",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "02ae43e470ed16943ef8783dbc59784ac7e6bbb1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/02ae43e470ed16943ef8783dbc59784ac7e6bbb1",
      "created_at": "2024-11-19T13:22:25Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15350958942,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOS_Qte",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15350958942",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d35740b5c63ceb2157518c572e76063f1d2968f2",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d35740b5c63ceb2157518c572e76063f1d2968f2",
      "created_at": "2024-11-19T15:02:27Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15371196417,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOUMdgB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15371196417",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "24a523084d061020a94fc13709cb0c99862e6687",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/24a523084d061020a94fc13709cb0c99862e6687",
      "created_at": "2024-11-20T18:19:29Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15371454684,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOUNcjc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15371454684",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "95e6b0d189b770af2d29fbdae93c5b34290848a7",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/95e6b0d189b770af2d29fbdae93c5b34290848a7",
      "created_at": "2024-11-20T18:46:12Z"
    },
    {
      "event": "labeled",
      "id": 15371455548,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOUNcw8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15371455548",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-20T18:46:17Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2489311955,
      "node_id": "IC_kwDOABII586UX-LT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2489311955",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-20T18:46:18Z",
      "updated_at": "2024-11-20T18:46:18Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33279820062</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2489311955",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 2445676953,
      "node_id": "PRR_kwDOABII586RxhGZ",
      "url": null,
      "actor": null,
      "commit_id": "95e6b0d189b770af2d29fbdae93c5b34290848a7",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-11-20T18:48:56Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2445676953",
      "submitted_at": "2024-11-20T18:48:56Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15373145284,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOUT5TE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15373145284",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "530d615acaf2db1adcb5ec58e23dc4967ed5a028",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/530d615acaf2db1adcb5ec58e23dc4967ed5a028",
      "created_at": "2024-11-20T21:45:00Z"
    },
    {
      "event": "unlabeled",
      "id": 15373675774,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOUV6z-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15373675774",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-20T22:49:48Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15385044720,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOVBSbw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15385044720",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "934094ef5701e5d6d576a93cf511d9db0038e982",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/934094ef5701e5d6d576a93cf511d9db0038e982",
      "created_at": "2024-11-21T16:33:51Z"
    },
    {
      "event": "commented",
      "id": 2491818543,
      "node_id": "IC_kwDOABII586UhiIv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2491818543",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T17:12:26Z",
      "updated_at": "2024-11-21T17:12:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33335042693</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2491818543",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15385588395,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOVDXKr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15385588395",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T17:12:26Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15385659114,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOVDobq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15385659114",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0d79c3688597d98d28f1d5db1ecf5645e3cfbd49",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0d79c3688597d98d28f1d5db1ecf5645e3cfbd49",
      "created_at": "2024-11-21T17:18:02Z"
    },
    {
      "event": "unsubscribed",
      "id": 15386015162,
      "node_id": "UE_lADOABII586bT0I_zwAAAAOVE_W6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15386015162",
      "actor": {
        "login": "jixi1991",
        "id": 5715530,
        "node_id": "MDQ6VXNlcjU3MTU1MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5715530?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jixi1991",
        "html_url": "https://github.com/jixi1991",
        "followers_url": "https://api.github.com/users/jixi1991/followers",
        "following_url": "https://api.github.com/users/jixi1991/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jixi1991/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jixi1991/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jixi1991/subscriptions",
        "organizations_url": "https://api.github.com/users/jixi1991/orgs",
        "repos_url": "https://api.github.com/users/jixi1991/repos",
        "events_url": "https://api.github.com/users/jixi1991/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jixi1991/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T17:48:23Z"
    },
    {
      "event": "unlabeled",
      "id": 15386239028,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOVF2A0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15386239028",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T18:06:24Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15405352594,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOWOwaS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15405352594",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "895e94bb76e227aa0e6c4d2f2fc00b7ef5d17066",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/895e94bb76e227aa0e6c4d2f2fc00b7ef5d17066",
      "created_at": "2024-11-22T23:46:40Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15411272108,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOWlVms",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15411272108",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a236c9ec3858e892276bb528a9d29cb3aa72bfb3",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a236c9ec3858e892276bb528a9d29cb3aa72bfb3",
      "created_at": "2024-11-24T19:10:17Z"
    },
    {
      "event": "reviewed",
      "id": 2462618817,
      "node_id": "PRR_kwDOABII586SyJTB",
      "url": null,
      "actor": null,
      "commit_id": "a236c9ec3858e892276bb528a9d29cb3aa72bfb3",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-11-26T20:55:39Z",
      "author_association": "MEMBER",
      "body": "Concept ACK\r\nThis is nice. Although I have not yet benchmarked this branch, I also like @furszy's idea of having a general-purpose thread pool.\r\n\r\nI just have one test improvement comment, question and a nit after first pass of the PR",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2462618817",
      "submitted_at": "2024-11-26T20:55:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "labeled",
      "id": 15517599072,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOc68Vg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15517599072",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T00:20:07Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15517806626,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOc7vAi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15517806626",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c2e3f6e8f23836d1f49201f0ede64e3749838a50",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c2e3f6e8f23836d1f49201f0ede64e3749838a50",
      "created_at": "2024-12-04T00:54:40Z"
    },
    {
      "event": "commented",
      "id": 2515910524,
      "node_id": "IC_kwDOABII586V9b98",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2515910524",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:02:47Z",
      "updated_at": "2024-12-04T17:21:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased. Since #30039 reading inputs is much faster, so the effect of this is somewhat less significant (17% -> 10%). It's still a significant speedup though so still worth it. Especially for worst case where the cache is completely empty, like on startup or right after it gets flushed due to size.\r\n\r\nIt is also refactored significantly. The main thread now writes everything before notifying threads, and then joins in working. This lets us do significantly less work in the critical section and parallelize more checks.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2515910524",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "renamed",
      "id": 15517864077,
      "node_id": "RTE_lADOABII586bT0I_zwAAAAOc79CN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15517864077",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:04:10Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads ~17% faster IBD",
        "to": "validation: fetch block inputs on parallel threads 10% faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15518016570,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOc8iQ6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518016570",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9d33a3a28b7bc9b2957bb528cf40476d8bc8c7ce",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9d33a3a28b7bc9b2957bb528cf40476d8bc8c7ce",
      "created_at": "2024-12-04T01:29:45Z"
    },
    {
      "event": "commented",
      "id": 2515966098,
      "node_id": "IC_kwDOABII586V9piS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2515966098",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:29:50Z",
      "updated_at": "2024-12-04T01:29:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33884531020</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2515966098",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15518016992,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOc8iXg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518016992",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:29:50Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15518169523,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOc9Hmz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518169523",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a544477011c40ee98a0c0254dfb968d6233ef811",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a544477011c40ee98a0c0254dfb968d6233ef811",
      "created_at": "2024-12-04T01:56:23Z"
    },
    {
      "event": "unlabeled",
      "id": 15518350100,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOc9zsU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518350100",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T02:24:38Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 15518493046,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOc-Wl2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518493046",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T02:49:11Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 15534194608,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOd6P-w",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15534194608",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T00:37:19Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15534228148,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOd6YK0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15534228148",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b2da76444613229e0bf5539596903ac3c1db3053",
      "created_at": "2024-12-05T00:43:37Z"
    },
    {
      "event": "unlabeled",
      "id": 15534948844,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOd9IHs",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15534948844",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T02:50:11Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "subscribed",
      "id": 16651261972,
      "node_id": "SE_lADOABII586bT0I_zwAAAAPgfhgU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16651261972",
      "actor": {
        "login": "jsarenik",
        "id": 244565,
        "node_id": "MDQ6VXNlcjI0NDU2NQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/244565?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jsarenik",
        "html_url": "https://github.com/jsarenik",
        "followers_url": "https://api.github.com/users/jsarenik/followers",
        "following_url": "https://api.github.com/users/jsarenik/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jsarenik/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jsarenik/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jsarenik/subscriptions",
        "organizations_url": "https://api.github.com/users/jsarenik/orgs",
        "repos_url": "https://api.github.com/users/jsarenik/repos",
        "events_url": "https://api.github.com/users/jsarenik/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jsarenik/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-10T09:38:36Z"
    },
    {
      "event": "labeled",
      "id": 17939209498,
      "node_id": "LE_lADOABII586bT0I_zwAAAAQtQp0a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17939209498",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-02T17:18:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2957908956,
      "node_id": "IC_kwDOABII586wThvc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2957908956",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-10T07:02:30Z",
      "updated_at": "2025-06-10T07:02:30Z",
      "author_association": "MEMBER",
      "body": "Looks like the CI started failing, due to too many threads being launched in the functional tests with that parallelism? As the threads may open files, this could be hitting the max open files limit? Or maybe it is a different limit hit?",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2957908956",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3009101750,
      "node_id": "IC_kwDOABII586zWz-2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3009101750",
      "actor": {
        "login": "HowHsu",
        "id": 38499194,
        "node_id": "MDQ6VXNlcjM4NDk5MTk0",
        "avatar_url": "https://avatars.githubusercontent.com/u/38499194?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HowHsu",
        "html_url": "https://github.com/HowHsu",
        "followers_url": "https://api.github.com/users/HowHsu/followers",
        "following_url": "https://api.github.com/users/HowHsu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/HowHsu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/HowHsu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/HowHsu/subscriptions",
        "organizations_url": "https://api.github.com/users/HowHsu/orgs",
        "repos_url": "https://api.github.com/users/HowHsu/repos",
        "events_url": "https://api.github.com/users/HowHsu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/HowHsu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-26T16:42:59Z",
      "updated_at": "2025-06-26T16:42:59Z",
      "author_association": "NONE",
      "body": "Hi folks, this looks great, since if all the `prevout coins` of all transactions of a block are loaded in advance, then the optimization in #32791 makes sense.",
      "user": {
        "login": "HowHsu",
        "id": 38499194,
        "node_id": "MDQ6VXNlcjM4NDk5MTk0",
        "avatar_url": "https://avatars.githubusercontent.com/u/38499194?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HowHsu",
        "html_url": "https://github.com/HowHsu",
        "followers_url": "https://api.github.com/users/HowHsu/followers",
        "following_url": "https://api.github.com/users/HowHsu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/HowHsu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/HowHsu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/HowHsu/subscriptions",
        "organizations_url": "https://api.github.com/users/HowHsu/orgs",
        "repos_url": "https://api.github.com/users/HowHsu/repos",
        "events_url": "https://api.github.com/users/HowHsu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/HowHsu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3009101750",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3302056248,
      "node_id": "IC_kwDOABII587E0WE4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3302056248",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-17T09:09:12Z",
      "updated_at": "2025-09-17T09:09:12Z",
      "author_association": "CONTRIBUTOR",
      "body": "What's the status here?",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3302056248",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19756832559,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASZmVcv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19756832559",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "created_at": "2025-09-17T18:18:36Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19756953150,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASZmy4-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19756953150",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "743d2da0f8871afc194c63a394e1ded4c8e17990",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/743d2da0f8871afc194c63a394e1ded4c8e17990",
      "created_at": "2025-09-17T18:25:40Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19757566915,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASZpIvD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19757566915",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/688c03597afb0b76077f1ffc4608eef19481056e",
      "created_at": "2025-09-17T18:56:46Z"
    },
    {
      "event": "commented",
      "id": 3304494917,
      "node_id": "IC_kwDOABII587E9pdF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3304494917",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-17T20:38:24Z",
      "updated_at": "2025-09-17T20:38:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Looks like the CI started failing, due to too many threads being launched in the functional tests with that parallelism? As the threads may open files, this could be hitting the max open files limit? Or maybe it is a different limit hit?\r\n\r\nThanks, I added `-par=1` to all nodes spawned in `features_proxy.py` in 6980852416040bdddf111df3cea3ec50639f010a. That test spawns lots of nodes and block validation is not relevant to it.\r\n\r\n> What's the status here?\r\n\r\nRebased to fix silent conflicts and added the fix for `features_proxy.py`.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3304494917",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3316319902,
      "node_id": "IC_kwDOABII587Fqwae",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3316319902",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-21T22:57:47Z",
      "updated_at": "2025-10-02T02:52:55Z",
      "author_association": "CONTRIBUTOR",
      "body": "I benchmarked the latest branch with default dbcache up to 912683. Results are a speedup of 14% - 5:07 vs 5:49.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo 688c03597afb0b76077f1ffc4608eef19481056e && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683` | 18430.672 Â± 19.856 | 18416.631 | 18444.712 | 1.00 |\r\n| `echo 1444ed855f438f1270104fca259ce61b99ed5cdb && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683` | 20937.219 Â± 62.635 | 20892.929 | 20981.508 | 1.14 Â± 0.00 |\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3316319902",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "renamed",
      "id": 19825003493,
      "node_id": "RTE_lADOABII586bT0I_zwAAAASdqYvl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19825003493",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-21T22:58:28Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads 10% faster IBD",
        "to": "validation: fetch block inputs on parallel threads >10% faster IBD"
      }
    },
    {
      "event": "unlabeled",
      "id": 19831185263,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAASeB99v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19831185263",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-22T08:13:18Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3324906640,
      "node_id": "IC_kwDOABII587GLgyQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3324906640",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-23T17:18:05Z",
      "updated_at": "2025-09-23T17:25:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "Did the same benchmark with 5000 dbcache and there is a 6% speedup :rocket: - 4:27 vs 4:44. Even with far fewer cache misses this change is still a benefit, and will continue to improve block connection speed as the blockchain and utxo set get bigger.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo 688c03597afb0b76077f1ffc4608eef19481056e && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683 -dbcache=5000` | 16021.047 Â± 5.892 | 16016.881 | 16025.213 | 1.00 |\r\n| `echo 1444ed855f438f1270104fca259ce61b99ed5cdb && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683 -dbcache=5000` | 17057.947 Â± 42.032 | 17028.226 | 17087.668 | 1.06 Â± 0.00 |",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3324906640",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 3264568566,
      "node_id": "PRR_kwDOABII587ClVz2",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-24T20:16:40Z",
      "author_association": "MEMBER",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3264568566",
      "submitted_at": "2025-09-24T20:16:40Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 2831320761,
      "node_id": "PRR_kwDOABII586owoa5",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-12T12:29:33Z",
      "author_association": "CONTRIBUTOR",
      "body": "I have re-reviewed the changes again lightly and did quite a few benchmarks on different platforms.\r\nThere were a lot of surprises, see my measurements:\r\n\r\n<details>\r\n<summary>rpi5-16 IBD from local node or & reindex-chainstate seem is ~27% faster</summary>\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=915961; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        29732.695 s               [User: 60441.083 s, System: 5856.247 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        37896.082 s               [User: 60968.810 s, System: 7062.414 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.27          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\n---\r\n\r\nRetested it separately with:\r\n```\r\n# cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && time ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -connect=rpi5-16-3.local\r\n\r\ncat ../BitcoinData/debug.log | egrep 'height=0|height=916000'\r\n2025-09-25T17:03:06Z UpdateTip: new best=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f height=0 version=0x00000001 log2_work=32.000022 tx=1 date='2009-01-03T18:15:05Z' progress=0.000000 cache=0.3MiB(0txo)\r\n2025-09-26T01:02:56Z UpdateTip: new best=000000000000000000003ca9748080f4c3d1230ba9fa4bed66be6ded05f9b6e6 height=916000 version=0x2000e000 log2_work=95.840381 tx=1246369867 date='2025-09-23T07:22:08Z' progress=0.998966 cache=367.7MiB(2821413txo)\r\n7h 59m 50s\r\n```\r\n\r\n</details>\r\n\r\nDoing the same on an Intel i9 with SSD shows similar results\r\n\r\n<details>\r\n<summary>i9 with SSD, IBD from real peers/reindex-chainstate seem is 24%/25% faster for default memory, done in 6h/3.5h</summary>\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=915961; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        12698.166 s               [User: 33794.242 s, System: 3015.471 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        15928.708 s               [User: 28382.232 s, System: 2308.299 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.25          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\nand\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=916000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 3 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (mean Â± Ïƒ):     21484.108 s Â± 1187.956 s    [User: 42976.944 s, System: 4356.289 s]\r\n  Range (min â€¦ max):   20112.390 s â€¦ 22175.559 s    3 runs\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (mean Â± Ïƒ):     26589.393 s Â± 1171.370 s    [User: 36011.245 s, System: 3193.496 s]\r\n  Range (min â€¦ max):   25607.731 s â€¦ 27886.055 s    3 runs\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.24 Â±  0.09  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\n</details>\r\n\r\nIncreasing the memory decreases the difference:\r\n\r\n<details>\r\n<summary>i9 reindex-chainstate seem is ~9% faster for default memory, done in 3.3h</summary>\r\n\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; STOP=915961; DBCACHE=4500; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        11801.704 s               [User: 20216.598 s, System: 1181.879 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        12916.432 s               [User: 17150.579 s, System: 747.711 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.09          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n</details>\r\n\r\nNote that the difference between small and big dbcache is also shrunk from 23% to 7.5%!\r\n\r\nChecked the same on an i7 with hdd, it seems the speedup is best on non-rotating disks, maybe we could consider reducing the parallelism in those cases:\r\n\r\n<details>\r\n<summary>i7 with HDD, IBD/reindex-chainstate seem is ~16% faster for default memory</summary>\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=916000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        35766.853 s               [User: 39688.514 s, System: 2853.808 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        41355.517 s               [User: 35667.321 s, System: 2872.506 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blockso$ly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.16          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\nand\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=916000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        35766.853 s               [User: 39688.514 s, System: 2853.808 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        41355.517 s               [User: 35667.321 s, System: 2872.506 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blockso$ly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.16          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\n</details>\r\n\r\nChecking the same on my M4 max laptop was the most surprising:\r\n<details>\r\n<summary>M4 max with SSD, IBD/reindex-chainstate seem is 290% faster for default memory</summary>\r\n\r\n```\r\nSTOP=916000; DBCACHE=450; \\\r\nDATA_DIR=\"/Users/lorinc/Library/Application\\ Support/Bitcoin\"; \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --parameter-list COMMIT 688c03597afb0b76077f1ffc4608eef19481056e \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\nBenchmark 1: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        20658.825 s               [User: 19679.918 s, System: 4763.490 s]\r\nBenchmark 1b: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        20186.312 s               [User: 19481.126 s, System: 4716.728 s]\r\n\r\nBenchmark 2: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        7131.178 s               [User: 17244.133 s, System: 12850.427 s]\r\nBenchmark 2b: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        7180.762 s               [User: 17430.360 s, System: 12949.731 s\r\n\r\nRelative speed comparison\r\n        2.90          ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n        1.00          ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n```\r\n\r\nIt was hard to believe this was true, so I re-ran it a few times, and it was consistent.\r\n\r\n</details>\r\n\r\nI have tried -par=32 on my laptop as well - exactly the same speed:\r\n<details>\r\n<summary>-par=32</summary>\r\n\r\n```\r\nSTOP=916000; DBCACHE=450; \\\r\nDATA_DIR=\"/Users/lorinc/Library/Application\\ Support/Bitcoin\"; \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --parameter-list COMMIT 688c03597afb0b76077f1ffc4608eef19481056e \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=32\"\r\n\r\nBenchmark 1: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=32 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        7109.626 s               [User: 17210.848 s, System: 12938.964 s]\r\n```\r\nnote, the commit had:\r\n```\r\n      m_input_fetcher{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, 10 * MAX_SCRIPTCHECK_THREADS)},\r\n```\r\n\r\n</details>\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2831320761",
      "submitted_at": "2025-09-29T16:16:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 3280693697,
      "node_id": "PRR_kwDOABII587Di2nB",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-29T16:17:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "<duplicate>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3280693697",
      "submitted_at": "2025-09-29T16:17:05Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 3280976253,
      "node_id": "PRR_kwDOABII587Dj7l9",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-29T17:45:27Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3280976253",
      "submitted_at": "2025-09-29T17:45:27Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "commented",
      "id": 3356601737,
      "node_id": "IC_kwDOABII587IEa2J",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3356601737",
      "actor": {
        "login": "Raimo33",
        "id": 104778891,
        "node_id": "U_kgDOBj7Miw",
        "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Raimo33",
        "html_url": "https://github.com/Raimo33",
        "followers_url": "https://api.github.com/users/Raimo33/followers",
        "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
        "organizations_url": "https://api.github.com/users/Raimo33/orgs",
        "repos_url": "https://api.github.com/users/Raimo33/repos",
        "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Raimo33/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-01T14:23:57Z",
      "updated_at": "2025-10-01T14:23:57Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "Raimo33",
        "id": 104778891,
        "node_id": "U_kgDOBj7Miw",
        "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Raimo33",
        "html_url": "https://github.com/Raimo33",
        "followers_url": "https://api.github.com/users/Raimo33/followers",
        "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
        "organizations_url": "https://api.github.com/users/Raimo33/orgs",
        "repos_url": "https://api.github.com/users/Raimo33/repos",
        "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Raimo33/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3356601737",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20058361971,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrklBz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20058361971",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "4331168bd08d63a73a6e45c84a7513d01541f19a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/4331168bd08d63a73a6e45c84a7513d01541f19a",
      "created_at": "2025-10-02T12:16:35Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20058563528,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrlWPI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20058563528",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "928847cdfd1d7fc5158362e5bade86f48bbd7c9a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/928847cdfd1d7fc5158362e5bade86f48bbd7c9a",
      "created_at": "2025-10-02T12:26:08Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20058731082,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrl_JK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20058731082",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "fe77ce977b40c8f24f641d33a15cc6eb73b1c3bb",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/fe77ce977b40c8f24f641d33a15cc6eb73b1c3bb",
      "created_at": "2025-10-02T12:33:48Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20059744050,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrp2cy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20059744050",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9cdbb25a79a090a631d5684818767895021d1220",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9cdbb25a79a090a631d5684818767895021d1220",
      "created_at": "2025-10-02T13:20:42Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20060123208,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrrTBI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20060123208",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "created_at": "2025-10-02T13:37:28Z"
    },
    {
      "event": "commented",
      "id": 3361944949,
      "node_id": "IC_kwDOABII587IYzV1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3361944949",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-02T15:47:28Z",
      "updated_at": "2025-10-02T15:47:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "Updated the input fetcher significantly:\n- uses counting_semaphores to synchronize threads instead of mutex + condvar.\n- stores tx + vin indexes in global vector instead of copying the COutPoints. The COutPoints are read from a global CBlock pointer.\n- The fetch queue counter is an atomic int instead of a mutex guarded int.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3361944949",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20084838906,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStJlH6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20084838906",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "86a9f72f89690fdd052532b3f908ea6a6e95aa2e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/86a9f72f89690fdd052532b3f908ea6a6e95aa2e",
      "created_at": "2025-10-03T15:58:49Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20084930245,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStJ7bF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20084930245",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "28b249c899ded88ee0765eac20b330e63b42cdfa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/28b249c899ded88ee0765eac20b330e63b42cdfa",
      "created_at": "2025-10-03T16:04:14Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20085086442,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStKhjq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20085086442",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c6e8499550632f87d6517472038f545e72c173b5",
      "created_at": "2025-10-03T16:14:00Z"
    },
    {
      "event": "commented",
      "id": 3366595565,
      "node_id": "IC_kwDOABII587Iqivt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3366595565",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-03T17:33:05Z",
      "updated_at": "2025-10-03T17:33:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "Removed `m_batch_size`. Each thread now increments the atomic counter by 1.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3366595565",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20092301267,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStmC_T",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20092301267",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a8f9a806751b5755bdec5b096186f70c0bfddcfa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a8f9a806751b5755bdec5b096186f70c0bfddcfa",
      "created_at": "2025-10-03T23:44:01Z"
    },
    {
      "event": "commented",
      "id": 3367707177,
      "node_id": "IC_kwDOABII587IuyIp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3367707177",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-04T00:53:28Z",
      "updated_at": "2025-10-04T00:53:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "The latest version seems very promising, I like that the algorithms is getting simpler.\r\nI noticed that for small dbcache it has a very noticeable effect, but for very high dbcache this seems to add an extra cost - since we already have everything in the cache, so it just does useless work.\r\nI wonder if we could enable this fetching only after the very first time we [Flush](https://github.com/bitcoin/bitcoin/blob/17372d788e6ca6f5a8452acf88d6b7db4221cb7e/src/coins.cpp#L251) and erase, since it cannot help in any way before that.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3367707177",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20097324062,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASt5NQe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20097324062",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/cf209da104d483aa064aa3bec621f1adc9574749",
      "created_at": "2025-10-04T15:53:30Z"
    },
    {
      "event": "commented",
      "id": 3378291849,
      "node_id": "IC_kwDOABII587JXKSJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3378291849",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-07T18:52:32Z",
      "updated_at": "2025-10-07T18:52:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "Compared it against master on a Raspberry Pi 5 synchronizing from real peers for realism, ran it twice for good measure until 917000 blocks with dbcache 450:\r\n\r\nThis isn't the [latest version](https://github.com/bitcoin/bitcoin/compare/a8f9a806751b5755bdec5b096186f70c0bfddcfa..cf209da104d483aa064aa3bec621f1adc9574749) of the PR, but should likely be representative anyway.\r\n\r\n<details>\r\n<summary>First run: 19% faster, finished IBD in 13h:11m | IBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"a8f9a806751b5755bdec5b096186f70c0bfddcfa f0dc19f16826f68ef482acfb7b24e8bb7168fc51\"; \\\r\nSTOP=917000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\na8f9a80675 validation: fetch block inputs in parallel\r\nf0dc19f168 coins: allow emplacing non-dirty coins internally\r\n\r\nIBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n  Time (abs â‰¡):        47485.682 s               [User: 79615.847 s, System: 9374.261 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n  Time (abs â‰¡):        56374.354 s               [User: 78807.079 s, System: 10196.290 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n        1.19          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Second run: 21% faster, finished IBD in 12h:45m | IBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"a8f9a806751b5755bdec5b096186f70c0bfddcfa f0dc19f16826f68ef482acfb7b24e8bb7168fc51\"; \\\r\nSTOP=917000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\na8f9a80675 validation: fetch block inputs in parallel\r\nf0dc19f168 coins: allow emplacing non-dirty coins internally\r\n\r\nIBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n  Time (abs â‰¡):        45907.874 s               [User: 81006.258 s, System: 10039.919 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n  Time (abs â‰¡):        55612.464 s               [User: 81830.349 s, System: 11913.754 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n        1.21          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n```\r\n\r\n</details>\r\n\r\nThe variance between the runs shows 1% for master and 3% difference for the PR indicating that we're likely nearing the network bandwidth limitations.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3378291849",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20226498884,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS1l-FE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20226498884",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "3335d8d45571247184c33136ba30a83c20be4701",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/3335d8d45571247184c33136ba30a83c20be4701",
      "created_at": "2025-10-11T18:03:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20226508890,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS1mAha",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20226508890",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "created_at": "2025-10-11T18:05:31Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20270952405,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS4Pi_V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20270952405",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "created_at": "2025-10-14T14:02:56Z"
    },
    {
      "event": "commented",
      "id": 3403508763,
      "node_id": "IC_kwDOABII587K3Wwb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3403508763",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T20:28:47Z",
      "updated_at": "2025-10-14T20:28:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I noticed that for small dbcache it has a very noticeable effect, but for very high dbcache this seems to add an extra cost - since we already have everything in the cache, so it just does useless work.\r\nI wonder if we could enable this fetching only after the very first time we [Flush](https://github.com/bitcoin/bitcoin/blob/17372d788e6ca6f5a8452acf88d6b7db4221cb7e/src/coins.cpp#L251) and erase, since it cannot help in any way before that.\r\n\r\n@l0rinc There is already quite a lot to review here, and your benchmarks (and mine) show very promising results. So, I would prefer to keep this idea as a follow-up. We can do isolated benchmarks with your suggested change afterwards and propose an improvement accordingly.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3403508763",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20278946868,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAS4uCw0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20278946868",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T20:28:48Z"
    },
    {
      "event": "subscribed",
      "id": 20278946906,
      "node_id": "SE_lADOABII586bT0I_zwAAAAS4uCxa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20278946906",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T20:28:48Z"
    },
    {
      "event": "commented",
      "id": 3403611574,
      "node_id": "IC_kwDOABII587K3v22",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3403611574",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T21:04:25Z",
      "updated_at": "2025-10-14T21:05:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'm fine with doing that in a follow-up if you think it's too complicated (though it's likely quite simple, we can just track the very first cache miss and always prefetch after that - that heuristic would even survive node restarts. Maybe we need to skip the Bip30 values though, but it's just a heuristic anyway).\r\nBut I don't yet see this PR as close to being final yet - do you? I still want to review it thoroughly, I don't think we should ossify yet :)",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3403611574",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 20300777456,
      "node_id": "LE_lADOABII586bT0I_zwAAAAS6BUfw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20300777456",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-15T16:40:06Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20307527136,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS6bEXg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307527136",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ace7f2446f4fc8c7d0acc0021e2b3db4720cd790",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ace7f2446f4fc8c7d0acc0021e2b3db4720cd790",
      "created_at": "2025-10-16T00:31:23Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20307609389,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS6bYct",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307609389",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/64de91105312d36dadb5f71ec01fc6af9b14da69",
      "created_at": "2025-10-16T00:41:47Z"
    },
    {
      "event": "unlabeled",
      "id": 20307845082,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAS6cR_a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307845082",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-16T01:12:58Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3408901200,
      "node_id": "IC_kwDOABII587LL7RQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3408901200",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-16T02:07:26Z",
      "updated_at": "2025-10-16T02:07:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased due to conflicts.\r\nRemoved the first commit. We don't need to modify `EmplaceCoinInternalDANGER`, we can just insert the coins as dirty into the cache. They will be set dirty when they are spent anyways. If a block fails validation inside `ConnectBlock`, then the dirty coins will just rewrite the same value to the db on the next flush or sync.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3408901200",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20367044158,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS9-G4-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20367044158",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7991379d7f5f42003f8168a56d09297ab4625280",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7991379d7f5f42003f8168a56d09297ab4625280",
      "created_at": "2025-10-19T14:41:30Z"
    },
    {
      "event": "commented",
      "id": 3419748327,
      "node_id": "IC_kwDOABII587L1Tfn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3419748327",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-19T15:26:45Z",
      "updated_at": "2025-10-19T15:26:45Z",
      "author_association": "CONTRIBUTOR",
      "body": "Updated to use `std::barrier` for the completion synchronization instead of acquiring a semaphore for each thread, as suggested by @l0rinc .",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3419748327",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20367214353,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAS9-wcR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20367214353",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-19T15:26:46Z"
    },
    {
      "event": "subscribed",
      "id": 20367214366,
      "node_id": "SE_lADOABII586bT0I_zwAAAAS9-wce",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20367214366",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-19T15:26:46Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368713439,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-Eebf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368713439",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "90b3286dd8ee4661fe1cedded466cca934fe95bc",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/90b3286dd8ee4661fe1cedded466cca934fe95bc",
      "created_at": "2025-10-19T22:18:42Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368756565,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-Eo9V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368756565",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "f509cf9a31445af176429b24ccd65aad598d1e71",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/f509cf9a31445af176429b24ccd65aad598d1e71",
      "created_at": "2025-10-19T22:30:54Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368819693,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-E4Xt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368819693",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d63496004d54ae215808a396d800280dba5e4017",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d63496004d54ae215808a396d800280dba5e4017",
      "created_at": "2025-10-19T22:48:15Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368952454,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-FYyG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368952454",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "fc0cb7579abf6a0949e513b2412c2e66a6a0446c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/fc0cb7579abf6a0949e513b2412c2e66a6a0446c",
      "created_at": "2025-10-19T23:21:21Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20369070922,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-F1tK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20369070922",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "created_at": "2025-10-19T23:54:29Z"
    },
    {
      "event": "commented",
      "id": 3427287178,
      "node_id": "IC_kwDOABII587MSECK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3427287178",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T15:32:32Z",
      "updated_at": "2025-10-21T15:32:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "I love the new structure, it's a lot easier to track the progress compared to previous versions. It's also measurably faster than previous versions, we seem to be nearing ~20% - sweeeet! It also pairs well with other `Siphash` related changes that are in the pipeline.\r\n\r\nI have reimplemented most of it locally to make sure I can do a meaningful review, see https://github.com/l0rinc/bitcoin/pull/47 for my attempt. It's not finished, I'm still experimenting with different alternatives to make sure we can make this as simple and useful as possible (e.g. using barriers, filtering and sorting before fetch, adding dedicated `ThreadPool`, splitting reading and writing caches etc.), but wanted to publish my observations so far.\r\n\r\nMy remaining biggest concern is that the threadpool should definitely be untangled from the `InputFetcher` logic (I hate concurrent mutability), it's an independent concern mixed with non-trivial fetcher logic. We also shouldn't parallelize based on CPU in the first place, I don't see why we'd do that. And the `ThreadPool` part still needs independent tests.\r\n\r\nI have tried fetching everything on a single thread and the same with sorted UTXOs and it does seem to be ~6% faster on an SSD (I'd expected even bigger difference on HDD, still measuring that) - but I don't have a final solution that's faster than everything else (since I could only solve it by single-threaded filtering which is slow).\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```\r\nb6ccd542fd single-threaded NO sort\r\nc50a6bd981 single-threaded + sorted fetch\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 100 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n \r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b6ccd542fdc371d3ecd90164169e3d5d7c60e82d)\r\n  Time (abs â‰¡):        11322.014 s               [User: 20431.572 s, System: 1375.995 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = c50a6bd9815ebb2e0d86d5e6b679da5ac021b796)\r\n  Time (abs â‰¡):        10646.049 s               [User: 19231.516 s, System: 1268.395 s]\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3427287178",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3427748120,
      "node_id": "IC_kwDOABII587MT0kY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3427748120",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T16:55:19Z",
      "updated_at": "2025-10-21T16:58:11Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thank you for your review @l0rinc!\r\n\r\n> I love the new structure, it's a lot easier to track the progress compared to previous versions. It's also measurably faster than previous versions, we seem to be nearing ~20% - sweeeet!\r\n\r\n:rocket:\r\n\r\n> we can make this as simple and useful as possible\r\n\r\nWhat else do you have in mind for this being useful? It has a very focused purpose in my view. I would love to make it as simple as possible.\r\n\r\n> using barriers\r\n\r\nDone :)\r\n\r\n> filtering and sorting before fetch\r\n\r\nCan you expand on why we would want this? Prefiltering on the main thread was always slower than filtering in parallel when I was testing this idea.\r\n\r\n> adding dedicated ThreadPool\r\n\r\nYes, see https://github.com/bitcoin/bitcoin/pull/26966. Hopefully we can pull that out and it can be used here. See https://github.com/andrewtoth/bitcoin/tree/test-thread-pool.\r\n\r\n> splitting reading and writing caches\r\n\r\nI'm not sure what you mean by this? There is only one cache, and we read from it concurrently, then write to it on a single thread. Can you expand on how we can split the cache into two? Also, why would we want separate caches?\r\n\r\n> My remaining biggest concern is that the threadpool should definitely be untangled from the InputFetcher logic\r\n\r\nIs this not accomplished by `ThreadLoop`, `Work` and `OnCompletion` functions? The `Work` function has no thread pool logic at all, it is completely independent and can be run by one thread or many. Do you have any concrete suggestions, or specific codepaths that are tangled that are concerning?\r\n\r\n> I hate concurrent mutability\r\n\r\nI'm not sure I understand this. There is no concurrent mutability in my implementation. That would be undefined behavior. Can you point out the data members that are being concurrently mutated and how? Perhaps we have different definitions of concurrent mutability.\r\n\r\n> We also shouldn't parallelize based on CPU in the first place, I don't see why we'd do that.\r\n\r\nThis is following the logic of the check queue. Ideally we could reuse both threads in the same threadpool in the future. Do you have any concrete recommendations on how we many threads we should run? Using the number of threads per CPU is yielding a 20% speed boost, so it seems like a sane enough choice.\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3427748120",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20410121940,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATAib7U",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20410121940",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T16:55:20Z"
    },
    {
      "event": "subscribed",
      "id": 20410121981,
      "node_id": "SE_lADOABII586bT0I_zwAAAATAib79",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20410121981",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T16:55:20Z"
    },
    {
      "event": "commented",
      "id": 3444285774,
      "node_id": "IC_kwDOABII587NS6FO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3444285774",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-24T18:02:04Z",
      "updated_at": "2025-10-24T19:15:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "Let me summarize our offline discussions:\r\n\r\n### Cache hierarchy\r\n\r\nDuring block connection we're adding an extra temporary in-memory dbcache layer on top so that whatever happens during block connection doesn't end up polluting the big dbcache or leveldb.\r\nI think we should take advantage of this and use the temporary top layer to collect the missing inputs there:\r\n* if block validation fails we can just throw it out\r\n* it's easier to test and benchmark, we can rerun the same operation without changing the underlying state\r\n* the missing values will all be fetched from the top layer now, avoiding two-hop lookups\r\n* since the threads aren't reading from the temp cache and aren't writing to the big cache, we can copy the needed inputs from the big in-memory cache contents on the main thread as well to the temporary top layer (without locking) while the other threads are fetching from the DB (since those are IO bound, this being CPU bound). That would create a dedicated dbcache per blocks which we could eventually flush independently.\r\n\r\nThis might need some workarounds, but it does enable new cache invalidation opportunities.\r\n\r\n### Sorted fetch\r\n\r\nSince LevelDB writes (via the `CDBBatch` and `MemTable`) are already sorted and result in a significant speedup compared to inserting the values one-by-one (though likely this isn't just the effect of sorting), I thought it would make sense to experiment with sorted fetches as well.\r\nI have added an extra fetch (similarly to this PR, see https://github.com/l0rinc/bitcoin/commit/b72f67d4a88495a0222cbb9ae825daa6ea38e4df) before calling `ConnectBlock` so that the cache is pre-warmed, but on a single thread. This is the baseline, in the next commit after gathering the missing values I'm sorting them and doing the fetch from the db one-by-one, but in a sorted order.\r\n\r\nThe results indicate that sorted fetching is a lot faster, especially on lower-end devices (i7 with HDD and Rpi5 with SSD).\r\n\r\n<details>\r\n<summary>6% faster reindex-chainstate | 919191 blocks | dbcache 450 | rpi5-16-2</summary>\r\n\r\n```\r\nCOMMITS=\"7d27af98c7cf858b5ab5a02e64f89a857cc53172 ccc748b05858a9ebeb375cc1f3e7426698394470 ead8da2b33117807e27a66f814cf11cdf676d194\"; \\\r\nSTOP=919191; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n7d27af98c7 Merge bitcoin/bitcoin#33461: ci: add Valgrind fuzz\r\nccc748b058 coins: prefetch inputs on single thread\r\nead8da2b33 coins: sorted input prefetch\r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)\r\n  Time (abs â‰¡):        42271.083 s               [User: 66842.872 s, System: 8003.776 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)\r\n  Time (abs â‰¡):        40776.988 s               [User: 67394.771 s, System: 7130.144 s]\r\n \r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)\r\n  Time (abs â‰¡):        38435.516 s               [User: 64537.357 s, System: 6716.634 s]\r\n \r\nRelative speed comparison\r\n        1.10          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)\r\n        1.06          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)\r\n```\r\n\r\n</details>\r\n\r\n(interestingly it seems this is even faster than master by a lot, we're not yet sure what's causing that since the fetches are still single-threaded)\r\n\r\nSimilar speedup on HDD:\r\n\r\n<details>\r\n<summary>5% faster reindex-chainstate | 919191 blocks | dbcache 450 | i7-hdd</summary>\r\n\r\n```\r\nSTOP=919191; DBCACHE=450; \\                                                                                                                   \r\nCC=gcc; CXX=g++; \\                                                                                                                                                                  \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                                           \r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\                                                                      \r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cor\r\nes | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || e\r\ncho HDD)\"; echo \"\") &&\\                                                                                                                                                             \r\nhyperfine \\                                  \r\n  --sort command \\                           \r\n  --runs 1 \\                                 \r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\                                                                      \r\n  --parameter-list COMMIT ${COMMITS// /,} \\                                               \r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\                                                  \r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\                                                                  \r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\                                                                        \r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\                                                                                                   \r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\                                                                                \r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"                         \r\n7d27af98c7 Merge bitcoin/bitcoin#33461: ci: add Valgrind fuzz                             \r\nccc748b058 coins: prefetch inputs on single thread                                        \r\nead8da2b33 coins: sorted input prefetch                                                   \r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD                                      \r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)                                        \r\n  Time (abs â‰¡):        42897.195 s               [User: 38613.661 s, System: 3154.561 s]                                                                                            \r\n                                             \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)                                               \r\n  Time (abs â‰¡):        42015.404 s               [User: 40096.242 s, System: 3180.038 s]                                                                                            \r\n                                             \r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)                                               \r\n  Time (abs â‰¡):        40176.361 s               [User: 38614.897 s, System: 3047.461 s]                                                                                            \r\n                                             \r\nRelative speed comparison                    \r\n        1.07          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)                               \r\n        1.05          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)                               \r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)   \r\n```\r\n\r\n</details>\r\n\r\nOn a very powerful i9 with very performant SSD sorting isn't faster than master, but it's still a lot faster than random fetching:\r\n\r\n<details>\r\n<summary>4% faster reindex-chainstate | 919191 blocks | dbcache 450 | i9-ssd</summary>\r\n\r\n```\r\nSTOP=919191; DBCACHE=450; \\                                                                                                      \r\nCC=gcc; CXX=g++; \\                                                                                                                                                     \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                              \r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\                                                         \r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\                                  \r\nhyperfine \\                              \r\n  --sort command \\                       \r\n  --runs 1 \\                             \r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\                                                         \r\n  --parameter-list COMMIT ${COMMITS// /,} \\                                        \r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\                                     \r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\                                                     \r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\                                                           \r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\                                                                                      \r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\                                                                   \r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"            \r\n\r\n7d27af98c7 Merge bitcoin/bitcoin#33461: ci: add Valgrind fuzz                      \r\nccc748b058 coins: prefetch inputs on single thread                                 \r\nead8da2b33 coins: sorted input prefetch                                            \r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD                        \r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)                    \r\n  Time (abs â‰¡):        20383.488 s               [User: 38259.799 s, System: 2702.188 s]                                                                               \r\n                                         \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)                    \r\n  Time (abs â‰¡):        21213.645 s               [User: 39728.945 s, System: 2709.999 s]                                                                               \r\n                                         \r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)                    \r\n  Time (abs â‰¡):        20476.751 s               [User: 38448.254 s, System: 2597.600 s]                                                                               \r\n                                         \r\nRelative speed comparison                \r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)           \r\n        1.04          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)           \r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)  \r\n```\r\n\r\n</details>\r\n\r\nTheoretically this can also be affected by LevelDB's internal `options.block_cache` and `options.block_size` and `iteroptions.fill_cache` (currently experimenting with different values to see if it makes any difference).\r\nThis is why I have [suggested](https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812534028) trying a read-only snapshot per thread, if they're reading sorted values the previous path could theoretically be caches which can help avoid a few lookups.\r\n\r\n### Separate ThreadPool\r\n\r\nI think we should be able to use a single barrier for starting and stopping, assuming that we either want to use all of them or none of them, something like: https://github.com/l0rinc/bitcoin/commit/67e79e041b524eb1b0039ff39d4fc5b235d89b8f#diff-7ad6c5646dfd3749d2634861dfaf98e8c6fbc041a8e8eded973ff39929acffd7 or https://github.com/bitcoin/bitcoin/pull/33689\r\nThis would also help with completely separating the multithreaded part from the `Inputfetcher` which would also allow testing that critical behavior separately.\r\nThis would also help with minimizing the mutable state which could theoretically allow concurrent calls to swap out the work from under the started threads (so likely the `m_task` in my example should be atomic, haven't given it enough thought).\r\n\r\nSince sorted-fetching currently needs a preprocessing step, we could use these available threads for filtering operations as well (since single-threaded filtering is slow, as proven above) - we could filter on all threads for missing, sort the missing on main thread and spread out to all threads for db fetching - leaving the main thread to do other things (since db fetching isn't really CPU bound, no need to involve the main thread), such as the mentioned outer-layer warming from the main in-memory dbcache.\r\nAnd alternative to the \"fetch-missing & sort & get\" on a single thread is to try \"fetch-all & sort & filter & get\" instead which is more parallelizable.\r\nSince everything in the outer-layer will be spent anyway, in the future maybe we could even flush them on a background thread to db (given that we've just copied the items to the temp cache, after successful flush we could just remove them from the main cache) - which would likely simplify the main dbcache's dirty and spent behaviors, but that's outside of the scope of this PR but could provide extra motivation for these changes).",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3444285774",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20513157923,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATGrfMj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513157923",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "13e2d22dfc4fdc63a2e7903b481f82c33b7145df",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/13e2d22dfc4fdc63a2e7903b481f82c33b7145df",
      "created_at": "2025-10-27T00:50:06Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20513600649,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATGtLSJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513600649",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "8aedbc78c2e341ef2b9f0e140245388718c74e33",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8aedbc78c2e341ef2b9f0e140245388718c74e33",
      "created_at": "2025-10-27T01:44:01Z"
    },
    {
      "event": "commented",
      "id": 3449216359,
      "node_id": "IC_kwDOABII587Nlt1n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3449216359",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T01:58:21Z",
      "updated_at": "2025-10-27T02:01:12Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thank you @l0rinc for your detailed review and suggestions! I have taken some of them. The input fetcher has now been redesigned.\r\n- Coins are written to the ephemeral cache that is created just to be used in `ConnectBlock`, instead of the main cache. This requires a new method in `CCoinsViewCache` - `GetPossiblySpentCoinFromCache`. Since we write to an empty cache instead of `CoinsTip()`, we could insert a `Coin` that exists in the db but is spent in `CoinsTip()`. Previously that insertion would fail since we were inserting again into `CoinsTip()` which would not overwrite the spent coin.\r\n- Because of this we can safely write to the ephemeral cache on the main thread, since the worker threads will be reading from a different cache. So the main thread does not do any fetching, but it writes fetched `Coin`s to the cache in parallel as workers fetch them. It is a lock-free MPSC queue. The workers and main thread synchronize on an atomic `Status` member of each input. The workers set it to `READY` while the main thread spins on it until it is no longer `WAITING`. This is a substantial speed improvement over the previous version, and it also lets us insert `Coin`s from the main cache into the ephemeral cache faster. So this change speeds up block connection even when there are no cache misses, and makes the workers utilize more CPU rather than just IO.\r\n- A single barrier is used to synchronize the threads. Both the main and worker threads call `arrive_and_wait` before they begin their work and after completion.\r\n\r\nI removed the last commit, and instead add the `InputFetcher` as multi threaded initially. It didn't make sense to split it since the worker threads and main threads do different things now.\r\n\r\nI haven't been able to effectively utilize a sorting strategy. Sorting the inputs before fetching doesn't seem to have a benefit in the multi threaded approach. The overhead of copying the `COutPoint`s and sorting them was always slower. I think the parallel fetching dominates any speedup achieved by sorted fetching anyways.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3449216359",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20513726785,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATGtqFB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513726785",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T01:58:23Z"
    },
    {
      "event": "subscribed",
      "id": 20513726804,
      "node_id": "SE_lADOABII586bT0I_zwAAAATGtqFU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513726804",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T01:58:23Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20529972733,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATHroX9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20529972733",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5781a445f1d19c9479561bb536ec0f884c4bb950",
      "created_at": "2025-10-27T16:10:15Z"
    },
    {
      "event": "reviewed",
      "id": 3347436866,
      "node_id": "PRR_kwDOABII587HhdVC",
      "url": null,
      "actor": null,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-10-27T21:58:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "Looks like I forgot to push the comments last time - that explains your surprise. I pushed all of them, many are out of date, please just resolve them. Sorry for the confusion.\r\n\r\nSince I'm reposting these old comments (since commented from the main GitHub view), lemme' post a recently finished Rpi4 benchmark showing a 31% speedup for an older push \\\\:D/\r\n\r\n<details>\r\n<summary>31% faster reindex-chainstate | 919191 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"063946d6bd78035276d12e070a208d84492ac5cd 64de91105312d36dadb5f71ec01fc6af9b14da69\"; \\\r\nSTOP=919191; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n063946d6bd coins: add inputfetcher\r\n64de911053 coins: fetch coins on parallel threads\r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 063946d6bd78035276d12e070a208d84492ac5cd)\r\n  Time (abs â‰¡):        329713.086 s               [User: 172834.637 s, System: 87207.916 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 64de91105312d36dadb5f71ec01fc6af9b14da69)\r\n  Time (abs â‰¡):        251976.600 s               [User: 177923.005 s, System: 116804.580 s]\r\n \r\nRelative speed comparison\r\n        1.31          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 063946d6bd78035276d12e070a208d84492ac5cd)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 64de91105312d36dadb5f71ec01fc6af9b14da69)\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3347436866",
      "submitted_at": "2025-10-27T21:48:06Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20554764190,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATJKM-e",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20554764190",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/2aa510348143521a14146e41b5cf87cb3e60b29e",
      "created_at": "2025-10-28T13:58:59Z"
    },
    {
      "event": "commented",
      "id": 3463894000,
      "node_id": "IC_kwDOABII587OdtPw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3463894000",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-29T20:40:40Z",
      "updated_at": "2025-10-29T20:40:40Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'd say it's time to update the PR description:\r\n<details>\r\n<summary>24% faster reindex-chainstate | 921129 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85 2aa510348143521a14146e41b5cf87cb3e60b29e\"; \\\r\nSTOP=921129; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log; \\\r\n              grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\ncb0fdfdf37 coins: add inputfetcher\r\n2aa5103481 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n  Time (abs â‰¡):        40539.887 s               [User: 69358.879 s, System: 7393.185 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n  Time (abs â‰¡):        32768.672 s               [User: 69495.022 s, System: 11880.553 s]\r\n \r\nRelative speed comparison\r\n        1.24          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n```\r\n\r\n</details>\r\n\r\nWith this change we're getting a 9 hours full `reindex-chainstate` on an rpi5 with default 450MB memory. Wow!",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3463894000",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "renamed",
      "id": 20594474601,
      "node_id": "RTE_lADOABII586bT0I_zwAAAATLhr5p",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20594474601",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-29T23:31:25Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads >10% faster IBD",
        "to": "validation: fetch block inputs on parallel threads >20% faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20624176497,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATNS_Vx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20624176497",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1ebf2f02e64ec94a493eb68c01bd874c57b19497",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1ebf2f02e64ec94a493eb68c01bd874c57b19497",
      "created_at": "2025-10-31T03:24:15Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20633380777,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATN2Gep",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20633380777",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "created_at": "2025-10-31T12:40:23Z"
    },
    {
      "event": "commented",
      "id": 3475945645,
      "node_id": "IC_kwDOABII587PLrit",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3475945645",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-01T08:20:29Z",
      "updated_at": "2025-11-04T07:15:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased the latest version of the PR now that https://github.com/bitcoin/bitcoin/pull/31645 was merged and measured a reindex on my M4 laptop: it finished all 3 runs with dbcache 450, 4500 and 45000 overnight.\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```\r\ntime ./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 \\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 \\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 \r\n\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate   8805.12s user 1456.47s system 134% cpu 2:07:22.36 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate    12201.80s user 3698.94s system 197% cpu 2:13:54.50 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate     20676.11s user 10582.81s system 358% cpu 2:25:26.52 total\r\n```\r\n\r\nrepeated the same later to check for stability:\r\n```\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate   8873.87s user 1468.17s system 134% cpu 2:07:47.62 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate    12178.09s user 3621.39s system 197% cpu 2:13:11.48 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate     20725.97s user 10666.85s system 359% cpu 2:25:33.12 total\r\n```\r\n\r\n</details>\r\n\r\n<img width=\"1185\" height=\"580\" alt=\"image\" src=\"https://github.com/user-attachments/assets/a530f7d2-e7e5-4fa4-9ab0-59d0359aa763\" />\r\n\r\nNote: I did get a `bitcoind(70369,0x16f5ff000) malloc: Failed to allocate segment from range group - out of space` warning above, maybe 45 GB memory was a bit too much, but I can continue the block connection after the reindexes, so the measurements are likely representative.\r\nEdit: reran the 45 GB case, it did complete successfully in a similar time without errors.\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\nreindex-chainstate seems correct, it can continue after:\r\n```\r\n./build/bin/bitcoind\r\n2025-11-01T08:16:25Z Bitcoin Core version v30.99.0-45fe0c0e5bed (release build)\r\n...\r\n2025-11-01T08:16:29Z nBestHeight = 921129\r\n...\r\n2025-11-01T08:16:29Z UpdateTip: new best=00000000000000000000a216ce3209897114b757dbac3b651c72484829637c0e height=921130 version=0x343ba000 log2_work=95.904905 tx=1262937761 date='2025-10-28T06:06:11Z' progress=0.998475 cache=0.5MiB(3812txo)\r\n2025-11-01T08:16:29Z UpdateTip: new best=00000000000000000001965d9ff2ef639dd6829da2ad19c3f5d46691475f0df1 height=921131 version=0x25472000 log2_work=95.904918 tx=1262938885 date='2025-10-28T06:13:50Z' progress=0.998477 cache=1.6MiB(9726txo)\r\n```\r\n\r\n</details>\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3475945645",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20654613374,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATPHGN-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20654613374",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/62868c8846f043477d128788eadced3e71522417",
      "created_at": "2025-11-01T21:43:52Z"
    },
    {
      "event": "commented",
      "id": 3476888214,
      "node_id": "IC_kwDOABII587PPRqW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3476888214",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-01T21:47:49Z",
      "updated_at": "2025-11-01T21:47:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased to test behavior with #31645.\r\nSome other touch-ups include:\r\n- Use `const COutPoint&` in `Input` struct instead of `vin` and `vtx` indexes\r\n- Cleanup shared vectors and pointers at the end of loop\r\n- Refactor inner work loop to do fewer existence checks at the expense of some duplicated code\r\n- Use `std::atomic_usize_t` instead of `std::atomic<usize_t>`\r\n- Use `GetPossiblySpentCoinFromCache` in tests and fuzz harness for better clarity and correctness",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3476888214",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 3389779624,
      "node_id": "PRR_kwDOABII587KC-6o",
      "url": null,
      "actor": null,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-02T20:32:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "I like how we're progressing here! I think we need a few more things and have to try out a few alternatives (I haven't given up on sorting yet, especially now with bigger dbcache) and want to see how this combines with the other optimizations (threadpool, SipHash13, map hash caching, etc), but I'm definitely getting closer and closer to an ACK :D\r\n\r\nI'm testing full IBD locally on my servers, but those are always slower than `reindex-chainstes` since the nodes can't send the blocks fast enough - I don't yet have a seeding node yet, but working on it.\r\n\r\n\"It simply inserts inputs into the temporary cache, which must be fetched before a transaction is validated anyways.\" beautiful, I think some of this should be added to the commit messages as well.\r\ncommit message nit: \"coins: add InputFetcher\" (commit message content and formatting is a bit sloppy)\r\n\r\nI'd merge `fuzz: add inputfetcher fuzz harness` and `tests: add inputfetcher tests` and `coins: add inputfetcher` since the clients are needed for the review of `InputFetcher`, otherwise it's just dead code added...\r\n\r\n\r\n<details>\r\n<summary>local patch I had during review - they're not necessarily suggestions, just changes I did locally</summary>\r\n\r\n```patch\r\ndiff --git a/src/bench/CMakeLists.txt b/src/bench/CMakeLists.txt\r\nindex 9d03f075a7..dcb6281699 100644\r\n--- a/src/bench/CMakeLists.txt\r\n+++ b/src/bench/CMakeLists.txt\r\n@@ -52,6 +52,7 @@ add_executable(bench_bitcoin\r\n   streams_findbyte.cpp\r\n   strencodings.cpp\r\n   txgraph.cpp\r\n+  txid_membership.cpp\r\n   txorphanage.cpp\r\n   util_time.cpp\r\n   verify_script.cpp\r\ndiff --git a/src/bench/inputfetcher.cpp b/src/bench/inputfetcher.cpp\r\nindex c10fcc5b5e..c1660c3ccf 100644\r\n--- a/src/bench/inputfetcher.cpp\r\n+++ b/src/bench/inputfetcher.cpp\r\n@@ -12,20 +12,18 @@\r\n #include <streams.h>\r\n #include <util/time.h>\r\n \r\n-static constexpr auto DELAY{2ms};\r\n-\r\n //! Simulates a DB by adding a delay when calling GetCoin\r\n struct DelayedCoinsView : CCoinsView\r\n {\r\n     std::optional<Coin> GetCoin(const COutPoint&) const override\r\n     {\r\n-        UninterruptibleSleep(DELAY);\r\n+        UninterruptibleSleep(2ms);\r\n         Coin coin{};\r\n         coin.out.nValue = 1;\r\n         return coin;\r\n     }\r\n \r\n-    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\r\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { throw std::logic_error{\"unused\"}; }\r\n };\r\n \r\n static void InputFetcherBenchmark(benchmark::Bench& bench)\r\n@@ -39,11 +37,13 @@ static void InputFetcherBenchmark(benchmark::Bench& bench)\r\n     // The main thread should be counted to prevent thread oversubscription, and\r\n     // to decrease the variance of benchmark results.\r\n     const auto worker_threads_num{GetNumCores() - 1};\r\n-    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};\r\n+    InputFetcher fetcher{worker_threads_num};\r\n \r\n     bench.run([&] {\r\n         CCoinsViewCache temp_cache(&main_cache);\r\n         fetcher.FetchInputs(temp_cache, main_cache, db, block);\r\n+        ankerl::nanobench::doNotOptimizeAway(&temp_cache);\r\n+        Assert(temp_cache.GetCacheSize() == 4599);\r\n     });\r\n }\r\n \r\ndiff --git a/src/bench/txid_membership.cpp b/src/bench/txid_membership.cpp\r\nnew file mode 100644\r\nindex 0000000000..e646bb2a4a\r\n--- /dev/null\r\n+++ b/src/bench/txid_membership.cpp\r\n@@ -0,0 +1,134 @@\r\n+// Copyright (c) 2022-present The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <bench/bench.h>\r\n+#include <bench/nanobench.h>\r\n+#include <primitives/transaction_identifier.h>\r\n+#include <random.h>\r\n+#include <util/check.h>\r\n+#include <util/hasher.h>\r\n+\r\n+#include <algorithm>\r\n+#include <ranges>\r\n+#include <set>\r\n+#include <unordered_set>\r\n+#include <vector>\r\n+\r\n+namespace {\r\n+\r\n+constexpr size_t iterations{100}; // since the inputs of the benchmarks are mutated by sorting, we can't rerun the benchmarks\r\n+constexpr size_t hits_count{275}; // assuming ~5% of blocks contain internal spends\r\n+constexpr size_t tx_count{5500};\r\n+\r\n+struct Dataset {\r\n+    std::set<Txid> sorted_set;\r\n+    std::unordered_set<Txid, SaltedTxidHasher> unsorted_set;\r\n+    std::vector<Txid> vec_sorted;\r\n+    std::vector<Txid> vec_unsorted;\r\n+\r\n+    std::vector<Txid> queries;\r\n+};\r\n+\r\n+std::vector<Dataset> BuildDatasets()\r\n+{\r\n+    FastRandomContext rng(/*fDeterministic=*/true);\r\n+\r\n+    std::vector<Dataset> datasets;\r\n+    datasets.reserve(iterations);\r\n+\r\n+    for (size_t d{0}; d < iterations; ++d) {\r\n+        Dataset ds;\r\n+        ds.queries.reserve(tx_count);\r\n+        ds.unsorted_set.reserve(tx_count);\r\n+        ds.vec_sorted.reserve(tx_count);\r\n+        ds.vec_unsorted.reserve(tx_count);\r\n+\r\n+        for (size_t i{0}; i < tx_count; ++i) {\r\n+            Txid t{Txid::FromUint256(rng.rand256())};\r\n+            ds.sorted_set.emplace(t);\r\n+            ds.unsorted_set.emplace(t);\r\n+            ds.vec_sorted.emplace_back(t);\r\n+            ds.vec_unsorted.emplace_back(t);\r\n+\r\n+            ds.queries.emplace_back(i < hits_count ? t : Txid::FromUint256(rng.rand256()));\r\n+        }\r\n+\r\n+        std::ranges::shuffle(ds.queries, rng);\r\n+        std::ranges::shuffle(ds.vec_unsorted, rng);\r\n+        std::sort(ds.vec_sorted.begin(), ds.vec_sorted.end());\r\n+\r\n+        datasets.emplace_back(std::move(ds));\r\n+    }\r\n+    return datasets;\r\n+}\r\n+\r\n+} // namespace\r\n+\r\n+static void Txid_UnorderedSalted(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += s.unsorted_set.contains(q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+static void Txid_SetOrdered(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += s.sorted_set.contains(q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+static void Txid_VectorBinarySearch(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += std::binary_search(s.vec_sorted.begin(), s.vec_sorted.end(), q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+static void Txid_VectorLinearScan(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    const auto contains_linear{[](const std::vector<Txid>& v, const Txid& x) noexcept {\r\n+        return std::ranges::find(v, x) != v.end();\r\n+    }};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += contains_linear(s.vec_unsorted, q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+BENCHMARK(Txid_UnorderedSalted, benchmark::PriorityLevel::LOW);\r\n+BENCHMARK(Txid_SetOrdered, benchmark::PriorityLevel::LOW);\r\n+BENCHMARK(Txid_VectorBinarySearch, benchmark::PriorityLevel::LOW);\r\n+BENCHMARK(Txid_VectorLinearScan, benchmark::PriorityLevel::LOW);\r\ndiff --git a/src/coins.h b/src/coins.h\r\nindex 1b3dcfc309..95c3bfe2f5 100644\r\n--- a/src/coins.h\r\n+++ b/src/coins.h\r\n@@ -486,7 +486,8 @@ public:\r\n      * Reserve enough space in the cache so the underlying unordered_map will\r\n      * not have to rehash unless capacity is exceeded.\r\n      */\r\n-    void Reserve(size_t capacity) {\r\n+    void Reserve(size_t capacity)\r\n+    {\r\n         cacheCoins.reserve(capacity);\r\n     }\r\n \r\ndiff --git a/src/inputfetcher.h b/src/inputfetcher.h\r\nindex cd9eaed6ea..d15c4874cc 100644\r\n--- a/src/inputfetcher.h\r\n+++ b/src/inputfetcher.h\r\n@@ -17,6 +17,7 @@\r\n #include <atomic>\r\n #include <barrier>\r\n #include <cstdint>\r\n+#include <set>\r\n #include <stdexcept>\r\n #include <thread>\r\n #include <unordered_set>\r\n@@ -38,9 +39,8 @@\r\n  */\r\n class InputFetcher\r\n {\r\n-private:\r\n     //! The latest input being fetched. Workers atomically increment this when fetching.\r\n-    alignas(64) std::atomic_size_t m_input_head{0};\r\n+    alignas(64) std::atomic_int32_t m_input_head{0};\r\n \r\n     //! The inputs of the block which is being fetched.\r\n     struct Input {\r\n@@ -59,7 +59,7 @@ private:\r\n         Coin coin{};\r\n \r\n         Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\r\n-        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n     };\r\n     std::vector<Input> m_inputs{};\r\n \r\n@@ -68,7 +68,7 @@ private:\r\n      * Used to filter out inputs that are created and spent in the same block,\r\n      * since they will not be in the db or the cache.\r\n      */\r\n-    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\r\n+    std::set<Txid> m_txids{};\r\n \r\n     //! DB coins view to fetch from.\r\n     const CCoinsView* m_db{nullptr};\r\n@@ -77,18 +77,15 @@ private:\r\n \r\n     std::vector<std::thread> m_worker_threads{};\r\n     std::barrier<> m_barrier;\r\n-    bool m_request_stop{false};\r\n \r\n     void WorkLoop() noexcept\r\n     {\r\n         while (true) {\r\n             m_barrier.arrive_and_wait();\r\n-            if (m_request_stop) [[unlikely]] {\r\n-                return;\r\n-            }\r\n+            if (m_input_head.load(std::memory_order_relaxed) < 0) [[unlikely]] return;\r\n             while (true) {\r\n-                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\r\n-                if (i >= m_inputs.size()) [[unlikely]] {\r\n+                const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\r\n+                if (i >= int32_t(m_inputs.size())) [[unlikely]] {\r\n                     break;\r\n                 }\r\n                 auto& input{m_inputs[i]};\r\n@@ -125,11 +122,10 @@ private:\r\n     }\r\n \r\n public:\r\n-    explicit InputFetcher(size_t worker_thread_count) noexcept\r\n-        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\r\n+    explicit InputFetcher(int32_t worker_thread_count) noexcept : m_barrier{(worker_thread_count + 1)}\r\n     {\r\n-        for (size_t n{0}; n < worker_thread_count; ++n) {\r\n-            m_worker_threads.emplace_back([this, n]() {\r\n+        for (int32_t n{0}; n < worker_thread_count; ++n) {\r\n+            m_worker_threads.emplace_back([this, n] {\r\n                 util::ThreadRename(strprintf(\"inputfetch.%i\", n));\r\n                 WorkLoop();\r\n             });\r\n@@ -145,6 +141,8 @@ public:\r\n \r\n         // Loop through the inputs of the block and set them in the queue.\r\n         // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\r\n+        //m_txids.reserve(block.vtx.size());\r\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\r\n         auto outputs_count{block.vtx[0]->vout.size()};\r\n         for (size_t i{1}; i < block.vtx.size(); ++i) {\r\n             const auto& tx{block.vtx[i]};\r\n@@ -162,7 +160,7 @@ public:\r\n         m_barrier.arrive_and_wait();\r\n \r\n         // Insert fetched coins into the temp_cache as they are set to READY.\r\n-        temp_cache.Reserve(m_inputs.size() + outputs_count);\r\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\r\n         for (auto& input : m_inputs) {\r\n             auto status{input.status.load(std::memory_order_acquire)};\r\n             while (status == Input::Status::WAITING) {\r\n@@ -175,6 +173,7 @@ public:\r\n                 break;\r\n             }\r\n         }\r\n+        Assert(temp_cache.GetCacheSize() <= temp_cache.GetCacheSize() + m_inputs.size() + outputs_count); // TODO remove\r\n \r\n         m_barrier.arrive_and_wait();\r\n         // Cleanup after all worker threads have exited the inner loop.\r\n@@ -186,11 +185,9 @@ public:\r\n \r\n     ~InputFetcher()\r\n     {\r\n-        m_request_stop = true;\r\n-        m_barrier.arrive_and_wait();\r\n-        for (auto& t : m_worker_threads) {\r\n-            t.join();\r\n-        }\r\n+        m_input_head.store(-1, std::memory_order_relaxed);\r\n+        m_barrier.arrive_and_drop();\r\n+        for (auto& t : m_worker_threads) t.join();\r\n     }\r\n };\r\n \r\ndiff --git a/src/test/inputfetcher_tests.cpp b/src/test/inputfetcher_tests.cpp\r\nindex b92a15d291..3d085bc843 100644\r\n--- a/src/test/inputfetcher_tests.cpp\r\n+++ b/src/test/inputfetcher_tests.cpp\r\n@@ -14,10 +14,8 @@\r\n \r\n #include <boost/test/unit_test.hpp>\r\n \r\n-#include <cstdint>\r\n #include <memory>\r\n #include <stdexcept>\r\n-#include <string>\r\n #include <unordered_set>\r\n \r\n BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\r\n@@ -82,7 +80,7 @@ BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\r\n         }\r\n \r\n         CCoinsViewCache main_cache(&db);\r\n-        CCoinsViewCache cache(&cache);\r\n+        CCoinsViewCache cache(&main_cache);\r\n         getFetcher().FetchInputs(cache, main_cache, db, block);\r\n \r\n         std::unordered_set<Txid, SaltedTxidHasher> txids{};\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 7564b97a07..07ab71852f 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -6299,7 +6299,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\r\n \r\n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\r\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\r\n-      m_input_fetcher{std::clamp<size_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\r\n+      m_input_fetcher{std::clamp<int32_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\r\n       m_interrupt{interrupt},\r\n       m_options{Flatten(std::move(options))},\r\n       m_blockman{interrupt, std::move(blockman_options)},\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3389779624",
      "submitted_at": "2025-11-02T20:31:48Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20663257933,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATPoEtN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20663257933",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "created_at": "2025-11-02T23:31:49Z"
    },
    {
      "event": "commented",
      "id": 3479640421,
      "node_id": "IC_kwDOABII587PZxll",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3479640421",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-03T09:34:31Z",
      "updated_at": "2025-11-03T09:34:31Z",
      "author_association": "CONTRIBUTOR",
      "body": "I have the IBD numbers for the i7-hdd and i9-ssd server. They're not as glorious as our `reindex-chainstate` measurements, most likely since I don't yet have a way to test IBD from extremely fast peers. But as a sanity-check I think it's fine, we're still bandwidth bound - which is a good problem to have.\r\n\r\n<details>\r\n<summary>7% faster IBD | 921129 blocks | dbcache 4500 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n```\r\nCOMMITS=\"bf07cf0adf19889727cb6bea24ebfbbfcc231a0c 45fe0c0e5beddce1c9e836ab5d97aa064069c192\"; \\                        \r\nSTOP=921129; DBCACHE=4500; \\                                                                                                                                \r\nCC=gcc; CXX=g++; \\                                                                                                                                          \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                   (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\                                              \r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\nbf07cf0adf coins: add inputfetcher\r\n45fe0c0e5b validation: fetch block inputs via InputFetcher before connecting\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)      \r\n  Time (mean Â± Ïƒ):     36470.995 s Â± 113.187 s    [User: 38024.880 s, System: 2035.545 s]\r\n  Range (min â€¦ max):   36390.960 s â€¦ 36551.030 s    2 runs\r\n  \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)                                                                         \r\n  Time (mean Â± Ïƒ):     33962.782 s Â± 375.163 s    [User: 41686.176 s, System: 2832.686 s]\r\n  Range (min â€¦ max):   33697.502 s â€¦ 34228.062 s    2 runs\r\n  \r\nRelative speed comparison\r\n        1.07 Â±  0.01  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n```\r\n\r\n</details>\r\n\r\nand\r\n\r\n<details>\r\n<summary>12% faster IBD | 921129 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n</summary>\r\n\r\n```\r\nCOMMITS=\"aeec2e421d2ba102d905633d474f0fb88f91a9bf 62868c8846f043477d128788eadced3e71522417\"; \\\r\nSTOP=921129; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\naeec2e421d coins: add inputfetcher\r\n62868c8846 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = aeec2e421d2ba102d905633d474f0fb88f91a9bf)\r\n  Time (mean Â± Ïƒ):     30907.958 s Â± 1761.510 s    [User: 51503.334 s, System: 3833.881 s]\r\n  Range (min â€¦ max):   29662.383 s â€¦ 32153.534 s    2 runs\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 62868c8846f043477d128788eadced3e71522417)\r\n  Time (mean Â± Ïƒ):     27504.900 s Â± 2529.652 s    [User: 59336.996 s, System: 5796.247 s]\r\n  Range (min â€¦ max):   25716.165 s â€¦ 29293.634 s    2 runs\r\n \r\nRelative speed comparison\r\n        1.12 Â±  0.12  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = aeec2e421d2ba102d905633d474f0fb88f91a9bf)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 62868c8846f043477d128788eadced3e71522417)\r\n```\r\n\r\n</details>\r\n\r\nand\r\n\r\n<details>\r\n<summary>9% faster IBD | 921129 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"2aa510348143521a14146e41b5cf87cb3e60b29e cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85\"; \\\r\nSTOP=921129; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\n2aa5103481 validation: fetch block inputs via InputFetcher before connecting\r\ncb0fdfdf37 coins: add inputfetcher\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n  Time (mean Â± Ïƒ):     61239.351 s Â± 4942.104 s    [User: 90457.852 s, System: 16836.057 s]\r\n  Range (min â€¦ max):   57744.756 s â€¦ 64733.946 s    2 runs\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n  Time (mean Â± Ïƒ):     66848.997 s Â± 1122.176 s    [User: 88025.800 s, System: 11057.384 s]\r\n  Range (min â€¦ max):   66055.499 s â€¦ 67642.496 s    2 runs\r\n  \r\nRelative speed comparison\r\n        1.09 Â±  0.09  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n```\r\n\r\n</details>\r\n\r\n\r\n-----\r\n\r\n\r\nThe reindex-chainstate cases (which we can look at as a more stable way of testing offline-IBD) show very good results even for the max-memory usecase (45 GB dbcache) - and confirm @andrewtoth's claim that we may be able to deprecate the `-dbcache` argument after this since it has barely any effect after this change!\r\n\r\n<details>\r\n<summary>3% faster reindex-chainstate | 921129 blocks | dbcache 45000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"bf07cf0adf19889727cb6bea24ebfbbfcc231a0c 45fe0c0e5beddce1c9e836ab5d97aa064069c192\"; \\\r\nSTOP=921129; DBCACHE=45000; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\nbf07cf0adf coins: add inputfetcher\r\n45fe0c0e5b validation: fetch block inputs via InputFetcher before connecting\r\n \r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n  Time (abs â‰¡):        16044.026 s               [User: 23421.874 s, System: 695.027 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n  Time (abs â‰¡):        15643.115 s               [User: 26237.588 s, System: 984.588 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n        1.03          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n```\r\n\r\n</details>\r\n\r\nthe same measurement with default memory is basically exactly the same speed as with max memory (450 MB -> 15818 seconds vs 45 GB -> 15643 seconds)\r\n\r\n<details>\r\n<summary>30% faster reindex-chainstate | 921129 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"bf07cf0adf19889727cb6bea24ebfbbfcc231a0c 45fe0c0e5beddce1c9e836ab5d97aa064069c192\"; STOP=921129; DBCACHE=450; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\nbf07cf0adf coins: add inputfetcher\r\n45fe0c0e5b validation: fetch block inputs via InputFetcher before connecting\r\n \r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n  Time (abs â‰¡):        20500.654 s               [User: 40766.355 s, System: 2845.314 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n  Time (abs â‰¡):        15818.604 s               [User: 45952.420 s, System: 4127.137 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n        1.30          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n```\r\n\r\n</details>\r\n\r\n\r\n<details>\r\n<summary>17% faster reindex-chainstate | 921129 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n```\r\nCOMMITS=\"cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85 2aa510348143521a14146e41b5cf87cb3e60b29e\"; STOP=921129; DBCACHE=450;\r\n CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origi\r\nn $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(unam\r\ne -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log; \\\r\n              grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\ncb0fdfdf37 coins: add inputfetcher                                            \r\n2aa5103481 validation: fetch block inputs via InputFetcher before connecting                                                                                \r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n  Time (abs â‰¡):        43407.876 s               [User: 40230.765 s, System: 3077.358 s]\r\n                                                                              \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)                       \r\n  Time (abs â‰¡):        37189.669 s               [User: 45706.002 s, System: 4452.708 s]\r\n  \r\nRelative speed comparison\r\n        1.17          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n```\r\n\r\n</details>\r\n\r\n<img width=\"1503\" height=\"869\" alt=\"image\" src=\"https://github.com/user-attachments/assets/2a3fa7c0-6d5e-4afb-a346-99aa733ac9e8\" />\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3479640421",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20670066006,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATQCC1W",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20670066006",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-03T09:34:33Z"
    },
    {
      "event": "subscribed",
      "id": 20670066069,
      "node_id": "SE_lADOABII586bT0I_zwAAAATQCC2V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20670066069",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-03T09:34:33Z"
    },
    {
      "event": "reviewed",
      "id": 3410536334,
      "node_id": "PRR_kwDOABII587LSKeO",
      "url": null,
      "actor": null,
      "commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-03T11:19:25Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3410536334",
      "submitted_at": "2025-11-03T11:19:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20713012354,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATSl3yC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20713012354",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "48da1e349f488220cfea299018969522b1f7a283",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/48da1e349f488220cfea299018969522b1f7a283",
      "created_at": "2025-11-04T20:59:31Z"
    },
    {
      "event": "labeled",
      "id": 20713609901,
      "node_id": "LE_lADOABII586bT0I_zwAAAATSoJqt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20713609901",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-04T21:42:53Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20713870398,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATSpJQ-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20713870398",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c055a95b8085bc871802e76cb6b03f5745572218",
      "created_at": "2025-11-04T22:03:19Z"
    },
    {
      "event": "unlabeled",
      "id": 20714725818,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATSsaG6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20714725818",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-04T23:11:53Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3488760623,
      "node_id": "IC_kwDOABII587P8kMv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3488760623",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-05T01:46:32Z",
      "updated_at": "2025-11-05T01:46:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "Benchmarked the latest up to block 921129 and it's 16% faster :rocket:. Not as fast as some of @l0rinc's numbers but it's on a laptop with an internal NVMe SSD. This change will see the most benefit for disk IO with higher latency, like network connected storage.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo d606c36a13ca2a055d1a4eb4c623fb6aa45405b2 && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=921129` | 18498.670 Â± 16.716 | 18486.850 | 18510.490 | 1.00 |\r\n| `echo 25c45bb0d0bd6618ec9296a1a43605657124e5de && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=921129` | 21537.077 Â± 123.626 | 21449.660 | 21624.494 | 1.16 Â± 0.01 |\r\n\r\nAlso refactored to not stop early if an input is missing. This let's us simplify the logic. We can get rid of the different status flags and just synchronize each input on an atomic bool.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3488760623",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20716636141,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATSzsft",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20716636141",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-05T01:46:33Z"
    },
    {
      "event": "subscribed",
      "id": 20716636156,
      "node_id": "SE_lADOABII586bT0I_zwAAAATSzsf8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20716636156",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-05T01:46:33Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20717270118,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATS2HRm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20717270118",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9ea30540974900de38d5485d133adaeb6123e803",
      "created_at": "2025-11-05T02:27:26Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20761636450,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATVfW5i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20761636450",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "created_at": "2025-11-06T14:33:23Z"
    },
    {
      "event": "labeled",
      "id": 20763087729,
      "node_id": "LE_lADOABII586bT0I_zwAAAATVk5Nx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20763087729",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-06T15:25:38Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3497802844,
      "node_id": "IC_kwDOABII587QfDxc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3497802844",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-06T15:25:48Z",
      "updated_at": "2025-11-06T15:25:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/actions/runs/19139133943/job/54698986986</sub>\n<sub>LLM reason (âœ¨ experimental): Trailing whitespace detected in src/inputfetcher.h caused the lint check to fail.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3497802844",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 3428778459,
      "node_id": "PRR_kwDOABII587MXwHb",
      "url": null,
      "actor": null,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-06T15:35:31Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3428778459",
      "submitted_at": "2025-11-06T15:35:31Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 3429394484,
      "node_id": "PRR_kwDOABII587MaGg0",
      "url": null,
      "actor": null,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-06T17:00:11Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3429394484",
      "submitted_at": "2025-11-06T17:00:11Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20766387744,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATVxe4g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20766387744",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "created_at": "2025-11-06T17:27:44Z"
    },
    {
      "event": "unlabeled",
      "id": 20767569679,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATV1_cP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20767569679",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-06T18:13:54Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20809638431,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATYWeIf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20809638431",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b4ae702e2cb9d947f190c35be41b46dc2f710552",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b4ae702e2cb9d947f190c35be41b46dc2f710552",
      "created_at": "2025-11-08T20:18:01Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20809991787,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATYX0Zr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20809991787",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "88910d258e5ae8dff8bfe4cc26b0e919678d6f17",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/88910d258e5ae8dff8bfe4cc26b0e919678d6f17",
      "created_at": "2025-11-08T21:07:51Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20892493596,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATdSicc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20892493596",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c2b0239001629a43d50cb8eb00e884423db89b38",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c2b0239001629a43d50cb8eb00e884423db89b38",
      "created_at": "2025-11-12T16:05:46Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDAxMGNmYmJhNTg0NGFmMmQwNmQ1YWZkOTc5YjdjY2VlNjM2Zjc0N2Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/010cfbba5844af2d06d5afd979b7ccee636f747f",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/010cfbba5844af2d06d5afd979b7ccee636f747f",
      "tree": {
        "sha": "bddfe5d01fa5245c531e9a842ab1c9b7f57966de",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bddfe5d01fa5245c531e9a842ab1c9b7f57966de"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree bddfe5d01fa5245c531e9a842ab1c9b7f57966de\nparent dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab\nauthor Andrew Toth <andrewstoth@gmail.com> 1730940717 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1763084393 -0500\n\ncoins: add InputFetcher for parallel input fetching\n\nIntroduce InputFetcher utility class that manages worker threads to\nfetch block inputs in parallel. Uses a lock-free MPSC queue design\nwith atomic counters for work distribution and per-input atomic flags\nfor completion signaling.\n\nThe main thread processes inputs sequentially as they become available,\ninserting fetched coins into the temporary cache. If the main thread\ncatches up to the workers, it assists with fetching to maximize\nparallelism.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\nCo-authored-by: TheCharlatan <seb.kung@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmkWiGkACgkQYAB6/Ik4\nsBgoZw/+NKEf4itASG1Tp61nfYMpxxHnb72XAhT2gRuKlimBXJ0Wjcib2Y0opACJ\n718ZnJZiZSvyw3qYBxPb5scixGupiJiw0BqB4fO/o6zWFVaEHKmpbVSOipzAqJiw\nYIq6GXEtr5NBuDpslhKx/suFmkOSqWx6Jr7pcrfITtYyAInX+c9+Hj6Uh1Zz/kpi\ndzrf3UDFAe8fVycbpkcX2fPCZMZLJO1rkroXLNEcWpA+5Wz+9mBr1KdT76Tsrinx\npayrZ/GrW2zfQc9MIWcegrI+/rZn4/3FsLKknazYHixeq5uloK/y/gjZdjlI0Ez6\nqkCeam17SolVApar2K1m5Ntts/x2JNwqh2Zf0UnFgqRVl/vjgJWmeOiPwVnoVRXh\nGCk8e4OruiTr9uQWGPTog8siVurphkzfxzXQdSqHrzJw93beiFLz3oQfcCt/6FSw\nhHf90Wm9JKXGjWK/wxLCpURpS1UAARWVcu89xL9rTBknpu+VSskoSZH4FK+QjYrh\nPqRJ9jKNQGoY99x6t7iemk0BVrQ2Kcmygs9eKxK6+fQdO9GBn4EsBgM/g1cxRS1E\nvnxuTLawci9NJAKzdUXpetxiS1cscuxlhz5aK+7JGxF6ijEV7fw/FaEcId9g/t1u\nDAH8yRvdMae84q/fB0a2ZKQA3lcGwAGB90ipW+r5OCYBnlvoifg=\n=w4BP\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab",
          "sha": "dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab"
        }
      ],
      "message": "coins: add InputFetcher for parallel input fetching\n\nIntroduce InputFetcher utility class that manages worker threads to\nfetch block inputs in parallel. Uses a lock-free MPSC queue design\nwith atomic counters for work distribution and per-input atomic flags\nfor completion signaling.\n\nThe main thread processes inputs sequentially as they become available,\ninserting fetched coins into the temporary cache. If the main thread\ncatches up to the workers, it assists with fetching to maximize\nparallelism.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\nCo-authored-by: TheCharlatan <seb.kung@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-11-14T01:39:53Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-11-07T00:51:57Z"
      },
      "sha": "010cfbba5844af2d06d5afd979b7ccee636f747f"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk1M2RiZjJlMTI4MTlkNzFmOGQ0NWJlZTRhNzg3OTdiOWI4NDU5OWU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/953dbf2e12819d71f8d45bee4a78797b9b84599e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/953dbf2e12819d71f8d45bee4a78797b9b84599e",
      "tree": {
        "sha": "4ea6e0ea0d97666a8ee7f4771044b4d85a7a9b27",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4ea6e0ea0d97666a8ee7f4771044b4d85a7a9b27"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 4ea6e0ea0d97666a8ee7f4771044b4d85a7a9b27\nparent 010cfbba5844af2d06d5afd979b7ccee636f747f\nauthor Andrew Toth <andrewstoth@gmail.com> 1762126158 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1763084393 -0500\n\nbench: add InputFetcher benchmark\n\nAdd benchmark to measure InputFetcher performance.\nThis helps validate performance improvements and identify potential regressions.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmkWiGkACgkQYAB6/Ik4\nsBgTsxAAhZQ9yTdpggRx6ONNZHNCxvuVPLu9CUugK9svPLUHIqX8eR/oPITV2VXd\nAnnl1yMEtdKiyU+D1G/BAdra1BN54alDBG01muk6MdUkOko2doSYk7OsuJ5fcjCM\no5u86pNyNgap6xxcL0IBPTSUp0WVqyJkvVEGNqxv6dTVhQ4+sj2Koze6pZpKHbYk\ngV3xeDLN24tWXPuahCA4E46MbNlRSy8s/UT8+y41QR/UGlCEgf2MZabPYbzJF7dn\n+6lkEh/DRKhxBXEv74NvICXA4y3O7AbpV9gx1GbaSHO278s2IqrP/R6t0Bt8kusM\nnZvpD+ZyqSo30jPTGAOg7gnxW7c88xdkg8oZAM1x4aXizsA3+p3T5CE/OuLRnWS+\n9rBTwrAPPnExSAQwrYT1RoBka6QpKWEZMUNalNPwNL9Oq00qNX4Or3mj4M9D2Q5p\nC+qJFEh+NWf9kYsvmy4nnRs9ptsbQOgPKh7BcjnQM5vDAxq9V0+/mLO0oDlEYASa\ndrt5yTnhlQUdo9KKwhBZDkdNeMitygJEUVEk8eMOzaJnc9szc0k4bK/6yO7ZcHID\n6mB5XBz9Dg7FMa5ubmQ3cjmvhqex0vNeMUl7WXSuw5XruoJbxSJkJfKTv5JZ/QEX\n4QeS5A52VFVhVRslOuiBNgwkejXSEBj0OfC42TNmcxPUSXGAHqA=\n=8t54\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/010cfbba5844af2d06d5afd979b7ccee636f747f",
          "sha": "010cfbba5844af2d06d5afd979b7ccee636f747f",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/010cfbba5844af2d06d5afd979b7ccee636f747f"
        }
      ],
      "message": "bench: add InputFetcher benchmark\n\nAdd benchmark to measure InputFetcher performance.\nThis helps validate performance improvements and identify potential regressions.",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-11-14T01:39:53Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-11-02T23:29:18Z"
      },
      "sha": "953dbf2e12819d71f8d45bee4a78797b9b84599e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQ2ZmFjODVlZTQ0NjVjY2U4ZTgxZTM2Y2RmZDQ2NjM2ZDM0NzI1ZmE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "tree": {
        "sha": "8d13f4ec82b7d646dff9222f20c026d158665438",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8d13f4ec82b7d646dff9222f20c026d158665438"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 8d13f4ec82b7d646dff9222f20c026d158665438\nparent 953dbf2e12819d71f8d45bee4a78797b9b84599e\nauthor Andrew Toth <andrewstoth@gmail.com> 1762126189 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1763084393 -0500\n\nvalidation: fetch block inputs via InputFetcher before connecting\n\nIntegrate InputFetcher into ConnectBlock flow. Inputs are now fetched\nin parallel before block connection, reducing sequential I/O wait time.\n\nThe InputFetcher uses the -par parameter for thread count, defaulting\nto the number of vcores or 15, whichever is fewer. This matches the\nCCheckQueue configuration, ensuring consistent threading behavior.\n\nInvalid blocks are handled gracefully: the temporary cache is discarded\nwithout flushing, which is an improvement over the previous behavior\nwhere inputs might be inserted into CoinsTip() cache for invalid blocks.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmkWiGkACgkQYAB6/Ik4\nsBhIGw/+Nf7lykVD38hqKC3YxA2nK4l8goEkiBopU3L6o+zsuS/2vi5bMeJqKWk1\nmP7v95n2NJlV4jPbBGmB9FFI1mWQpYtWsCS2c44EOkcAlfBAsISwvbIc4+Y23xGA\n5rE1tHXRy6x/c7dLekZUwoyl9z4L0D/DS48eKspkNqDTtXlK5FaprX4sY8HCdW1q\nDKRoM9scGNKvyC+3iB/0E31Why/gwCMO6APaYQEp+j47KzHHAFaEQ6vm2NRTkpqx\nG4dtVlcWjmDQ4B9Q557+LpkqoSMQq9ZhlaFIUVbjmlmi0GldJUJPruE/CdbRe7hM\n0tiw8vxevKOGHXNS+NB+ATBZftT/UdiUKQG1q8QfDIXEjtLkY4yF/Hg3Voqh/nrP\nZ/9on8uv8bcFlaprrxiQMtANAfpn3iugZld+JVl++Hz4WriYJ7IiLBqS6xhAxyML\n/a7J0Tm/bWBgwC7XpsFA1pfnNxTZlnvC8KWhBUznawWVJZTb7BFUaKv7rXm1McxT\nzCvy05AerBHfvVhYYC6Cz4xYgCsP9f41TqIwmOS9J7Rhb/GOFZftGXxIXbbV0Wkl\nAu84E6QYRQsda1TDC7NdPmIFpNPvVobw5oWIHlGJDdOcGE+4mbKDZ9DmXl2n/zZS\n+BU+WXt/9WwCw5ls2rEFEVmvnsjD4bzVYAPo3mo/hSyezBsUs9A=\n=xfHY\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/953dbf2e12819d71f8d45bee4a78797b9b84599e",
          "sha": "953dbf2e12819d71f8d45bee4a78797b9b84599e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/953dbf2e12819d71f8d45bee4a78797b9b84599e"
        }
      ],
      "message": "validation: fetch block inputs via InputFetcher before connecting\n\nIntegrate InputFetcher into ConnectBlock flow. Inputs are now fetched\nin parallel before block connection, reducing sequential I/O wait time.\n\nThe InputFetcher uses the -par parameter for thread count, defaulting\nto the number of vcores or 15, whichever is fewer. This matches the\nCCheckQueue configuration, ensuring consistent threading behavior.\n\nInvalid blocks are handled gracefully: the temporary cache is discarded\nwithout flushing, which is an improvement over the previous behavior\nwhere inputs might be inserted into CoinsTip() cache for invalid blocks.",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-11-14T01:39:53Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-11-02T23:29:49Z"
      },
      "sha": "d6fac85ee4465cce8e81e36cdfd46636d34725fa"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20931074963,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATfltuT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20931074963",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "created_at": "2025-11-14T01:40:00Z"
    },
    {
      "event": "commented",
      "id": 3532063730,
      "node_id": "IC_kwDOABII587ShwPy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3532063730",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-14T10:29:48Z",
      "updated_at": "2025-11-14T10:29:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "I was still wondering how number of parallel threads affects this, given that it's not a cpu-bound task.\r\n\r\nThe measurements were done on i9, m4 and rpi4. First two have 16 threads, rpi has 4.\r\nThe results still indicate to me that it doesn't make sense to set parallelism based on number of cpus directly. Beyond 4-8 threads the systems didn't really perform any better.\r\n\r\n<img width=\"1489\" height=\"861\" alt=\"image\" src=\"https://github.com/user-attachments/assets/c6065154-0625-4609-928f-867c957ba2e4\" />\r\n\r\nI will continue measuring it on other systems as well, but wanted to share preliminary results since these measurements take a lot of time.\r\n\r\n<details>\r\n<summary>i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD \r\n</summary>\r\n\r\n```\r\ncommit=c2b0239001629a43d50cb8eb00e884423db89b38 && git log -1 --pretty='%h %s' $commit && git checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && for par in 2 4 8 16 32 64; do   time ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par; done\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreal    94m1.512s\r\nuser    169m2.995s\r\nsys     11m59.017s\r\n\r\nreal    86m23.533s\r\nuser    171m32.112s\r\nsys     12m42.929s\r\n\r\nreal    82m58.013s\r\nuser    179m20.981s\r\nsys     14m25.288s\r\n\r\nreal    82m38.540s\r\nuser    197m24.427s\r\nsys     20m31.753s\r\n\r\nreal    82m38.442s\r\nuser    197m16.954s\r\nsys     20m32.770s\r\n\r\nreal    82m46.060s\r\nuser    197m44.609s\r\nsys     20m37.426s\r\n```\r\n</details>\r\n\r\n\r\n<details>\r\n<summary>Macbook Pro M4 Max</summary>\r\n\r\n```\r\ncommit=c2b0239001629a43d50cb8eb00e884423db89b38 && git log -1 --pretty='%h %s' $commit && \\\r\ngit checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && \\\r\nfor par in 2 4 8 16 32 64; do\r\n  time ./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par\r\ndone\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     10711.00s user 1495.61s system 181% cpu 1:51:52.59 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     10601.27s user 1311.29s system 207% cpu 1:35:49.25 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     11362.34s user 2558.23s system 242% cpu 1:35:29.27 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12203.63s user 5783.56s system 299% cpu 1:40:07.62 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12124.30s user 5764.53s system 298% cpu 1:40:01.07 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12276.36s user 5816.05s system 300% cpu 1:40:13.27 total\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>rpi4-8-1</summary>\r\n\r\n```\r\nroot@rpi4-8-1:/mnt/my_storage/bitcoin# for par in 4 8; do \\\r\n    COMMITS=\"c2b0239001629a43d50cb8eb00e884423db89b38\"; \\\r\n    STOP=700000; DBCACHE=450; \\\r\n    CC=gcc; CXX=g++; \\\r\n    BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n    (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n    (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\n    hyperfine \\\r\n      --sort command \\\r\n      --runs 1 \\\r\n      --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n      --parameter-list COMMIT ${COMMITS// /,} \\\r\n      --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n        ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n      --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n                  cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n      \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par\"; \\\r\ndone\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=4 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        36057.895 s               [User: 61089.585 s, System: 12571.590 s]\r\n \r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=8 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        35682.583 s               [User: 61828.582 s, System: 14162.402 s]\r\n```\r\n\r\n</details>\r\n\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3532063730",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3536696051,
      "node_id": "IC_kwDOABII587SzbLz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3536696051",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-15T17:24:42Z",
      "updated_at": "2025-11-15T17:42:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "What about capping worker threads to min of 7 or `-par` value minus 1 if `-par` is set to something greater than 0. If `-par` is 0, set to 7? I think extra threads will help here even on a single core system.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3536696051",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812440117",
      "pull_request_review_id": 2388117544,
      "id": 1812440117,
      "node_id": "PRRC_kwDOABII585sB6Q1",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Q: Is this a leftover a hack for non-owning LevelDB threads, or is this really the best way to name threads in a cross-platform way?",
      "created_at": "2024-10-23T10:26:47Z",
      "updated_at": "2024-10-23T13:27:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812440117",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812440117"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 169,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812531761",
      "pull_request_review_id": 2388117544,
      "id": 1812531761,
      "node_id": "PRRC_kwDOABII585sCQox",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We're mostly creating the buckets randomly here, so each thread will need access to basically all of the keys.\r\nSince we have an idea of how LevelDB works here (i.e. Sorted String Table), we could likely improve cache locality (would likely be most beneficial on HDDs) and minimize lock contention by splitting the reads by sorted transactions instead.",
      "created_at": "2024-10-23T11:29:06Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812531761",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812531761"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812534028",
      "pull_request_review_id": 2388117544,
      "id": 1812534028,
      "node_id": "PRRC_kwDOABII585sCRMM",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm wondering if we really need to (b)lock here or whether we could we create a [read-only snapshot](https://github.com/google/leveldb/blob/main/doc/index.md#snapshots) instead and avoid stalling?",
      "created_at": "2024-10-23T11:30:32Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812534028",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812534028"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812548418",
      "pull_request_review_id": 2388117544,
      "id": 1812548418,
      "node_id": "PRRC_kwDOABII585sCUtC",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 39,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I know it's not trivial request, but can we add a test for this class which fetches everything in parallel and sequentially and assert that the result is equivalent?\r\nAnd preferably also a benchmark, like we have it for https://github.com/bitcoin/bitcoin/blob/master/src/bench/checkqueue.cpp.\r\nI would gladly help here, if needed.",
      "created_at": "2024-10-23T11:39:06Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812548418",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812548418"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 39,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812560601",
      "pull_request_review_id": 2388117544,
      "id": 1812560601,
      "node_id": "PRRC_kwDOABII585sCXrZ",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "For consistency (see: `explicit CCheckQueue(unsigned int batch_size, int worker_threads_num)`) and simplicity (`m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)}`, and to follow modern C++ directions where sizes seem to be preferred as signed values, see: https://github.com/bitcoin/bitcoin/pull/30927#discussion_r1766881296), please consider making these int(s) instead.",
      "created_at": "2024-10-23T11:46:37Z",
      "updated_at": "2024-10-23T12:47:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812560601",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812560601"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812599960",
      "pull_request_review_id": 2388117544,
      "id": 1812599960,
      "node_id": "PRRC_kwDOABII585sChSY",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Unlike the script checks, these fetches aren't CPU bound, there is no reason to provide the number of CPUs as the number of parallels threads.\r\nI don't know if we care about HDD performance here or not, but we can likely find a multiplier that makes this better for both SSD and HDD.\r\n\r\nQuoting from https://pkolaczk.github.io/disk-parallelism:\r\n> It was surprising to me that even 64 threads, which are far more than the number of CPU cores (4 physical, 8 virtual), still improved the performance. I guess that with requests of such a small size to such a fast storage, you need to submit really many of them to keep the SSD busy.\r\n\r\nIf we can provide a benchmark for this usecase we can likely find an optimal multiplier here - I won't nack but this part is very important for me.",
      "created_at": "2024-10-23T12:07:45Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812599960",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812599960"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812604307",
      "pull_request_review_id": 2388117544,
      "id": 1812604307,
      "node_id": "PRRC_kwDOABII585sCiWT",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 188,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Would it be possible to create the batch sizes dynamically?\r\nSince the number of missing values differs for every block (and every dbcache size), it may not make more sense to calculate the optimal split instead of using the random value of 128.\r\nCoroutines might alleviate this problem.",
      "created_at": "2024-10-23T12:10:35Z",
      "updated_at": "2024-10-23T13:37:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812604307",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812604307"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812606720",
      "pull_request_review_id": 2388117544,
      "id": 1812606720,
      "node_id": "PRRC_kwDOABII585sCi8A",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));\n+                    buffer.clear();\n+                    buffer.reserve(m_batch_size);\n+                }\n+            }\n+            txids.insert(tx->GetHash());\n+        }\n+\n+        Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 197,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Do we always have leftovers or will this process the last batch twice (or process an empty one) if the batch happens to be divisible by batch_size?",
      "created_at": "2024-10-23T12:11:58Z",
      "updated_at": "2024-10-23T13:37:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812606720",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812606720"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812659221",
      "pull_request_review_id": 2388117544,
      "id": 1812659221,
      "node_id": "PRRC_kwDOABII585sCvwV",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We're basically mimicking RocksDB's `MultiGet` here - but prewarming the cache instead in separate get requests, since we can't really access LevelDB's internals.\r\n\r\nSince splitting into buckets isn't trivial and since `MultiGet` seems to rely on C++20 [coroutines](https://en.cppreference.com/w/cpp/language/coroutines) (which wasn't available in 2012 when `CCheckQueue` was written), I'm wondering how much simpler this fetching would be if we had lightweight suspendible threads instead: https://rocksdb.org/blog/2022/10/07/asynchronous-io-in-rocksdb.html#multiget",
      "created_at": "2024-10-23T12:35:29Z",
      "updated_at": "2024-10-23T13:37:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812659221",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812659221"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812779405",
      "pull_request_review_id": 2388734949,
      "id": 1812779405,
      "node_id": "PRRC_kwDOABII585sDNGN",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is blocking so we can access the queue of shared outpoints that we need to fetch from. It is not blocking for LevelDB, we access the db once we are out of the critical section.",
      "created_at": "2024-10-23T13:34:07Z",
      "updated_at": "2024-10-23T13:34:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812779405",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812779405"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812781136",
      "pull_request_review_id": 2388740849,
      "id": 1812781136,
      "node_id": "PRRC_kwDOABII585sDNhQ",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 39,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812548418,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, I can add these but I am waiting for some more conceptual support.",
      "created_at": "2024-10-23T13:35:04Z",
      "updated_at": "2024-10-23T13:35:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812781136",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812781136"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 39,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812785573",
      "pull_request_review_id": 2388754731,
      "id": 1812785573,
      "node_id": "PRRC_kwDOABII585sDOml",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));\n+                    buffer.clear();\n+                    buffer.reserve(m_batch_size);\n+                }\n+            }\n+            txids.insert(tx->GetHash());\n+        }\n+\n+        Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 197,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812606720,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It won't process twice, but it could pass in an empty vector, which is ignored if you look at `Add` implementation.",
      "created_at": "2024-10-23T13:37:19Z",
      "updated_at": "2024-10-23T13:37:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812785573",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812785573"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812794214",
      "pull_request_review_id": 2388768186,
      "id": 1812794214,
      "node_id": "PRRC_kwDOABII585sDQtm",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think it would be similar in complexity, we would still need all the locking mechanisms to prevent multithreaded access.\r\n\r\nWhat would really be great is if we had a similar construction to Rust's `std::sync::mpsc`.",
      "created_at": "2024-10-23T13:40:49Z",
      "updated_at": "2024-10-23T13:40:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812794214",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812794214"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812797796",
      "pull_request_review_id": 2388773991,
      "id": 1812797796,
      "node_id": "PRRC_kwDOABII585sDRlk",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 188,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812604307,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure it would warrant the complexity I think this batch size is \"good enough\" for now. In a follow up we could maybe add ways to set this with configs to experiment if there really is more optimal settings.",
      "created_at": "2024-10-23T13:42:02Z",
      "updated_at": "2024-10-23T13:42:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812797796",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812797796"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812800076",
      "pull_request_review_id": 2388778745,
      "id": 1812800076,
      "node_id": "PRRC_kwDOABII585sDSJM",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812599960,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Adding more threads will require more memory, which is one reason to not use many more.\r\n\r\nI did a benchmark using 64 threads on the same 16 vcore machine, and it was slightly slower :/",
      "created_at": "2024-10-23T13:43:08Z",
      "updated_at": "2024-10-23T13:43:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812800076",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812800076"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812807883",
      "pull_request_review_id": 2388792724,
      "id": 1812807883,
      "node_id": "PRRC_kwDOABII585sDUDL",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812531761,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think there is any lock contention here if we are doing multithreaded reading?\r\n\r\nI also think what you're suggesting would add a lot more complexity to this PR, when this is \"good enough\".",
      "created_at": "2024-10-23T13:46:50Z",
      "updated_at": "2024-10-23T13:46:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812807883",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812807883"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812815888",
      "pull_request_review_id": 2388804635,
      "id": 1812815888,
      "node_id": "PRRC_kwDOABII585sDWAQ",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812440117,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Unsure, copied from `CScriptCheck`. If the state of the art of thread naming has advanced since that was written, please let me know!",
      "created_at": "2024-10-23T13:49:23Z",
      "updated_at": "2024-10-23T13:49:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812815888",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812815888"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 169,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812826580",
      "pull_request_review_id": 2388824311,
      "id": 1812826580,
      "node_id": "PRRC_kwDOABII585sDYnU",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812440117,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The C++ standard library does as far as I know have no way of renaming threads at all. `src/util/threadnames.{h,cpp}` is our wrapper around the various platform-dependent ways of doing so on supported systems.",
      "created_at": "2024-10-23T13:54:03Z",
      "updated_at": "2024-10-23T13:54:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812826580",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812826580"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 169,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812838378",
      "pull_request_review_id": 2388842458,
      "id": 1812838378,
      "node_id": "PRRC_kwDOABII585sDbfq",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Can you tell me why we need to prevent multithreaded access exactly? We could collect the values to different vectors, each one accessed only by a single thread and merge them into the cache at the end on a single thread, right?\r\n \r\n How would `mpsc` solve this better? Do you think we need work stealing to make it perfectly parallel? Wouldn't coroutines already achieve the same?",
      "created_at": "2024-10-23T13:58:56Z",
      "updated_at": "2024-10-23T13:58:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812838378",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812838378"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812842053",
      "pull_request_review_id": 2388848761,
      "id": 1812842053,
      "node_id": "PRRC_kwDOABII585sDcZF",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812599960,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "4x may be too much to begin with, but 1.5-2x sounds plausible, I'll help with benchmarking this once my current batches finish.",
      "created_at": "2024-10-23T14:00:53Z",
      "updated_at": "2024-10-23T14:00:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812842053",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812842053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812845859",
      "pull_request_review_id": 2388855957,
      "id": 1812845859,
      "node_id": "PRRC_kwDOABII585sDdUj",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812531761,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This might be as simple as sorting by tx before we create the buckets.",
      "created_at": "2024-10-23T14:02:34Z",
      "updated_at": "2024-10-23T14:02:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812845859",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812845859"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812849403",
      "pull_request_review_id": 2388859978,
      "id": 1812849403,
      "node_id": "PRRC_kwDOABII585sDeL7",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812440117,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thank you, please resolve the comment.",
      "created_at": "2024-10-23T14:03:52Z",
      "updated_at": "2024-10-23T14:03:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812849403",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812849403"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 169,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812852143",
      "pull_request_review_id": 2388864249,
      "id": 1812852143,
      "node_id": "PRRC_kwDOABII585sDe2v",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As mentioned before, why do we need shared outpoints here?",
      "created_at": "2024-10-23T14:04:56Z",
      "updated_at": "2024-10-23T14:04:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812852143",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812852143"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812858116",
      "pull_request_review_id": 2388874771,
      "id": 1812858116,
      "node_id": "PRRC_kwDOABII585sDgUE",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I haven't yet experimented with them, but as far as I understand it, coroutines are just programming paradigm, not magic; they don't do anything of their own, besides making things that were already possible easier to write. In particular, you still need a thread pool or some mechanism for scheduling how to run them,",
      "created_at": "2024-10-23T14:07:08Z",
      "updated_at": "2024-10-23T14:07:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812858116",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812858116"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812862679",
      "pull_request_review_id": 2388882032,
      "id": 1812862679,
      "node_id": "PRRC_kwDOABII585sDhbX",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> We could collect the values to different vectors, each one accessed only by a single thread and merge them into the cache at the end on a single thread\r\n\r\nIf the vectors are thread local, then how can the main thread access them at the end to write them? We also want to be writing throughout while the workers are fetching, not just at the end.\r\n\r\n> How would mpsc solve this better?\r\n\r\nInstead of each worker thread having a local queue of results, which they then append to the global results queue, they could just push each result to the channel individually. The main thread could just pull results off the channel as they arrive, instead of waiting to be awoken by a worker thread that appended all its results to the global queue.\r\n\r\n> work stealing\r\n\r\nThat is a concept for async rust, or `std::async::mpsc`. We can do all this without introducing an async runtime. But, this is getting off topic.",
      "created_at": "2024-10-23T14:09:31Z",
      "updated_at": "2024-10-23T14:09:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812862679",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812862679"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812869347",
      "pull_request_review_id": 2388892235,
      "id": 1812869347,
      "node_id": "PRRC_kwDOABII585sDjDj",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812531761,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "If a benchmark shows that it is better, then great!",
      "created_at": "2024-10-23T14:12:37Z",
      "updated_at": "2024-10-23T14:17:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812869347",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812869347"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812874933",
      "pull_request_review_id": 2388902089,
      "id": 1812874933,
      "node_id": "PRRC_kwDOABII585sDka1",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The main thread adds all outpoints to a global vector, which all workers will fetch their work from.",
      "created_at": "2024-10-23T14:15:35Z",
      "updated_at": "2024-10-23T14:17:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812874933",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812874933"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813017536",
      "pull_request_review_id": 2389159040,
      "id": 1813017536,
      "node_id": "PRRC_kwDOABII585sEHPA",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> coroutines are just programming paradigm, not magic\r\n\r\nThat's also what I was counting on! :D\r\n\r\nIn RocksDB they have [high and low priority work](https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide#parallelism-options) (I assume that's just added to the front or the back of a background work deque) â€“ this could align well with @furszy's suggestion for mixing different kinds of background work units.\r\n\r\nI haven't used the C++ variant of coroutines either, but my thinking was that since they can theoretically yield execution when waiting for IO (and resume later), this would allow threads to focus on other tasks in the meantime. Combined with an appropriate scheduling mechanism (such as a thread pool), we could maximize both CPU and IO usage, if I'm not mistaken.\r\nInstead of each thread handling just one task, it could suspend a coroutine while waiting on IO (e.g., a database fetch) and resume it later, effectively maximizing CPU and IO work without needing to know the exact details of the work.\r\n\r\n> If the vectors are thread local\r\n\r\nThe vector would still be global, but each thread would only access a single bucket (i.e. global vector of vectors, with each thread from the pool writing only to `vector[thread_id]`, which contains a vector of fetched coins).\r\nWhen all the work is finished, we'd iterate over the global vector and merge the results into the cache on a single thread.\r\nAs mentioned, sorting the outpoints before fetching could help improve data locality and reduce lock contention, and the coroutines above would help with work stealing, ensuring that all threads finish roughly at the same time.\r\n\r\nIs there anything prohibiting us from doing something like this to minimize synchronization and lock contention during the fetch phase? I understand some synchronization would still be needed during the merge, but this could help reduce global locks and unnecessary synchronization throughout the process.\r\n",
      "created_at": "2024-10-23T15:15:39Z",
      "updated_at": "2024-10-23T15:18:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1813017536",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813017536"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813041419",
      "pull_request_review_id": 2389202333,
      "id": 1813041419,
      "node_id": "PRRC_kwDOABII585sENEL",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I haven't used the C++ variant of coroutines either, but my thinking was that since they can theoretically yield execution when waiting for IO (and resume later), this would allow threads to focus on other tasks in the meantime.\r\n\r\nThat needs async I/O, and is unrelated to coroutines, as far as I understand it. Coroutines just help with keeping track of what to do when the reads come back inside rocksdb.\r\n\r\nAs long as LevelDB (or whatever database engine we use) internally does not use async I/O, there will be one (waiting) thread per parallel outstanding read request from the database.",
      "created_at": "2024-10-23T15:28:19Z",
      "updated_at": "2024-10-23T15:28:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1813041419",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813041419"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832842632",
      "pull_request_review_id": 2421253359,
      "id": 1832842632,
      "node_id": "PRRC_kwDOABII585tPvWI",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 188,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812604307,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I changed the batch size to be number of workers.",
      "created_at": "2024-11-07T15:05:53Z",
      "updated_at": "2024-11-07T15:05:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832842632",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832842632"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843082",
      "pull_request_review_id": 2421254123,
      "id": 1832843082,
      "node_id": "PRRC_kwDOABII585tPvdK",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812599960,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added a benchmark to experiment with these.",
      "created_at": "2024-11-07T15:06:09Z",
      "updated_at": "2024-11-07T15:06:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832843082",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843082"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843202",
      "pull_request_review_id": 2421254376,
      "id": 1832843202,
      "node_id": "PRRC_kwDOABII585tPvfC",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812560601,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-11-07T15:06:14Z",
      "updated_at": "2024-11-07T15:06:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832843202",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843202"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832844237",
      "pull_request_review_id": 2421256210,
      "id": 1832844237,
      "node_id": "PRRC_kwDOABII585tPvvN",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 39,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812548418,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added tests and benchmark.\r\nThe test has random parameters, one of which would be end up having a single worker thread.",
      "created_at": "2024-11-07T15:06:54Z",
      "updated_at": "2024-11-07T15:06:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832844237",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832844237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 39,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1845238389",
      "pull_request_review_id": 2440804044,
      "id": 1845238389,
      "node_id": "PRRC_kwDOABII585t_Bp1",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 39,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812548418,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Also added fuzz harness",
      "created_at": "2024-11-16T20:59:12Z",
      "updated_at": "2024-11-16T20:59:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1845238389",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1845238389"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 39,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846665944",
      "pull_request_review_id": 2442755733,
      "id": 1846665944,
      "node_id": "PRRC_kwDOABII585uEeLY",
      "diff_hunk": "@@ -0,0 +1,73 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <inputfetcher.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <cstdint>\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 15)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    CCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache cache(&db);\n+\n+    CBlock block;\n+    Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+    const auto txs{fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(1,\n+        std::numeric_limits<uint32_t>::max())};\n+    for (uint32_t i{0}; i < txs; ++i) {",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This will create very long running inputs (e.g. txs = std::numeric_limits<uint32_t>::max()).\r\n\r\n```suggestion\r\n    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), N) {\r\n```\r\n\r\nor\r\n\r\n```suggestion\r\n    LIMITED_WHILE(fuzzed_data_provider.remaining_bytes(), N) {\r\n```",
      "created_at": "2024-11-18T14:16:51Z",
      "updated_at": "2024-11-18T14:22:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1846665944",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846665944"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 30,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846667260",
      "pull_request_review_id": 2442755733,
      "id": 1846667260,
      "node_id": "PRRC_kwDOABII585uEef8",
      "diff_hunk": "@@ -0,0 +1,73 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <inputfetcher.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <cstdint>\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 15)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    CCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache cache(&db);\n+\n+    CBlock block;\n+    Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+    const auto txs{fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(1,\n+        std::numeric_limits<uint32_t>::max())};\n+    for (uint32_t i{0}; i < txs; ++i) {\n+        CMutableTransaction tx;\n+\n+        const auto inputs{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+        for (uint32_t j{0}; j < inputs; ++j) {",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 36,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Same as above, this will create long running inputs and maybe even run out of memory?",
      "created_at": "2024-11-18T14:17:42Z",
      "updated_at": "2024-11-18T14:22:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1846667260",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846667260"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 35,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846954861",
      "pull_request_review_id": 2443219199,
      "id": 1846954861,
      "node_id": "PRRC_kwDOABII585uFktt",
      "diff_hunk": "@@ -0,0 +1,73 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <inputfetcher.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <cstdint>\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 15)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    CCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache cache(&db);\n+\n+    CBlock block;\n+    Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+    const auto txs{fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(1,\n+        std::numeric_limits<uint32_t>::max())};\n+    for (uint32_t i{0}; i < txs; ++i) {",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "in_reply_to_id": 1846665944,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thanks, done!",
      "created_at": "2024-11-18T17:04:07Z",
      "updated_at": "2024-11-18T17:04:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1846954861",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846954861"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 30,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1848485522",
      "pull_request_review_id": 2445676953,
      "id": 1848485522,
      "node_id": "PRRC_kwDOABII585uLaaS",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Should this rather say \"optionally marking the emplaced coin as not dirty\", since the default is always dirty?",
      "created_at": "2024-11-19T14:38:21Z",
      "updated_at": "2024-11-20T18:48:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1848485522",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1848485522"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850828070",
      "pull_request_review_id": 2449452592,
      "id": 1850828070,
      "node_id": "PRRC_kwDOABII585uUWUm",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": 1848485522,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure that's the best though, since we do not mark a coin as not dirty. That is the default state.\r\n\r\nWhat about\r\n\"marking the coin as dirty unless `set_dirty` is set to false\"?",
      "created_at": "2024-11-20T18:53:20Z",
      "updated_at": "2024-11-20T18:53:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1850828070",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850828070"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850853460",
      "pull_request_review_id": 2449493581,
      "id": 1850853460,
      "node_id": "PRRC_kwDOABII585uUchU",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": 1848485522,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "That sounds good to me :+1: ",
      "created_at": "2024-11-20T19:15:26Z",
      "updated_at": "2024-11-20T19:15:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1850853460",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850853460"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1851032146",
      "pull_request_review_id": 2449778426,
      "id": 1851032146,
      "node_id": "PRRC_kwDOABII585uVIJS",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": 1848485522,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-11-20T21:56:03Z",
      "updated_at": "2024-11-20T21:56:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1851032146",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1851032146"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859189838",
      "pull_request_review_id": 2462618817,
      "id": 1859189838,
      "node_id": "PRRC_kwDOABII585u0PxO",
      "diff_hunk": "@@ -0,0 +1,200 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    SeedRandomForTest(SeedRand::ZEROS);\n+\n+    const auto cores{GetNumCores()};\n+    const auto num_txs{m_rng.randrange(cores * 10)};\n+    const auto block{CreateBlock(num_txs)};\n+    const auto batch_size{m_rng.randrange<int32_t>(block.vtx.size() * 2)};\n+    const auto worker_threads{m_rng.randrange(cores * 2)};\n+    InputFetcher fetcher{batch_size, worker_threads};",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3c201bcffc1d7e382e8afa9a88750a4c261c1cf8",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In 3c201bcffc1d7e382e8afa9a88750a4c261c1cf8 \"tests: add inputfetcher tests\"\r\nYou can set this up in `InputFetcherTest` so that you don't have to repeat it in the rest of the tests.",
      "created_at": "2024-11-26T20:31:21Z",
      "updated_at": "2024-11-26T20:55:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1859189838",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859189838"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 50,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859192217",
      "pull_request_review_id": 2462618817,
      "id": 1859192217,
      "node_id": "PRRC_kwDOABII585u0QWZ",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In 2349ac7d6071746a80223358bce0d5e556b277d7 \"bench: add inputfetcher bench\"\r\nHow did you select this batch size?",
      "created_at": "2024-11-26T20:33:51Z",
      "updated_at": "2024-11-26T20:55:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1859192217",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859192217"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859204841",
      "pull_request_review_id": 2462618817,
      "id": 1859204841,
      "node_id": "PRRC_kwDOABII585u0Tbp",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 19,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In 2349ac7d6071746a80223358bce0d5e556b277d7 \"bench: add inputfetcher bench\"\r\nnit: will be nice if we have `block413567` input's data that we can read so that we dont have to simulate this.",
      "created_at": "2024-11-26T20:47:18Z",
      "updated_at": "2024-11-26T20:55:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1859204841",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859204841"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868551853",
      "pull_request_review_id": 2477040586,
      "id": 1868551853,
      "node_id": "PRRC_kwDOABII585vX9at",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We no longer need to block on the shared outpoints vector. We write to it once in the main thread before notifying the other threads and then only read from it afterwards.",
      "created_at": "2024-12-04T00:56:57Z",
      "updated_at": "2024-12-04T00:56:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868551853",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868551853"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552609",
      "pull_request_review_id": 2477041647,
      "id": 1868552609,
      "node_id": "PRRC_kwDOABII585vX9mh",
      "diff_hunk": "@@ -0,0 +1,200 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    SeedRandomForTest(SeedRand::ZEROS);\n+\n+    const auto cores{GetNumCores()};\n+    const auto num_txs{m_rng.randrange(cores * 10)};\n+    const auto block{CreateBlock(num_txs)};\n+    const auto batch_size{m_rng.randrange<int32_t>(block.vtx.size() * 2)};\n+    const auto worker_threads{m_rng.randrange(cores * 2)};\n+    InputFetcher fetcher{batch_size, worker_threads};",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3c201bcffc1d7e382e8afa9a88750a4c261c1cf8",
      "in_reply_to_id": 1859189838,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-12-04T00:58:01Z",
      "updated_at": "2024-12-04T00:58:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868552609",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552609"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 50,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552959",
      "pull_request_review_id": 2477042136,
      "id": 1868552959,
      "node_id": "PRRC_kwDOABII585vX9r_",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859192217,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is the hardcoded batch size used in CheckQueue. Not sure why that was selected, but I deferred to previous choices.",
      "created_at": "2024-12-04T00:58:35Z",
      "updated_at": "2024-12-04T00:58:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868552959",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552959"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868553486",
      "pull_request_review_id": 2477042938,
      "id": 1868553486,
      "node_id": "PRRC_kwDOABII585vX90O",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 19,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859204841,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We're reading the previous outpoints of that block's inputs, which are in many other previous blocks. So, not sure this is feasible.",
      "created_at": "2024-12-04T00:59:31Z",
      "updated_at": "2024-12-04T00:59:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868553486",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868553486"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2083465171",
      "pull_request_review_id": 2831320761,
      "id": 2083465171,
      "node_id": "PRRC_kwDOABII5858LyfT",
      "diff_hunk": "@@ -3195,6 +3195,8 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.GetInputFetcher().FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Can we let the objects do the job instead of querying their internals and doing it ourselves (\"tell, don't ask\"):\r\n```suggestion\r\n        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);\r\n```",
      "created_at": "2025-05-11T09:26:33Z",
      "updated_at": "2025-09-29T17:13:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2083465171",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2083465171"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2173389714",
      "pull_request_review_id": 2968760335,
      "id": 2173389714,
      "node_id": "PRRC_kwDOABII586Bi0uS",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "HowHsu",
        "id": 38499194,
        "node_id": "MDQ6VXNlcjM4NDk5MTk0",
        "avatar_url": "https://avatars.githubusercontent.com/u/38499194?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HowHsu",
        "html_url": "https://github.com/HowHsu",
        "followers_url": "https://api.github.com/users/HowHsu/followers",
        "following_url": "https://api.github.com/users/HowHsu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/HowHsu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/HowHsu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/HowHsu/subscriptions",
        "organizations_url": "https://api.github.com/users/HowHsu/orgs",
        "repos_url": "https://api.github.com/users/HowHsu/repos",
        "events_url": "https://api.github.com/users/HowHsu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/HowHsu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": " > Is there anything prohibiting us from doing something like this to minimize synchronization and lock contention during the fetch phase? I understand some synchronization would still be needed during the merge, but this could help reduce global locks and unnecessary synchronization throughout the process.\r\n \r\n As far as I know, the advantage of coroutines over threads is faster context switching, since it doesnâ€™t go through the operating system kernel. This advantage only becomes apparent under extremely high concurrency, such as hundreds of thousands of concurrent tasks. Using coroutines does not eliminate the need for synchronization mechanisms where they are inherently required.\r\n\r\n\r\n",
      "created_at": "2025-06-28T16:06:38Z",
      "updated_at": "2025-06-28T16:06:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2173389714",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2173389714"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2376962309",
      "pull_request_review_id": 3264568566,
      "id": 2376962309,
      "node_id": "PRRC_kwDOABII586NrZEF",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "seems a bit odd to have the number of  nodes in a test influence whether or not the test has to be edited to remove or add `-par=1` everywhere. Would it not be easier to just globally set `-par=2` for all funtional tests?\r\n\r\n\r\n```diff\r\ndiff --git a/test/functional/test_framework/util.py b/test/functional/test_framework/util.py\r\nindex e5a5938f07..42bb213dd3 100644\r\n--- a/test/functional/test_framework/util.py\r\n+++ b/test/functional/test_framework/util.py\r\n@@ -459,6 +459,7 @@ def write_config(config_path, *, n, chain, extra_config=\"\", disable_autoconnect=\r\n         f.write(\"printtoconsole=0\\n\")\r\n         f.write(\"natpmp=0\\n\")\r\n         f.write(\"shrinkdebugfile=0\\n\")\r\n+        f.write(\"par=2\\n\")\r\n         # To improve SQLite wallet performance so that the tests don't timeout, use -unsafesqlitesync\r\n         f.write(\"unsafesqlitesync=1\\n\")\r\n         if disable_autoconnect:\r\n",
      "created_at": "2025-09-24T20:16:40Z",
      "updated_at": "2025-09-24T20:16:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2376962309",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2376962309"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2377071137",
      "pull_request_review_id": 3264725425,
      "id": 2377071137,
      "node_id": "PRRC_kwDOABII586Nrzoh",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2376962309,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, I wondered if that would be more invasive to other tests though.",
      "created_at": "2025-09-24T21:01:37Z",
      "updated_at": "2025-09-24T21:01:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2377071137",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2377071137"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2378064596",
      "pull_request_review_id": 3266228181,
      "id": 2378064596,
      "node_id": "PRRC_kwDOABII586NvmLU",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2376962309,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It disables the auto-detection for all functional tests by default, which I can't really find a downside to. Also, it removes idle \"spam\" threads while debugging (gdb and other tools will display less script check threads), which also seems beneficial to have?",
      "created_at": "2025-09-25T07:42:08Z",
      "updated_at": "2025-09-25T07:42:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2378064596",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2378064596"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384229679",
      "pull_request_review_id": 3275004800,
      "id": 2384229679,
      "node_id": "PRRC_kwDOABII586OHHUv",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2376962309,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Makes sense. Done here https://github.com/bitcoin/bitcoin/pull/33485.",
      "created_at": "2025-09-27T16:09:48Z",
      "updated_at": "2025-09-27T16:09:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2384229679",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384229679"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388213294",
      "pull_request_review_id": 2831320761,
      "id": 2388213294,
      "node_id": "PRRC_kwDOABII586OWT4u",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: is there anything in the error that we may want to log?",
      "created_at": "2025-09-29T14:31:49Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388213294",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388213294"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388218975",
      "pull_request_review_id": 2831320761,
      "id": 2388218975,
      "node_id": "PRRC_kwDOABII586OWVRf",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I haven't reviewed it in detail but was wondering why we need locking here, it should be possible to do most of this lock free (especially if we sort the keys first so that threads are more likely to access different regions). I have started reviewing and testing it in detail, but to have some progress I'm sharing my observations as I go along",
      "created_at": "2025-09-29T14:33:42Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388218975",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388218975"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388224454",
      "pull_request_review_id": 2831320761,
      "id": 2388224454,
      "node_id": "PRRC_kwDOABII586OWWnG",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 82,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "instead of the comment, can we express this in the method name?",
      "created_at": "2025-09-29T14:35:05Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388224454",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388224454"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 82,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388236852",
      "pull_request_review_id": 2831320761,
      "id": 2388236852,
      "node_id": "PRRC_kwDOABII586OWZo0",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have tried `std::jthread` in [l0rinc/bitcoin@`6afe2e8` (#40)](https://github.com/l0rinc/bitcoin/pull/40/commits/6afe2e878046703cd71b166a3cf0e53ccd12e478#diff-b1e19192258d83199d8adaa5ac31f067af98f63554bfdd679bd8e8073815e69dR1363) but it seems the CI's libc++ doesnâ€™t provide it\r\n\r\nQ: it's just the second commit and we're already doing the fetching on multiple threads. Can we add a single-threaded input fetcher first and add multithreading only as the very last step?",
      "created_at": "2025-09-29T14:38:56Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388236852",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388236852"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388250227",
      "pull_request_review_id": 2831320761,
      "id": 2388250227,
      "node_id": "PRRC_kwDOABII586OWc5z",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "what if instead of locking we just iterate every `n`th element (where `n` is the thread index), implicitly dividing the input into `n` buckets without locking. Each thread would work on a distinct set of values - we can pre-filter for existing values on a single thread before forking off. This won't have work stealing, but we can likely assume uniform distribution and the solution would be trivial and lock free.",
      "created_at": "2025-09-29T14:42:49Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388250227",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388250227"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 73,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388256954",
      "pull_request_review_id": 2831320761,
      "id": 2388256954,
      "node_id": "PRRC_kwDOABII586OWei6",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 77,
      "commit_id": "7991379d7f5f42003f8168a56d09297ab4625280",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "could we pre-filter on a single tread and send the results to the fetcher instead? That way we can also decide not to do multi-threaded access for small sets (we can experiment with the values, but we can probably start with set size < nproc should be done on a single thread).",
      "created_at": "2025-09-29T14:44:35Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388256954",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388256954"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 75,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388258759",
      "pull_request_review_id": 2831320761,
      "id": 2388258759,
      "node_id": "PRRC_kwDOABII586OWe_H",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "4331168bd08d63a73a6e45c84a7513d01541f19a",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: the curse of long review queues\n```suggestion\n// Copyright (c) 2025-present The Bitcoin Core developers\n```",
      "created_at": "2025-09-29T14:45:09Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388258759",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388258759"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388269800",
      "pull_request_review_id": 2831320761,
      "id": 2388269800,
      "node_id": "PRRC_kwDOABII586OWhro",
      "diff_hunk": "@@ -423,12 +423,13 @@ class CCoinsViewCache : public CCoinsViewBacked\n \n     /**\n      * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * the emplaced coin as dirty unless `set_dirty` is `false`.\n      *\n-     * NOT FOR GENERAL USE. Used only when loading coins from a UTXO snapshot.\n+     * NOT FOR GENERAL USE. Used when loading coins from a UTXO snapshot, and\n+     * in the InputFetcher.\n      * @sa ChainstateManager::PopulateAndValidateSnapshot()\n      */\n-    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin);\n+    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty = true);",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "to peel away the preparatory commits, it would simplify review to extract these into tiny, focused PRs - to have some progress, since this PR is in review for some time, but it's a very good change that I'd like to have some progress on.\r\n\r\nnit: I understand the default param is meant to make the diff smaller, but it doesn't help with understanding the effect of the change, to see where this is used and what we're changing",
      "created_at": "2025-09-29T14:48:50Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388269800",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388269800"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 432,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388273122",
      "pull_request_review_id": 2831320761,
      "id": 2388273122,
      "node_id": "PRRC_kwDOABII586OWifi",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 7,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\r\nI had something similar in https://github.com/bitcoin/bitcoin/pull/32313/files#diff-f0ed73d62dae6ca28ebd3045e5fc0d5d02eaaacadb4c2a292985a3fbd7e1c77cR254\r\n\r\nCan you please explain in the commit message why this change is necessary?",
      "created_at": "2025-09-29T14:49:52Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388273122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388273122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 114,
      "original_line": 114,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388275122",
      "pull_request_review_id": 2831320761,
      "id": 2388275122,
      "node_id": "PRRC_kwDOABII586OWi-y",
      "diff_hunk": "@@ -6266,6 +6268,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have tested this with different `par` values and surprisingly it barely had any effect. Is it because of the locking?\n\n",
      "created_at": "2025-09-29T14:50:31Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388275122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388275122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388297125",
      "pull_request_review_id": 2831320761,
      "id": 2388297125,
      "node_id": "PRRC_kwDOABII586OWoWl",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        cachedCoinsUsage += mem_usage;",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 11,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "af8a366bd6a08d9362e69a89b0b89b5c94eb63ca",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this seems like a change in behavior, but it assumed that the coin was never in the cache - though `if (inserted)` didn't help with understanding this, so it likely isn't.\r\n\r\nIs that still something that we can assume - hence the \"danger\", right?\r\nAnd if it's always inserted, does the insertion guard still make sense? It's a bit even more confusing now :/",
      "created_at": "2025-09-29T14:57:23Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388297125",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388297125"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 118,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388303800",
      "pull_request_review_id": 2831320761,
      "id": 2388303800,
      "node_id": "PRRC_kwDOABII586OWp-4",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 24,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\r\n * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\r\n```",
      "created_at": "2025-09-29T14:59:38Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388303800",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388303800"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 23,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388307927",
      "pull_request_review_id": 2831320761,
      "id": 2388307927,
      "node_id": "PRRC_kwDOABII586OWq_X",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 27,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "do we need to write to a global vector or can we safely iterate the prevouts directly from each thread?",
      "created_at": "2025-09-29T15:00:53Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388307927",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388307927"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 26,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 27,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388318316",
      "pull_request_review_id": 2831320761,
      "id": 2388318316,
      "node_id": "PRRC_kwDOABII586OWths",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Q: do we really need the main thread to be part of this? I expect this to be disk bound and not CPU restricted, we should be able to go beyond `nproc`, so it should be safe to leave the main thread out of this as far as I can tell...",
      "created_at": "2025-09-29T15:04:17Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388318316",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388318316"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388399879",
      "pull_request_review_id": 2831320761,
      "id": 2388399879,
      "node_id": "PRRC_kwDOABII586OXBcH",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 130,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "as mentioned before I think it should be safe to pre-filter on a single thread instead",
      "created_at": "2025-09-29T15:28:53Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388399879",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388399879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388409573",
      "pull_request_review_id": 2831320761,
      "id": 2388409573,
      "node_id": "PRRC_kwDOABII586OXDzl",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 127,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "what if this ends up on different threads, i.e. a spend from an earlier outpoint processed on a different thread? Wouldn't we take care of those automatically? We can likely skip all values that are not found, since we will revalidate everything after this cache warming call - we just have to document that it's theoretically possible that some values won't be in the cache after this call (though the internal spends should be added, just in a different thread, right?).",
      "created_at": "2025-09-29T15:31:41Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388409573",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388409573"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388412343",
      "pull_request_review_id": 2831320761,
      "id": 2388412343,
      "node_id": "PRRC_kwDOABII586OXEe3",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 136,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "do we really care about this, it's not our job here to validate, just fetch whatever we can, the validation will happen after this pre-warming.",
      "created_at": "2025-09-29T15:32:29Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388412343",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388412343"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388419154",
      "pull_request_review_id": 2831320761,
      "id": 2388419154,
      "node_id": "PRRC_kwDOABII586OXGJS",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 162,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "what's the reason for allowing negative `worker_thread_count`? In other cases I think it was used to signal how many CPUs to reserve, but that doesn't seem to be the case here, and since we're claming to min of 0, consider:\r\n```suggestion\r\n        if (worker_thread_count == 0) {\r\n```",
      "created_at": "2025-09-29T15:34:56Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388419154",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388419154"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 151,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388427056",
      "pull_request_review_id": 2831320761,
      "id": 2388427056,
      "node_id": "PRRC_kwDOABII586OXIEw",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 192,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Can we maybe do something like this instead?\r\n```suggestion\r\n        if (block.vtx.size() < m_worker_threads.size()) {\r\n```",
      "created_at": "2025-09-29T15:37:35Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388427056",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388427056"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388430113",
      "pull_request_review_id": 2831320761,
      "id": 2388430113,
      "node_id": "PRRC_kwDOABII586OXI0h",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {\n+            return;\n+        }\n+\n+        // Set the db and cache to use for this block.\n+        m_db = &db;\n+        m_cache = &cache;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 198,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we avoid mutating the state in a multithreaded class for safety? It's easier to follow along knowing that the class is immutable and the state is passed along...",
      "created_at": "2025-09-29T15:38:31Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388430113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388430113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 134,
      "original_start_line": 197,
      "start_side": "RIGHT",
      "line": 135,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388436958",
      "pull_request_review_id": 2831320761,
      "id": 2388436958,
      "node_id": "PRRC_kwDOABII586OXKfe",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 50,
      "original_position": 51,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we add these tests before the multithreading change - having a single-threaded InputFetcher first, adding tests and benchmarks after and doing the actual multithreading as a very last step. That would construct the whole scenario in smaller steps, proving that every change is safe",
      "created_at": "2025-09-29T15:40:35Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388436958",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388436958"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 50,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388439344",
      "pull_request_review_id": 2831320761,
      "id": 2388439344,
      "node_id": "PRRC_kwDOABII586OXLEw",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I understand why benchmarks need predictability, but wouldn't we want variance for tests?",
      "created_at": "2025-09-29T15:41:15Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388439344",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388439344"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388449458",
      "pull_request_review_id": 2831320761,
      "id": 2388449458,
      "node_id": "PRRC_kwDOABII586OXNiy",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto batch_size{m_rng.randrange<int32_t>(m_block->vtx.size() * 2)};\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(batch_size, worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView db;\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+class ThrowCoinsView : public CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        throw std::runtime_error(\"database error\");",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 162,
      "original_position": 171,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "consider `std::terminate`",
      "created_at": "2025-09-29T15:44:14Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388449458",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388449458"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 162,
      "original_line": 162,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388454027",
      "pull_request_review_id": 2831320761,
      "id": 2388454027,
      "node_id": "PRRC_kwDOABII586OXOqL",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859192217,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I would prefer retesting those assumptions (I don't even think we need a batch here)",
      "created_at": "2025-09-29T15:45:38Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388454027",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388454027"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388459245",
      "pull_request_review_id": 2831320761,
      "id": 2388459245,
      "node_id": "PRRC_kwDOABII586OXP7t",
      "diff_hunk": "@@ -0,0 +1,153 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(batch_size * worker_threads * 2)) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin),\n+                        /*set_dirty=*/fuzzed_data_provider.ConsumeBool());\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);\n+\n+        for (const auto& [outpoint, pair] : db_map) {\n+            // Check pre-existing coins in the cache have not been updated\n+            const auto it{cache_map.find(outpoint)};\n+            if (it != cache_map.end()) {\n+                const auto& cache_coin{it->second};\n+                const auto& coin{cache.AccessCoin(outpoint)};\n+                assert(coin.IsSpent() == cache_coin.IsSpent());\n+                assert(coin.fCoinBase == cache_coin.fCoinBase);\n+                assert(coin.nHeight == cache_coin.nHeight);\n+                assert(coin.out == cache_coin.out);\n+                continue;\n+            }\n+\n+            if (!cache.HaveCoinInCache(outpoint)) {\n+                continue;\n+            }\n+\n+            const auto& [maybe_coin, err] = pair;\n+            assert(maybe_coin && !err);\n+\n+            // Check any newly added coins in the cache are the same as the db\n+            const auto& coin{cache.AccessCoin(outpoint)};\n+            assert(!coin.IsSpent());\n+            assert(coin.fCoinBase == (*maybe_coin).fCoinBase);\n+            assert(coin.nHeight == (*maybe_coin).nHeight);\n+            assert(coin.out == (*maybe_coin).out);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 150,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "1faf0595a59ee0da61aabb195c9939575f2536eb",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\r\n            assert(coin.fCoinBase == maybe_coin->fCoinBase);\r\n            assert(coin.nHeight == maybe_coin->nHeight);\r\n            assert(coin.out == maybe_coin->out);\r\n```",
      "created_at": "2025-09-29T15:47:05Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388459245",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388459245"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 148,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 148,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388733196",
      "pull_request_review_id": 3280976253,
      "id": 2388733196,
      "node_id": "PRRC_kwDOABII586OYS0M",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think we should add exact types here to make sure calculations like `end_index - local_batch_size` can't underflow",
      "created_at": "2025-09-29T17:41:02Z",
      "updated_at": "2025-09-29T17:45:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388733196",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388733196"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 85,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388743389",
      "pull_request_review_id": 3280976253,
      "id": 2388743389,
      "node_id": "PRRC_kwDOABII586OYVTd",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashBlock) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 38,
      "original_position": 47,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm a bit conflicted here: this way we're all measuring something slightly different - which is especially problematic since the work here isn't even CPU bound. What if we did a min of npcu and 4?",
      "created_at": "2025-09-29T17:44:49Z",
      "updated_at": "2025-09-29T17:45:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388743389",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388743389"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 38,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399012085",
      "pull_request_review_id": 3294897463,
      "id": 2399012085,
      "node_id": "PRRC_kwDOABII586O_gT1",
      "diff_hunk": "@@ -3195,6 +3195,8 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.GetInputFetcher().FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "in_reply_to_id": 2083465171,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I tried to mimic the script validation like `GetCheckQueue`. But, I guess this is different enough. Will change next time I push.",
      "created_at": "2025-10-02T14:20:12Z",
      "updated_at": "2025-10-02T14:20:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399012085",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399012085"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399016753",
      "pull_request_review_id": 3294903795,
      "id": 2399016753,
      "node_id": "PRRC_kwDOABII586O_hcx",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I've updated to use semaphores instead of mutex. That should be more efficient.\r\n\r\n> especially if we sort the keys first so that threads are more likely to access different regions\r\n\r\nI don't understand what this has to do with being lock free.",
      "created_at": "2025-10-02T14:21:49Z",
      "updated_at": "2025-10-02T14:21:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399016753",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399016753"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399019592",
      "pull_request_review_id": 3294907722,
      "id": 2399019592,
      "node_id": "PRRC_kwDOABII586O_iJI",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 82,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388224454,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I updated the thread name to ThreadLoop, which just does the loop. There is another function now, `FetchInputsOnThread`, that fetches for each block until finished.",
      "created_at": "2025-10-02T14:22:46Z",
      "updated_at": "2025-10-02T14:22:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399019592",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399019592"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 82,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399025372",
      "pull_request_review_id": 3294915812,
      "id": 2399025372,
      "node_id": "PRRC_kwDOABII586O_jjc",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388250227,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Prefiltering on the main thread is too slow, it's faster if we do the filtering in parallel. So, we still need to have a smaller batch size because then work will not be divided evenly. One thread could get all cache misses while the others all have cached inputs.",
      "created_at": "2025-10-02T14:24:55Z",
      "updated_at": "2025-10-02T14:24:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399025372",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399025372"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 73,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399027783",
      "pull_request_review_id": 3294919045,
      "id": 2399027783,
      "node_id": "PRRC_kwDOABII586O_kJH",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 77,
      "commit_id": "7991379d7f5f42003f8168a56d09297ab4625280",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388256954,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Prefiltering on the main thread is too slow. It is several milliseconds to check every input in large blocks whether they exist in the cache.\r\n\r\n",
      "created_at": "2025-10-02T14:25:46Z",
      "updated_at": "2025-10-02T14:25:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399027783",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399027783"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 75,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399028082",
      "pull_request_review_id": 3294919403,
      "id": 2399028082,
      "node_id": "PRRC_kwDOABII586O_kNy",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "4331168bd08d63a73a6e45c84a7513d01541f19a",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388258759,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-02T14:25:52Z",
      "updated_at": "2025-10-02T14:25:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399028082",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399028082"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399032242",
      "pull_request_review_id": 3294924932,
      "id": 2399032242,
      "node_id": "PRRC_kwDOABII586O_lOy",
      "diff_hunk": "@@ -6266,6 +6268,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388275122,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I believe this is resolved.",
      "created_at": "2025-10-02T14:27:19Z",
      "updated_at": "2025-10-02T14:27:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399032242",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399032242"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399049434",
      "pull_request_review_id": 3294948927,
      "id": 2399049434,
      "node_id": "PRRC_kwDOABII586O_pba",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        cachedCoinsUsage += mem_usage;",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 11,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "af8a366bd6a08d9362e69a89b0b89b5c94eb63ca",
      "in_reply_to_id": 2388297125,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is dangerous because it doesn't check for freshness or if already inserted. It is meant to bulk load new utxos from the assume utxo set. Since assume utxo assumes the utxo set is currently empty, the coins would always be inserted.\r\nThis is repurposed here to bulk load utxos from the db directly into the cache. However, an invalid block could be mined which spends an already spent utxo that is in the cache but has not been synced to the db yet. In that case, \r\nthe insertion will fail here. There is a unit test specifically for this scenario.",
      "created_at": "2025-10-02T14:33:42Z",
      "updated_at": "2025-10-02T14:33:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399049434",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399049434"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 118,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399056272",
      "pull_request_review_id": 3294959235,
      "id": 2399056272,
      "node_id": "PRRC_kwDOABII586O_rGQ",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 27,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388307927,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We iterate the prevouts directly from the block now. However, we store the tx index and vin index in a global vector now. This way we can flatten the inputs instead of having to scan the txs to see how many inputs they have.",
      "created_at": "2025-10-02T14:36:02Z",
      "updated_at": "2025-10-02T14:36:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399056272",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399056272"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 26,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 27,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399059149",
      "pull_request_review_id": 3294963215,
      "id": 2399059149,
      "node_id": "PRRC_kwDOABII586O_rzN",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388318316,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Not sure, would have to benchmark this.\r\nI have updated the functions though to make the main thread's entrance clearer.",
      "created_at": "2025-10-02T14:37:07Z",
      "updated_at": "2025-10-02T14:37:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399059149",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399059149"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399062889",
      "pull_request_review_id": 3294968319,
      "id": 2399062889,
      "node_id": "PRRC_kwDOABII586O_stp",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 130,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388399879,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It is definitely safe to do, since all access would be on main thread. It is also safe to do from parallel threads if we don't write until all threads are done reading, which is what this PR does.\r\nPrefiltering is slow though (several milliseconds) so is better to do in parallel.",
      "created_at": "2025-10-02T14:38:33Z",
      "updated_at": "2025-10-02T14:38:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399062889",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399062889"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399067712",
      "pull_request_review_id": 3294975172,
      "id": 2399067712,
      "node_id": "PRRC_kwDOABII586O_t5A",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 127,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388409573,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure I understand this.\r\nThe m_txids set is computed on the main thread, and is only read from multiple threads. If we didn't do this we would try to fetch non-existent outputs from the db, which would be much slower.",
      "created_at": "2025-10-02T14:40:12Z",
      "updated_at": "2025-10-02T14:40:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399067712",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399067712"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069027",
      "pull_request_review_id": 3294977180,
      "id": 2399069027,
      "node_id": "PRRC_kwDOABII586O_uNj",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388250227,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Not sure why that's problematic, we don't *have* to have perfect parallelism, it seems to me we can assume uniform distribution - it's fine if there are outliers if that makes the code simpler (which I think it should, it could even eliminate most locks, since the jobs are basically completely independent)",
      "created_at": "2025-10-02T14:40:35Z",
      "updated_at": "2025-10-02T14:40:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399069027",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069027"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 73,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069282",
      "pull_request_review_id": 3294977557,
      "id": 2399069282,
      "node_id": "PRRC_kwDOABII586O_uRi",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I don't understand what this has to do with being lock free.\r\n\r\nWe may have fewer file system locks if the threads are accessing different regions\r\n\r\n> I've updated to use semaphores instead of mutex\r\n\r\nI will review that in more detail soon, probably next week.",
      "created_at": "2025-10-02T14:40:41Z",
      "updated_at": "2025-10-02T14:40:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399069282",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069282"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399071701",
      "pull_request_review_id": 3294980461,
      "id": 2399071701,
      "node_id": "PRRC_kwDOABII586O_u3V",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 136,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388412343,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We don't really care, but it would be good to not continue doing work here if we know it's pointless. This just exits early. No validation is happening.",
      "created_at": "2025-10-02T14:41:29Z",
      "updated_at": "2025-10-02T14:41:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399071701",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399071701"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399074127",
      "pull_request_review_id": 3294983877,
      "id": 2399074127,
      "node_id": "PRRC_kwDOABII586O_vdP",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 192,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388427056,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is to not enter if there is only a coinbase tx, since it has no inputs to fetch. If there were 2 txs, and the second has 1000 inputs, we would still want to enter here.",
      "created_at": "2025-10-02T14:42:21Z",
      "updated_at": "2025-10-02T14:42:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399074127",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399074127"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399077894",
      "pull_request_review_id": 3294988855,
      "id": 2399077894,
      "node_id": "PRRC_kwDOABII586O_wYG",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388318316,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "My benchmarks so far indicate the opposite: after 3-4 threads there is no benefit to the parallelization (either on SSD or HDD). I will remeasure your new changes after you give me the ðŸ‘ ",
      "created_at": "2025-10-02T14:43:24Z",
      "updated_at": "2025-10-02T14:43:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399077894",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399077894"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399079463",
      "pull_request_review_id": 3294990649,
      "id": 2399079463,
      "node_id": "PRRC_kwDOABII586O_wwn",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {\n+            return;\n+        }\n+\n+        // Set the db and cache to use for this block.\n+        m_db = &db;\n+        m_cache = &cache;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 198,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388430113,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think we can do that. We need to set these here for other threads to read. These are only read from other threads, never written to. We also only read from other threads after the main thread has released the counting_semaphore, so we know the pointers are synced across the threads.",
      "created_at": "2025-10-02T14:43:51Z",
      "updated_at": "2025-10-02T14:43:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399079463",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399079463"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 134,
      "original_start_line": 197,
      "start_side": "RIGHT",
      "line": 135,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399082258",
      "pull_request_review_id": 3294994294,
      "id": 2399082258,
      "node_id": "PRRC_kwDOABII586O_xcS",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto batch_size{m_rng.randrange<int32_t>(m_block->vtx.size() * 2)};\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(batch_size, worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView db;\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+class ThrowCoinsView : public CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        throw std::runtime_error(\"database error\");",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 162,
      "original_position": 171,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": 2388449458,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Err, we want to throw a runtime error here to test the try/catch in the inputfetcher.",
      "created_at": "2025-10-02T14:44:35Z",
      "updated_at": "2025-10-02T14:44:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399082258",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399082258"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 162,
      "original_line": 162,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399083511",
      "pull_request_review_id": 3294995976,
      "id": 2399083511,
      "node_id": "PRRC_kwDOABII586O_xv3",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388733196,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I rewrote this part, these are gone now.",
      "created_at": "2025-10-02T14:44:59Z",
      "updated_at": "2025-10-02T14:45:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399083511",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399083511"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 85,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399084818",
      "pull_request_review_id": 3294997807,
      "id": 2399084818,
      "node_id": "PRRC_kwDOABII586O_yES",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 130,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388399879,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "But prefiltering would allow sorting, which should untangle the threads.\r\nThe threads will access the same files (which are more likely to be different from the files the other threads are requesting), so they may profit from cache locality if the OS supports it - that's why I suggested giving it a try.",
      "created_at": "2025-10-02T14:45:28Z",
      "updated_at": "2025-10-02T14:45:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399084818",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399084818"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399092048",
      "pull_request_review_id": 3295008083,
      "id": 2399092048,
      "node_id": "PRRC_kwDOABII586O_z1Q",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> We may have fewer file system locks if the threads are accessing different regions\r\n\r\nOk, but that is not the same as this InputFetcher construction being lock free.",
      "created_at": "2025-10-02T14:47:30Z",
      "updated_at": "2025-10-02T14:47:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399092048",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399092048"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399094785",
      "pull_request_review_id": 3295011711,
      "id": 2399094785,
      "node_id": "PRRC_kwDOABII586O_0gB",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {\n+            return;\n+        }\n+\n+        // Set the db and cache to use for this block.\n+        m_db = &db;\n+        m_cache = &cache;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 198,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388430113,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I really dislike that, will try to come up with a lock-free version later (maybe next week)",
      "created_at": "2025-10-02T14:48:22Z",
      "updated_at": "2025-10-02T14:48:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399094785",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399094785"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 134,
      "original_start_line": 197,
      "start_side": "RIGHT",
      "line": 135,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399100147",
      "pull_request_review_id": 3295018607,
      "id": 2399100147,
      "node_id": "PRRC_kwDOABII586O_1zz",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 136,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388412343,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think I would prefer a less opinionated version, as long as it's still correct. No need to optimize for the consensus failure speed in my opinion, I would prefer simpler code for a change as risky as this one.",
      "created_at": "2025-10-02T14:50:17Z",
      "updated_at": "2025-10-02T14:50:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399100147",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399100147"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399116295",
      "pull_request_review_id": 3295038544,
      "id": 2399116295,
      "node_id": "PRRC_kwDOABII586O_5wH",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "No, that's orthogonal, it's another area where we could possibly reduce contention.",
      "created_at": "2025-10-02T14:54:52Z",
      "updated_at": "2025-10-02T14:54:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399116295",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399116295"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470414",
      "pull_request_review_id": 3299718995,
      "id": 2402470414,
      "node_id": "PRRC_kwDOABII586PMsoO",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 162,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388419154,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-03T15:58:56Z",
      "updated_at": "2025-10-03T15:58:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2402470414",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470414"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 151,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470769",
      "pull_request_review_id": 3299719451,
      "id": 2402470769,
      "node_id": "PRRC_kwDOABII586PMstx",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 24,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388303800,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-03T15:59:05Z",
      "updated_at": "2025-10-03T15:59:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2402470769",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470769"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 23,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402472467",
      "pull_request_review_id": 3299721826,
      "id": 2402472467,
      "node_id": "PRRC_kwDOABII586PMtIT",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 7,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388273122,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added some explanation in the commit message. Please let me know if it makes it more clear.",
      "created_at": "2025-10-03T15:59:58Z",
      "updated_at": "2025-10-03T15:59:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2402472467",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402472467"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 114,
      "original_line": 114,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403069813",
      "pull_request_review_id": 3300510926,
      "id": 2403069813,
      "node_id": "PRRC_kwDOABII586PO-91",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859192217,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Removed the batch size ðŸŽ‰",
      "created_at": "2025-10-03T19:06:32Z",
      "updated_at": "2025-10-03T19:06:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2403069813",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403069813"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403595535",
      "pull_request_review_id": 3301344527,
      "id": 2403595535,
      "node_id": "PRRC_kwDOABII586PQ_UP",
      "diff_hunk": "@@ -3195,6 +3195,8 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.GetInputFetcher().FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "in_reply_to_id": 2083465171,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-04T00:00:08Z",
      "updated_at": "2025-10-04T00:00:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2403595535",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403595535"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404065695",
      "pull_request_review_id": 3301981036,
      "id": 2404065695,
      "node_id": "PRRC_kwDOABII586PSyGf",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388236852,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Can we add a single-threaded input fetcher first and add multithreading only as the very last step?\r\n\r\nDone.",
      "created_at": "2025-10-04T15:55:22Z",
      "updated_at": "2025-10-04T15:55:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2404065695",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404065695"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404066620",
      "pull_request_review_id": 3301981608,
      "id": 2404066620,
      "node_id": "PRRC_kwDOABII586PSyU8",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 50,
      "original_position": 51,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": 2388436958,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-04T15:57:41Z",
      "updated_at": "2025-10-04T15:57:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2404066620",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404066620"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 50,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072675",
      "pull_request_review_id": 3327511391,
      "id": 2423072675,
      "node_id": "PRRC_kwDOABII586QbSej",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388213294,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added a log.",
      "created_at": "2025-10-11T18:04:13Z",
      "updated_at": "2025-10-11T18:04:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2423072675",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072675"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072759",
      "pull_request_review_id": 3327511515,
      "id": 2423072759,
      "node_id": "PRRC_kwDOABII586QbSf3",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": 2388439344,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Changed to `FIXED_SEED`.",
      "created_at": "2025-10-11T18:04:32Z",
      "updated_at": "2025-10-11T18:04:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2423072759",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072759"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072787",
      "pull_request_review_id": 3327511553,
      "id": 2423072787,
      "node_id": "PRRC_kwDOABII586QbSgT",
      "diff_hunk": "@@ -0,0 +1,153 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(batch_size * worker_threads * 2)) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin),\n+                        /*set_dirty=*/fuzzed_data_provider.ConsumeBool());\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);\n+\n+        for (const auto& [outpoint, pair] : db_map) {\n+            // Check pre-existing coins in the cache have not been updated\n+            const auto it{cache_map.find(outpoint)};\n+            if (it != cache_map.end()) {\n+                const auto& cache_coin{it->second};\n+                const auto& coin{cache.AccessCoin(outpoint)};\n+                assert(coin.IsSpent() == cache_coin.IsSpent());\n+                assert(coin.fCoinBase == cache_coin.fCoinBase);\n+                assert(coin.nHeight == cache_coin.nHeight);\n+                assert(coin.out == cache_coin.out);\n+                continue;\n+            }\n+\n+            if (!cache.HaveCoinInCache(outpoint)) {\n+                continue;\n+            }\n+\n+            const auto& [maybe_coin, err] = pair;\n+            assert(maybe_coin && !err);\n+\n+            // Check any newly added coins in the cache are the same as the db\n+            const auto& coin{cache.AccessCoin(outpoint)};\n+            assert(!coin.IsSpent());\n+            assert(coin.fCoinBase == (*maybe_coin).fCoinBase);\n+            assert(coin.nHeight == (*maybe_coin).nHeight);\n+            assert(coin.out == (*maybe_coin).out);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 150,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "1faf0595a59ee0da61aabb195c9939575f2536eb",
      "in_reply_to_id": 2388459245,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done!",
      "created_at": "2025-10-11T18:04:40Z",
      "updated_at": "2025-10-11T18:04:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2423072787",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072787"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 148,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 148,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429350877",
      "pull_request_review_id": 3335914404,
      "id": 2429350877,
      "node_id": "PRRC_kwDOABII586QzPPd",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388236852,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I have tried std::jthread\r\n\r\nI looked at this, but it doesn't really add anything to this implementation. We could have a `std::stop_token` for each thread, but we would have to `request_stop()` each `jthread` before releasing the semaphore in the destructor anyway. So it doesn't let us remove the destructor, and saves a line for not having to declare `m_request_stop`. I don't think it's worth it to use `jthread`s here.",
      "created_at": "2025-10-14T14:09:53Z",
      "updated_at": "2025-10-14T14:09:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2429350877",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429350877"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429481952",
      "pull_request_review_id": 3336096572,
      "id": 2429481952,
      "node_id": "PRRC_kwDOABII586QzvPg",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388236852,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I couldn't get it to work on CI anyway",
      "created_at": "2025-10-14T14:49:17Z",
      "updated_at": "2025-10-14T14:49:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2429481952",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429481952"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2433196004",
      "pull_request_review_id": 3341247537,
      "id": 2433196004,
      "node_id": "PRRC_kwDOABII586RB5_k",
      "diff_hunk": "@@ -423,12 +423,13 @@ class CCoinsViewCache : public CCoinsViewBacked\n \n     /**\n      * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * the emplaced coin as dirty unless `set_dirty` is `false`.\n      *\n-     * NOT FOR GENERAL USE. Used only when loading coins from a UTXO snapshot.\n+     * NOT FOR GENERAL USE. Used when loading coins from a UTXO snapshot, and\n+     * in the InputFetcher.\n      * @sa ChainstateManager::PopulateAndValidateSnapshot()\n      */\n-    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin);\n+    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty = true);",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388269800,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think I can just drop this first commit entirely. We don't actually care to not set the coins we fetch as dirty.\r\nIn the happy path, all these coins will be spent immediately after `ConnectBlock`, so they will be set to dirty anyways.\r\nIn the unhappy path where the valid proof-of-work block is found to be invalid, the dirty coins we added will just cause the coins to be overwritten by the same data in the db at the next flush.",
      "created_at": "2025-10-15T16:09:11Z",
      "updated_at": "2025-10-15T16:09:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2433196004",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2433196004"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 432,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2437808988",
      "pull_request_review_id": 3347436866,
      "id": 2437808988,
      "node_id": "PRRC_kwDOABII586RTgNc",
      "diff_hunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * It loops through the block and writes all input indexes to a\n+ * vector. It then assigns itself an input from the vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * a different vector. Once all inputs are fetched, it writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 35,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "063946d6bd78035276d12e070a208d84492ac5cd",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As far as I understood the tx index and the vin index cannot exceed the limits of a `uint32_t`, see https://github.com/bitcoin/bitcoin/blob/e744fd1249bf9577274614eaf3997bf4bbb612ff/src/primitives/transaction.h#L32\r\n\r\nPlease consider `std::vector<std::pair<uint32_t, uint32_t>>` instead, which would likely halve the memory footprint. Based on https://godbolt.org/z/Wb918bWaM it seems to me this layout allows modern compilers to coalesce the two member accesses into a single, optimal 64-bit load from memory.\r\n\r\nPacking it into a single `uint64_t` seems to be the best, but that's completely unreadable, so I'd go with the above `std::pair<uint32_t, uint32_t>`.",
      "created_at": "2025-10-16T23:56:04Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2437808988",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2437808988"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 35,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442436064",
      "pull_request_review_id": 3347436866,
      "id": 2442436064,
      "node_id": "PRRC_kwDOABII586RlJ3g",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);\n+\n         CCoinsViewCache view(&CoinsTip());",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 6,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have played with this to see if we can construct the new cache layer before the fetcher, so that it populates the new layer instead of reading & writing to the old one - seemed like a cleaner separation.\n\nBut unfortunately we would need access to both in-memory cache layers inside `FetchInputs` in that case - to read for presence from the old cache and to write the newly fetched values to the new one (which will be flushed together with the new outputs when existing this scope).\n\nBut given that we're adding these missing entries only to spend them a moment later in the other cache layer (and to avoid having all of the missing ones require two-hop-lookups) we should still try reading from the stable cache and writing to the temporary one.\n\nCollecting the missing inputs to a separate cache would also help with benchmarking and testing since the underlying cache would only be modified once block connection finishes - while the complete diff would be in the top cache layer. We also shouldn't add the entries to the cache if the block fails validation.",
      "created_at": "2025-10-18T14:02:59Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442436064",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442436064"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 3140,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 3142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442481463",
      "pull_request_review_id": 3347436866,
      "id": 2442481463,
      "node_id": "PRRC_kwDOABII586RlU83",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 40,
      "original_position": 41,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Does this mean the spent tx is never processed on the same thread currently?\n\nMaybe we can mix it up a bit by something like\n```C++\nif (m_rng.randbool()) {\n    prevhash = tx.GetHash(); // TODO This can theoretically simulate double spends\n}\n```",
      "created_at": "2025-10-18T16:14:51Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442481463",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442481463"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 40,
      "original_line": 40,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442488159",
      "pull_request_review_id": 3347436866,
      "id": 2442488159,
      "node_id": "PRRC_kwDOABII586RlWlf",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 150,
      "original_position": 153,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What's the point of the loop in these, is there a state we're changing in each iteration?",
      "created_at": "2025-10-18T16:34:46Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442488159",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442488159"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 150,
      "original_line": 150,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498069",
      "pull_request_review_id": 3347436866,
      "id": 2442498069,
      "node_id": "PRRC_kwDOABII586RlZAV",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\n\n```suggestion\n    std::optional<Coin> GetCoin(const COutPoint&) const override { std::abort(); }\n```",
      "created_at": "2025-10-18T16:52:47Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498069",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498069"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 44,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 49,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498338",
      "pull_request_review_id": 3347436866,
      "id": 2442498338,
      "node_id": "PRRC_kwDOABII586RlZEi",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 26,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: in test code I'd strive for simpler code instead of needlessly \"safe\"\n\n```suggestion\nstruct DbCoinsView : CCoinsView\n{\n    DbMap& m_map;\n```",
      "created_at": "2025-10-18T16:53:38Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498338",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498338"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 21,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498626",
      "pull_request_review_id": 3347436866,
      "id": 2442498626,
      "node_id": "PRRC_kwDOABII586RlZJC",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 29,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`GetCoin` shouldn't return spent entries",
      "created_at": "2025-10-18T16:54:18Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498626",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498626"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 29,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498819",
      "pull_request_review_id": 3347436866,
      "id": 2442498819,
      "node_id": "PRRC_kwDOABII586RlZMD",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 24,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this seems overly general to me, I think we can inline the delay for now",
      "created_at": "2025-10-18T16:54:57Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498819",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498819"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442499107",
      "pull_request_review_id": 3347436866,
      "id": 2442499107,
      "node_id": "PRRC_kwDOABII586RlZQj",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+public:\n+\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_block = &block;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 153,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As mentioned before, I really dislike these lines, a fetcher shouldn't change the internal state (especially since they're const). Since we need a continuously running threads, can we package these to avoid state mutations? This would likely be solved by sending these off to a ThreadPool instance.",
      "created_at": "2025-10-18T16:55:53Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442499107",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442499107"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 151,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 153,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442502361",
      "pull_request_review_id": 3347436866,
      "id": 2442502361,
      "node_id": "PRRC_kwDOABII586RlaDZ",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We shouldn't test this with invalid (empty) blocks:\n\n```suggestion\n        if (block.vtx.empty()) continue;\n        fetcher.FetchInputs(cache, db, block);\n```",
      "created_at": "2025-10-18T17:00:10Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442502361",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442502361"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505074",
      "pull_request_review_id": 3347436866,
      "id": 2442505074,
      "node_id": "PRRC_kwDOABII586Rlaty",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 39,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\n\n```suggestion\n    CBlock block;\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n```",
      "created_at": "2025-10-18T17:08:43Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442505074",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505074"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 37,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505360",
      "pull_request_review_id": 3347436866,
      "id": 2442505360,
      "node_id": "PRRC_kwDOABII586RlayQ",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.",
      "path": "src/bench/inputfetcher.cpp",
      "position": 37,
      "original_position": 45,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "\"should be counted\" is the reason for the \"- 1\"?",
      "created_at": "2025-10-18T17:09:25Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442505360",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505360"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 36,
      "original_start_line": 44,
      "start_side": "RIGHT",
      "line": 37,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442506743",
      "pull_request_review_id": 3347436866,
      "id": 2442506743,
      "node_id": "PRRC_kwDOABII586RlbH3",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: if we keep the processor count here (which kinda' makes the benchmark measure different things on different platforms, but I don't really have a better idea, unless we assume that even the simplest machines where this matters (e.g. rpi4) already have at least 4 threads - and since this isn't even CPU bound, we shouldn't pretend that it does):\n\n```suggestion\n    const auto worker_threads_num{size_t(GetNumCores() - 1)};\n    const InputFetcher fetcher{worker_threads_num};\n```\nor\n```suggestion\n    const InputFetcher fetcher{/*max_thread_count=*/4};\n```",
      "created_at": "2025-10-18T17:12:32Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442506743",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442506743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 46,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442508359",
      "pull_request_review_id": 3347436866,
      "id": 2442508359,
      "node_id": "PRRC_kwDOABII586RlbhH",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};\n+\n+    bench.run([&] {\n+        const auto ok{cache.Flush()};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Doesn't this change the behavior of the benchmark after the first iteration?",
      "created_at": "2025-10-18T17:17:32Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442508359",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442508359"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442511181",
      "pull_request_review_id": 3347436866,
      "id": 2442511181,
      "node_id": "PRRC_kwDOABII586RlcNN",
      "diff_hunk": "@@ -6265,6 +6267,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{std::clamp<size_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't understand what `0` threads means. It likely means turn off prefetching.\r\n \r\nI would consider it to be a lot more intuitive if this started with 1 (and not be bound by the number of unrelated `MAX_SCRIPTCHECK_THREADS` since it's not script related and not even CPU bound).\r\n\r\nNote: `chainstatemanager_snapshot_init` creates it with `0` workers by default, not sure it's intended",
      "created_at": "2025-10-18T17:25:12Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442511181",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442511181"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6302,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442521884",
      "pull_request_review_id": 3347436866,
      "id": 2442521884,
      "node_id": "PRRC_kwDOABII586Rle0c",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 113,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It seems to me that since the original `m_coins` is never written by different threads, we shouldn't have a false sharing problem here - right?",
      "created_at": "2025-10-18T17:38:03Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442521884",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442521884"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442524173",
      "pull_request_review_id": 3347436866,
      "id": 2442524173,
      "node_id": "PRRC_kwDOABII586RlfYN",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 78,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This style of dynamic work-stealing seems too complicated for such a uniform problem - static slicing would likely be a lot simpler and I would expect it to perform equally well.\r\n\r\nI also realize that some of these are needed to avoid recreating the threads for every call. Currently the parallelism and the thread recreation are done in a single commit - could we first implement multithreading with thread recreation, and do the thread reuse as a separate concern (though a `ThreadPool` with dedicated test)?",
      "created_at": "2025-10-18T17:41:16Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442524173",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442524173"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 76,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442538377",
      "pull_request_review_id": 3347436866,
      "id": 2442538377,
      "node_id": "PRRC_kwDOABII586Rli2J",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\n                Coin coin{};\n                assert(coin.IsSpent());\n```",
      "created_at": "2025-10-18T18:09:31Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442538377",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442538377"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 131,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446494738",
      "pull_request_review_id": 3347436866,
      "id": 2446494738,
      "node_id": "PRRC_kwDOABII586R0owS",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 96,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Would this suffice?\r\n```suggestion\r\n            (void)m_complete_barrier.arrive();\r\n```",
      "created_at": "2025-10-21T01:23:08Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2446494738",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446494738"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 96,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446502718",
      "pull_request_review_id": 3347436866,
      "id": 2446502718,
      "node_id": "PRRC_kwDOABII586R0qs-",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_block = &block;\n+        m_txids.clear();\n+        m_inputs.clear();\n+\n+        // Loop through the inputs of the block and add them to the queue.\n+        // Construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            for (size_t j{0}; j < block.vtx[i]->vin.size(); ++j) {\n+                m_inputs.emplace_back(i, j);\n+            }\n+            m_txids.emplace(block.vtx[i]->GetHash());\n+        }\n+\n+        // Set the input counter and wake threads.\n+        m_input_counter.store(0, std::memory_order_relaxed);\n+        m_start_semaphore.release(m_worker_threads.size());\n+\n+        // Have the main thread work too before we wait for other threads\n+        Work(m_worker_threads.size());\n+        m_complete_barrier.arrive_and_wait();",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 190,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What's the reason for not doing the completion here instead of the `OnCompletion` workaround?\n```suggestion\n        m_complete_barrier.arrive_and_wait();\n        for (auto& coins : m_coins) {\n            for (auto& [outpoint, coin] : coins) {\n                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n            }\n            coins.clear();\n        }\n```",
      "created_at": "2025-10-21T01:29:43Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2446502718",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446502718"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 190,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446503935",
      "pull_request_review_id": 3347436866,
      "id": 2446503935,
      "node_id": "PRRC_kwDOABII586R0q__",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`std::ptrdiff_t` seems more appropriate here: https://en.cppreference.com/w/cpp/thread/barrier/barrier.html\n```suggestion\n    explicit InputFetcher(size_t worker_thread_count) noexcept : m_complete_barrier{std::ptrdiff_t(worker_thread_count + 1)}\n```",
      "created_at": "2025-10-21T01:30:57Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2446503935",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446503935"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 148,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448545244",
      "pull_request_review_id": 3347436866,
      "id": 2448545244,
      "node_id": "PRRC_kwDOABII586R8dXc",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "wouldn't `m_worker_threads.size() == 0` be an error?",
      "created_at": "2025-10-21T14:21:14Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448545244",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448545244"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448558350",
      "pull_request_review_id": 3347436866,
      "id": 2448558350,
      "node_id": "PRRC_kwDOABII586R8gkO",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I personally would favor going for simpler code as opposed to going for theoretically better encapsulation, similarly to current `inputfetcher_tests.cpp`:\n```C++\nstruct DelayedCoinsView : CCoinsView\n```",
      "created_at": "2025-10-21T14:24:37Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448558350",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448558350"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448561438",
      "pull_request_review_id": 3347436866,
      "id": 2448561438,
      "node_id": "PRRC_kwDOABII586R8hUe",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We can add better assertions if we count the iterator size here:\r\n```C++\r\nbool BatchWrite(CoinsViewCacheCursor& cursor, const uint256&) override\r\n{\r\n    for (auto it{cursor.Begin()}; it != cursor.End(); it = cursor.NextAndMaybeErase(*it)) {\r\n        m_write_count++;\r\n    }\r\n    return true;\r\n}\r\n```\r\nSo the bench could be (without flush which makes the bench runs equivalent):\r\n```C++\r\nbench.run([&] {\r\n    CCoinsViewCache block_cache{&cache};\r\n    fetcher.FetchInputs(cache, block_cache, db, block);\r\n    assert(db.m_write_count == 0 && cache.GetCacheSize() == 0 && block_cache.GetCacheSize() == 4599);\r\n});\r\n```",
      "created_at": "2025-10-21T14:25:37Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448561438",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448561438"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448577697",
      "pull_request_review_id": 3347436866,
      "id": 2448577697,
      "node_id": "PRRC_kwDOABII586R8lSh",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Given that we already create the actual temporary top cache here, it would be great if we could separate the reading and writing (read from old/big in-memory cache and write to the temporary small one):\r\n```C++\r\nCCoinsViewCache* cache{&CoinsTip()};\r\nCCoinsViewCache new_cache{cache};\r\nm_chainman.FetchInputs(*cache, new_cache, CoinsDB(), *block_to_connect);\r\n```\r\n\r\nThis would also mean that the actually read changes are read after that from the top-layer cache instead of always requiring two hops (assuming many missing ones). It also makes sense to not add inputs from blocks that fail validation - which we'd be getting for free this way.",
      "created_at": "2025-10-21T14:30:23Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448577697",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448577697"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3140,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469585296",
      "pull_request_review_id": 3388785294,
      "id": 2469585296,
      "node_id": "PRRC_kwDOABII586TMuGQ",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);\n+\n         CCoinsViewCache view(&CoinsTip());",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 6,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442436064,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T13:30:03Z",
      "updated_at": "2025-10-28T13:30:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469585296",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469585296"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 3140,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 3142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469589719",
      "pull_request_review_id": 3388791537,
      "id": 2469589719,
      "node_id": "PRRC_kwDOABII586TMvLX",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 150,
      "original_position": 153,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442488159,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The InputFetcher is stateful, so this is making sure previous state does not leak into the next fetch phase.",
      "created_at": "2025-10-28T13:31:25Z",
      "updated_at": "2025-10-28T13:31:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469589719",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469589719"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 150,
      "original_line": 150,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469606414",
      "pull_request_review_id": 3388813847,
      "id": 2469606414,
      "node_id": "PRRC_kwDOABII586TMzQO",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+public:\n+\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_block = &block;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 153,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442499107,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Indeed, this would be gracefully solved with https://github.com/bitcoin/bitcoin/pull/33689. We could pass all state into the worker threads via lambda capture.",
      "created_at": "2025-10-28T13:36:14Z",
      "updated_at": "2025-10-28T13:36:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469606414",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469606414"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 151,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 153,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469609534",
      "pull_request_review_id": 3388818232,
      "id": 2469609534,
      "node_id": "PRRC_kwDOABII586TM0A-",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442502361,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why not? The InputFetcher should not make assumptions about the structure of the block being passed in.",
      "created_at": "2025-10-28T13:37:05Z",
      "updated_at": "2025-10-28T13:37:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469609534",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469609534"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469616204",
      "pull_request_review_id": 3388827732,
      "id": 2469616204,
      "node_id": "PRRC_kwDOABII586TM1pM",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442506743,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why don't we want different benchmarks on different machines? All benchmarks are subtly different depending on the host machine.",
      "created_at": "2025-10-28T13:38:54Z",
      "updated_at": "2025-10-28T13:38:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469616204",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469616204"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 46,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469618569",
      "pull_request_review_id": 3388831117,
      "id": 2469618569,
      "node_id": "PRRC_kwDOABII586TM2OJ",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};\n+\n+    bench.run([&] {\n+        const auto ok{cache.Flush()};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442508359,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Fixed in latest iteration.",
      "created_at": "2025-10-28T13:39:40Z",
      "updated_at": "2025-10-28T13:39:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469618569",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469618569"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469625970",
      "pull_request_review_id": 3388841516,
      "id": 2469625970,
      "node_id": "PRRC_kwDOABII586TM4By",
      "diff_hunk": "@@ -6265,6 +6267,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{std::clamp<size_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442511181,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "0 threads means it is turned off, yes. If `-par=1` is configured, we want to pass 0 to input fetcher to disable prefetching. Also if `options.worker_threads_num` was negative for some reason. Do you have a suggestion of how this can be made more clear?",
      "created_at": "2025-10-28T13:41:30Z",
      "updated_at": "2025-10-28T13:42:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469625970",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469625970"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6302,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469631434",
      "pull_request_review_id": 3388848844,
      "id": 2469631434,
      "node_id": "PRRC_kwDOABII586TM5XK",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 113,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442521884,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Possibly.\r\nThis is no longer relevant in the current implementation.",
      "created_at": "2025-10-28T13:43:01Z",
      "updated_at": "2025-10-28T13:43:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469631434",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469631434"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469638986",
      "pull_request_review_id": 3388860309,
      "id": 2469638986,
      "node_id": "PRRC_kwDOABII586TM7NK",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448545244,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "No, we can have no worker threads, for instance if started with `-par=1`. In that case just disable prefetching.",
      "created_at": "2025-10-28T13:44:51Z",
      "updated_at": "2025-10-28T13:44:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469638986",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469638986"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469655686",
      "pull_request_review_id": 3388889093,
      "id": 2469655686,
      "node_id": "PRRC_kwDOABII586TM_SG",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "When do we do a batch write though in this example?",
      "created_at": "2025-10-28T13:49:46Z",
      "updated_at": "2025-10-28T13:49:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469655686",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469655686"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469658436",
      "pull_request_review_id": 3388892165,
      "id": 2469658436,
      "node_id": "PRRC_kwDOABII586TM_9E",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448577697,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T13:50:24Z",
      "updated_at": "2025-10-28T13:50:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469658436",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469658436"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3140,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469691257",
      "pull_request_review_id": 3388935705,
      "id": 2469691257,
      "node_id": "PRRC_kwDOABII586TNH95",
      "diff_hunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * It loops through the block and writes all input indexes to a\n+ * vector. It then assigns itself an input from the vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * a different vector. Once all inputs are fetched, it writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 35,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "063946d6bd78035276d12e070a208d84492ac5cd",
      "in_reply_to_id": 2437808988,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done, using uint32_t in the Input struct now, not sure if it will have any effect in the struct though.",
      "created_at": "2025-10-28T13:59:24Z",
      "updated_at": "2025-10-28T13:59:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469691257",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469691257"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 35,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469694470",
      "pull_request_review_id": 3388940589,
      "id": 2469694470,
      "node_id": "PRRC_kwDOABII586TNIwG",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498069,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:04Z",
      "updated_at": "2025-10-28T14:00:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469694470",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469694470"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 44,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 49,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695146",
      "pull_request_review_id": 3388941480,
      "id": 2469695146,
      "node_id": "PRRC_kwDOABII586TNI6q",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 24,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498819,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:12Z",
      "updated_at": "2025-10-28T14:00:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469695146",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695146"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695839",
      "pull_request_review_id": 3388942384,
      "id": 2469695839,
      "node_id": "PRRC_kwDOABII586TNJFf",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 29,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498626,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:19Z",
      "updated_at": "2025-10-28T14:00:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469695839",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695839"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 29,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469696287",
      "pull_request_review_id": 3388943033,
      "id": 2469696287,
      "node_id": "PRRC_kwDOABII586TNJMf",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 26,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498338,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:25Z",
      "updated_at": "2025-10-28T14:00:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469696287",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469696287"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 21,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469697562",
      "pull_request_review_id": 3388945347,
      "id": 2469697562,
      "node_id": "PRRC_kwDOABII586TNJga",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 39,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442505074,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:43Z",
      "updated_at": "2025-10-28T14:00:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469697562",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469697562"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 37,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469698872",
      "pull_request_review_id": 3388947368,
      "id": 2469698872,
      "node_id": "PRRC_kwDOABII586TNJ04",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442538377,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:01:00Z",
      "updated_at": "2025-10-28T14:01:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469698872",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469698872"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 131,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469699476",
      "pull_request_review_id": 3388948249,
      "id": 2469699476,
      "node_id": "PRRC_kwDOABII586TNJ-U",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448558350,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:01:08Z",
      "updated_at": "2025-10-28T14:01:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469699476",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469699476"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469710016",
      "pull_request_review_id": 3388965041,
      "id": 2469710016,
      "node_id": "PRRC_kwDOABII586TNMjA",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 40,
      "original_position": 41,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442481463,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Does this mean the spent tx is never processed on the same thread currently?\r\n\r\nI don't think that's what it means. The same thread could fetch two inputs in a row.\r\n\r\n> Maybe we can mix it up a bit by something like\r\n\r\nSo we can use the same prevhash in difference txs? What is the benefit of this?",
      "created_at": "2025-10-28T14:04:05Z",
      "updated_at": "2025-10-28T14:04:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469710016",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469710016"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 40,
      "original_line": 40,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469713772",
      "pull_request_review_id": 3388970527,
      "id": 2469713772,
      "node_id": "PRRC_kwDOABII586TNNds",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 78,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442524173,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It should be simpler now. I'm not sure if this comment is still valid though with the current approach. I agree if we already had a ThreadPool this would be much cleaner.",
      "created_at": "2025-10-28T14:05:10Z",
      "updated_at": "2025-10-28T14:05:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469713772",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469713772"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 76,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470247644",
      "pull_request_review_id": 3389722061,
      "id": 2470247644,
      "node_id": "PRRC_kwDOABII586TPPzc",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Originally we flushed, so if we still want to, we may want to extend this to assert that behavior. Or avoid flushing and simplify the bench. Or add the flushing behavior above to a test, etc.",
      "created_at": "2025-10-28T16:28:43Z",
      "updated_at": "2025-10-28T16:28:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470247644",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470247644"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470254148",
      "pull_request_review_id": 3389731253,
      "id": 2470254148,
      "node_id": "PRRC_kwDOABII586TPRZE",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442502361,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Even consensus invalid ones? Or did I misunderstand the context here?",
      "created_at": "2025-10-28T16:30:48Z",
      "updated_at": "2025-10-28T16:30:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470254148",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470254148"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470260510",
      "pull_request_review_id": 3389741417,
      "id": 2470260510,
      "node_id": "PRRC_kwDOABII586TPS8e",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442506743,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yeah, but we want to understand where the differences are coming from, otherwise we'd have the \"faster-on-my-machine\" syndrome. If you disagree, just resolve the issue.",
      "created_at": "2025-10-28T16:32:30Z",
      "updated_at": "2025-10-28T16:32:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470260510",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470260510"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 46,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470278073",
      "pull_request_review_id": 3389766524,
      "id": 2470278073,
      "node_id": "PRRC_kwDOABII586TPXO5",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We avoid flushing now.",
      "created_at": "2025-10-28T16:37:44Z",
      "updated_at": "2025-10-28T16:37:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470278073",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470278073"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470280988",
      "pull_request_review_id": 3389771134,
      "id": 2470280988,
      "node_id": "PRRC_kwDOABII586TPX8c",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442502361,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yeah, InputFetcher doesn't know if a block is consensus valid or not yet. It hasn't passed `ConnectBlock` yet before entering here.",
      "created_at": "2025-10-28T16:38:48Z",
      "updated_at": "2025-10-28T16:38:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470280988",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470280988"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470285353",
      "pull_request_review_id": 3389779624,
      "id": 2470285353,
      "node_id": "PRRC_kwDOABII586TPZAp",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 28,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: we could throw now to indicate we don't have unrepeatable side-effects",
      "created_at": "2025-10-28T16:40:19Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470285353",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470285353"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470286368",
      "pull_request_review_id": 3389779624,
      "id": 2470286368,
      "node_id": "PRRC_kwDOABII586TPZQg",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Nit: structs are now formatted consistently on the same line",
      "created_at": "2025-10-28T16:40:43Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470286368",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470286368"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484846327",
      "pull_request_review_id": 3389779624,
      "id": 2484846327,
      "node_id": "PRRC_kwDOABII586UG773",
      "diff_hunk": "@@ -474,6 +482,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     //! See: https://stackoverflow.com/questions/42114044/how-to-release-unordered-map-memory\n     void ReallocateCache();\n \n+    /**\n+     * Reserve enough space in the cache so the underlying unordered_map will\n+     * not have to rehash unless capacity is exceeded.\n+     */\n+    void Reserve(size_t capacity) {",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Nit: can you please reformat the change with latest clang-format after rebase?\r\nNit2: this seems to belong closer to `GetCacheSize`, one reserves, the other returns the actual size\r\n",
      "created_at": "2025-11-02T14:39:32Z",
      "updated_at": "2025-11-02T20:33:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484846327",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484846327"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 489,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484851139",
      "pull_request_review_id": 3389779624,
      "id": 2484851139,
      "node_id": "PRRC_kwDOABII586UG9HD",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I like that we're doing this, we've usually avoided preallocating our maps - we should do it more often!\r\n\r\n-----\r\n\r\nI know we're providing empty caches via the parameters, but for completeness either assert that they're empty or:\r\n\r\n```suggestion\r\n        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\r\n```\r\n\r\n----\r\n\r\nI have added\r\n```C++\r\n        Assert(temp_cache.GetCacheSize() <= temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\r\n```\r\nafter the `for (auto& input : m_inputs) {` loop to validate that the allocation achieves - the tests pass! ðŸ‘ ",
      "created_at": "2025-11-02T14:50:44Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484851139",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484851139"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484854164",
      "pull_request_review_id": 3389779624,
      "id": 2484854164,
      "node_id": "PRRC_kwDOABII586UG92U",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we're also just adding stuff to the `m_inputs` without any reservation, the first few times we will have some needless copying - we could likely alleviate that by doing a rough reservation\r\n```C++\r\n        m_txids.reserve(block.vtx.size());\r\n        m_inputs.reserve(2 * block.vtx.size()); // rough guess\r\n```",
      "created_at": "2025-11-02T14:57:38Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484854164",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484854164"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484858152",
      "pull_request_review_id": 3389779624,
      "id": 2484858152,
      "node_id": "PRRC_kwDOABII586UG-0o",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I understand if you don't want to bother with this, but how many of these do we expect per block?\r\nI wonder if we want to incur the hashing cost here or if using a sorted set or a sorted vector with `std::binary_search` (or even (unsorted?) SIMD-enabled linear scan) would be faster or simpler here.\r\n\r\nI also thought of whether we could just add these to `temp_cache` directly, but that would likely pollute the up-coming validation (unless we can differentiate these from existing inputs).\r\n\r\n----\r\n\r\nTaking `block413567`, we can assuming for the benchmark that 5% of the txs are internal spends (we need to measure this properly before we decide) and assuming 1556 txs (4886 inputs, 3581 outputs), 287 internal spends, we can compare the alternatives, here's a bench for motivation.\r\n\r\n<details>\r\n<summary>Benchmark comparing the miss and hit count of Txid_SetOrdered, Txid_UnorderedSalted, Txid_VectorBinarySearch, Txid_VectorLinearScan</summary>\r\n\r\n```C++\r\n// Copyright (c) 2022-present The Bitcoin Core developers\r\n// Distributed under the MIT software license, see the accompanying\r\n// file COPYING or https://www.opensource.org/licenses/mit-license.php.\r\n\r\n#include <bench/bench.h>\r\n#include <bench/nanobench.h>\r\n#include <primitives/transaction_identifier.h>\r\n#include <random.h>\r\n#include <util/check.h>\r\n#include <util/hasher.h>\r\n\r\n#include <algorithm>\r\n#include <ranges>\r\n#include <set>\r\n#include <unordered_set>\r\n#include <vector>\r\n\r\nnamespace {\r\n\r\nconstexpr size_t iterations{100}; // since the inputs of the benchmarks are mutated by sorting, we can't rerun the benchmarks\r\nconstexpr size_t hits_count{275}; // assuming ~5% of blocks contain internal spends\r\nconstexpr size_t tx_count{5500};\r\n\r\nstruct Dataset {\r\n    std::set<Txid> sorted_set;\r\n    std::unordered_set<Txid, SaltedTxidHasher> unsorted_set;\r\n    std::vector<Txid> vec_sorted;\r\n    std::vector<Txid> vec_unsorted;\r\n\r\n    std::vector<Txid> queries;\r\n};\r\n\r\nstd::vector<Dataset> BuildDatasets()\r\n{\r\n    FastRandomContext rng(/*fDeterministic=*/true);\r\n\r\n    std::vector<Dataset> datasets;\r\n    datasets.reserve(iterations);\r\n\r\n    for (size_t d{0}; d < iterations; ++d) {\r\n        Dataset ds;\r\n        ds.queries.reserve(tx_count);\r\n        ds.unsorted_set.reserve(tx_count);\r\n        ds.vec_sorted.reserve(tx_count);\r\n        ds.vec_unsorted.reserve(tx_count);\r\n\r\n        for (size_t i{0}; i < tx_count; ++i) {\r\n            Txid t{Txid::FromUint256(rng.rand256())};\r\n            ds.sorted_set.emplace(t);\r\n            ds.unsorted_set.emplace(t);\r\n            ds.vec_sorted.emplace_back(t);\r\n            ds.vec_unsorted.emplace_back(t);\r\n\r\n            ds.queries.emplace_back(i < hits_count ? t : Txid::FromUint256(rng.rand256()));\r\n        }\r\n\r\n        std::ranges::shuffle(ds.queries, rng);\r\n        std::ranges::shuffle(ds.vec_unsorted, rng);\r\n        std::sort(ds.vec_sorted.begin(), ds.vec_sorted.end());\r\n\r\n        datasets.emplace_back(std::move(ds));\r\n    }\r\n    return datasets;\r\n}\r\n\r\n} // namespace\r\n\r\nstatic void Txid_UnorderedSalted(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.unsorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_SetOrdered(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.sorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorBinarySearch(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += std::binary_search(s.vec_sorted.begin(), s.vec_sorted.end(), q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorLinearScan(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    const auto contains_linear{[](const std::vector<Txid>& v, const Txid& x) noexcept {\r\n        return std::ranges::find(v, x) != v.end();\r\n    }};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += contains_linear(s.vec_unsorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nBENCHMARK(Txid_UnorderedSalted, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_SetOrdered, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorBinarySearch, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorLinearScan, benchmark::PriorityLevel::LOW);\r\n```\r\n\r\n</details>\r\n\r\n```\r\ncmake -B build -DBUILD_BENCH=ON -DENABLE_IPC=OFF -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc) && build/bin/bench_bitcoin -filter='Txid_.*'\r\n```\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          217,247.09 |            4,603.05 |    0.0% |      0.02 | `Txid_SetOrdered`\r\n|          202,607.50 |            4,935.65 |    0.0% |      0.02 | `Txid_UnorderedSalted`\r\n|          194,347.91 |            5,145.41 |    0.0% |      0.02 | `Txid_VectorBinarySearch`\r\n|       12,449,880.83 |               80.32 |    0.0% |      1.24 | `Txid_VectorLinearScan`\r\n\r\n<details>\r\n<summary>Same measurement on an Rpi5 with GCC instead</summary>\r\n\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|        1,179,326.18 |              847.94 |    0.0% |    2,361,313.36 |    2,820,742.15 |  0.837 |     475,693.50 |    1.2% |      0.12 | `Txid_SetOrdered`\r\n|          912,335.48 |            1,096.09 |    0.0% |    1,346,377.49 |    2,183,167.97 |  0.617 |      84,874.38 |    5.7% |      0.09 | `Txid_UnorderedSalted`\r\n|          732,493.03 |            1,365.20 |    0.0% |    2,411,291.90 |    1,752,928.05 |  1.376 |     531,672.95 |    8.1% |      0.07 | `Txid_VectorBinarySearch`\r\n|       25,449,442.73 |               39.29 |    0.0% |  235,989,723.07 |   60,929,976.87 |  3.873 |  58,998,462.96 |    0.0% |      2.54 | `Txid_VectorLinearScan`\r\n\r\n</details>\r\n\r\n---\r\n\r\nSo the benchmark isn't as revealing as I was hoping, please verify my assumptions and we can still test these with some macro-benchmark to see if there's any performance or memory advantage to any of these.",
      "created_at": "2025-11-02T15:06:28Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484858152",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484858152"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484898679",
      "pull_request_review_id": 3389779624,
      "id": 2484898679,
      "node_id": "PRRC_kwDOABII586UHIt3",
      "diff_hunk": "@@ -173,6 +173,11 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const {",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This seems like a code smell that we should pay attention to. I have already brought this up a year ago in https://github.com/bitcoin/bitcoin/pull/30673#discussion_r1722286606, seems it keeps biting us.\r\nInstead of adding a new method that basically does the same, can we keep `GetCoin` to simply return the coin and move the spentness checks to the call sites?\r\nI understand that it would likely require another PR, but it would make this one cleaner - I don't like that we need a workaround for a scenario that isn't out of the ordinary.",
      "created_at": "2025-11-02T16:40:44Z",
      "updated_at": "2025-11-02T20:33:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484898679",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484898679"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905167",
      "pull_request_review_id": 3389779624,
      "id": 2484905167,
      "node_id": "PRRC_kwDOABII586UHKTP",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\r\n```suggestion\r\n            m_worker_threads.emplace_back([this, n] {\r\n```",
      "created_at": "2025-11-02T16:54:42Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484905167",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905167"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905870",
      "pull_request_review_id": 3389779624,
      "id": 2484905870,
      "node_id": "PRRC_kwDOABII586UHKeO",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 128,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\r\n    explicit InputFetcher(int32_t worker_thread_count) noexcept : m_barrier{(worker_thread_count + 1)}\r\n```\r\nthis would remove a few static casts",
      "created_at": "2025-11-02T16:56:03Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484905870",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905870"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 128,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484907043",
      "pull_request_review_id": 3389779624,
      "id": 2484907043,
      "node_id": "PRRC_kwDOABII586UHKwj",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 62,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\r\n```suggestion\r\n        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n```",
      "created_at": "2025-11-02T16:58:43Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484907043",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484907043"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 62,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484908114",
      "pull_request_review_id": 3389779624,
      "id": 2484908114,
      "node_id": "PRRC_kwDOABII586UHLBS",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 43,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "is the `alignas` a false sharing guard? Does it have a measurable effect?",
      "created_at": "2025-11-02T17:01:24Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484908114",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484908114"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484910336",
      "pull_request_review_id": 3389779624,
      "id": 2484910336,
      "node_id": "PRRC_kwDOABII586UHLkA",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;",
      "path": "src/inputfetcher.h",
      "position": 182,
      "original_position": 189,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't like that we need a separate field for this only, but I guess without `std::jthread` we have to do this manually.\r\n\r\nSince this field isn't checked on every iteration, only once per thread per job as far as I can tell, we could repurpose `m_input_head` and use it as\r\n```C++\r\nalignas(64) std::atomic_int32_t m_input_head{0};\r\n...\r\nif (m_input_head.load(std::memory_order_acquire) < 0) [[unlikely]] {\r\n...\r\nm_input_head.store(-1, std::memory_order_relaxed);\r\n```",
      "created_at": "2025-11-02T17:05:35Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484910336",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484910336"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 182,
      "original_line": 182,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484912732",
      "pull_request_review_id": 3389779624,
      "id": 2484912732,
      "node_id": "PRRC_kwDOABII586UHMJc",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;\n+        m_barrier.arrive_and_wait();",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 190,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "not certain, but I think this should likely be:\r\n```suggestion\r\n        m_barrier.arrive_and_drop();\r\n```",
      "created_at": "2025-11-02T17:10:36Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484912732",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484912732"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 190,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484913752",
      "pull_request_review_id": 3389779624,
      "id": 2484913752,
      "node_id": "PRRC_kwDOABII586UHMZY",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I understand that this poison pill broadcast is needed to stop execution when errors occur - but I'm not sure we should care here about fetching error, I think we should just try to continue if that makes the code simpler",
      "created_at": "2025-11-02T17:13:06Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484913752",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484913752"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484927472",
      "pull_request_review_id": 3389779624,
      "id": 2484927472,
      "node_id": "PRRC_kwDOABII586UHPvw",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 91,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't mind the `unlikely` parts but we're barely using them in the code, they have some weird side-effects when merged - which may not be the case here, so I'm fine wither way, if nothing else, it documents the usage",
      "created_at": "2025-11-02T17:47:41Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484927472",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484927472"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928036",
      "pull_request_review_id": 3389779624,
      "id": 2484928036,
      "node_id": "PRRC_kwDOABII586UHP4k",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm surprised synchronized insertion is faster than collecting them in a lock-free way - guess it's all the copying, but we should be able to avoid that, I don't like that we're locking again",
      "created_at": "2025-11-02T17:49:27Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484928036",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928036"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928411",
      "pull_request_review_id": 3389779624,
      "id": 2484928411,
      "node_id": "PRRC_kwDOABII586UHP-b",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "as mentioned before, is `FAILED` an important state for the fetcher? Why not just debug/warn log and continue?",
      "created_at": "2025-11-02T17:50:14Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484928411",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928411"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931397",
      "pull_request_review_id": 3389779624,
      "id": 2484931397,
      "node_id": "PRRC_kwDOABII586UHQtF",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 104,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "hmm, code states it's likely, but the new tests are passing with:\r\n```C++\r\nif (!input.coin.IsSpent()) {\r\n    throw \"\";\r\n}\r\n```",
      "created_at": "2025-11-02T17:57:09Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484931397",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931397"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 104,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931836",
      "pull_request_review_id": 3389779624,
      "id": 2484931836,
      "node_id": "PRRC_kwDOABII586UHQz8",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448545244,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Not a biggy, but this also seems uncovered by the unit tests.",
      "created_at": "2025-11-02T17:58:11Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484931836",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931836"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484932388",
      "pull_request_review_id": 3389779624,
      "id": 2484932388,
      "node_id": "PRRC_kwDOABII586UHQ8k",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 24,
      "original_position": 25,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think the test belongs with the implementation, I need it to be able to review the first commit (otherwise it's just dead code, with the tests it has at least a test user)",
      "created_at": "2025-11-02T17:59:35Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484932388",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484932388"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 24,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484934183",
      "pull_request_review_id": 3389779624,
      "id": 2484934183,
      "node_id": "PRRC_kwDOABII586UHRYn",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 21,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: some of these seem unused:\r\n```suggestion\r\n#include <memory>\r\n#include <stdexcept>\r\n#include <unordered_set>\r\n```",
      "created_at": "2025-11-02T18:02:22Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484934183",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484934183"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 17,
      "original_start_line": 17,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484936325",
      "pull_request_review_id": 3389779624,
      "id": 2484936325,
      "node_id": "PRRC_kwDOABII586UHR6F",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think we could still add\r\n```C++\r\n        ankerl::nanobench::doNotOptimizeAway(&temp_cache);\r\n        Assert(temp_cache.GetCacheSize() == 4599);\r\n```\r\nto document that the benchmark can loop now (i.e. every iteration should be the same)",
      "created_at": "2025-11-02T18:08:21Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484936325",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484936325"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484980972",
      "pull_request_review_id": 3389779624,
      "id": 2484980972,
      "node_id": "PRRC_kwDOABII586UHczs",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "hmm, how does this even compile?",
      "created_at": "2025-11-02T20:03:47Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484980972",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484980972"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484994822",
      "pull_request_review_id": 3389779624,
      "id": 2484994822,
      "node_id": "PRRC_kwDOABII586UHgMG",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 43,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't have a good fuzzer locally - does this cover all the new code?",
      "created_at": "2025-11-02T20:24:54Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484994822",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484994822"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484996439",
      "pull_request_review_id": 3389779624,
      "id": 2484996439,
      "node_id": "PRRC_kwDOABII586UHglX",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 105,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The comments indicate that you also don't think this code is very intuitive - I'm also a bit lost here, can we simplify this somehow? I don't even understand what \"release\" means here or why both branches result in `Status::READY` (can we unify them) or what happens if the first internal `if` isn't fulfilled, or the outer one or the else, etc. The branching + `continue` + try/catch doesn't help",
      "created_at": "2025-11-02T20:28:55Z",
      "updated_at": "2025-11-02T20:46:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484996439",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484996439"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 105,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485033847",
      "pull_request_review_id": 3409041873,
      "id": 2485033847,
      "node_id": "PRRC_kwDOABII586UHpt3",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I did try and use a sorted vector and do binary search in the workers, but it was not a measurable performance difference. In theory it should be faster since txid comparison is much faster than siphash. I can do this if you want, but I think it makes the code clearer using the `unordered_set`.",
      "created_at": "2025-11-02T21:38:15Z",
      "updated_at": "2025-11-02T21:38:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485033847",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485033847"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485039220",
      "pull_request_review_id": 3409047007,
      "id": 2485039220,
      "node_id": "PRRC_kwDOABII586UHrB0",
      "diff_hunk": "@@ -173,6 +173,11 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const {",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484898679,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is a consequence of skipping the main cache and writing directly to the temp cache.\r\n\r\nI don't think we can modify `GetCoin` to not return spent coins, it's part of the definition [Retrieve the Coin (unspent transaction output) for a given outpoint.](https://github.com/bitcoin/bitcoin/blob/master/src/coins.h#L310). This also goes backwards from your change https://github.com/bitcoin/bitcoin/pull/30849 where you added TODOs to not return spent coins where our test `GetCoin`s do. I don't think a PR to return spent coins from `GetCoin` would get enough support to be merged.\r\n\r\nIf `GetCoin` could return spent coins, we would also not be able to use it until we call `HaveCoinInCache`. This is because even though `GetCoin` is `const`, it modifies `cacheCoins` internally (which has the `mutable` modifier for this purpose). But, `HaveCoinInCache` also returns false if the coin is spent, so we would need to modify that. So, we would have 2 methods change and we would also then have to do 2 lookups. This method is very simple and very much defined for this special purpose, similar to `EmplaceCoinInCacheDANGER`.\r\n\r\nI'm open to other suggestions, but modifying `GetCoin` (and then `HaveCoinInCache`) doesn't seem like the way.",
      "created_at": "2025-11-02T21:52:21Z",
      "updated_at": "2025-11-02T21:52:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485039220",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485039220"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040051",
      "pull_request_review_id": 3409047688,
      "id": 2485040051,
      "node_id": "PRRC_kwDOABII586UHrOz",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 43,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484908114,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It was for false sharing. I don't think it has a measurable effect, but it might on some systems? I think it's harmless to keep, since there's only one InputFetcher.",
      "created_at": "2025-11-02T21:54:23Z",
      "updated_at": "2025-11-02T21:54:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485040051",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040051"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040642",
      "pull_request_review_id": 3409048208,
      "id": 2485040642,
      "node_id": "PRRC_kwDOABII586UHrYC",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;",
      "path": "src/inputfetcher.h",
      "position": 182,
      "original_position": 189,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484910336,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think that's actually preferable. The current way is more readable IMO.",
      "created_at": "2025-11-02T21:55:58Z",
      "updated_at": "2025-11-02T21:55:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485040642",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040642"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 182,
      "original_line": 182,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485042527",
      "pull_request_review_id": 3409049863,
      "id": 2485042527,
      "node_id": "PRRC_kwDOABII586UHr1f",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There are no locks... This is a lock free implementation. It is synchronized with atomics per input, and the threads are work stealing via the `m_input_head`. Or do you mean something else?",
      "created_at": "2025-11-02T22:00:54Z",
      "updated_at": "2025-11-02T22:00:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485042527",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485042527"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485043525",
      "pull_request_review_id": 3409050730,
      "id": 2485043525,
      "node_id": "PRRC_kwDOABII586UHsFF",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928411,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We can't have the main thread insert a failed fetch. The coin will not be updated. I suppose the main thread could check if the coin is unspent.\r\nWe want to exit ASAP as well if we can't find an input, so we need to signal the main thread that they should exit the loop.",
      "created_at": "2025-11-02T22:03:22Z",
      "updated_at": "2025-11-02T22:03:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485043525",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485043525"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485058898",
      "pull_request_review_id": 3409078087,
      "id": 2485058898,
      "node_id": "PRRC_kwDOABII586UHv1S",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In `ConnectBlock` if we encounter a missing input we abort validation immediately. It is wasted work to continue. Why should we do it here?",
      "created_at": "2025-11-02T22:30:38Z",
      "updated_at": "2025-11-02T22:30:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485058898",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485058898"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485063519",
      "pull_request_review_id": 3409082555,
      "id": 2485063519,
      "node_id": "PRRC_kwDOABII586UHw9f",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 104,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484931397,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Right, didn't cover this new happy path in tests. Unlikely case is covered though. Will add. Thanks.",
      "created_at": "2025-11-02T22:42:10Z",
      "updated_at": "2025-11-02T22:42:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485063519",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485063519"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 104,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073051",
      "pull_request_review_id": 3409091421,
      "id": 2485073051,
      "node_id": "PRRC_kwDOABII586UHzSb",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 21,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": 2484934183,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`<cstdint>` we need because we use `int32_t`.\r\n",
      "created_at": "2025-11-02T23:04:33Z",
      "updated_at": "2025-11-02T23:04:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485073051",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073051"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 17,
      "original_start_line": 17,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073570",
      "pull_request_review_id": 3409092042,
      "id": 2485073570,
      "node_id": "PRRC_kwDOABII586UHzai",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 43,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484994822,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, I need to fuzz it though myself. The CI is fuzzing it a little bit.",
      "created_at": "2025-11-02T23:05:58Z",
      "updated_at": "2025-11-02T23:05:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485073570",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073570"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074194",
      "pull_request_review_id": 3409092724,
      "id": 2485074194,
      "node_id": "PRRC_kwDOABII586UHzkS",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484854164,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This won't have a measurable effect if we are connecting lots of blocks though.",
      "created_at": "2025-11-02T23:07:35Z",
      "updated_at": "2025-11-02T23:07:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485074194",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074194"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074795",
      "pull_request_review_id": 3409093788,
      "id": 2485074795,
      "node_id": "PRRC_kwDOABII586UHztr",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 28,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470285353,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We could just get rid of this line now.",
      "created_at": "2025-11-02T23:08:46Z",
      "updated_at": "2025-11-02T23:08:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485074795",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074795"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086517",
      "pull_request_review_id": 3409112313,
      "id": 2485086517,
      "node_id": "PRRC_kwDOABII586UH2k1",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 28,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470285353,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Got rid of it.",
      "created_at": "2025-11-02T23:31:57Z",
      "updated_at": "2025-11-02T23:31:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086517",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086517"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086567",
      "pull_request_review_id": 3409112362,
      "id": 2485086567,
      "node_id": "PRRC_kwDOABII586UH2ln",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470286368,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:32:03Z",
      "updated_at": "2025-11-02T23:32:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086567",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086567"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086761",
      "pull_request_review_id": 3409112526,
      "id": 2485086761,
      "node_id": "PRRC_kwDOABII586UH2op",
      "diff_hunk": "@@ -474,6 +482,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     //! See: https://stackoverflow.com/questions/42114044/how-to-release-unordered-map-memory\n     void ReallocateCache();\n \n+    /**\n+     * Reserve enough space in the cache so the underlying unordered_map will\n+     * not have to rehash unless capacity is exceeded.\n+     */\n+    void Reserve(size_t capacity) {",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484846327,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I couldn't get `clang-format` to work, but I made this a one-liner and moved under `GetCacheSize`.",
      "created_at": "2025-11-02T23:32:27Z",
      "updated_at": "2025-11-02T23:32:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086761",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086761"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 489,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086827",
      "pull_request_review_id": 3409112593,
      "id": 2485086827,
      "node_id": "PRRC_kwDOABII586UH2pr",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484851139,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:32:36Z",
      "updated_at": "2025-11-02T23:32:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086827",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086827"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087021",
      "pull_request_review_id": 3409113306,
      "id": 2485087021,
      "node_id": "PRRC_kwDOABII586UH2st",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484854164,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Did it anyways.",
      "created_at": "2025-11-02T23:33:00Z",
      "updated_at": "2025-11-02T23:33:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087021",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087021"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087120",
      "pull_request_review_id": 3409113407,
      "id": 2485087120,
      "node_id": "PRRC_kwDOABII586UH2uQ",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484905167,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:12Z",
      "updated_at": "2025-11-02T23:33:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087120",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087120"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087167",
      "pull_request_review_id": 3409113449,
      "id": 2485087167,
      "node_id": "PRRC_kwDOABII586UH2u_",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 128,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484905870,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:18Z",
      "updated_at": "2025-11-02T23:33:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087167",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087167"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 128,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087197",
      "pull_request_review_id": 3409113489,
      "id": 2485087197,
      "node_id": "PRRC_kwDOABII586UH2vd",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 62,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484907043,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:24Z",
      "updated_at": "2025-11-02T23:33:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087197",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087197"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 62,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087251",
      "pull_request_review_id": 3409113526,
      "id": 2485087251,
      "node_id": "PRRC_kwDOABII586UH2wT",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 43,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484908114,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Removed it.",
      "created_at": "2025-11-02T23:33:31Z",
      "updated_at": "2025-11-02T23:33:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087251",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087251"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087341",
      "pull_request_review_id": 3409113615,
      "id": 2485087341,
      "node_id": "PRRC_kwDOABII586UH2xt",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;\n+        m_barrier.arrive_and_wait();",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 190,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484912732,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:45Z",
      "updated_at": "2025-11-02T23:33:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087341",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087341"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 190,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087547",
      "pull_request_review_id": 3409113833,
      "id": 2485087547,
      "node_id": "PRRC_kwDOABII586UH207",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 24,
      "original_position": 25,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": 2484932388,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:34:20Z",
      "updated_at": "2025-11-02T23:34:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087547",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087547"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 24,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087694",
      "pull_request_review_id": 3409114014,
      "id": 2485087694,
      "node_id": "PRRC_kwDOABII586UH23O",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484980972,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Fixed. But, it wouldn't affect the correctness of the test.",
      "created_at": "2025-11-02T23:34:42Z",
      "updated_at": "2025-11-02T23:34:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087694",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087694"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087978",
      "pull_request_review_id": 3409114255,
      "id": 2485087978,
      "node_id": "PRRC_kwDOABII586UH27q",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 105,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484996439,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Rewrote this part to make it more clear. I was trying to be clever by avoiding some extra checks, but they are probably meaningless and clarity is better here.",
      "created_at": "2025-11-02T23:35:19Z",
      "updated_at": "2025-11-02T23:35:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087978",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087978"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 105,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485157101",
      "pull_request_review_id": 3409208596,
      "id": 2485157101,
      "node_id": "PRRC_kwDOABII586UIHzt",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I wrote benchmarks to check how fast it was to construct, since this is the work that is done not in parallel:\r\n\r\n```C++\r\nstatic void SortedVectorBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n    std::vector<Txid> v{};\r\n    v.reserve(block.vtx.size());\r\n\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(tx->GetHash());\r\n        }\r\n        std::sort(v.begin(), v.end());\r\n    });\r\n}\r\n\r\nstatic void UnorderedSetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n    std::unordered_set<Txid, SaltedTxidHasher> u{};\r\n    u.reserve(block.vtx.size());\r\n\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(tx->GetHash());\r\n        }\r\n    });\r\n}\r\n\r\nstatic void SetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n    std::set<Txid> s{};\r\n\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(tx->GetHash());\r\n        }\r\n    });\r\n}\r\n```\r\n\r\nResults:\r\n```\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|           45,794.65 |           21,836.61 |    1.6% |      777,851.91 |      110,515.70 |  7.038 |      88,000.15 |    0.5% |      0.01 | `UnorderedSetBenchmark`\r\n|           96,598.09 |           10,352.17 |    1.8% |      574,593.10 |      233,289.00 |  2.463 |     129,942.30 |    1.5% |      0.01 | `SetBenchmark`\r\n|        1,037,787.00 |              963.59 |    5.1% |   12,280,496.00 |    2,472,876.00 |  4.966 |   2,863,217.00 |    1.3% |      0.02 | :wavy_dash: `SortedVectorBenchmark` (Unstable with ~1.9 iters. Increase `minEpochIterations` to e.g. 19)\r\n```\r\n\r\nObviously we don't want to use the sorted vector. `unordered_set` is roughly twice as fast as `set`. I don't think it's worth pursuing a different filter container.",
      "created_at": "2025-11-03T01:42:49Z",
      "updated_at": "2025-11-03T01:42:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485157101",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485157101"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485569647",
      "pull_request_review_id": 3409770319,
      "id": 2485569647,
      "node_id": "PRRC_kwDOABII586UJshv",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think we should abort, it's not the fetcher's job to validate. If we didn't, we could even use short ids for the intra-block spends (64 bit likely won't even result in a single duplicate, and when they do collide we would just do a db check)",
      "created_at": "2025-11-03T07:44:08Z",
      "updated_at": "2025-11-03T07:44:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485569647",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485569647"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485572792",
      "pull_request_review_id": 3409774526,
      "id": 2485572792,
      "node_id": "PRRC_kwDOABII586UJtS4",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "atomics work via CAS, they need to retry in case of high contention. the previous solution didn't have contention, the threads all knew beforehand what to work on.",
      "created_at": "2025-11-03T07:46:00Z",
      "updated_at": "2025-11-03T07:46:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485572792",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485572792"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485575807",
      "pull_request_review_id": 3409778530,
      "id": 2485575807,
      "node_id": "PRRC_kwDOABII586UJuB_",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928411,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "that's my point, I don't think we should validate at all, it would simplify the code if we didn't ",
      "created_at": "2025-11-03T07:47:45Z",
      "updated_at": "2025-11-03T07:47:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485575807",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485575807"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485579371",
      "pull_request_review_id": 3409783658,
      "id": 2485579371,
      "node_id": "PRRC_kwDOABII586UJu5r",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484980972,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "how so? Can we assert the behavior of the main cache as well so that the previous version doesn't pass?",
      "created_at": "2025-11-03T07:49:18Z",
      "updated_at": "2025-11-03T07:49:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485579371",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485579371"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485697378",
      "pull_request_review_id": 3409948029,
      "id": 2485697378,
      "node_id": "PRRC_kwDOABII586UKLti",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470286368,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There are other ones that I didn't mention, reformatted the change, please take the ones that make sense:\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```patch\r\ndiff --git a/src/coins.cpp b/src/coins.cpp\r\nindex 2ef2e36ccc..baac1a32b5 100644\r\n--- a/src/coins.cpp\r\n+++ b/src/coins.cpp\r\n@@ -173,7 +173,8 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\r\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\r\n }\r\n \r\n-std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const noexcept {\r\n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept\r\n+{\r\n     if (auto it{cacheCoins.find(outpoint)}; it != cacheCoins.end()) return it->second.coin;\r\n     return std::nullopt;\r\n }\r\ndiff --git a/src/coins.h b/src/coins.h\r\nindex e7d28ace97..02c3ea9e15 100644\r\n--- a/src/coins.h\r\n+++ b/src/coins.h\r\n@@ -407,7 +407,7 @@ public:\r\n      * Used in InputFetcher to make sure we do not add a coin from the backing\r\n      * view when it is spent in the cache but not yet flushed to the parent.\r\n      */\r\n-    std::optional<Coin> GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const noexcept;\r\n+    std::optional<Coin> GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept;\r\n \r\n     /**\r\n      * Return a reference to Coin in the cache, or coinEmpty if not found. This is\r\ndiff --git a/src/inputfetcher.h b/src/inputfetcher.h\r\nindex a8a3f4d1ad..74c655caf1 100644\r\n--- a/src/inputfetcher.h\r\n+++ b/src/inputfetcher.h\r\n@@ -46,8 +46,8 @@ private:\r\n     struct Input {\r\n         enum class Status : uint8_t {\r\n             WAITING, // The coin has not been fetched yet\r\n-            READY, // The coin has been fetched and is ready to be inserted into the cache\r\n-            FAILED, // The coin failed to be fetched\r\n+            READY,   // The coin has been fetched and is ready to be inserted into the cache\r\n+            FAILED,  // The coin failed to be fetched\r\n             SKIPPED, // The coin is created and spent in the same block so cannot be fetched\r\n         };\r\n \r\ndiff --git a/src/test/fuzz/inputfetcher.cpp b/src/test/fuzz/inputfetcher.cpp\r\nindex cd2a0f5c68..70f5153912 100644\r\n--- a/src/test/fuzz/inputfetcher.cpp\r\n+++ b/src/test/fuzz/inputfetcher.cpp\r\n@@ -18,8 +18,7 @@\r\n \r\n using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\r\n \r\n-struct DbCoinsView : CCoinsView\r\n-{\r\n+struct DbCoinsView : CCoinsView {\r\n     DbMap& m_map;\r\n     DbCoinsView(DbMap& map) noexcept : m_map(map) {}\r\n \r\n@@ -35,8 +34,7 @@ struct DbCoinsView : CCoinsView\r\n     }\r\n };\r\n \r\n-struct NoAccessCoinsView : CCoinsView\r\n-{\r\n+struct NoAccessCoinsView : CCoinsView {\r\n     std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\r\n };\r\n \r\n@@ -49,7 +47,8 @@ FUZZ_TARGET(inputfetcher)\r\n         fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\r\n     InputFetcher fetcher{worker_threads};\r\n \r\n-    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\r\n+    {\r\n         CBlock block;\r\n         Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\r\n \r\n@@ -61,13 +60,13 @@ FUZZ_TARGET(inputfetcher)\r\n         NoAccessCoinsView back;\r\n         CCoinsViewCache main_cache(&back);\r\n \r\n-        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\r\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\r\n+        {\r\n             CMutableTransaction tx;\r\n \r\n-            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\r\n-                const auto txid{fuzzed_data_provider.ConsumeBool()\r\n-                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\r\n-                    : prevhash};\r\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10)\r\n+            {\r\n+                const auto txid{fuzzed_data_provider.ConsumeBool() ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider)) : prevhash};\r\n                 const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\r\n                 const COutPoint outpoint(txid, index);\r\n \r\n@@ -87,8 +86,8 @@ FUZZ_TARGET(inputfetcher)\r\n                     maybe_coin = std::nullopt;\r\n                 }\r\n                 db_map.try_emplace(outpoint, std::make_pair(\r\n-                    maybe_coin,\r\n-                    fuzzed_data_provider.ConsumeBool()));\r\n+                                                 maybe_coin,\r\n+                                                 fuzzed_data_provider.ConsumeBool()));\r\n \r\n                 // Add the coin to the cache\r\n                 if (fuzzed_data_provider.ConsumeBool()) {\r\ndiff --git a/src/test/inputfetcher_tests.cpp b/src/test/inputfetcher_tests.cpp\r\nindex 33fb8c6cb0..83f3d19432 100644\r\n--- a/src/test/inputfetcher_tests.cpp\r\n+++ b/src/test/inputfetcher_tests.cpp\r\n@@ -48,7 +48,7 @@ private:\r\n \r\n public:\r\n     explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\r\n-                             TestOpts opts = {})\r\n+                              TestOpts opts = {})\r\n         : BasicTestingSetup{chainType, opts}\r\n     {\r\n         SeedRandomForTest(SeedRand::FIXED_SEED);\r\n@@ -200,8 +200,7 @@ BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\r\n     }\r\n }\r\n \r\n-struct ThrowCoinsView : CCoinsView\r\n-{\r\n+struct ThrowCoinsView : CCoinsView {\r\n     std::optional<Coin> GetCoin(const COutPoint&) const override\r\n     {\r\n         throw std::runtime_error(\"database error\");\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 26141305cb..2ff7c5ef6d 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -1341,7 +1341,8 @@ public:\r\n     void RecalculateBestHeader() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     CCheckQueue<CScriptCheck>& GetCheckQueue() { return m_script_check_queue; }\r\n-    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& main_cache, const CCoinsView& db, const CBlock& block) noexcept {\r\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& main_cache, const CCoinsView& db, const CBlock& block) noexcept\r\n+    {\r\n         m_input_fetcher.FetchInputs(temp_cache, main_cache, db, block);\r\n     }\r\n```\r\n\r\n</details>",
      "created_at": "2025-11-03T08:44:19Z",
      "updated_at": "2025-11-03T08:44:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485697378",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485697378"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485772199",
      "pull_request_review_id": 3410060281,
      "id": 2485772199,
      "node_id": "PRRC_kwDOABII586UKd-n",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm, I'm not sure this is correct.\r\n\r\n> Obviously we don't want to use the sorted vector\r\n\r\nThat's not what I'm getting. You were inserting to the same collection over and over, I'm not sure what we were measuring there.\r\nAdding the collection creation and an assertion to not optimize it away (to make sure we're measuring the same thing in every iteration) reveals something completely different.\r\n\r\n<details>\r\n<summary>updated benchmarking code</summary>\r\n\r\n```C++\r\n#include <bench/bench.h>\r\n#include <bench/data/block413567.raw.h>\r\n#include <coins.h>\r\n#include <inputfetcher.h>\r\n#include <primitives/block.h>\r\n#include <serialize.h>\r\n#include <streams.h>\r\n\r\nstatic void InputFetcher_SortedVectorBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    bench.run([&] {\r\n        std::vector<Txid> v{};\r\n        v.reserve(block.vtx.size());\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(tx->GetHash());\r\n        }\r\n        std::sort(v.begin(), v.end());\r\n        ankerl::nanobench::doNotOptimizeAway(v);\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_UnorderedSetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    bench.run([&] {\r\n        std::unordered_set<Txid, SaltedTxidHasher> u{};\r\n        u.reserve(block.vtx.size());\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(u);\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    bench.run([&] {\r\n        std::set<Txid> s{};\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(s);\r\n    });\r\n}\r\n\r\nBENCHMARK(InputFetcher_SortedVectorBenchmark, benchmark::PriorityLevel::HIGH);\r\nBENCHMARK(InputFetcher_UnorderedSetBenchmark, benchmark::PriorityLevel::HIGH);\r\nBENCHMARK(InputFetcher_SetBenchmark, benchmark::PriorityLevel::HIGH);\r\n```\r\n\r\n</details>\r\n\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|          246,121.59 |            4,063.03 |    0.0% |      978,180.25 |      883,481.68 |  1.107 |     224,954.25 |    2.8% |     11.00 | `InputFetcher_SetBenchmark`\r\n|          130,850.86 |            7,642.29 |    0.2% |      608,319.13 |      469,743.71 |  1.295 |     135,588.13 |    4.4% |     11.04 | `InputFetcher_SortedVectorBenchmark`\r\n|          171,092.09 |            5,844.81 |    0.0% |    1,207,752.53 |      614,142.35 |  1.967 |     174,278.58 |    1.1% |     11.00 | `InputFetcher_UnorderedSetBenchmark`\r\n\r\n\r\n<img width=\"1500\" height=\"860\" alt=\"image\" src=\"https://github.com/user-attachments/assets/548ca5a4-bfe0-478c-9268-d76c6cd91e75\" />\r\n\r\n",
      "created_at": "2025-11-03T09:09:53Z",
      "updated_at": "2025-11-03T09:13:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485772199",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485772199"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486129322",
      "pull_request_review_id": 3410536334,
      "id": 2486129322,
      "node_id": "PRRC_kwDOABII586UL1Kq",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm observing a memory leak in this fuzz test similar to the one we had for the thread pool. Over there, we disabled logging and instantiate only a single pool instance: https://github.com/bitcoin/bitcoin/pull/33689/files#diff-68602d972fe2b027e3987eff0042c27f3f00fc161b7fe871bdb147571f348298R49-R58 . Maybe similar things can be done here?",
      "created_at": "2025-11-03T11:19:24Z",
      "updated_at": "2025-11-03T11:19:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486129322",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486129322"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486137554",
      "pull_request_review_id": 3410548325,
      "id": 2486137554,
      "node_id": "PRRC_kwDOABII586UL3LS",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thanks for reporting, that explains why I was seeing\r\n```bash\r\nbench_bitcoin(10874,0x207c84800) malloc: Failed to allocate segment from range group - out of space\r\n```\r\nand\r\n```bash\r\nbitcoind(70369,0x16f5ff000) malloc: Failed to allocate segment from range group - out of space\r\n```\r\nrecently (cc: @maflcko)",
      "created_at": "2025-11-03T11:22:17Z",
      "updated_at": "2025-11-03T11:22:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486137554",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486137554"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486195510",
      "pull_request_review_id": 3410633771,
      "id": 2486195510,
      "node_id": "PRRC_kwDOABII586UMFU2",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Interesting, how would a fuzz target lead to a crash in bench or bitcoind? Did you run it in parallel?\r\n\r\nThough, the suggestion to disable logging is correct, because while fuzzing, we probably don't want to spend cycles on log formatting. I guess those logs only end up in the buffer which causes the memory to grow? (There should be a `DEFAULT_MAX_LOG_BUFFER`, so if buffering is the issue, the memory should be limited)",
      "created_at": "2025-11-03T11:44:36Z",
      "updated_at": "2025-11-03T11:44:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486195510",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486195510"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486301326",
      "pull_request_review_id": 3410778296,
      "id": 2486301326,
      "node_id": "PRRC_kwDOABII586UMfKO",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The following patch seems to stabilize memory consumption:\r\n```diff\r\ndiff --git a/src/test/fuzz/inputfetcher.cpp b/src/test/fuzz/inputfetcher.cpp\r\nindex cd2a0f5c68..609b8e1191 100644\r\n--- a/src/test/fuzz/inputfetcher.cpp\r\n+++ b/src/test/fuzz/inputfetcher.cpp\r\n@@ -43 +43,10 @@ struct NoAccessCoinsView : CCoinsView\r\n-FUZZ_TARGET(inputfetcher)\r\n+std::optional<InputFetcher> g_fetcher{};\r\n+\r\n+static void setup_threadpool_test()\r\n+{\r\n+    LogInstance().DisableLogging();\r\n+    g_fetcher.emplace(3);\r\n+}\r\n+\r\n+FUZZ_TARGET(inputfetcher, .init = setup_threadpool_test)\r\n@@ -48,4 +56,0 @@ FUZZ_TARGET(inputfetcher)\r\n-    const auto worker_threads{\r\n-        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\r\n-    InputFetcher fetcher{worker_threads};\r\n-\r\n@@ -115 +120 @@ FUZZ_TARGET(inputfetcher)\r\n-        fetcher.FetchInputs(cache, main_cache, db, block);\r\n+        g_fetcher->FetchInputs(cache, main_cache, db, block);\r\n```",
      "created_at": "2025-11-03T12:23:08Z",
      "updated_at": "2025-11-03T12:23:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486301326",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486301326"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486317255",
      "pull_request_review_id": 3410800185,
      "id": 2486317255,
      "node_id": "PRRC_kwDOABII586UMjDH",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Are we sure we're not just masking a real problem with the disabled logger?",
      "created_at": "2025-11-03T12:27:41Z",
      "updated_at": "2025-11-03T12:27:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486317255",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486317255"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486334639",
      "pull_request_review_id": 3410822736,
      "id": 2486334639,
      "node_id": "PRRC_kwDOABII586UMnSv",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The logger is way less problematic in terms of its effect on the memory growing, and I find it difficult to really pin its effect. Having a global input fetcher that does not get instantiated with every fuzzer iteration has an immediate and clear effect. It is not clear to me if we are are actually leaking anything through the threads, or if creating and destroying thousands of threads per second puts too much pressure on the os (same for the threadpool).",
      "created_at": "2025-11-03T12:33:00Z",
      "updated_at": "2025-11-03T12:33:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486334639",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486334639"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486501704",
      "pull_request_review_id": 3411052521,
      "id": 2486501704,
      "node_id": "PRRC_kwDOABII586UNQFI",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm right I was not clearing the containers, so the sorting was dominating. I retried with clearing and the unordered_map is still slightly faster. In your benchmark you are creating and reserving the map inside the benchmark instead of before. In this implementation the reserved memory is kept in between blocks, so reserving and creating outside makes more sense.",
      "created_at": "2025-11-03T13:30:16Z",
      "updated_at": "2025-11-03T13:30:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486501704",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486501704"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486506578",
      "pull_request_review_id": 3411058494,
      "id": 2486506578,
      "node_id": "PRRC_kwDOABII586UNRRS",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why would short ids matter here though? Isn't that for keeping the bandwidth smaller for compact blocks?",
      "created_at": "2025-11-03T13:31:59Z",
      "updated_at": "2025-11-03T13:31:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486506578",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486506578"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486519559",
      "pull_request_review_id": 3411075340,
      "id": 2486519559,
      "node_id": "PRRC_kwDOABII586UNUcH",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "no, I mean, we don't actually need 256 bits of precision here, just a probabilistic check, so taking the first 32/64 bits of the hash should suffice, since the worst case is just going to disk, so it's not a tragedy if there are false positives, as long as in the average case checks are lot faster",
      "created_at": "2025-11-03T13:36:41Z",
      "updated_at": "2025-11-03T13:36:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486519559",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486519559"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486652576",
      "pull_request_review_id": 3411260777,
      "id": 2486652576,
      "node_id": "PRRC_kwDOABII586UN06g",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Some contention on shared resources is unavoidable. The threads need to synchronize on atomics. There are no locks in this implementation that all other threads need to wait on.\r\n\r\nThe main thread *may* have to wait here if there is a slow fetch, but it would be reading uncontested memory right up until one worker thread flips this bit. None of the other threads are trying to write to this same bit, so there is no contention between the main thread and any other worker threads.",
      "created_at": "2025-11-03T14:20:11Z",
      "updated_at": "2025-11-03T14:20:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486652576",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486652576"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486669187",
      "pull_request_review_id": 3411282133,
      "id": 2486669187,
      "node_id": "PRRC_kwDOABII586UN4-D",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't see why aborting early would prevent us from using less precision. It's doubtful there would be a collision, and if there were that block will just be a little slower to connect. I don't think it would have a measurable effect though, siphashing 64 bits vs 256 here?",
      "created_at": "2025-11-03T14:25:28Z",
      "updated_at": "2025-11-03T14:26:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486669187",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486669187"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492188555",
      "pull_request_review_id": 3418805230,
      "id": 2492188555,
      "node_id": "PRRC_kwDOABII586Ui8eL",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470286368,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Took the formats, thanks!",
      "created_at": "2025-11-04T22:15:12Z",
      "updated_at": "2025-11-04T22:15:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492188555",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492188555"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492189914",
      "pull_request_review_id": 3418806894,
      "id": 2492189914,
      "node_id": "PRRC_kwDOABII586Ui8za",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I removed the abort early logic, so we keep going if we don't find an input. It makes the logic much simpler, but we will do some more work if we get a block mined that is double spending.",
      "created_at": "2025-11-04T22:15:58Z",
      "updated_at": "2025-11-04T22:15:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492189914",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492189914"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492191544",
      "pull_request_review_id": 3418808858,
      "id": 2492191544,
      "node_id": "PRRC_kwDOABII586Ui9M4",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I've updated this to be an atomic_bool instead of this enum. So, since there is only a false value that is set to true, we have the main thread call `input.ready.wait(false, std::memory_order_acquire);`. This way we don't spin.",
      "created_at": "2025-11-04T22:16:53Z",
      "updated_at": "2025-11-04T22:16:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492191544",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492191544"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492194122",
      "pull_request_review_id": 3418811951,
      "id": 2492194122,
      "node_id": "PRRC_kwDOABII586Ui91K",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "@TheCharlatan thanks for fuzzing, and the diff for the fuzzer! I have taken it, and added you as a co-author :heart_hands:.\r\n\r\n@l0rinc it is concerning that you are getting malloc errors. Are there any other details you can share about this?",
      "created_at": "2025-11-04T22:18:21Z",
      "updated_at": "2025-11-04T22:18:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492194122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492194122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492195430",
      "pull_request_review_id": 3418813465,
      "id": 2492195430,
      "node_id": "PRRC_kwDOABII586Ui-Jm",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928411,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done, this `Status` enum has been replaced. It is now just an `atomic_bool` `ready`.",
      "created_at": "2025-11-04T22:19:03Z",
      "updated_at": "2025-11-04T22:19:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492195430",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492195430"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2493940857",
      "pull_request_review_id": 3421210209,
      "id": 2493940857,
      "node_id": "PRRC_kwDOABII586UpoR5",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> In this implementation the reserved memory is kept in between blocks\r\n\r\nK, so let's reserve outside and clear inside.\r\nNow that missing values aren't failures, we can experiment with shortids - since a missing value isn't a failure anymore (even though I wouldn't expect any collisions in 64 bits either, assuming uniform distribution. But even if the distribution isn't uniform, we can likely store it safely).\r\n64 bit ids for internal spends would mean that in case of some collision we will attempt to fetch something from disk that was actually in the current block - so the attacker can at best slow down block validation by a few milliseconds.\r\n\r\n<details>\r\n<summary>sorted/unsorted/vector benchmarks & shortids</summary>\r\n\r\n```C++\r\n// Copyright (c) 2022-present The Bitcoin Core developers\r\n// Distributed under the MIT software license, see the accompanying\r\n// file COPYING or https://www.opensource.org/licenses/mit-license.php.\r\n\r\n#include <algorithm>\r\n#include <bench/bench.h>\r\n#include <bench/data/block413567.raw.h>\r\n#include <bench/nanobench.h>\r\n#include <coins.h>\r\n#include <functional>\r\n#include <inputfetcher.h>\r\n#include <primitives/block.h>\r\n#include <primitives/transaction_identifier.h>\r\n#include <random.h>\r\n#include <ranges>\r\n#include <serialize.h>\r\n#include <set>\r\n#include <streams.h>\r\n#include <unordered_set>\r\n#include <util/check.h>\r\n#include <util/hasher.h>\r\n#include <vector>\r\n\r\nnamespace {\r\nconstexpr size_t iterations{100}; // since the inputs of the benchmarks are mutated by sorting, we can't rerun the benchmarks\r\nconstexpr size_t hits_count{275}; // assuming ~5% of blocks contain internal spends\r\nconstexpr size_t tx_count{5500};\r\n\r\nuint64_t GetShortID(const Txid& txid)\r\n{\r\n    return txid.ToUint256().GetUint64(0);\r\n}\r\n\r\ntemplate <typename T>\r\nstruct Dataset {\r\n    std::set<T> sorted_set;\r\n    std::unordered_set<T, std::conditional_t<std::is_same_v<T, Txid>, SaltedTxidHasher, std::identity>> unsorted_set;\r\n    std::vector<T> vec_sorted;\r\n    std::vector<T> vec_unsorted;\r\n    std::vector<T> queries;\r\n\r\n    static T Convert(const Txid& txid)\r\n    {\r\n        if constexpr (std::is_same_v<T, Txid>) {\r\n            return txid;\r\n        } else {\r\n            static_assert(std::is_same_v<T, uint64_t>);\r\n            return GetShortID(txid);\r\n        }\r\n    }\r\n};\r\n\r\ntemplate <typename T>\r\nstd::vector<Dataset<T>> BuildDatasets()\r\n{\r\n    FastRandomContext rng(/*fDeterministic=*/true);\r\n\r\n    std::vector<Dataset<T>> datasets;\r\n    datasets.reserve(iterations);\r\n\r\n    for (size_t d{0}; d < iterations; ++d) {\r\n        Dataset<T> ds;\r\n        ds.queries.reserve(tx_count);\r\n        ds.unsorted_set.reserve(tx_count);\r\n        ds.vec_sorted.reserve(tx_count);\r\n        ds.vec_unsorted.reserve(tx_count);\r\n\r\n        for (size_t i{0}; i < tx_count; ++i) {\r\n            T t1{Dataset<T>::Convert(Txid::FromUint256(rng.rand256()))};\r\n            ds.sorted_set.emplace(t1);\r\n            ds.unsorted_set.emplace(t1);\r\n            ds.vec_sorted.emplace_back(t1);\r\n            ds.vec_unsorted.emplace_back(t1);\r\n\r\n            T t2{Dataset<T>::Convert(Txid::FromUint256(rng.rand256()))};\r\n            ds.queries.emplace_back(i < hits_count ? t1 : t2);\r\n        }\r\n\r\n        std::ranges::shuffle(ds.queries, rng);\r\n        std::ranges::shuffle(ds.vec_unsorted, rng);\r\n        std::sort(ds.vec_sorted.begin(), ds.vec_sorted.end());\r\n\r\n        datasets.emplace_back(std::move(ds));\r\n    }\r\n    return datasets;\r\n}\r\n} // namespace\r\n\r\nstatic void Txid_UnorderedSalted(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.unsorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_SetOrdered(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.sorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorBinarySearch(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += std::binary_search(s.vec_sorted.begin(), s.vec_sorted.end(), q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorLinearScan(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    const auto contains_linear{[](const std::vector<Txid>& v, const Txid& x) noexcept {\r\n        return std::ranges::find(v, x) != v.end();\r\n    }};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += contains_linear(s.vec_unsorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_UnorderedSalted_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.unsorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_SetOrdered_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.sorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorBinarySearch_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += std::ranges::binary_search(s.vec_sorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorLinearScan_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    const auto contains_linear{[](const std::vector<uint64_t>& v, uint64_t x) noexcept {\r\n        return std::ranges::find(v, x) != v.end();\r\n    }};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += contains_linear(s.vec_unsorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SortedVectorBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::vector<Txid> v{};\r\n    v.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(tx->GetHash());\r\n        }\r\n        std::sort(v.begin(), v.end());\r\n        ankerl::nanobench::doNotOptimizeAway(v);\r\n        v.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_UnorderedSetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::unordered_set<Txid, SaltedTxidHasher> u{};\r\n    u.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(u);\r\n        u.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::set<Txid> s{};\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(s);\r\n        s.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SortedVectorBenchmark_shortid(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::vector<uint64_t> v{};\r\n    v.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(GetShortID(tx->GetHash()));\r\n        }\r\n        std::ranges::sort(v);\r\n        ankerl::nanobench::doNotOptimizeAway(v);\r\n        v.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_UnorderedSetBenchmark_shortid(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::unordered_set<uint64_t> u{};\r\n    u.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(GetShortID(tx->GetHash()));\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(u);\r\n        u.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SetBenchmark_shortid(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::set<uint64_t> s{};\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(GetShortID(tx->GetHash()));\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(s);\r\n        s.clear();\r\n    });\r\n}\r\n\r\nBENCHMARK(InputFetcher_SortedVectorBenchmark, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_UnorderedSetBenchmark, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_SetBenchmark, benchmark::PriorityLevel::LOW);\r\n\r\nBENCHMARK(InputFetcher_SortedVectorBenchmark_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_UnorderedSetBenchmark_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_SetBenchmark_shortid, benchmark::PriorityLevel::LOW);\r\n\r\nBENCHMARK(Txid_UnorderedSalted, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_SetOrdered, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorBinarySearch, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorLinearScan, benchmark::PriorityLevel::LOW);\r\n\r\nBENCHMARK(Txid_UnorderedSalted_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_SetOrdered_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorBinarySearch_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorLinearScan_shortid, benchmark::PriorityLevel::LOW);\r\n```\r\n\r\n</details>\r\n\r\n\r\n<img width=\"1487\" height=\"864\" alt=\"image\" src=\"https://github.com/user-attachments/assets/8f971f62-87c7-496f-a060-0dec2bb9cc51\" />\r\n\r\nThe new measurements indicate that the single-threaded preparation is 4x faster with a sorted vector, while multithreaded search is more than 2x faster with small ids compared to the current approach. Worth investigating further, I'd say :)",
      "created_at": "2025-11-05T10:48:39Z",
      "updated_at": "2025-11-05T10:52:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2493940857",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2493940857"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2494844175",
      "pull_request_review_id": 3422525781,
      "id": 2494844175,
      "node_id": "PRRC_kwDOABII586UtE0P",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484980972,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Can we assert the behavior of the main cache as well so that the previous version doesn't pass?\r\n\r\nNeither the temp cache or the main cache touch their backing cache in the input fetcher. So, we can't assert a failure if the backing cache is something else. We can assert that the backing view is not touched during `FetchInputs`, which is done in the fuzz harness.",
      "created_at": "2025-11-05T14:43:45Z",
      "updated_at": "2025-11-05T14:43:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2494844175",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2494844175"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2497861709",
      "pull_request_review_id": 3426708700,
      "id": 2497861709,
      "node_id": "PRRC_kwDOABII586U4lhN",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Did the same on master:\r\n```\r\ngit log -1\r\ncommit 5c5704e730796c6f31e2d7891bf6334674a04219 (HEAD, upstream/master, upstream/HEAD, origin/master, origin/HEAD)\r\n```\r\nand unfortunately I'm getting the same:\r\n```\r\ntime ./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\r\nbitcoind(71239,0x170f2f000) malloc: Failed to allocate segment from range group - out of space\r\n...\r\n```\r\nso it's not related to this PR\r\n\r\nAlso fuzzed for almost a day, no problems came up:\r\n```\r\n...\r\n#12935791       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1640/4082 MS: 3 EraseBytes-PersAutoDict-InsertRepeatedBytes- DE: \"\\001\\\\\"-\r\n#12941278       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1734/4082 MS: 2 PersAutoDict-EraseBytes- DE: \"\\377\\031\"-\r\n#12943860       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1303/4082 MS: 2 InsertByte-EraseBytes-\r\n#12956441       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2407/4082 MS: 1 EraseBytes-\r\n#12973964       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2400/4082 MS: 3 ChangeByte-ChangeBinInt-EraseBytes-\r\n#12980710       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1835/4082 MS: 1 EraseBytes-\r\n#12986931       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 471/4082 MS: 1 EraseBytes-\r\n#12987148       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1295/4082 MS: 2 PersAutoDict-EraseBytes- DE: \"\\377\\377\\377\\377\"-\r\n#13001660       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2399/4082 MS: 2 PersAutoDict-EraseBytes- DE: \"\\332\\377\\377\\377\"-\r\n#13008530       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 3079/4082 MS: 5 ChangeByte-PersAutoDict-EraseBytes-ChangeASCIIInt-InsertRepeatedBytes- DE: \"\\363\\006\\000\\000\\000\\000\\000\\000\"-\r\n#13015051       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 3063/4082 MS: 1 EraseBytes-\r\n#13026498       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2374/4082 MS: 2 ChangeBinInt-EraseBytes-\r\n```\r\n",
      "created_at": "2025-11-06T07:49:13Z",
      "updated_at": "2025-11-06T07:50:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2497861709",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2497861709"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499419184",
      "pull_request_review_id": 3428778459,
      "id": 2499419184,
      "node_id": "PRRC_kwDOABII586U-hww",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;",
      "path": "src/inputfetcher.h",
      "position": 90,
      "original_position": 81,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "when can this be true?",
      "created_at": "2025-11-06T15:22:17Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499419184",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499419184"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 90,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499420838",
      "pull_request_review_id": 3428778459,
      "id": 2499420838,
      "node_id": "PRRC_kwDOABII586U-iKm",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\n        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n```",
      "created_at": "2025-11-06T15:22:46Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499420838",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499420838"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499427113",
      "pull_request_review_id": 3428778459,
      "id": 2499427113,
      "node_id": "PRRC_kwDOABII586U-jsp",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 93,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: trailing newline shouldn't be needed anymore\n\n```suggestion\n                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\", e.what());\n```",
      "created_at": "2025-11-06T15:24:14Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499427113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499427113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 93,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499430732",
      "pull_request_review_id": 3428778459,
      "id": 2499430732,
      "node_id": "PRRC_kwDOABII586U-klM",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\n        std::ranges::sort(m_txids);\n```",
      "created_at": "2025-11-06T15:24:55Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499430732",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499430732"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499442182",
      "pull_request_review_id": 3428778459,
      "id": 2499442182,
      "node_id": "PRRC_kwDOABII586U-nYG",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait\n+                if (!FetchCoin()) {\n+                    input.ready.wait(false, std::memory_order_acquire);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 134,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "based on https://en.cppreference.com/w/cpp/atomic/atomic_flag/wait.html\n```suggestion\n                    input.ready.wait(/*old*/false, std::memory_order_acquire);\n```",
      "created_at": "2025-11-06T15:26:50Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499442182",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499442182"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499446404",
      "pull_request_review_id": 3428778459,
      "id": 2499446404,
      "node_id": "PRRC_kwDOABII586U-oaE",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "not yet sure I fully understand why this is needed - it's more complex, but does it result in at least a theoretic speedup?",
      "created_at": "2025-11-06T15:27:26Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499446404",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499446404"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499449442",
      "pull_request_review_id": 3428778459,
      "id": 2499449442,
      "node_id": "PRRC_kwDOABII586U-pJi",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait\n+                if (!FetchCoin()) {\n+                    input.ready.wait(false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin.IsSpent()) continue;\n+            temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 139,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`continue` effectively skipping the last line is a bit confusing an dangerous - it should only skip the next line:\r\n```suggestion\r\n            if (!input.coin.IsSpent()) {\r\n                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\r\n            }\r\n```",
      "created_at": "2025-11-06T15:27:53Z",
      "updated_at": "2025-11-06T15:36:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499449442",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499449442"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 138,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 139,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499464047",
      "pull_request_review_id": 3428778459,
      "id": 2499464047,
      "node_id": "PRRC_kwDOABII586U-stv",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 70,
      "original_position": 61,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "should we document here what happens in case of a cache miss or collision?",
      "created_at": "2025-11-06T15:29:59Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499464047",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499464047"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 70,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499486476",
      "pull_request_review_id": 3428778459,
      "id": 2499486476,
      "node_id": "PRRC_kwDOABII586U-yMM",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 76,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this will fix the linter failure as well (whitespace after `*`):\n```suggestion\n     * \n     * @return whether there are more inputs in the queue to fetch\n```",
      "created_at": "2025-11-06T15:33:54Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499486476",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499486476"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 74,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 76,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499916845",
      "pull_request_review_id": 3429394484,
      "id": 2499916845,
      "node_id": "PRRC_kwDOABII586VAbQt",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 78,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we call it something else to not coincide with `CCoinsViewCache::FetchCoin`",
      "created_at": "2025-11-06T17:00:11Z",
      "updated_at": "2025-11-06T17:00:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499916845",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499916845"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 78,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500031838",
      "pull_request_review_id": 3429535933,
      "id": 2500031838,
      "node_id": "PRRC_kwDOABII586VA3Ve",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;",
      "path": "src/inputfetcher.h",
      "position": 90,
      "original_position": 81,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499419184,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is true when all inputs have been fetched from the block. We want the compiler to optimize for the case where we have work.",
      "created_at": "2025-11-06T17:28:06Z",
      "updated_at": "2025-11-06T17:33:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500031838",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500031838"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 90,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500047237",
      "pull_request_review_id": 3429554524,
      "id": 2500047237,
      "node_id": "PRRC_kwDOABII586VA7GF",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The work done on the other threads is much slower than what the main thread is doing. Fetching inputs possibly from disk vs inserting coins into the temporary cache. So, in cases where there are fewer worker threads the main thread will likely be waiting on the work to be done. In these cases we can just start fetching as well. I think this would have a large impact in cases where there are few worker threads (like rpis), or if using a low but > 1 -par value. For instance, using `-par=2` this would in theory double the efficiency of fetching inputs from disk. It is likely not a measurable effect for setups that have 16 or more vcpus.",
      "created_at": "2025-11-06T17:31:33Z",
      "updated_at": "2025-11-06T17:32:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500047237",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500047237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500222372",
      "pull_request_review_id": 3429762642,
      "id": 2500222372,
      "node_id": "PRRC_kwDOABII586VBl2k",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure I understand why, what's the difference between *two threads working while main is waiting* vs *one thread working and main also working*?\r\nWhere does the difference come from (especially given that the work is not fully cpu-bound)?",
      "created_at": "2025-11-06T18:09:45Z",
      "updated_at": "2025-11-06T18:09:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500222372",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500222372"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500300779",
      "pull_request_review_id": 3429863156,
      "id": 2500300779,
      "node_id": "PRRC_kwDOABII586VB4_r",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> two threads working while main is waiting vs one thread working and main also working?\r\n\r\nIt would be two threads working while main is waiting vs two threads working and main also working? So the latter has 3 threads working vs the former's 2 threads working. If using `-par=3` this is the case. 50% more work is done in parallel. ",
      "created_at": "2025-11-06T18:29:10Z",
      "updated_at": "2025-11-06T18:31:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500300779",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500300779"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500406322",
      "pull_request_review_id": 3429996035,
      "id": 2500406322,
      "node_id": "PRRC_kwDOABII586VCSwy",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "So why not just do the work that `par` defined and leave main asleep, wouldn't that be simpler while basically achieving exactly the same?",
      "created_at": "2025-11-06T18:52:50Z",
      "updated_at": "2025-11-06T18:52:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500406322",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500406322"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500437404",
      "pull_request_review_id": 3430036138,
      "id": 2500437404,
      "node_id": "PRRC_kwDOABII586VCaWc",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "No because we would have to insert all entries into temp cache at the end, instead of parallelizing that work as well. That was the previous implementation where we waited for every thread to be done and then inserted everything in series before exiting.\nNow, the main thread does both. It inserts while others are fetching, but if it inserts fast enough where it is waiting for new entries it will also fetch entries.",
      "created_at": "2025-11-06T19:02:28Z",
      "updated_at": "2025-11-06T19:02:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500437404",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500437404"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500462588",
      "pull_request_review_id": 3430067614,
      "id": 2500462588,
      "node_id": "PRRC_kwDOABII586VCgf8",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "On a system with 15 worker threads + main, it is likely that main will not be waiting much. The other 15 threads are busy setting newly fetched coins to ready so that the main thread can continuously read `true` for the ready flags.\r\nOn a system with only 3 worker threads + main, it is likely that the 3 worker threads will not be able to fetch and set ready coins fast enough where the main thread does not have to wait. For instance all 3 threads are fetching from disk, and the main thread reads the next input and ready is still `false`. So now it can either wait until one of the 3 worker threads fetches an input from disk, or it can start helping out the 3 workers and fetch from disk itself. This will increase parallel throughput by 33%, since 4 workers are fetching instead of just 3. Then when main returns with its fetched coin, main can insert the rest of the coins that the workers have fetched and set ready while main was busy fetching. Then it will catch up again to the latest input that is not yet ready, and fetch another coin.",
      "created_at": "2025-11-06T19:10:26Z",
      "updated_at": "2025-11-06T19:17:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500462588",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500462588"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500696484",
      "pull_request_review_id": 3430354624,
      "id": 2500696484,
      "node_id": "PRRC_kwDOABII586VDZmk",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We discussed this out of band, here's the summary:\r\n* the main thread is special because it has access to the dbcache, it can insert there without locking the cache.\r\n* the threads each have their inputs now, each of which have a switch to signal when they've fetched the input and move on to the next\r\n* the threads each compete for which input to fetch, marking them one-by-one as ready\r\n* the main thread goes in order, spins until the next one is available, if it needs to wait, it does some fetching itself, rechecks later if the given value is available and if so, it inserts to the dbcache, after which it checks the next value in order.\r\n\r\nThis way the IO and CPU bound work is parallelized, so we don't need to do the heavy rehashing at the end, it's done while the other threads are doing IO work - that's why it's faster.\r\n\r\nI have to think about this, it sounds like we can simplify this further, but this is already an improvement over previous solutions.\r\n\r\n---\r\n\r\nAnd given that the worst thing that can happen for an internal spend is that if there's another input with the same prefix in the same block, we wouldn't fetch it here and it would be fetched during block connection like it was done before.\r\nThis means that we likely don't even need 64 bits for that, likely 32 are enough. Back of the napkin calculations indicate that would mean that 1/1000 blocks would contain transactions that won't be fetched by `InputFetcher` and would need to be fetched during block connection instead on a single thread. As long as 32 bit checks are faster than 64 (which should definitely be the case for the sorted-vector case), this should likely result in an overall speedup. We definitely need to add a test case for that.",
      "created_at": "2025-11-06T20:18:07Z",
      "updated_at": "2025-11-06T20:18:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500696484",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500696484"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    }
  ]
}