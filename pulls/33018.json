{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018",
    "id": 2679273445,
    "node_id": "PR_kwDOABII586fsnfl",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/33018",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/33018.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/33018.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33018",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33018/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/98698b45d53f92603ada14689f377df3df973893",
    "number": 33018,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "coins: remove SetFresh method from CCoinsCacheEntry",
    "user": {
      "login": "andrewtoth",
      "id": 237213,
      "node_id": "MDQ6VXNlcjIzNzIxMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andrewtoth",
      "html_url": "https://github.com/andrewtoth",
      "followers_url": "https://api.github.com/users/andrewtoth/followers",
      "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
      "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
      "repos_url": "https://api.github.com/users/andrewtoth/repos",
      "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "There is plenty of test code that exercises the code path for FRESH-but-not-DIRTY coins in CCoinsViewCache. However, we can see there is only one place in production code where we call `SetFresh` that is not preceded by `SetDirty`. This is in `CCoinsViewCache::FetchCoin` and we can see that this is called if the coin retrieved from `base->GetCoin` is spent. The `base` in this case can be another `CCoinsViewCache` or a `CCoinsViewDB`. In `CCoinsViewCache::GetCoin` we can see that we do not return spent coins, and in `CCoinsViewDB` we don't ever store spent coins so there are none to return.\r\n\r\nThus, we can safely remove this dead code, and now we can see that there are never any calls to `SetFresh` not preceded by `SetDirty`. This PR removes this dead code and replaces `SetFresh` by passing a `fresh` boolean flag to `SetDirty`. This simplifies the logic of `CCoinsViewCache` and lets us remove test cases checking for FRESH-but-not-DIRTY coins. It removes the possibility of FRESH-but-not-DIRTY coins being called from any code path, so we can eliminate this state entirely and reduce the cognitive load of having to consider it.\r\n\r\nThis is pulled out from https://github.com/bitcoin/bitcoin/pull/30673 to make the change simpler.",
    "labels": [
      {
        "id": 97470796,
        "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
        "name": "UTXO Db and Indexes",
        "color": "fbca04",
        "default": false
      }
    ],
    "created_at": "2025-07-19T19:21:35Z",
    "updated_at": "2025-10-16T11:50:04Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "0393a8f58b0a7c262b35f14c60921157b104ceba",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "andrewtoth:remove-setfresh",
      "ref": "remove-setfresh",
      "sha": "98698b45d53f92603ada14689f377df3df973893",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 156145027,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNTYxNDUwMjc=",
        "name": "bitcoin",
        "full_name": "andrewtoth/bitcoin",
        "owner": {
          "login": "andrewtoth",
          "id": 237213,
          "node_id": "MDQ6VXNlcjIzNzIxMw==",
          "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/andrewtoth",
          "html_url": "https://github.com/andrewtoth",
          "followers_url": "https://api.github.com/users/andrewtoth/followers",
          "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
          "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
          "repos_url": "https://api.github.com/users/andrewtoth/repos",
          "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/andrewtoth/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/andrewtoth/bitcoin",
        "archive_url": "https://api.github.com/repos/andrewtoth/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/andrewtoth/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/andrewtoth/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/andrewtoth/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/andrewtoth/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/andrewtoth/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/andrewtoth/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/andrewtoth/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/andrewtoth/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/andrewtoth/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/andrewtoth/bitcoin/events",
        "forks_url": "https://api.github.com/repos/andrewtoth/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/andrewtoth/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/andrewtoth/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/andrewtoth/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/andrewtoth/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/andrewtoth/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/andrewtoth/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/andrewtoth/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/andrewtoth/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/andrewtoth/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:andrewtoth/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/andrewtoth/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/andrewtoth/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/andrewtoth/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/andrewtoth/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/andrewtoth/bitcoin/hooks",
        "svn_url": "https://github.com/andrewtoth/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 287594,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-10-16T03:45:29Z",
        "created_at": "2018-11-05T01:43:59Z",
        "updated_at": "2022-12-23T04:16:30Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "e14451ac87339ed61b8c872f027184a978dd96eb",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 38037,
        "stargazers_count": 86214,
        "watchers_count": 86214,
        "size": 295003,
        "default_branch": "master",
        "open_issues_count": 823,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-10-16T08:53:08Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-10-16T11:09:41Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 42,
    "deletions": 91,
    "changed_files": 6,
    "commits": 6,
    "review_comments": 36,
    "comments": 3
  },
  "events": [
    {
      "event": "labeled",
      "id": 18712832524,
      "node_id": "LE_lADOABII587Bc6GezwAAAARbXyoM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18712832524",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-19T19:21:38Z",
      "label": {
        "name": "UTXO Db and Indexes",
        "color": "fbca04"
      }
    },
    {
      "event": "commented",
      "id": 3092526814,
      "node_id": "IC_kwDOABII5864VDbe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3092526814",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-19T19:21:39Z",
      "updated_at": "2025-10-16T11:50:04Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33018.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [l0rinc](https://github.com/bitcoin/bitcoin/pull/33018#pullrequestreview-3036128101) |\n\nIf your review is incorrectly listed, please react with 👎 to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33512](https://github.com/bitcoin/bitcoin/pull/33512) (coins: use number of dirty cache entries in flush warnings/logs by l0rinc)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#issuecomment-3092526814",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33018"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 18717562758,
      "node_id": "HRFPE_lADOABII587Bc6GezwAAAARbp1eG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18717562758",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "created_at": "2025-07-20T18:17:13Z"
    },
    {
      "event": "reviewed",
      "id": 3036128101,
      "node_id": "PRR_kwDOABII586096Nl",
      "url": null,
      "actor": null,
      "commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-07-20T19:20:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nVery glad this is getting cleanup up, I found it worrying that a lot of tests were exercising invalid states in the first place - not the best foundation.\r\nQuickly went over the changes, I find the small commits and excellent commit messages easy to follow.\r\nI'll run a full IBD over this (maybe with some extra `SanityCheck` sprinkled around for extra measure) to make sure real usage doesn't trigger any invalid states we're not aware of.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#pullrequestreview-3036128101",
      "submitted_at": "2025-07-20T19:20:21Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
    },
    {
      "event": "reviewed",
      "id": 3036282843,
      "node_id": "PRR_kwDOABII5860-f_b",
      "url": null,
      "actor": null,
      "commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-07-21T01:11:46Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#pullrequestreview-3036282843",
      "submitted_at": "2025-07-21T01:11:46Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 18719180874,
      "node_id": "HRFPE_lADOABII587Bc6GezwAAAARbwAhK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18719180874",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "95f0ff06b911dd77f4ded97dfb5b8155b8e7b3ef",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/95f0ff06b911dd77f4ded97dfb5b8155b8e7b3ef",
      "created_at": "2025-07-21T01:28:49Z"
    },
    {
      "event": "commented",
      "id": 3095031799,
      "node_id": "IC_kwDOABII5864em_3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3095031799",
      "actor": {
        "login": "Lalaweazel",
        "id": 180723578,
        "node_id": "U_kgDOCsWfeg",
        "avatar_url": "https://avatars.githubusercontent.com/u/180723578?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Lalaweazel",
        "html_url": "https://github.com/Lalaweazel",
        "followers_url": "https://api.github.com/users/Lalaweazel/followers",
        "following_url": "https://api.github.com/users/Lalaweazel/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Lalaweazel/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Lalaweazel/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Lalaweazel/subscriptions",
        "organizations_url": "https://api.github.com/users/Lalaweazel/orgs",
        "repos_url": "https://api.github.com/users/Lalaweazel/repos",
        "events_url": "https://api.github.com/users/Lalaweazel/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Lalaweazel/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-21T02:06:34Z",
      "updated_at": "2025-07-21T02:21:13Z",
      "author_association": "NONE",
      "body": "' DQ at need  f cc 2iooo9 to be in work iiiiiiii iroieeieeieowwiereo W e\r\n\r\nOn Mon, 21 July 2025, 12:02 pm Andrew Toth, ***@***.***>\r\nwrote:\r\n\r\n> ***@***.**** commented on this pull request.\r\n> ------------------------------\r\n>\r\n> In src/coins.h\r\n> <https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218067867>:\r\n>\r\n> >   * - spent, not FRESH, DIRTY (e.g. a coin is spent and spentness needs to be flushed to the parent)\r\n>   */\r\n>  struct CCoinsCacheEntry\r\n>  {\r\n>  private:\r\n>      /**\r\n>       * These are used to create a doubly linked list of flagged entries.\r\n> -     * They are set in SetDirty, SetFresh, and unset in SetClean.\r\n> -     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\r\n> +     * They are set in SetDirty and unset in SetClean.\r\n> +     * A flagged entry is any entry that is DIRTY or DIRTY and FRESH.\r\n>\r\n> Done.\r\n>\r\n> —\r\n> Reply to this email directly, view it on GitHub\r\n> <https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218067867>,\r\n> or unsubscribe\r\n> <https://github.com/notifications/unsubscribe-auth/BLCZ66TZ63CTQEG3FDJLXXD3JRC23AVCNFSM6AAAAACB46C4HCVHI2DSMVQWIX3LMV43YUDVNRWFEZLROVSXG5CSMV3GSZLXHMZTAMZWGMZDKOBZGM>\r\n> .\r\n> You are receiving this because you are subscribed to this thread.Message\r\n> ID: ***@***.***>\r\n>\r\n",
      "user": {
        "login": "Lalaweazel",
        "id": 180723578,
        "node_id": "U_kgDOCsWfeg",
        "avatar_url": "https://avatars.githubusercontent.com/u/180723578?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Lalaweazel",
        "html_url": "https://github.com/Lalaweazel",
        "followers_url": "https://api.github.com/users/Lalaweazel/followers",
        "following_url": "https://api.github.com/users/Lalaweazel/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Lalaweazel/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Lalaweazel/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Lalaweazel/subscriptions",
        "organizations_url": "https://api.github.com/users/Lalaweazel/orgs",
        "repos_url": "https://api.github.com/users/Lalaweazel/repos",
        "events_url": "https://api.github.com/users/Lalaweazel/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Lalaweazel/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#issuecomment-3095031799",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33018"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 18719537063,
      "node_id": "HRFPE_lADOABII587Bc6GezwAAAARbxXen",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18719537063",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "99b243d53e7ca3e824369e7e194981d814c04708",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/99b243d53e7ca3e824369e7e194981d814c04708",
      "created_at": "2025-07-21T02:21:13Z"
    },
    {
      "event": "labeled",
      "id": 18719538269,
      "node_id": "LE_lADOABII587Bc6GezwAAAARbxXxd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18719538269",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-21T02:21:24Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3095048145,
      "node_id": "IC_kwDOABII5864eq_R",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3095048145",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-21T02:21:26Z",
      "updated_at": "2025-07-21T02:21:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n🚧 At least one of the CI tasks failed.\n<sub>Task `CentOS, depends, gui`: https://github.com/bitcoin/bitcoin/runs/46353382966</sub>\n<sub>LLM reason (✨ experimental): The CI failure is caused by an assertion failure in coins.cpp during the coins_tests, leading to subprocess abortion.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#issuecomment-3095048145",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33018"
    },
    {
      "event": "unlabeled",
      "id": 18721406277,
      "node_id": "UNLE_lADOABII587Bc6GezwAAAARb4f1F",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/18721406277",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-07-21T06:04:12Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 20300507169,
      "node_id": "LE_lADOABII587Bc6GezwAAAAS6ASgh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20300507169",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-15T16:28:46Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGE3YzJhZTQ2MjJhZDVmM2IwMTdkN2RkMjI5YjI2MzE5N2ZhM2FkZjg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a7c2ae4622ad5f3b017d7dd229b263197fa3adf8",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a7c2ae4622ad5f3b017d7dd229b263197fa3adf8",
      "tree": {
        "sha": "cb11c0df4e45110974ea4982a37980584b82228c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cb11c0df4e45110974ea4982a37980584b82228c"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree cb11c0df4e45110974ea4982a37980584b82228c\nparent e14451ac87339ed61b8c872f027184a978dd96eb\nauthor Andrew Toth <andrewstoth@gmail.com> 1752949714 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1760574819 -0400\n\ntest: coins returned from GetCoin cannot be spent\n\nThis is already not possible for any production GetCoin\nimplementation, so this aligns tests with production code.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmjwPWMACgkQYAB6/Ik4\nsBgfVRAAknUOQ2etlKKycc/6YhbnSInrLLdjwk3sfLa9/ADJ+MIC8zjQGjjhSXvx\nV3Tf8AXMyqyfxrRmSrM7uOb4n4jsWWUk1sT+TUo0zEwT27xFrvy7BbI2ACoWMxA9\n7wj1b8ENPm714OX5kIzAexQR6mBKLuUGdgD+wMNYv97Su6vSDxYEH7mVTBu/ulmQ\nK6jV0/nrJUd4ryCzhHAKf/KR/NPOVGes1GIfoo6TCCVkXNSudS/6Krh/DhHnc3Zo\nyd8f76+4G6MDtDHaz6JufL5SzcWyiP7Y5pHwtlTHfO6lwsmIAI2DHO7yff0oLcvm\n/BPLDXMpqt9a3G2aZ2dTVo5i19OvzJpmSxuGmf04qIJJuhaMg5jCQ2xccTBSXy/t\n+UeaMUhYldwcl/EoehKsnY7rLu93To3OZb9OzjriTODFo4wjbFIUQJPa8FA63W8v\n2ZbrkehdaNT/TLpLlOlGeHrqyTIQ2/ySlSgenVTQDlwuy/V742/ZufCk9vUFKOJ1\n2GLd4fxvOp7Cbv5lrQUI2lhnmt7Nkvy7sSGgKMnz7Y7241sXP51HwAz6/79TXyhw\n5Mowobl5Hdkb75EGgQLGvqLIbNerOQ8KwQ1iP5Kz6iE1DCawbJiWZne9fp8RrWNM\nnn5cTcPMQ/ZnaRLCflcCdwlHFEDePTQJNwa48/oiYRTgIyyQJZU=\n=uW7P\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e14451ac87339ed61b8c872f027184a978dd96eb",
          "sha": "e14451ac87339ed61b8c872f027184a978dd96eb",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e14451ac87339ed61b8c872f027184a978dd96eb"
        }
      ],
      "message": "test: coins returned from GetCoin cannot be spent\n\nThis is already not possible for any production GetCoin\nimplementation, so this aligns tests with production code.",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-10-16T00:33:39Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-07-19T18:28:34Z"
      },
      "sha": "a7c2ae4622ad5f3b017d7dd229b263197fa3adf8"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ0MGM0NmIxYzAwZWNhMDQ4YzhjMjIyNjRjNmQwYWIwOTIwZmI0NWU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/440c46b1c00eca048c8c22264c6d0ab0920fb45e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/440c46b1c00eca048c8c22264c6d0ab0920fb45e",
      "tree": {
        "sha": "40fd1428f9b32776dbed7b8821df201c12fee154",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/40fd1428f9b32776dbed7b8821df201c12fee154"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 40fd1428f9b32776dbed7b8821df201c12fee154\nparent a7c2ae4622ad5f3b017d7dd229b263197fa3adf8\nauthor Andrew Toth <andrewstoth@gmail.com> 1753033832 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1760574819 -0400\n\ncoins: remove SetFresh in FetchCoin\n\nThis is the only place in production code where SetFresh is called\nwhen not preceded by SetDirty.\nWe can see that coin is retrieved from base->GetCoin, and base can\nonly be another CCoinsViewCache or CCoinsViewDB.\nCCoinsViewCache::GetCoin does not return spent coins, and CCoinsViewDB\ndoes not store any spent coins to return.\nThus, we can conclude that this call to SetFresh is dead code and can\nbe safely removed.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmjwPWMACgkQYAB6/Ik4\nsBhKHw/+JkQnhff+1CZGpUY9HVOL9uC05n6JtXteVqsdpechM5y5iKgAE5XSPQ1j\nnbJOJgeCWWEHRquM5M7YMbjPp8rnOhSOqJzhq5hgXSung8oUUAmZr7FoA0KJXY/C\nU5zdoBTGS7KXBEozm3JTCuhbkyXVTvrUhJ22FN6bdumVSfnogEQIK2Ll0eWDyT9W\nnwsrOX4tSPp4ZGSUJCIpKuSWeeU3lhwjmGfFOhMFekUnR3XVDU0Ab65ZpWGzHqau\n8pNkmp7+4WZpcUFjIx5vdO+jJR4X8TfxxNzeB8fBhHDlYTT2m+/sqUQzbYp1dHPT\nNFFnbf+wG9o+dbd9ZK8QjTsQWTumdZAsrT/+5XJyj9dhBpPY4WWRucHYld4A4O+Y\nQCHEoE8ntBULMt4nJ2wMPXHZbUUJBJwoqnTQzMgDVSqQQ0OoyAIt8ZDlD09JJtWe\nzcUpTSoW2gG+zxzhYOAoBMnJY5yfz4Z07Z83+zb71AIfyyKaAYJkF2BoMRdtBFt2\nGx47EfkmPe3xOzdX0Y8h9EOY3bBxA+HvpO3bRkN5rcWVtBiEKtLNFj+FvfGK0//Q\nwLN/ZEF2SVUd/DuVaNTRaO4vN+y0Sbz+wHWcQ8mTcBYtIkAXDnDQaLW0Zu0HIc9W\nUlcBezNvpViBl9BeJ2ERBr0Su+QV/xZRfsXj2JPqkviG4Wv2Hn8=\n=/hI1\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a7c2ae4622ad5f3b017d7dd229b263197fa3adf8",
          "sha": "a7c2ae4622ad5f3b017d7dd229b263197fa3adf8",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a7c2ae4622ad5f3b017d7dd229b263197fa3adf8"
        }
      ],
      "message": "coins: remove SetFresh in FetchCoin\n\nThis is the only place in production code where SetFresh is called\nwhen not preceded by SetDirty.\nWe can see that coin is retrieved from base->GetCoin, and base can\nonly be another CCoinsViewCache or CCoinsViewDB.\nCCoinsViewCache::GetCoin does not return spent coins, and CCoinsViewDB\ndoes not store any spent coins to return.\nThus, we can conclude that this call to SetFresh is dead code and can\nbe safely removed.",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-10-16T00:33:39Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-07-20T17:50:32Z"
      },
      "sha": "440c46b1c00eca048c8c22264c6d0ab0920fb45e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDlmNzJlZjg0YTc0OWRmZTZiOTMyODk2NmY2YWQ3ZGM2YzBjM2NiMDM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9f72ef84a749dfe6b9328966f6ad7dc6c0c3cb03",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/9f72ef84a749dfe6b9328966f6ad7dc6c0c3cb03",
      "tree": {
        "sha": "d0e28e8cc14d78cf7ef7b2734da47fe4ce1ca866",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d0e28e8cc14d78cf7ef7b2734da47fe4ce1ca866"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree d0e28e8cc14d78cf7ef7b2734da47fe4ce1ca866\nparent 440c46b1c00eca048c8c22264c6d0ab0920fb45e\nauthor Andrew Toth <andrewstoth@gmail.com> 1753033959 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1760574819 -0400\n\ntest: remove FRESH-but-not-DIRTY state from coins_tests\n\nThe FRESH-but-not-DIRTY state cannot occur in production code.\nThere are never any calls to SetFresh not preceded by SetDirty.\nWe should remove these test cases to simplify the test code and\nbetter align it with production code.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmjwPWMACgkQYAB6/Ik4\nsBjP4w//ci2X16l1MSPMZRLdj2D8vbd9R2b01Byl7M8798keGMZN023VKu5rTwqd\nbedmCiOrOtS38guGES/PrR3fGema/wU0v1CIvzthSF0xZCIXTYxG7AKeI6eyRrC8\nC2zhL2G01uXAvdX/u3yzdkO8NxkqXlD3tA7lp4PYM00OUKeodUprWCGHaWOwjHTY\nykukDiuSiGK+cgyp9aHmEonnML5L6z8Nj0hd3mOqYDxqo8yulHNQzUVfrjY0fyGq\ngXQOZYEexxm+KdvDgPMOkQ76/3IdFO7x4fGHHT7YJBfC0PRQ1DaqrM1yYrDuZ+YP\nSIwZB1x6N0JcDqRum5WzKgVuwfhxmJP6jZRhw6p24Z4fqjy7tiLn7kMZZ2xL2840\n/hNTGIB+wcjkCkTLj4eQaRgDZuE8kES5fTj1h1DHs/yL1/uTkjuu5qfEaU9ZjxGu\ncOQcEYOYJMj3MR1g1ADFTC7q8mySXZkzSOeJelNoD9YIbefAaNySF31q+8l6gzQj\nEtHHi0saQx0M2G1dmevp4+puuGOvO+2Vna6V2SmxduVo9WNLh/x2Z01XEFDPG9PT\ncwwnJSR+99w3lgayoCLdFT22oVS54WasfdUBvSBulQaITL5avvacF+03ry2Jd7ar\nbK/LxUYsEXZvloeZ9uwuVrXprW+67BPI4xzQbTCOfhDmAxee6PI=\n=RF/d\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/440c46b1c00eca048c8c22264c6d0ab0920fb45e",
          "sha": "440c46b1c00eca048c8c22264c6d0ab0920fb45e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/440c46b1c00eca048c8c22264c6d0ab0920fb45e"
        }
      ],
      "message": "test: remove FRESH-but-not-DIRTY state from coins_tests\n\nThe FRESH-but-not-DIRTY state cannot occur in production code.\nThere are never any calls to SetFresh not preceded by SetDirty.\nWe should remove these test cases to simplify the test code and\nbetter align it with production code.",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-10-16T00:33:39Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-07-20T17:52:39Z"
      },
      "sha": "9f72ef84a749dfe6b9328966f6ad7dc6c0c3cb03"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDI1NzQ3MWFlYWM3MTQ4YWM1ZTk4YWIwZGZmMDQ2MTdjOWE5ZjcxMzI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/257471aeac7148ac5e98ab0dff04617c9a9f7132",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/257471aeac7148ac5e98ab0dff04617c9a9f7132",
      "tree": {
        "sha": "82208962e749becdc28267977000a9cd69bb373f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/82208962e749becdc28267977000a9cd69bb373f"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 82208962e749becdc28267977000a9cd69bb373f\nparent 9f72ef84a749dfe6b9328966f6ad7dc6c0c3cb03\nauthor Andrew Toth <andrewstoth@gmail.com> 1753034147 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1760574819 -0400\n\ntest: assert no FRESH-but-not-DIRTY coins can occur\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmjwPWMACgkQYAB6/Ik4\nsBgEsA/+IqI5aIz+QN4+LEpE4O7msIBnBOECedCbZa649ptKOMT+A1Xttsg9CCBG\nnV9NCat6+f2Wxeo1+crxa1i3QqbVFwXvAL5I2dmQEtvTJdER/RzI0uyuktX9nccy\nn0jHhijnOmHvKaSM02KW6jPmIrQw9LSTFui52f0P56o7K/E3DHvgIGpCRu2M7lhE\nASh44jEVq9h0WoEDN3K8pvbx+BQVgoAZTRNRla9aTI2w26I6iTRLymDb+I2Gf5oP\nuCug6Ra6kWjlvbsB1ZlIT85yDW/vkll8G9CVG0vwzs6/DC5GyyIJLucQyGJCbIgh\nyQ+PuxEpQHxjNlc5+FijKzP/XPHo/w+askNFgZMtgU/jxQn35opfpdAYFceph7ai\nZI4zq/JCjRA3CIhNJPyLW+EA575PgbL/aTZCbmoCH763ty2dBZkrBi59ne9vidIC\npDH5ZlsnH/UwiyJQHbL/q06bvzzAQSlc5euYtPpEtPXP+D91x9WbKT4oAMqMxn15\nII8z2/aB+N85SZJnf4K9TqQkAeB93/OYc7jGCwgg2IbZnrnOkKXYA3jmYaNpUfNA\n7VhXGLOr47cyLFyyHEwTpLi9DsnY7+F1eVeTCFNF7V79f6+ILhiBCbfV1KusWFTW\nEenWBoJzAalhW15C8GBeRppmt46yV0d/uFPT8l5r1CRSNSSSXRs=\n=w8/i\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9f72ef84a749dfe6b9328966f6ad7dc6c0c3cb03",
          "sha": "9f72ef84a749dfe6b9328966f6ad7dc6c0c3cb03",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9f72ef84a749dfe6b9328966f6ad7dc6c0c3cb03"
        }
      ],
      "message": "test: assert no FRESH-but-not-DIRTY coins can occur",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-10-16T00:33:39Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-07-20T17:55:47Z"
      },
      "sha": "257471aeac7148ac5e98ab0dff04617c9a9f7132"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDJmOGQwOWQ3YTE5ZjA3NDk3MGFhYTg0ODhjMWVkYWE0MjUxNDhmNTc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2f8d09d7a19f074970aaa8488c1edaa425148f57",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/2f8d09d7a19f074970aaa8488c1edaa425148f57",
      "tree": {
        "sha": "409a7cfa1bba120098cd310e562f68af0ee67e55",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/409a7cfa1bba120098cd310e562f68af0ee67e55"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 409a7cfa1bba120098cd310e562f68af0ee67e55\nparent 257471aeac7148ac5e98ab0dff04617c9a9f7132\nauthor Andrew Toth <andrewstoth@gmail.com> 1753034772 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1760574850 -0400\n\ncoins: remove SetFresh method from CCoinsCacheEntry\n\nThere are no instances where SetFresh is called without being\npreceded by SetDirty. This replaces SetFresh with a boolean flag\npassed to SetDirty to indicate whether the DIRTY coin should also\nbe set to FRESH. This removes the possibility of setting a\nFRESH-but-not-DIRTY cached coin state.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmjwPYMACgkQYAB6/Ik4\nsBjbEQ/9Er2FxqW8QvZKXWeQkK7wErkn9ZjCXLsVSZ43W1+ZPy4iCT6YeM1LLEph\njWboD1OTVvMphnhVaDCL2iecxBhKu5e5ggmBtrsuaUJLl0ehI5xPhUx+FuvkDE/9\nSf2mxVZFxf5eu05Sx6MgkPynd6+QE6qwiw76DCZyZ+Hw1osVdcMZASIQ6zJInJVq\nTxsGWheeWWCAdQwizykWuwhf0MrruamlEDhZzS7sPltL98BKnFJl9DMCoTvSOD0g\nPkjW/pGa8CD9Qu0uvhuLKZXG6MPE6oJUOid+/NEClAmwTN7H7gTEuEInaZKHuVsk\nLHwyIlkmhAB5iiovgKsxnzGnORJHX10AOfoQOe7I2KaUQm3r3FlwDG5AO1LSqYyZ\n7DtvZT/R1HsC8uc39tfOo3Jpf81rsutBSVkdBaRHCYq2f1apYHIlbyVOOPGe2+pj\nZ7eZ9dVO2KFCPZrJHcuURUvBZJKlBiEK4bveUWw7OkNSKOGQxytuwRkKBKJCiyRX\nEYih6oTehEdgqpb12Zoq2hbgM6Z+3qNdL2VKB2Mt/OQ5kECYQ+ribZ2/+ECjk/EI\nhDnhb4ftvlne3E6lAN+tT3wJbQVptjphOAPPfr2GLKi/zpflr17affhF3CpuiD3K\njrTqf/w93NvltClqcY5w/gPBmolA1vjao88YPYSTDcp1opV04S8=\n=7DPW\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/257471aeac7148ac5e98ab0dff04617c9a9f7132",
          "sha": "257471aeac7148ac5e98ab0dff04617c9a9f7132",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/257471aeac7148ac5e98ab0dff04617c9a9f7132"
        }
      ],
      "message": "coins: remove SetFresh method from CCoinsCacheEntry\n\nThere are no instances where SetFresh is called without being\npreceded by SetDirty. This replaces SetFresh with a boolean flag\npassed to SetDirty to indicate whether the DIRTY coin should also\nbe set to FRESH. This removes the possibility of setting a\nFRESH-but-not-DIRTY cached coin state.",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-10-16T00:34:10Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-07-20T18:06:12Z"
      },
      "sha": "2f8d09d7a19f074970aaa8488c1edaa425148f57"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk4Njk4YjQ1ZDUzZjkyNjAzYWRhMTQ2ODlmMzc3ZGYzZGY5NzM4OTM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/98698b45d53f92603ada14689f377df3df973893",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/98698b45d53f92603ada14689f377df3df973893",
      "tree": {
        "sha": "f3cad09e09df4f9f1d08ed1c64e4060db4725dad",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f3cad09e09df4f9f1d08ed1c64e4060db4725dad"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree f3cad09e09df4f9f1d08ed1c64e4060db4725dad\nparent 2f8d09d7a19f074970aaa8488c1edaa425148f57\nauthor Andrew Toth <andrewstoth@gmail.com> 1753034941 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1760574851 -0400\n\ncoins: inline CCoinsViewCache::AddFlags into SetDirty\n\nThere is only one callsite now for AddFlags, so we can inline\nit into SetDirty.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmjwPYMACgkQYAB6/Ik4\nsBhKVBAAqgxsl+rmoTYT1ZJInBPJAPpFZWTRzDZtjG6Dro/IvvdeCJ63JWtNrX0P\n46SP010DkJJo//vbmKG1wUIfM5SyVbHoJBl0T8tL0onXxQqPfp92cOYHjlXbeZw8\nls8GfzByG1a/PgZChcRriZaY3c4Xz0vM9zkBQ4FsqSfgWZWtJPiEzwxXn1BvTaJG\nqiBmDZF+EudLHIiYebceZXxuICsxj7dg2GddYegh5eCA2XvaugHELUHpEvy0FmSx\noDURofmDJ7gjI9mvRXl1XpDxkhbNtrzFxCKAhKz2Ho4bbqERRJ+4QPE3B/i3UfzA\nliZmKC6MdZgtcUcY+746F8cJ5F1t8mowKXoGHfnvC0aX8LjKuRPNfw6azYu2dcUd\nECe5MoUGb5DtgeHfyknTX0RElThpgxnF8HUZtRb+t5jkXsZw6fQZMGMDjztMjcr4\n+sKPAbeX+VV9yuTKqKzIzZhYOdTep71Wl0G4ljNcWSXQKxBcjVGuHWw5tmW5O7F6\nKcJAZza+f5JSmYu2iW/hS5eCfpNBGFvzLbZoxuMm96drk/qY/p0r0KDo3mwQ7ZvU\n2AYOtQjCblOdE048J/uFXN/YqzUtJBREyHI70gVK52QRE+BxpcZc5ATUAkRxTsha\nCfosY7QxiCMeANsEi89U/ffdlbgoZvqKKuR/xPhT9rPNqcY4wlU=\n=sSCm\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2f8d09d7a19f074970aaa8488c1edaa425148f57",
          "sha": "2f8d09d7a19f074970aaa8488c1edaa425148f57",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/2f8d09d7a19f074970aaa8488c1edaa425148f57"
        }
      ],
      "message": "coins: inline CCoinsViewCache::AddFlags into SetDirty\n\nThere is only one callsite now for AddFlags, so we can inline\nit into SetDirty.",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-10-16T00:34:11Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-07-20T18:09:01Z"
      },
      "sha": "98698b45d53f92603ada14689f377df3df973893"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20307550458,
      "node_id": "HRFPE_lADOABII587Bc6GezwAAAAS6bKD6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307550458",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/98698b45d53f92603ada14689f377df3df973893",
      "created_at": "2025-10-16T00:34:16Z"
    },
    {
      "event": "unlabeled",
      "id": 20307825723,
      "node_id": "UNLE_lADOABII587Bc6GezwAAAAS6cNQ7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307825723",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-16T01:10:27Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920312",
      "pull_request_review_id": 3036128101,
      "id": 2217920312,
      "node_id": "PRRC_kwDOABII586EMsc4",
      "diff_hunk": "@@ -148,8 +146,10 @@ class CoinsViewBottom final : public CCoinsView\n public:\n     std::optional<Coin> GetCoin(const COutPoint& outpoint) const final\n     {\n-        // TODO GetCoin shouldn't return spent coins\n-        if (auto it = m_data.find(outpoint); it != m_data.end()) return it->second;\n+        if (auto it = m_data.find(outpoint); it != m_data.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n         return std::nullopt;\n     }\n ",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 21,
      "original_position": 21,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "We should be able to remove `HaveCoin` now, since\r\n```C++\r\nbool CCoinsView::HaveCoin(const COutPoint &outpoint) const\r\n{\r\n    return GetCoin(outpoint).has_value();\r\n}\r\n```\r\nis more accurate (especially with the new extra assert)",
      "created_at": "2025-07-20T19:01:06Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217920312",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920312"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 155,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920379",
      "pull_request_review_id": 3036128101,
      "id": 2217920379,
      "node_id": "PRRC_kwDOABII586EMsd7",
      "diff_hunk": "@@ -51,10 +51,6 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\n         if (auto coin{base->GetCoin(outpoint)}) {\n             ret->second.coin = std::move(*coin);\n             cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n-            if (ret->second.coin.IsSpent()) { // TODO GetCoin cannot return spent coins",
      "path": "src/coins.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Now that we've removed it we should at least add an `Assume(!ret->second.coin.IsSpent());` here - or even an `assert`, since if we're not sure about this we shouldn't do it in the first place",
      "created_at": "2025-07-20T19:01:26Z",
      "updated_at": "2025-07-20T19:26:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217920379",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920379"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 54,
      "original_line": 54,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920517",
      "pull_request_review_id": 3036128101,
      "id": 2217920517,
      "node_id": "PRRC_kwDOABII586EMsgF",
      "diff_hunk": "@@ -188,14 +177,14 @@ struct CCoinsCacheEntry\n     bool IsDirty() const noexcept { return m_flags & DIRTY; }\n     bool IsFresh() const noexcept { return m_flags & FRESH; }\n \n-    //! Only call Next when this entry is DIRTY, FRESH, or both\n+    //! Only call Next when this entry is DIRTY or DIRTY-and-FRESH\n     CoinsCachePair* Next() const noexcept\n     {\n         Assume(m_flags);",
      "path": "src/coins.h",
      "position": 80,
      "original_position": 80,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I understand if you think it may modify too many things here, but I'd prefer an actual `Assume` instead of the comment:\r\n```suggestion\r\n    CoinsCachePair* Next() const noexcept\r\n    {\r\n        Assume(IsDirty());\r\n        return m_next;\r\n    }\r\n```\r\n\r\n(same for `Prev`)",
      "created_at": "2025-07-20T19:02:06Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217920517",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920517"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": 180,
      "original_start_line": 180,
      "start_side": "RIGHT",
      "line": 183,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920827",
      "pull_request_review_id": 3036128101,
      "id": 2217920827,
      "node_id": "PRRC_kwDOABII586EMsk7",
      "diff_hunk": "@@ -121,21 +121,6 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n-    //! Adding a flag requires a reference to the sentinel of the flagged pair linked list.\n-    static void AddFlags(uint8_t flags, CoinsCachePair& pair, CoinsCachePair& sentinel) noexcept\n-    {\n-        Assume(flags & (DIRTY | FRESH));",
      "path": "src/coins.h",
      "position": 35,
      "original_position": 7,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "we might want to mention in the commit message why we can safely remove this now",
      "created_at": "2025-07-20T19:03:03Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217920827",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217920827"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 134,
      "original_line": 134,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217921211",
      "pull_request_review_id": 3036128101,
      "id": 2217921211,
      "node_id": "PRRC_kwDOABII586EMsq7",
      "diff_hunk": "@@ -169,7 +154,16 @@ struct CCoinsCacheEntry\n \n     static void SetDirty(CoinsCachePair& pair, CoinsCachePair& sentinel, bool fresh = false) noexcept\n     {\n-        AddFlags(fresh ? DIRTY | FRESH : DIRTY, pair, sentinel);\n+        if (!pair.second.m_flags) {\n+            Assume(!pair.second.m_prev && !pair.second.m_next);\n+            pair.second.m_prev = sentinel.second.m_prev;\n+            pair.second.m_next = &sentinel;\n+            sentinel.second.m_prev = &pair;\n+            pair.second.m_prev->second.m_next = &pair;\n+        }\n+        Assume(pair.second.m_prev && pair.second.m_next);\n+        pair.second.m_flags |= DIRTY;\n+        if (fresh) pair.second.m_flags |= FRESH;",
      "path": "src/coins.h",
      "position": 67,
      "original_position": 36,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "What should happen when `fresh` is `false`?\r\nShouldn't we assert something like:\r\n```C++\r\nif (fresh) {\r\n    pair.second.m_flags |= FRESH; \r\n} else {\r\n    assert(!(pair.second.m_flags & FRESH));\r\n}",
      "created_at": "2025-07-20T19:04:30Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217921211",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217921211"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 166,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217921830",
      "pull_request_review_id": 3036128101,
      "id": 2217921830,
      "node_id": "PRRC_kwDOABII586EMs0m",
      "diff_hunk": "@@ -154,16 +154,16 @@ BOOST_AUTO_TEST_CASE(linked_list_set_state)\n     BOOST_CHECK_EQUAL(sentinel.second.Next(), &n1);\n     BOOST_CHECK_EQUAL(sentinel.second.Prev(), &n1);\n \n-    // Check that setting FRESH on new node inserts it after n1\n-    CCoinsCacheEntry::SetFresh(n2, sentinel);\n-    BOOST_CHECK(n2.second.IsFresh() && !n2.second.IsDirty());\n+    // Check that setting DIRTY and FRESH on new node inserts it after n1\n+    CCoinsCacheEntry::SetDirty(n2, sentinel, /*fresh=*/true);\n+    BOOST_CHECK(n2.second.IsFresh() && n2.second.IsDirty());",
      "path": "src/test/coinscachepair_tests.cpp",
      "position": 9,
      "original_position": 9,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: for consistency with other `SetDirty` calls we could swap the parameter order:\r\n```suggestion\r\n    BOOST_CHECK(n2.second.IsDirty() && n2.second.IsFresh());\r\n```\r\n\r\n----\r\n\r\nAlternatively we could rename `IsFresh` to `IsDirtyAndFresh` and assert that if fresh is true, so is dirty - which would simplify this line to asserting just a single method.",
      "created_at": "2025-07-20T19:06:43Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217921830",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217921830"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 159,
      "original_line": 159,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217922071",
      "pull_request_review_id": 3036128101,
      "id": 2217922071,
      "node_id": "PRRC_kwDOABII586EMs4X",
      "diff_hunk": "@@ -150,8 +150,7 @@ void TestCoinsView(FuzzedDataProvider& fuzzed_data_provider, CCoinsView& backend\n                         coins_cache_entry.coin = *opt_coin;\n                     }\n                     auto it{coins_map.emplace(random_out_point, std::move(coins_cache_entry)).first};\n-                    if (dirty) CCoinsCacheEntry::SetDirty(*it, sentinel);\n-                    if (fresh) CCoinsCacheEntry::SetFresh(*it, sentinel);\n+                    if (dirty) CCoinsCacheEntry::SetDirty(*it, sentinel, fresh);",
      "path": "src/test/fuzz/coins_view.cpp",
      "position": 15,
      "original_position": 6,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "definition of `fresh` should likely include `dirty` now:\r\n```C++\r\nconst auto fresh{dirty && fuzzed_data_provider.ConsumeBool()};\r\n```",
      "created_at": "2025-07-20T19:07:45Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217922071",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217922071"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 146,
      "original_line": 146,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217922169",
      "pull_request_review_id": 3036128101,
      "id": 2217922169,
      "node_id": "PRRC_kwDOABII586EMs55",
      "diff_hunk": "@@ -102,47 +102,25 @@ using CoinsCachePair = std::pair<const COutPoint, CCoinsCacheEntry>;\n  * - unspent, FRESH, DIRTY (e.g. a new coin created in the cache)\n  * - unspent, not FRESH, DIRTY (e.g. a coin changed in the cache during a reorg)\n  * - unspent, not FRESH, not DIRTY (e.g. an unspent coin fetched from the parent cache)\n- * - spent, FRESH, not DIRTY (e.g. a spent coin fetched from the parent cache)\n  * - spent, not FRESH, DIRTY (e.g. a coin is spent and spentness needs to be flushed to the parent)\n  */\n struct CCoinsCacheEntry\n {\n private:\n     /**\n      * These are used to create a doubly linked list of flagged entries.\n-     * They are set in SetDirty, SetFresh, and unset in SetClean.\n-     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     * They are set in SetDirty and unset in SetClean.\n+     * A flagged entry is any entry that is DIRTY or DIRTY and FRESH.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 15,
      "commit_id": "99b243d53e7ca3e824369e7e194981d814c04708",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\n     * A flagged entry is any entry that is DIRTY or DIRTY-and-FRESH.\r\n```\r\n(the or/and combination is confusing otherwise)",
      "created_at": "2025-07-20T19:08:14Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217922169",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217922169"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217923008",
      "pull_request_review_id": 3036128101,
      "id": 2217923008,
      "node_id": "PRRC_kwDOABII586EMtHA",
      "diff_hunk": "@@ -148,8 +146,10 @@ class CoinsViewBottom final : public CCoinsView\n public:\n     std::optional<Coin> GetCoin(const COutPoint& outpoint) const final\n     {\n-        // TODO GetCoin shouldn't return spent coins\n-        if (auto it = m_data.find(outpoint); it != m_data.end()) return it->second;\n+        if (auto it = m_data.find(outpoint); it != m_data.end()) {",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "99b243d53e7ca3e824369e7e194981d814c04708",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: for consistency with other overrides:\r\n```suggestion\r\n        if (auto it{m_data.find(outpoint)}; it != m_data.end()) {\r\n```",
      "created_at": "2025-07-20T19:10:42Z",
      "updated_at": "2025-07-20T19:20:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217923008",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217923008"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217925887",
      "pull_request_review_id": 3036128101,
      "id": 2217925887,
      "node_id": "PRRC_kwDOABII586EMtz_",
      "diff_hunk": "@@ -321,8 +315,8 @@ void CCoinsViewCache::SanityCheck() const\n         if (entry.IsDirty()) attr |= 1;\n         if (entry.IsFresh()) attr |= 2;\n         if (entry.coin.IsSpent()) attr |= 4;\n-        // Only 5 combinations are possible.\n-        assert(attr != 2 && attr != 4 && attr != 7);\n+        // Only 4 combinations are possible.\n+        assert(attr != 2 && attr != 4 && attr != 6 && attr != 7);",
      "path": "src/coins.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "great, now that we have this, can we call `SanityCheck` in more tests? I understood that we couldn't do it until now since we still had invalid states in fuzz/unit tests",
      "created_at": "2025-07-20T19:17:42Z",
      "updated_at": "2025-07-20T19:27:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2217925887",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2217925887"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 324,
      "original_line": 324,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218040983",
      "pull_request_review_id": 3036282843,
      "id": 2218040983,
      "node_id": "PRRC_kwDOABII586ENJ6X",
      "diff_hunk": "@@ -203,11 +198,10 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\n                     entry.coin = it->second.coin;\n                 }\n                 cachedCoinsUsage += entry.coin.DynamicMemoryUsage();\n-                CCoinsCacheEntry::SetDirty(*itUs, m_sentinel);",
      "path": "src/coins.cpp",
      "position": 26,
      "original_position": 25,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "note: the cursor contains dirty entries now, so `if (!it->second.IsDirty()) {` on line 186 is also a noop - could we add a TODO there to signal that we're aware of it but want to tackle it in a follow-up?",
      "created_at": "2025-07-21T01:11:45Z",
      "updated_at": "2025-07-21T01:11:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218040983",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218040983"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 210,
      "original_line": 210,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218050169",
      "pull_request_review_id": 3036298262,
      "id": 2218050169,
      "node_id": "PRRC_kwDOABII586ENMJ5",
      "diff_hunk": "@@ -148,8 +146,10 @@ class CoinsViewBottom final : public CCoinsView\n public:\n     std::optional<Coin> GetCoin(const COutPoint& outpoint) const final\n     {\n-        // TODO GetCoin shouldn't return spent coins\n-        if (auto it = m_data.find(outpoint); it != m_data.end()) return it->second;\n+        if (auto it = m_data.find(outpoint); it != m_data.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n         return std::nullopt;\n     }\n ",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 21,
      "original_position": 21,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920312,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-07-21T01:29:05Z",
      "updated_at": "2025-07-21T01:29:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218050169",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218050169"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 155,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218050233",
      "pull_request_review_id": 3036298324,
      "id": 2218050233,
      "node_id": "PRRC_kwDOABII586ENMK5",
      "diff_hunk": "@@ -51,10 +51,6 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\n         if (auto coin{base->GetCoin(outpoint)}) {\n             ret->second.coin = std::move(*coin);\n             cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n-            if (ret->second.coin.IsSpent()) { // TODO GetCoin cannot return spent coins",
      "path": "src/coins.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920379,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-07-21T01:29:13Z",
      "updated_at": "2025-07-21T01:29:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218050233",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218050233"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 54,
      "original_line": 54,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218050997",
      "pull_request_review_id": 3036299636,
      "id": 2218050997,
      "node_id": "PRRC_kwDOABII586ENMW1",
      "diff_hunk": "@@ -188,14 +177,14 @@ struct CCoinsCacheEntry\n     bool IsDirty() const noexcept { return m_flags & DIRTY; }\n     bool IsFresh() const noexcept { return m_flags & FRESH; }\n \n-    //! Only call Next when this entry is DIRTY, FRESH, or both\n+    //! Only call Next when this entry is DIRTY or DIRTY-and-FRESH\n     CoinsCachePair* Next() const noexcept\n     {\n         Assume(m_flags);",
      "path": "src/coins.h",
      "position": 80,
      "original_position": 80,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920517,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't see how that is different. `m_flags` being set implies `IsDirty()` now, so it is equivalent. I prefer not to change this.",
      "created_at": "2025-07-21T01:30:06Z",
      "updated_at": "2025-07-21T01:30:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218050997",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218050997"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": 180,
      "original_start_line": 180,
      "start_side": "RIGHT",
      "line": 183,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218053411",
      "pull_request_review_id": 3036303265,
      "id": 2218053411,
      "node_id": "PRRC_kwDOABII586ENM8j",
      "diff_hunk": "@@ -188,14 +177,14 @@ struct CCoinsCacheEntry\n     bool IsDirty() const noexcept { return m_flags & DIRTY; }\n     bool IsFresh() const noexcept { return m_flags & FRESH; }\n \n-    //! Only call Next when this entry is DIRTY, FRESH, or both\n+    //! Only call Next when this entry is DIRTY or DIRTY-and-FRESH\n     CoinsCachePair* Next() const noexcept\n     {\n         Assume(m_flags);",
      "path": "src/coins.h",
      "position": 80,
      "original_position": 80,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920517,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`Assume(m_flags);` would also be true for fresh only - `Assume(IsDirty());` is stricter",
      "created_at": "2025-07-21T01:34:38Z",
      "updated_at": "2025-07-21T01:37:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218053411",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218053411"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": 180,
      "original_start_line": 180,
      "start_side": "RIGHT",
      "line": 183,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218054579",
      "pull_request_review_id": 3036305261,
      "id": 2218054579,
      "node_id": "PRRC_kwDOABII586ENNOz",
      "diff_hunk": "@@ -148,8 +146,10 @@ class CoinsViewBottom final : public CCoinsView\n public:\n     std::optional<Coin> GetCoin(const COutPoint& outpoint) const final\n     {\n-        // TODO GetCoin shouldn't return spent coins\n-        if (auto it = m_data.find(outpoint); it != m_data.end()) return it->second;\n+        if (auto it = m_data.find(outpoint); it != m_data.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n         return std::nullopt;\n     }\n ",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 21,
      "original_position": 21,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920312,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Isn't that the same as the parent in `CCoinsView`?",
      "created_at": "2025-07-21T01:37:04Z",
      "updated_at": "2025-07-21T01:37:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218054579",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218054579"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 155,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218061776",
      "pull_request_review_id": 3036316470,
      "id": 2218061776,
      "node_id": "PRRC_kwDOABII586ENO_Q",
      "diff_hunk": "@@ -188,14 +177,14 @@ struct CCoinsCacheEntry\n     bool IsDirty() const noexcept { return m_flags & DIRTY; }\n     bool IsFresh() const noexcept { return m_flags & FRESH; }\n \n-    //! Only call Next when this entry is DIRTY, FRESH, or both\n+    //! Only call Next when this entry is DIRTY or DIRTY-and-FRESH\n     CoinsCachePair* Next() const noexcept\n     {\n         Assume(m_flags);",
      "path": "src/coins.h",
      "position": 80,
      "original_position": 80,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920517,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It's not possible to set fresh only now.",
      "created_at": "2025-07-21T01:47:42Z",
      "updated_at": "2025-07-21T01:47:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218061776",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218061776"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": 180,
      "original_start_line": 180,
      "start_side": "RIGHT",
      "line": 183,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218064237",
      "pull_request_review_id": 3036320785,
      "id": 2218064237,
      "node_id": "PRRC_kwDOABII586ENPlt",
      "diff_hunk": "@@ -188,14 +177,14 @@ struct CCoinsCacheEntry\n     bool IsDirty() const noexcept { return m_flags & DIRTY; }\n     bool IsFresh() const noexcept { return m_flags & FRESH; }\n \n-    //! Only call Next when this entry is DIRTY, FRESH, or both\n+    //! Only call Next when this entry is DIRTY or DIRTY-and-FRESH\n     CoinsCachePair* Next() const noexcept\n     {\n         Assume(m_flags);",
      "path": "src/coins.h",
      "position": 80,
      "original_position": 80,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920517,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Exactly, hence my recommendation ",
      "created_at": "2025-07-21T01:51:53Z",
      "updated_at": "2025-07-21T01:51:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218064237",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218064237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": 180,
      "original_start_line": 180,
      "start_side": "RIGHT",
      "line": 183,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218067867",
      "pull_request_review_id": 3036325893,
      "id": 2218067867,
      "node_id": "PRRC_kwDOABII586ENQeb",
      "diff_hunk": "@@ -102,47 +102,25 @@ using CoinsCachePair = std::pair<const COutPoint, CCoinsCacheEntry>;\n  * - unspent, FRESH, DIRTY (e.g. a new coin created in the cache)\n  * - unspent, not FRESH, DIRTY (e.g. a coin changed in the cache during a reorg)\n  * - unspent, not FRESH, not DIRTY (e.g. an unspent coin fetched from the parent cache)\n- * - spent, FRESH, not DIRTY (e.g. a spent coin fetched from the parent cache)\n  * - spent, not FRESH, DIRTY (e.g. a coin is spent and spentness needs to be flushed to the parent)\n  */\n struct CCoinsCacheEntry\n {\n private:\n     /**\n      * These are used to create a doubly linked list of flagged entries.\n-     * They are set in SetDirty, SetFresh, and unset in SetClean.\n-     * A flagged entry is any entry that is either DIRTY, FRESH, or both.\n+     * They are set in SetDirty and unset in SetClean.\n+     * A flagged entry is any entry that is DIRTY or DIRTY and FRESH.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 15,
      "commit_id": "99b243d53e7ca3e824369e7e194981d814c04708",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217922169,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-07-21T01:56:35Z",
      "updated_at": "2025-07-21T01:56:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218067867",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218067867"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218068273",
      "pull_request_review_id": 3036326661,
      "id": 2218068273,
      "node_id": "PRRC_kwDOABII586ENQkx",
      "diff_hunk": "@@ -321,8 +315,8 @@ void CCoinsViewCache::SanityCheck() const\n         if (entry.IsDirty()) attr |= 1;\n         if (entry.IsFresh()) attr |= 2;\n         if (entry.coin.IsSpent()) attr |= 4;\n-        // Only 5 combinations are possible.\n-        assert(attr != 2 && attr != 4 && attr != 7);\n+        // Only 4 combinations are possible.\n+        assert(attr != 2 && attr != 4 && attr != 6 && attr != 7);",
      "path": "src/coins.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217925887,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "We can't since we are still calling this with spent, dirty, and fresh entries. These would be deleted in production code. That can also be tackled in a follow-up.",
      "created_at": "2025-07-21T01:57:14Z",
      "updated_at": "2025-07-21T01:57:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218068273",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218068273"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 324,
      "original_line": 324,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218068575",
      "pull_request_review_id": 3036327280,
      "id": 2218068575,
      "node_id": "PRRC_kwDOABII586ENQpf",
      "diff_hunk": "@@ -203,11 +198,10 @@ bool CCoinsViewCache::BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &ha\n                     entry.coin = it->second.coin;\n                 }\n                 cachedCoinsUsage += entry.coin.DynamicMemoryUsage();\n-                CCoinsCacheEntry::SetDirty(*itUs, m_sentinel);",
      "path": "src/coins.cpp",
      "position": 26,
      "original_position": 25,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2218040983,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "There are quite a few places where we can clean up production and test logic to not have to deal with non-dirty entries in BatchWrite. I think there would be too many TODOs.",
      "created_at": "2025-07-21T01:57:47Z",
      "updated_at": "2025-07-21T01:57:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218068575",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218068575"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 210,
      "original_line": 210,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218068664",
      "pull_request_review_id": 3036327359,
      "id": 2218068664,
      "node_id": "PRRC_kwDOABII586ENQq4",
      "diff_hunk": "@@ -148,8 +146,10 @@ class CoinsViewBottom final : public CCoinsView\n public:\n     std::optional<Coin> GetCoin(const COutPoint& outpoint) const final\n     {\n-        // TODO GetCoin shouldn't return spent coins\n-        if (auto it = m_data.find(outpoint); it != m_data.end()) return it->second;\n+        if (auto it = m_data.find(outpoint); it != m_data.end()) {",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "99b243d53e7ca3e824369e7e194981d814c04708",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217923008,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-07-21T01:57:54Z",
      "updated_at": "2025-07-21T01:57:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218068664",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218068664"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218069073",
      "pull_request_review_id": 3036328308,
      "id": 2218069073,
      "node_id": "PRRC_kwDOABII586ENQxR",
      "diff_hunk": "@@ -321,8 +315,8 @@ void CCoinsViewCache::SanityCheck() const\n         if (entry.IsDirty()) attr |= 1;\n         if (entry.IsFresh()) attr |= 2;\n         if (entry.coin.IsSpent()) attr |= 4;\n-        // Only 5 combinations are possible.\n-        assert(attr != 2 && attr != 4 && attr != 7);\n+        // Only 4 combinations are possible.\n+        assert(attr != 2 && attr != 4 && attr != 6 && attr != 7);",
      "path": "src/coins.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217925887,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "You did enable it for a few additional cases, that's already a win 👍 ",
      "created_at": "2025-07-21T01:59:02Z",
      "updated_at": "2025-07-21T01:59:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218069073",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218069073"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 324,
      "original_line": 324,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218069128",
      "pull_request_review_id": 3036328369,
      "id": 2218069128,
      "node_id": "PRRC_kwDOABII586ENQyI",
      "diff_hunk": "@@ -150,8 +150,7 @@ void TestCoinsView(FuzzedDataProvider& fuzzed_data_provider, CCoinsView& backend\n                         coins_cache_entry.coin = *opt_coin;\n                     }\n                     auto it{coins_map.emplace(random_out_point, std::move(coins_cache_entry)).first};\n-                    if (dirty) CCoinsCacheEntry::SetDirty(*it, sentinel);\n-                    if (fresh) CCoinsCacheEntry::SetFresh(*it, sentinel);\n+                    if (dirty) CCoinsCacheEntry::SetDirty(*it, sentinel, fresh);",
      "path": "src/test/fuzz/coins_view.cpp",
      "position": 15,
      "original_position": 6,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217922071,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-07-21T01:59:08Z",
      "updated_at": "2025-07-21T01:59:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218069128",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218069128"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 146,
      "original_line": 146,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218070113",
      "pull_request_review_id": 3036329626,
      "id": 2218070113,
      "node_id": "PRRC_kwDOABII586ENRBh",
      "diff_hunk": "@@ -321,8 +315,8 @@ void CCoinsViewCache::SanityCheck() const\n         if (entry.IsDirty()) attr |= 1;\n         if (entry.IsFresh()) attr |= 2;\n         if (entry.coin.IsSpent()) attr |= 4;\n-        // Only 5 combinations are possible.\n-        assert(attr != 2 && attr != 4 && attr != 7);\n+        // Only 4 combinations are possible.\n+        assert(attr != 2 && attr != 4 && attr != 6 && attr != 7);",
      "path": "src/coins.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217925887,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Err, I did but didn't test locally before pushing. I will have to revert. Tests are failing.",
      "created_at": "2025-07-21T02:01:21Z",
      "updated_at": "2025-07-21T02:01:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218070113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218070113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 324,
      "original_line": 324,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218071116",
      "pull_request_review_id": 3036331142,
      "id": 2218071116,
      "node_id": "PRRC_kwDOABII586ENRRM",
      "diff_hunk": "@@ -121,21 +121,6 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n-    //! Adding a flag requires a reference to the sentinel of the flagged pair linked list.\n-    static void AddFlags(uint8_t flags, CoinsCachePair& pair, CoinsCachePair& sentinel) noexcept\n-    {\n-        Assume(flags & (DIRTY | FRESH));",
      "path": "src/coins.h",
      "position": 35,
      "original_position": 7,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920827,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't see what can be explained more than the code? This seems obvious to me.",
      "created_at": "2025-07-21T02:04:03Z",
      "updated_at": "2025-07-21T02:04:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218071116",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218071116"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 134,
      "original_line": 134,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218071185",
      "pull_request_review_id": 3036331255,
      "id": 2218071185,
      "node_id": "PRRC_kwDOABII586ENRSR",
      "diff_hunk": "@@ -321,8 +315,8 @@ void CCoinsViewCache::SanityCheck() const\n         if (entry.IsDirty()) attr |= 1;\n         if (entry.IsFresh()) attr |= 2;\n         if (entry.coin.IsSpent()) attr |= 4;\n-        // Only 5 combinations are possible.\n-        assert(attr != 2 && attr != 4 && attr != 7);\n+        // Only 4 combinations are possible.\n+        assert(attr != 2 && attr != 4 && attr != 6 && attr != 7);",
      "path": "src/coins.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217925887,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Can we fix those cases instead? Having a sanitycheck which isn't run just gives us a false sense of security otherwise\r\n",
      "created_at": "2025-07-21T02:04:15Z",
      "updated_at": "2025-07-21T02:04:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218071185",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218071185"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 324,
      "original_line": 324,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218071890",
      "pull_request_review_id": 3036332453,
      "id": 2218071890,
      "node_id": "PRRC_kwDOABII586ENRdS",
      "diff_hunk": "@@ -121,21 +121,6 @@ struct CCoinsCacheEntry\n     CoinsCachePair* m_next{nullptr};\n     uint8_t m_flags{0};\n \n-    //! Adding a flag requires a reference to the sentinel of the flagged pair linked list.\n-    static void AddFlags(uint8_t flags, CoinsCachePair& pair, CoinsCachePair& sentinel) noexcept\n-    {\n-        Assume(flags & (DIRTY | FRESH));",
      "path": "src/coins.h",
      "position": 35,
      "original_position": 7,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920827,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ok, agree, please resolve the comment",
      "created_at": "2025-07-21T02:05:34Z",
      "updated_at": "2025-07-21T02:05:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218071890",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218071890"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 134,
      "original_line": 134,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218079735",
      "pull_request_review_id": 3036343490,
      "id": 2218079735,
      "node_id": "PRRC_kwDOABII586ENTX3",
      "diff_hunk": "@@ -148,8 +146,10 @@ class CoinsViewBottom final : public CCoinsView\n public:\n     std::optional<Coin> GetCoin(const COutPoint& outpoint) const final\n     {\n-        // TODO GetCoin shouldn't return spent coins\n-        if (auto it = m_data.find(outpoint); it != m_data.end()) return it->second;\n+        if (auto it = m_data.find(outpoint); it != m_data.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n         return std::nullopt;\n     }\n ",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 21,
      "original_position": 21,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217920312,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ah right, removed.",
      "created_at": "2025-07-21T02:21:43Z",
      "updated_at": "2025-07-21T02:21:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218079735",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218079735"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 155,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218080120",
      "pull_request_review_id": 3036343964,
      "id": 2218080120,
      "node_id": "PRRC_kwDOABII586ENTd4",
      "diff_hunk": "@@ -169,7 +154,16 @@ struct CCoinsCacheEntry\n \n     static void SetDirty(CoinsCachePair& pair, CoinsCachePair& sentinel, bool fresh = false) noexcept\n     {\n-        AddFlags(fresh ? DIRTY | FRESH : DIRTY, pair, sentinel);\n+        if (!pair.second.m_flags) {\n+            Assume(!pair.second.m_prev && !pair.second.m_next);\n+            pair.second.m_prev = sentinel.second.m_prev;\n+            pair.second.m_next = &sentinel;\n+            sentinel.second.m_prev = &pair;\n+            pair.second.m_prev->second.m_next = &pair;\n+        }\n+        Assume(pair.second.m_prev && pair.second.m_next);\n+        pair.second.m_flags |= DIRTY;\n+        if (fresh) pair.second.m_flags |= FRESH;",
      "path": "src/coins.h",
      "position": 67,
      "original_position": 36,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217921211,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I suppose its legal to call SetDirty on a coin that is already DIRTY-and-FRESH. I'm not sure we need to do anything here in that case.",
      "created_at": "2025-07-21T02:22:30Z",
      "updated_at": "2025-07-21T02:22:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218080120",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218080120"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 166,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218081257",
      "pull_request_review_id": 3036345672,
      "id": 2218081257,
      "node_id": "PRRC_kwDOABII586ENTvp",
      "diff_hunk": "@@ -169,7 +154,16 @@ struct CCoinsCacheEntry\n \n     static void SetDirty(CoinsCachePair& pair, CoinsCachePair& sentinel, bool fresh = false) noexcept\n     {\n-        AddFlags(fresh ? DIRTY | FRESH : DIRTY, pair, sentinel);\n+        if (!pair.second.m_flags) {\n+            Assume(!pair.second.m_prev && !pair.second.m_next);\n+            pair.second.m_prev = sentinel.second.m_prev;\n+            pair.second.m_next = &sentinel;\n+            sentinel.second.m_prev = &pair;\n+            pair.second.m_prev->second.m_next = &pair;\n+        }\n+        Assume(pair.second.m_prev && pair.second.m_next);\n+        pair.second.m_flags |= DIRTY;\n+        if (fresh) pair.second.m_flags |= FRESH;",
      "path": "src/coins.h",
      "position": 67,
      "original_position": 36,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217921211,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Should we remove its freshness in that case?",
      "created_at": "2025-07-21T02:24:47Z",
      "updated_at": "2025-07-21T02:24:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218081257",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218081257"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 166,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218084376",
      "pull_request_review_id": 3036350295,
      "id": 2218084376,
      "node_id": "PRRC_kwDOABII586ENUgY",
      "diff_hunk": "@@ -169,7 +154,16 @@ struct CCoinsCacheEntry\n \n     static void SetDirty(CoinsCachePair& pair, CoinsCachePair& sentinel, bool fresh = false) noexcept\n     {\n-        AddFlags(fresh ? DIRTY | FRESH : DIRTY, pair, sentinel);\n+        if (!pair.second.m_flags) {\n+            Assume(!pair.second.m_prev && !pair.second.m_next);\n+            pair.second.m_prev = sentinel.second.m_prev;\n+            pair.second.m_next = &sentinel;\n+            sentinel.second.m_prev = &pair;\n+            pair.second.m_prev->second.m_next = &pair;\n+        }\n+        Assume(pair.second.m_prev && pair.second.m_next);\n+        pair.second.m_flags |= DIRTY;\n+        if (fresh) pair.second.m_flags |= FRESH;",
      "path": "src/coins.h",
      "position": 67,
      "original_position": 36,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217921211,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "No, that would make this a behavior change rather than a refactor. We only added flags before, so we must only do that now as well.",
      "created_at": "2025-07-21T02:29:55Z",
      "updated_at": "2025-07-21T02:29:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218084376",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218084376"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 166,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218086462",
      "pull_request_review_id": 3036353147,
      "id": 2218086462,
      "node_id": "PRRC_kwDOABII586ENVA-",
      "diff_hunk": "@@ -169,7 +154,16 @@ struct CCoinsCacheEntry\n \n     static void SetDirty(CoinsCachePair& pair, CoinsCachePair& sentinel, bool fresh = false) noexcept\n     {\n-        AddFlags(fresh ? DIRTY | FRESH : DIRTY, pair, sentinel);\n+        if (!pair.second.m_flags) {\n+            Assume(!pair.second.m_prev && !pair.second.m_next);\n+            pair.second.m_prev = sentinel.second.m_prev;\n+            pair.second.m_next = &sentinel;\n+            sentinel.second.m_prev = &pair;\n+            pair.second.m_prev->second.m_next = &pair;\n+        }\n+        Assume(pair.second.m_prev && pair.second.m_next);\n+        pair.second.m_flags |= DIRTY;\n+        if (fresh) pair.second.m_flags |= FRESH;",
      "path": "src/coins.h",
      "position": 67,
      "original_position": 36,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217921211,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "But we have prohibited one of the states here, we can document that with code now instead of comments. If we think it's a behavior change the PR is incorrect, isn't it?",
      "created_at": "2025-07-21T02:34:31Z",
      "updated_at": "2025-07-21T02:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218086462",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218086462"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 166,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218086535",
      "pull_request_review_id": 3036353511,
      "id": 2218086535,
      "node_id": "PRRC_kwDOABII586ENVCH",
      "diff_hunk": "@@ -321,8 +315,8 @@ void CCoinsViewCache::SanityCheck() const\n         if (entry.IsDirty()) attr |= 1;\n         if (entry.IsFresh()) attr |= 2;\n         if (entry.coin.IsSpent()) attr |= 4;\n-        // Only 5 combinations are possible.\n-        assert(attr != 2 && attr != 4 && attr != 7);\n+        // Only 4 combinations are possible.\n+        assert(attr != 2 && attr != 4 && attr != 6 && attr != 7);",
      "path": "src/coins.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217925887,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I can make a follow-up to remove spent fresh and dirty entries from the test cases as well. I don't think that should happen in this PR though to keep it focused.\nThe previous PR also did this.",
      "created_at": "2025-07-21T02:34:43Z",
      "updated_at": "2025-07-21T02:34:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218086535",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218086535"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 324,
      "original_line": 324,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218092689",
      "pull_request_review_id": 3036363265,
      "id": 2218092689,
      "node_id": "PRRC_kwDOABII586ENWiR",
      "diff_hunk": "@@ -169,7 +154,16 @@ struct CCoinsCacheEntry\n \n     static void SetDirty(CoinsCachePair& pair, CoinsCachePair& sentinel, bool fresh = false) noexcept\n     {\n-        AddFlags(fresh ? DIRTY | FRESH : DIRTY, pair, sentinel);\n+        if (!pair.second.m_flags) {\n+            Assume(!pair.second.m_prev && !pair.second.m_next);\n+            pair.second.m_prev = sentinel.second.m_prev;\n+            pair.second.m_next = &sentinel;\n+            sentinel.second.m_prev = &pair;\n+            pair.second.m_prev->second.m_next = &pair;\n+        }\n+        Assume(pair.second.m_prev && pair.second.m_next);\n+        pair.second.m_flags |= DIRTY;\n+        if (fresh) pair.second.m_flags |= FRESH;",
      "path": "src/coins.h",
      "position": 67,
      "original_position": 36,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217921211,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Your suggestion is to assert that if fresh is false then the entry cannot already be fresh. This is not the case. An entry can be made DIRTY-and-FRESH, and then it can be made DIRTY again while already DIRTY-and-FRESH. The current behavior allows this to happen and keeps the entry DIRTY-and-FRESH when SetDirty is called. If we assert that we can't call SetDirty on a DIRTY-and-FRESH entry then it is a behavior change.",
      "created_at": "2025-07-21T02:45:01Z",
      "updated_at": "2025-07-21T02:45:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218092689",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218092689"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 166,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218093659",
      "pull_request_review_id": 3036364564,
      "id": 2218093659,
      "node_id": "PRRC_kwDOABII586ENWxb",
      "diff_hunk": "@@ -169,7 +154,16 @@ struct CCoinsCacheEntry\n \n     static void SetDirty(CoinsCachePair& pair, CoinsCachePair& sentinel, bool fresh = false) noexcept\n     {\n-        AddFlags(fresh ? DIRTY | FRESH : DIRTY, pair, sentinel);\n+        if (!pair.second.m_flags) {\n+            Assume(!pair.second.m_prev && !pair.second.m_next);\n+            pair.second.m_prev = sentinel.second.m_prev;\n+            pair.second.m_next = &sentinel;\n+            sentinel.second.m_prev = &pair;\n+            pair.second.m_prev->second.m_next = &pair;\n+        }\n+        Assume(pair.second.m_prev && pair.second.m_next);\n+        pair.second.m_flags |= DIRTY;\n+        if (fresh) pair.second.m_flags |= FRESH;",
      "path": "src/coins.h",
      "position": 67,
      "original_position": 36,
      "commit_id": "98698b45d53f92603ada14689f377df3df973893",
      "original_commit_id": "8eb06adaaae4534b31aba0a4d0e4862b72f5c310",
      "in_reply_to_id": 2217921211,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nah, I'm just on a phone and thought I'm commenting on SetDirty and SetFresh. ",
      "created_at": "2025-07-21T02:47:07Z",
      "updated_at": "2025-07-21T02:47:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33018#discussion_r2218093659",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2218093659"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33018"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 166,
      "original_line": 166,
      "side": "RIGHT"
    }
  ]
}