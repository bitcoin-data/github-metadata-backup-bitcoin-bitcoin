{
  "type": "issue",
  "issue": {
    "id": 2176381162,
    "node_id": "I_kwDOABII586BuPDq",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/29603",
    "number": 29603,
    "state": "open",
    "state_reason": null,
    "title": "Current default settings are broken, some fix is needed",
    "body": "### Please describe the feature you'd like to see added.\r\n\r\nBetter default settings, or fix to database cache handling\r\n\r\n### Is your feature related to a problem, if so please describe it.\r\n\r\nWhen doing IBD using default settings, on a relatively fast machine on relatively fast HDD everything works well until ~when segwit was activated. After that ETA estimate shot up from 4 days to 3 weeks. Investigating, my 1MB/s internet was downloading only about 15% of the time. The operating system became extremely laggy, and i found that the HDD was stuck on 100% IO load, doing 4-6MB/s read, plus the normal occasional writes for downloaded parts.\r\n\r\nI tried increasing db cache by 2x to 900MB, but absolutely nothing changed. RAM usage etc. same.\r\n\r\nSearching for issues i found that many \"fixed\" it by putting chainstate on SSD. This was not an option, so i started looking into putting it into a ramdrive. But then in a random comment about using a ramdrive someone said using more than 8000 dbcache makes the full chainstate fit into ram, essentially achieving the same. I was skeptical, since doubling it had not made any difference. But i decided to test it with 8500.\r\n\r\nAnd Bitcoin started working perfectly. Continuous download, low IO load, much faster write throughput. Something bordering unusable became smooth. So why is this a feature request instead of \"that's expected with such high db cache\"\r\n\r\nBecause even a device with only 3 gigs of ram can use a value of 8500 and start working well, instead of being useless. It takes something like 8 hours before bitcoin's RAM usage reaches 3 gigs when syncing at 1MB/s. And at this point one can restart bitcoin which frees the ram, and sync for another 8 hours.\r\n\r\nThis is very weird that there exists an undocumented \"threshold\" where dbcache's operation changes completely, starting to work as an actual cache, freeing the HDD from doing constant small random read operations.\r\n\r\n### Describe the solution you'd like\r\n\r\njust drop dbcache setting completely, let it grow as needed and when RAM starts to get full, just flush it as if restarting bitcoin. I wonder how many HDD:s have broken down due to weeks long constant 100% random read IO stress due to this issue, and how many users gave up on the idea of running a node because they thought their machine is not up to the task.\r\n\r\n### Describe any alternatives you've considered\r\n\r\nchange default setting to the minimum value that can support proper cache behavior after segwit blocks. Warn user that reducing the cache will cause extreme slowdown and disk stress when doing IBD after segwit blocks start, practically only doable with SSD.",
    "user": {
      "login": "reivanen",
      "id": 6353462,
      "node_id": "MDQ6VXNlcjYzNTM0NjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/reivanen",
      "html_url": "https://github.com/reivanen",
      "followers_url": "https://api.github.com/users/reivanen/followers",
      "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
      "organizations_url": "https://api.github.com/users/reivanen/orgs",
      "repos_url": "https://api.github.com/users/reivanen/repos",
      "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/reivanen/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 326918230,
        "node_id": "MDU6TGFiZWwzMjY5MTgyMzA=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Resource%20usage",
        "name": "Resource usage",
        "color": "981023",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 7,
    "created_at": "2024-03-08T16:34:45Z",
    "updated_at": "2024-03-12T09:09:25Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 12057997744,
      "node_id": "LE_lADOABII586BuPDqzwAAAALOtnGw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12057997744",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T16:34:45Z",
      "label": {
        "name": "Feature",
        "color": "7cf575"
      }
    },
    {
      "event": "commented",
      "id": 1986067957,
      "node_id": "IC_kwDOABII5852YP31",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986067957",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T17:01:39Z",
      "updated_at": "2024-03-08T17:01:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "Hi @reivanen, thanks for your report.\r\n\r\nIt is documented in https://github.com/bitcoin/bitcoin/blob/master/doc/reduce-memory.md#in-memory-caches that higher dbcache settings give better IBD performance, and I think it stands to reason that this effect would be more pronounced on slower hardware.\r\n\r\nI do agree though that it could be stated more clearly (other than in a doc titled \"reduce memory\") that this known effect occurs.\r\n\r\nThere is also a somewhat-related [PR open ](https://github.com/bitcoin/bitcoin/pull/28358)to increase the maximum dbcache value, to further speed up IBD.\r\n\r\nIn my opinion the current program model of having a constrained memory footprint is preferable to making it unconstrained. If you want to speed up IDB then you can temporarily increase your cache size (to another known maximum size), and after IDB is complete and you are in sync, the (known) memory constraints make Bitcoin Core a more stable program to run and use overall.\r\n\r\nAdditionally, having the program notified that \"memory is running out\" is often more simply said-than-done, usually requiring workarounds which also in turn can make other internals harder to reason about than fixed sizes.\r\n\r\nI have a spinning HDD so may get around to try your cache size cutoff and see if I can also notice the performance differences you mention.",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986067957",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "mentioned",
      "id": 12058354779,
      "node_id": "MEE_lADOABII586BuPDqzwAAAALOu-Rb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12058354779",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T17:01:41Z"
    },
    {
      "event": "subscribed",
      "id": 12058354810,
      "node_id": "SE_lADOABII586BuPDqzwAAAALOu-R6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12058354810",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-08T17:01:41Z"
    },
    {
      "event": "commented",
      "id": 1986824229,
      "node_id": "IC_kwDOABII5852bIgl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986824229",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-09T10:56:02Z",
      "updated_at": "2024-03-09T12:26:45Z",
      "author_association": "NONE",
      "body": "This is not just an issue of \"better performance with larger dbcache\" but a completely different way of working (depending on how much dbcache is used of total allocated?).\r\n\r\nI tested by increasing the network speed to 2MB/s. It worked as good as with 1, HDD was more than able to keep up. Until RAM usage had gone to around 8000 used from 8500 total, then the 100% IO READ started and download happening only a fraction of the time. Restart bitcoin, and it continues to download at 2MB/s continuously, presumably until 8 gigs of ram has filled.\r\n\r\nSo after these data points i don't see any other easy \"fix\" than making the default dbcache size large enough to properly process segwit blocks, and then purge the cache every time it is starting to fill up, before the \"phase change\" happens in cache behavior.\r\n\r\nI should not need to periodically restart bitcoin to make it work properly. (also it seems like the source i read is outdated, because currently the whole chainstate does not seem to fit into 8 gigs and it starts throttling DL speed due to the random reads. I will test with dbcache 10000 if it will finally sync to the end properly.",
      "user": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986824229",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "commented",
      "id": 1986828626,
      "node_id": "IC_kwDOABII5852bJlS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1986828626",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-09T11:16:15Z",
      "updated_at": "2024-03-09T12:28:48Z",
      "author_association": "NONE",
      "body": "One more data point came to mind: this seems to be related to segwit?\r\n\r\nBecause i was able to properly process the blockchain until around segwit activation using 450MB dbcache. But after that even 8500 dbcache was not enough, but started throttling as it (or RAM) came close to filling up.",
      "user": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1986828626",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "unlabeled",
      "id": 12070867581,
      "node_id": "UNLE_lADOABII586BuPDqzwAAAALPetJ9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12070867581",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-11T09:49:55Z",
      "label": {
        "name": "Feature",
        "color": "7cf575"
      }
    },
    {
      "event": "labeled",
      "id": 12070867588,
      "node_id": "LE_lADOABII586BuPDqzwAAAALPetKE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12070867588",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-11T09:49:55Z",
      "label": {
        "name": "Resource usage",
        "color": "981023"
      }
    },
    {
      "event": "commented",
      "id": 1988257599,
      "node_id": "IC_kwDOABII5852gmc_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1988257599",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-11T11:48:00Z",
      "updated_at": "2024-03-11T11:49:09Z",
      "author_association": "MEMBER",
      "body": "@reivanen is you node pruned? If it is, make sure to test on a recent version of master - #20827 may have improved performance for pruned nodes.\r\n\r\nIf your node is not pruned, then #28358 should help, but only until you run out of RAM (and if you don't there may be diminishing returns).\r\n\r\nThe `-dbcache` feature reduces frequent disk _writes_, because it delays the process of writing new coins to disk. If you use it all the way through IBD, then it also reduces disk _reads_, since all the coins you created are in RAM.\r\n\r\nOnce you run out of RAM the cache is flushed. So from that point onwards you still have the benefit of fewer writes (it waits until the next flush), but for reading you have to fetch coins from disk (unless the coins are from after the last flush, in which case they're in RAM).\r\n\r\n> I tried increasing db cache by 2x to 900MB, but absolutely nothing changed. RAM usage etc. same.\r\n\r\nThe RAM is only used when needed. So it takes a while before you should see a difference.\r\n\r\n> even a device with only 3 gigs of ram can use a value of 8500\r\n\r\nYou would run of out of memory and crash once dbcache grows beyond the size of your RAM.\r\n\r\nBefore that, things may grind to a halt if you have swap configured; your operating system will start writing RAM to disk, defeating the purpose of `-dbcache`. I'm not sure at what point that kicks in. But for benchmarking you may want to turn swap off.\r\n\r\n> Until RAM usage had gone to around 8000 used from 8500 total, then the 100% IO READ started and download happening only a fraction of the time.\r\n\r\nIf you're pushing this close to the limit of your machine, swap might be the reason it slows down (and you're risking a crash). ",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1988257599",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "mentioned",
      "id": 12072395320,
      "node_id": "MEE_lADOABII586BuPDqzwAAAALPkiI4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12072395320",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-11T11:48:01Z"
    },
    {
      "event": "subscribed",
      "id": 12072395340,
      "node_id": "SE_lADOABII586BuPDqzwAAAALPkiJM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12072395340",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-11T11:48:01Z"
    },
    {
      "event": "commented",
      "id": 1989553030,
      "node_id": "IC_kwDOABII5852liuG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1989553030",
      "actor": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-11T22:26:16Z",
      "updated_at": "2024-03-11T22:26:16Z",
      "author_association": "NONE",
      "body": "i'm not running pruned.\r\n\r\nI did indeed turn off swap as first mitigation to see what is actually going on with RAM usage.\r\n\r\nFrom what you wrote it's curious why restarting bitcoin-qt will allow for it to continue syncing at high speed until dbcache fills up.",
      "user": {
        "login": "reivanen",
        "id": 6353462,
        "node_id": "MDQ6VXNlcjYzNTM0NjI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6353462?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/reivanen",
        "html_url": "https://github.com/reivanen",
        "followers_url": "https://api.github.com/users/reivanen/followers",
        "following_url": "https://api.github.com/users/reivanen/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/reivanen/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/reivanen/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/reivanen/subscriptions",
        "organizations_url": "https://api.github.com/users/reivanen/orgs",
        "repos_url": "https://api.github.com/users/reivanen/repos",
        "events_url": "https://api.github.com/users/reivanen/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/reivanen/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1989553030",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "commented",
      "id": 1991010152,
      "node_id": "IC_kwDOABII5852rGdo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991010152",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-12T08:16:58Z",
      "updated_at": "2024-03-12T08:16:58Z",
      "author_association": "MEMBER",
      "body": "Because if your dbcache is no longer in RAM but in swap on disk, it's going to slow down. When you restart dbcache is empty, so it's in RAM. Until it fills again and your OS moves it to swap. That's my theory anyway, you'd have to check if that's what's happening.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1991010152",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    },
    {
      "event": "commented",
      "id": 1991104111,
      "node_id": "IC_kwDOABII5852rdZv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1991104111",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-12T09:09:23Z",
      "updated_at": "2024-03-12T09:09:23Z",
      "author_association": "CONTRIBUTOR",
      "body": "Right, if you set dbcache higher than RAM available then the OS should start swapping it out when it runs out of (real) RAM. This should be expected to have bad performance because you are not using RAM cache for as much of the time as possible, and you become reliant on manually flushing the cache by restarting Bitcoin Core manually.\r\n\r\nIn the case that dbcache is set lower than available RAM, Bitcoin Core will process until the cache is filled, then flush it all to disk, largely emptying it's (fast, RAM) cache again. This should provide better performance, analagous to how you noticed that \"manually\" emptying the cache (by restarting bitcoind) did.\r\n\r\nBecause I was curious about the spinning disk speed I left a node syncing from a single LAN connection last night. This had a 7200rpm HDD and bitcoind used default settings apart from the following:\r\n\r\n```txt\r\ndaemon=1\r\nport=18833\r\nrpcport=18832\r\nblocksonly=1\r\nconnect=localhost:8833\r\n```\r\nThis implies a dbcache of 450MB.\r\n\r\nI plotted the times which blocks were processed according to the logfile in matplotlib, also marking segwit activation height:\r\n\r\n![spinning_IBD_529122](https://github.com/bitcoin/bitcoin/assets/6606587/b17419f8-bc0f-418b-849e-4f28ae27b78f)\r\n\r\nI also marked with red dots blocks who had an interval > 30 seconds from the last block, which in some cases might indicate cache flushes, but I did not log cache flushes so can't be sure.\r\n\r\nIt does not appear to me from the shape of the graph that there's any specific issue with segwit activation height and block processing times on IBD with default settings on a spinning disk. Rather the slope seems to follow general levels of the chains usage, which seems entriely in line with expectations.",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29603#issuecomment-1991104111",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29603"
    }
  ]
}