{
  "type": "issue",
  "issue": {
    "id": 1978336976,
    "node_id": "I_kwDOABII58516wbQ",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28801",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28801/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28801/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28801/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/28801",
    "number": 28801,
    "state": "closed",
    "state_reason": "completed",
    "title": "p2p_segwit.py fails with thread sanitizer",
    "body": "### Current behaviour\r\n\r\nUsing clang version 15.0.7 on Ubuntu and enabling the thread sanitizer, the `p2p_segwit.py --descriptors` test consistently fails.\r\n\r\nIt fails during the `Subtest: test_wtxid_relay (Segwit active = True)`.\r\n\r\nIt's different from #28800 in that this isn't a timeout. The subtests fails after about 5 seconds.\r\n\r\n```\r\nNode returned unexpected exit code (66) vs (0) when stopping\r\n```\r\n\r\n### Expected behaviour\r\n\r\nDon't fail.\r\n\r\n### Steps to reproduce\r\n\r\n```\r\nexport TSAN_OPTIONS=\"suppressions=$(pwd)/test/sanitizer_suppressions/tsan:halt_on_error=1:second_deadlock_stack=1\"\r\n./autogen\r\n./configure CC=clang CXX=clang++ --enable-suppress-external-warnings --with-sanitizers=thread --without-gui\r\nmake -j33\r\ntest/functional/p2p_segwit.py\r\n```\r\n\r\n### Relevant log output\r\n\r\n```\r\nstderr:\r\nTraceback (most recent call last):\r\n  File \"/home/sjors/dev/bitcoin/test/functional/p2p_segwit.py\", line 2070, in <module>\r\n    SegWitTest().main()\r\n  File \"/home/sjors/dev/bitcoin/test/functional/test_framework/test_framework.py\", line 155, in main\r\n    exit_code = self.shutdown()\r\n  File \"/home/sjors/dev/bitcoin/test/functional/test_framework/test_framework.py\", line 314, in shutdown\r\n    self.stop_nodes()\r\n  File \"/home/sjors/dev/bitcoin/test/functional/test_framework/test_framework.py\", line 580, in stop_nodes\r\n    node.wait_until_stopped()\r\n  File \"/home/sjors/dev/bitcoin/test/functional/test_framework/test_node.py\", line 409, in wait_until_stopped\r\n    wait_until_helper_internal(lambda: self.is_node_stopped(expected_ret_code=expected_ret_code, **kwargs), timeout=timeout, timeout_factor=self.timeout_factor)\r\n  File \"/home/sjors/dev/bitcoin/test/functional/test_framework/util.py\", line 264, in wait_until_helper_internal\r\n    if predicate():\r\n  File \"/home/sjors/dev/bitcoin/test/functional/test_framework/test_node.py\", line 409, in <lambda>\r\n    wait_until_helper_internal(lambda: self.is_node_stopped(expected_ret_code=expected_ret_code, **kwargs), timeout=timeout, timeout_factor=self.timeout_factor)\r\n  File \"/home/sjors/dev/bitcoin/test/functional/test_framework/test_node.py\", line 389, in is_node_stopped\r\n    assert return_code == expected_ret_code, self._node_msg(\r\nAssertionError: [node 0] Node returned unexpected exit code (66) vs (0) when stopping\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nCompiled from source\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nmaster@953d302a242381ae13112ea42f87d57e6e796147\r\n\r\n### Operating system and version\r\n\r\nUbuntu 23.04\r\n\r\n### Machine specifications\r\n\r\nAMD Ryzen 7950x",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 2,
    "closed_at": "2023-11-06T06:13:20Z",
    "created_at": "2023-11-06T05:43:27Z",
    "updated_at": "2023-11-06T06:14:32Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 1794142983,
      "node_id": "IC_kwDOABII585q8HMH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1794142983",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-11-06T06:04:59Z",
      "updated_at": "2023-11-06T06:06:59Z",
      "author_association": "MEMBER",
      "body": "Some warnings from the sanitizer: https://gist.github.com/Sjors/607c3426136db1c91b89acea3c62affb\r\n\r\n(running again with the supressions on)",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/28801#issuecomment-1794142983",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28801"
    },
    {
      "event": "commented",
      "id": 1794150128,
      "node_id": "IC_kwDOABII585q8I7w",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1794150128",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-11-06T06:13:20Z",
      "updated_at": "2023-11-06T06:14:32Z",
      "author_association": "MEMBER",
      "body": "Closing this. When I first saw this failure it was while running multiple tests in parallel. That was run by a script which _does_ use supressions. But when I tried to reproduce I forgot the suppressions. Running the indidivual test with suppressions on doesn't fail. And when I ran the test suite in parallel again it also didn't fail. So I think it was just a random failure.\r\n\r\nI'll try to get the logs from the parallel run next time; that way we can diagnose these more random failures.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/28801#issuecomment-1794150128",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28801"
    },
    {
      "event": "closed",
      "id": 10868084061,
      "node_id": "CE_lADOABII58516wbQzwAAAAKHyc1d",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10868084061",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-11-06T06:13:20Z"
    }
  ]
}