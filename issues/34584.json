{
  "type": "issue",
  "issue": {
    "id": 3938408116,
    "node_id": "I_kwDOABII587qv1a0",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34584",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34584/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34584/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34584/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/34584",
    "number": 34584,
    "state": "open",
    "state_reason": null,
    "title": "Bug: Race Condition in Mempool Fee Estimation Leading to Consensus Failure",
    "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWhen transactions are re-admitted to the mempool during block reorganizations, a race condition exists between [UpdateTransactionsFromBlock()](vscode-file://vscode-app/Applications/Visual%20Studio%20Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) and [LimitMempoolSize()](vscode-file://vscode-app/Applications/Visual%20Studio%20Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) that causes:\n\nStale UTXO cache ([m_view](vscode-file://vscode-app/Applications/Visual%20Studio%20Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)) data used for transaction validation\nValid transactions incorrectly rejected with \"mempool full\"\nInconsistent mempool state across nodes during reorg windows\nPotential consensus divergence between peers\nAffected Code: [validation.cpp](vscode-file://vscode-app/Applications/Visual%20Studio%20Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) lines 300-400 ([MaybeUpdateMempoolForReorg](vscode-file://vscode-app/Applications/Visual%20Studio%20Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)) and lines 585-900 ([MemPoolAccept](vscode-file://vscode-app/Applications/Visual%20Studio%20Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html) class)\n\nExpected Behaviour\nUTXO cache should be properly synchronized after mempool state changes\nTransaction validation must use current, accurate coin data\nAll nodes should reach consistent mempool state regardless of timing\nNo race conditions between mempool trimming and transaction acceptance\n\n### Expected behaviour\n\nMempool fee calculations should remain consistent and accurate during block reorganizations\nUTXO cache ([m_view](vscode-file://vscode-app/Applications/Visual%20Studio%20Code.app/Contents/Resources/app/out/vs/code/electron-browser/workbench/workbench.html)) must be properly synchronized after any mempool state change\nTransaction validation should use fresh, accurate coin data\nNo race conditions should exist between mempool trimming and fee estimation\nAll nodes should reach consensus on mempool contents regardless of timing\n\n### Steps to reproduce\n\nRun Bitcoin Core with near-full mempool: bitcoind -maxmempool=300 -debug=mempool -regtest\n\n2.Generate blocks and fill mempool to ~90% capacity\n3.Trigger manual reorg (2-3 blocks deep): bitcoin-cli invalidateblock <block_hash>\nbitcoin-cli reconsiderblock <block_hash>\n3.During the reorg window, broadcast transactions with borderline fees (near mempool minimum)\n4.Observe inconsistent acceptance across nodes - some accept, others reject as \"mempool full\"\n\n### Relevant log output\n\n2026-02-13T10:23:45Z [mempool] replacing mempool tx abc123... (fees=500, vsize=250)\n2026-02-13T10:23:45Z [validation] AcceptToMemoryPool: tx REJECTED (reason: mempool full)\n2026-02-13T10:23:45Z [validation] BUG! PLEASE REPORT THIS! CheckInputScripts failed\n2026-02-13T10:23:46Z [mempool] transaction failed: mempool full (code 64)\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nBitcoin Core version v30.99.0-dev\n\n### Operating system and version\n\nUbuntu 22.04 LTS Also reproducible on macOS 13+ and Windows 10/11\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "vishalharkal15",
      "id": 168349626,
      "node_id": "U_kgDOCgjPug",
      "avatar_url": "https://avatars.githubusercontent.com/u/168349626?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vishalharkal15",
      "html_url": "https://github.com/vishalharkal15",
      "followers_url": "https://api.github.com/users/vishalharkal15/followers",
      "following_url": "https://api.github.com/users/vishalharkal15/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/vishalharkal15/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/vishalharkal15/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/vishalharkal15/subscriptions",
      "organizations_url": "https://api.github.com/users/vishalharkal15/orgs",
      "repos_url": "https://api.github.com/users/vishalharkal15/repos",
      "events_url": "https://api.github.com/users/vishalharkal15/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/vishalharkal15/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 0,
    "created_at": "2026-02-13T18:10:56Z",
    "updated_at": "2026-02-13T18:19:19Z"
  },
  "events": [
    {
      "event": "referenced",
      "id": 22773958688,
      "node_id": "REFE_lADOABII587qv1a0zwAAAAVNbwgg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22773958688",
      "actor": {
        "login": "vishalharkal15",
        "id": 168349626,
        "node_id": "U_kgDOCgjPug",
        "avatar_url": "https://avatars.githubusercontent.com/u/168349626?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vishalharkal15",
        "html_url": "https://github.com/vishalharkal15",
        "followers_url": "https://api.github.com/users/vishalharkal15/followers",
        "following_url": "https://api.github.com/users/vishalharkal15/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vishalharkal15/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vishalharkal15/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vishalharkal15/subscriptions",
        "organizations_url": "https://api.github.com/users/vishalharkal15/orgs",
        "repos_url": "https://api.github.com/users/vishalharkal15/repos",
        "events_url": "https://api.github.com/users/vishalharkal15/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vishalharkal15/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "646db42684397eabda0f98b41c82f8e24cd16101",
      "commit_url": "https://api.github.com/repos/vishalharkal15/bitcoin/commits/646db42684397eabda0f98b41c82f8e24cd16101",
      "created_at": "2026-02-13T18:20:44Z"
    }
  ]
}