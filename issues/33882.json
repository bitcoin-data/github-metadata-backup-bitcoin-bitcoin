{
  "type": "issue",
  "issue": {
    "id": 3629644627,
    "node_id": "I_kwDOABII587YV_tT",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33882",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33882/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33882/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33882/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33882",
    "number": 33882,
    "state": "open",
    "state_reason": null,
    "title": "Standardness policy rules for legacy Multisig script is incoherent",
    "body": "Over the years policy surrounding multisig scripts, particularly for legacy multisig scripts, has evolved in a haphazard way with various PRs affecting  legacy multisig script policy without considering the ramifications.\n\nThe current status of legacy multisig script policy is as follows:\n\n* Legacy multisig outputs in transactions can be at most *m*-of-3.  All pubkeys in such outputs must be of the form of a compressed pubkey, or uncompressed pubkey, or a hybrid pubkey.\n* Legacy multisig inputs being redeemed in transaction can be *m*-of-*n* with *m* and *n* 20 or less.  Any public keys processed by OP_CHECKMULTISIG must be compressed or uncompressed pubkeys.  hybrid or other data blobs are only allowed in the unprocessed part of the public key list.\n\nWhile it is acceptable for legacy multisig output creation policy to be stricter than redemption policy, it makes no sense to allow hybrid keys in outputs by policy, but then to disallow them as inputs by policy.\n\nHowever, there are further issues. Legacy multisig policy has evolved over time.  In the beginning when legacy multisig outputs were introduced as standard by BIP 11, \"pubkeys\" were allowed by policy to be any value between 33 and 120 bytes.  Some Bitcoin users have taken advantage of those liberal policies and created legacy multisig script UTXOs that were redeemable by policy at the time they were created, but are no longer redeemable by policy today.  The UTXO 4dacd03d73cb497229dbfe2e7209adc4221540efe0e4c57f408b09b2fd36ece6:1 from 2014-01-12 is but one example.  @ajtowns's analysis in #33755 suggests there are at least 147,470 such UTXOs that have become *soft-confiscated* over time, meaning that when they were created they were redeemable by policy, but become no longer redeemable by policy and would require direct miner assistance to be spent.\n\nBased on my research, I believe there are 4 tasks that need to be done to make legacy Multisig policy coherent again.\n\n### 1. Ban hybrid keys in legacy outputs\n\nWe should strengthen the rules surrounding creating legacy multisig (and legacy single sig) to ban the use of hybrid keys.  Such keys are nearly irredeemable.  However, we should only strengthen policy around the creating new legacy script outputs without further restricting policy around redeeming legacy script UTXOs.\n\n### 2. Bring legacy script redemption policy in line with P2SH redeem script policy.\n\nP2SH redeem script policy has also evolved over time.  Current policy for P2SH redemption allow any scripts so long as they have a limited number of CHECKSIG related operations.  I see no reason why legacy script should be subject to significantly more stringent constraints than P2SH redeem scripts are.\n\n### 3. Relax `SCRIPT_VERIFY_STRICTENC` policy to only ban hybrid keys.\n\nPR #5247 went unnecessarily overboard in its quest to stomp out uses of hybrid keys and made UTXOs that already existed at the time unspendable.  PR #33755 partially reverts this change so that only hybrid keys are excluded from processing in  CHECKMULTISIG.\n\n### 4. Bring `SCRIPT_VERIFY_WITNESS_PUBKEYTYPE` policy in line with BIP 143 requirements.\n\nThis task is technically unrelated to legacy multisig policy, being instead about Segwit V0 multisig policy.  However the policy implemented in Bitcoin Core does not match the policy stated in BIP 143, and they ought to be brought into agreement. Either by implementing the policy correctly (as #33759 does), or by amending BIP 143 to describe the current policy as implemented.\n\nIn particular, both tasks 2 and 3 need to be completed in order to make stuck UTXOs, such as 4dacd03d73cb497229dbfe2e7209adc4221540efe0e4c57f408b09b2fd36ece6:1 spendable by policy again.\n\nI want to make it clear that UTXOs such as the above are not particularly abusive.  They were simply caught up incidentally in the policy changes of PR #5247, which was only about banning the use of hybrid keys.  4dacd03d73cb497229dbfe2e7209adc4221540efe0e4c57f408b09b2fd36ece6:1 has no hybrid nor hybrid looking pubkeys in it.\n\n```\t\nOP_PUSHNUM_1\nOP_PUSHBYTES_33 035bceeb417f25beaa28d133ee7b28faa1e4f5c2f76b8daf12c3fab18261718790\nOP_PUSHBYTES_33 1c434e545250525459000000000000000000000001000000004190ab0000000000\nOP_PUSHNUM_2\nOP_CHECKMULTISIG\n```\n*The script from UTXO 4dacd03d73cb497229dbfe2e7209adc4221540efe0e4c57f408b09b2fd36ece6:1*",
    "user": {
      "login": "roconnor-blockstream",
      "id": 21371712,
      "node_id": "MDQ6VXNlcjIxMzcxNzEy",
      "avatar_url": "https://avatars.githubusercontent.com/u/21371712?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/roconnor-blockstream",
      "html_url": "https://github.com/roconnor-blockstream",
      "followers_url": "https://api.github.com/users/roconnor-blockstream/followers",
      "following_url": "https://api.github.com/users/roconnor-blockstream/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/roconnor-blockstream/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/roconnor-blockstream/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/roconnor-blockstream/subscriptions",
      "organizations_url": "https://api.github.com/users/roconnor-blockstream/orgs",
      "repos_url": "https://api.github.com/users/roconnor-blockstream/repos",
      "events_url": "https://api.github.com/users/roconnor-blockstream/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/roconnor-blockstream/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 1,
    "created_at": "2025-11-16T02:09:46Z",
    "updated_at": "2025-11-16T02:36:31Z"
  },
  "events": [
    {
      "event": "mentioned",
      "id": 20966534628,
      "node_id": "MEE_lADOABII587YV_tTzwAAAAThs-3k",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20966534628",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-16T02:09:47Z"
    },
    {
      "event": "subscribed",
      "id": 20966534636,
      "node_id": "SE_lADOABII587YV_tTzwAAAAThs-3s",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20966534636",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-16T02:09:48Z"
    },
    {
      "event": "commented",
      "id": 3537392532,
      "node_id": "IC_kwDOABII587S2FOU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3537392532",
      "actor": {
        "login": "roconnor-blockstream",
        "id": 21371712,
        "node_id": "MDQ6VXNlcjIxMzcxNzEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/21371712?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/roconnor-blockstream",
        "html_url": "https://github.com/roconnor-blockstream",
        "followers_url": "https://api.github.com/users/roconnor-blockstream/followers",
        "following_url": "https://api.github.com/users/roconnor-blockstream/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/roconnor-blockstream/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/roconnor-blockstream/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/roconnor-blockstream/subscriptions",
        "organizations_url": "https://api.github.com/users/roconnor-blockstream/orgs",
        "repos_url": "https://api.github.com/users/roconnor-blockstream/repos",
        "events_url": "https://api.github.com/users/roconnor-blockstream/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/roconnor-blockstream/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-16T02:12:29Z",
      "updated_at": "2025-11-16T02:16:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "## How did we get here\n\nI've compiled a list of what I believe are all the relevant PRs related to policy surrounding multisig scripts, listed in chronological order. This work is based on previous work done by @ajtowns \n\n### PR #669; merged 2011-12-20\nThis PR introduces *m*-of-*n* checkmultisig as a solvable script for the first time. Solvability requires *m* and *n* to be at most 16. Per BIP 11, standardness requires solvable MULTISIG tx outputs to be at most *m*-of-3 and *m* to be less than *n*.\n\nAny data between 33 and 120 bytes is considered a \"pubkey\" for solvability purposes.\n\nThis PR also introduces a new standardness rule requiring redeemed legacy scripts to be solvable. This is done because the solver needs to be run to determine if the UTXO's scriptpubkey being redeemed is an OP_EVAL (later P2SH) script.\n\nBoth legacy scripts redeemed and OP_EVAL/P2SH redeem scripts are required to be solvable at redemption time. Additionally  EVAL/P2SH redeem scripts are required to be standard.\n\nBe aware of the difference between a solvable script and a standard script. Standard scripts are limited to *m*-of-3 multisig, but solvability allows up to 16.  Standardness is stronger than solvability.\n\nBecause the scriptpubkey for legacy UTXOs are now checked for solvability, any subsequent strengthening of standardness rules via `Solver` becomes a vector for soft-confiscation of UTXOs.\n\n\n### PR #769; merged 2012-02-07\nUnexpected stack items are banned using `ScriptSigArgsExpected` counting when redeeming legacy script and P2SH script. This seems to be done to prevent data stuffing in scriptsigs. It is unclear if the data stuffing is a concern or the malleability is a concern. (Later code comments in PR #4365 suggests malleability isn't actually a concern, but PR comments in PR #7387 suggests it was.)\n\nThe relevance here is that `Solver`'s output is now also being used to help count the number of expected stack items. Later `ScriptSigArgsExpected` will be removed.\n\nUnless I'm mistaken, this PR also no longer requires P2SH scripts to be standard and now merely requires them to be solvable.  This enables larger P2SH multisig scripts beyond *m*-of-3. This change seems to be a violation of BIP 16 standardness rules, but it passes without comment.\n\n### PR #1742; merged 2012-10-20\n`CHECKSIG` and `CHECKMULTISIG` operations are modified to check pubkeys to see if they are in canonical form, which must begin with `0x02`, `0x03` or `0x04`, and be of suitable lengths.\n\nAt this point non-canonical pubkey stack items are not yet banned from OP_CHECKMULTISIG. Instead, mempool policy diverges from consensus policy as all non-canonical pubkey stack items immediately count as a signature failure, with OP_CHECKSIG pushing a 0 in these cases and OP_CHECKMULISIG moving to the next pubkey. While non-pubkey would always fail the CHECKSIG anyways, this is a problem for valid hybrid keys where script execution for mempool policy could cause execution to diverge from consensus rule execution.\n\nThis counts as a slight tightening of policy around the redemption (but not creation) of scripts using hybrid keys and applies both to P2SH and legacy scripts.\n\n### PR #3718; merged 2014-02-14\n\nSolvability (and hence standardness) for script is tightened so that for script standardness purposes pubkey data must be between 33 and 65 bytes rather than 33 and 120 bytes.\n\nDue to the fact that solvability rules are checked upon UTXO redemption means that some funds, both P2SH and legacy, could have been soft-confiscated here.\n\n::TODO:: see if any such UTXOs exist.\n\n### PR #4365; merged 2014-06-27;\nP2SH rules are relaxed so non-solvable redeem scripts are allowed if sigop count is less than 15(?). Clean stack not required for redeeming such non-standard P2SH redeem scripts. I don't know why this is considered okay.\n\nThis is the beginning of the divergence of policy between redeeming legacy script and redeeming P2SH script.\n\n### PR #5247; merged 2014-11-21\n\nThe inconsistency between mempool policy execution of script and consensus execution of script is resolved by failing `SCRIPT_VERIFY_STRICTENC` standardness whenever a pubkeys processed by `CHECK*SIG` is non-canonical.\n\nThis accidently causes in-use pre-counterparty-1.0-like legacy multiscript UTXO's to be soft-confiscated. e.g. 4dacd03d73cb497229dbfe2e7209adc4221540efe0e4c57f408b09b2fd36ece6:1 from 2014-01-12. The effect of soft-confiscating existing UTXO seems to have been inadvertent and wasn't contemplated in this PR.\n\nThis policy only applies to redemption, not creation of outputs. Standardness rules still allow creating transactions with legacy script outputs with non-canonical keys.\n\n### PR #7387; merged 2016-01-22;\nScriptSigArgsExpected is removed since now SCRIPT_VERIFY_CLEANSTACK is robustly checking for a clean stack.\n\nFurther divergence between redeeming legacy script and redeeming P2SH occurs as now as P2SH redeem scripts are themselves no longer checked for solvability. So long as the P2SH redeem scripts have a low enough `GetSigOpCount` they are allowed here. Legacy script redemptions still must be solvable scripts.\n\nIn particular, P2SH multisig redeem scripts with 66-120 byte \"pubkeys\" occurring at the end of their list that may have been soft-confiscated in PR #3718 are now, once again, redeemable.\n\n### PR #8499; merged 2016-10-17;\nFor the new P2WSH script, this PR attempts to implement the policy mandated by BIP 143:\n\n> As a default policy, only compressed public keys are accepted in P2WPKH and\n> P2WSH. Each public key passed to a sigop inside version 0 witness program must\n> be a compressed key: the first byte MUST be either 0x02 or 0x03, and the size\n> MUST be 33 bytes. Transactions that break this rule will not be relayed or mined\n> by default.\n\nHowever, the implementation fails to adhere to the policy written above and only checks that, for P2WSH, the pubkeys processed by CHECKMULTISIG are compressed public key, rather than checking that all keys passed to CHECKMULTISIG are compressed public keys.\n\n### PR #12460; merged 2018-04-04;\nSolvability rules for scripts are tightened to require pubkeys in them to be well-formed, but not-necessarily canonical.\n\nNow the creation of legacy script UTXOs are, by standardness, required to be canonical or hybrid pubkeys.\nIt is still the case that if script evaluation encounters a hybrid pubkey it is a violation of `SCRIPT_VERIFY_STRICTENC` standardness rules to redeem.\n\nHowever because scriptpubkeys still are checked during redemption for solvability for legacy script (but not P2SH script), this PR likely soft-confiscates even more UTXOs.\n\nPre-counterparty-1.0-like legacy multiscript UTXO are now in violation of two redemption rules:  They are neither solvable, and if they were executed the OP_CHECKMULTISIG would fail when trying to process non-canonical keys.\n\n::TODO:: Find examples of UTXOs newly soft-confiscated by this PR.\n\n### PR #20867; merged 2021-05-03\n\nThis PR lifts the solvability of *m*-of-*n* multisig up from 16 to 20, *increasing* the types of legacy multisig scripts that are now redeemable.  Transactions creating legacy multisig continue to be limited to 1 ≤ m ≤ n ≤ 3.",
      "user": {
        "login": "roconnor-blockstream",
        "id": 21371712,
        "node_id": "MDQ6VXNlcjIxMzcxNzEy",
        "avatar_url": "https://avatars.githubusercontent.com/u/21371712?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/roconnor-blockstream",
        "html_url": "https://github.com/roconnor-blockstream",
        "followers_url": "https://api.github.com/users/roconnor-blockstream/followers",
        "following_url": "https://api.github.com/users/roconnor-blockstream/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/roconnor-blockstream/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/roconnor-blockstream/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/roconnor-blockstream/subscriptions",
        "organizations_url": "https://api.github.com/users/roconnor-blockstream/orgs",
        "repos_url": "https://api.github.com/users/roconnor-blockstream/repos",
        "events_url": "https://api.github.com/users/roconnor-blockstream/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/roconnor-blockstream/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33882#issuecomment-3537392532",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33882"
    },
    {
      "event": "mentioned",
      "id": 20966560598,
      "node_id": "MEE_lADOABII587YV_tTzwAAAAThtFNW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20966560598",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-16T02:12:30Z"
    },
    {
      "event": "subscribed",
      "id": 20966560605,
      "node_id": "SE_lADOABII587YV_tTzwAAAAThtFNd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20966560605",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-16T02:12:30Z"
    }
  ]
}