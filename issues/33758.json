{
  "type": "issue",
  "issue": {
    "id": 3575888633,
    "node_id": "I_kwDOABII587VI7r5",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33758",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33758/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33758/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33758/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33758",
    "number": 33758,
    "state": "open",
    "state_reason": null,
    "title": "BlockTemplate Manager Tracking issue",
    "body": "The main motivation and design rationale are discussed in #33389.\n\nWhat to review\n\n* #33421\n\n### Plan\n\n* [ ] **Introduce the Block Template Cache (Manager) #33421**\n  Implement a cache layer. All newly created block templates should be stored along with their respective configuration options. Client requests for block templates will specify the **maximum age** of the template in seconds; that is, how fresh they want the template to be:\n\n  * If a template with matching options exists in the cache and the interval has not elapsed, a cached template is returned.\n  * If no template exists or the interval has elapsed, a new template is generated, stored in the cache, and returned.\n  * After insertion, the oldest template is evicted if the cache exceeds its maximum size.\n    The cache has a configurable maximum size (default: 10).\n    It also subscribes to the validation interfaceâ€™s `BlockConnected` notification and clears the cache when a new block is connected or disconnected, preventing stale templates from being served.\n    If `test_block_validity` is set to `true` in the block creation options and the cached template found has not yet been validated, it is checked and then returned.\n    This stage will also allow sharing of template metadata built from the mining interface for a fee estimation mechanism that requires building a block template to obtain package fee rates and use them for fee estimation, and vice versa. See the discussion in #33389.\n\n* [ ] Create a block template manager that will own the `BlockTemplateCache`. Block template requests from node components and other block template-related operations will be handled via this cache.\n\n* [ ] Prune `WaitAndCreateNewBlock` and move its implementation to the block template manager under `GetNext`. This method will use the block template cache for decisions to build a block template. This approach is cleaner and should allow reusing the logic in `getblocktemplate`, thereby removing the global state.\n  [https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/rpc/mining.cpp#L776](https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/rpc/mining.cpp#L776)\n  [https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/rpc/mining.cpp#L859-L861](https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/rpc/mining.cpp#L859-L861)\n  This will also allow pruning `WaitTipChanged` and exposing information to retrieve the metadata of the last built block template, enabling the removal of additional global state.\n  [https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/node/miner.h#L186-L189](https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/node/miner.h#L186-L189)\n\n* [ ] **Implement trimming of transactions** in larger block templates to enable reuse when configurations do not match (see the idea here: [https://github.com/bitcoin/bitcoin/issues/33389#issuecomment-3295505510](https://github.com/bitcoin/bitcoin/issues/33389#issuecomment-3295505510))\n  This will allow reusing block templates from `SENDTEMPLATE` for mining and fee estimation, but not vice versa, because `SENDTEMPLATE` builds templates larger than 4 MB.\n\n* [ ] **Introduce a push-based subscription mechanism** that allows clients to subscribe to fee updates for a given block template and receive a new template when the fee threshold is reached or when the tip changes. This is what `waitnext` should use.\n  See the related discussion here:\n  [https://delvingbitcoin.org/t/determining-blocktemplate-fee-increase-using-fee-rate-diagram/2052](https://delvingbitcoin.org/t/determining-blocktemplate-fee-increase-using-fee-rate-diagram/2052)\n  This feature depends on cluster mempool.\n\n",
    "user": {
      "login": "ismaelsadeeq",
      "id": 48946461,
      "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ismaelsadeeq",
      "html_url": "https://github.com/ismaelsadeeq",
      "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
      "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
      "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
      "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
      "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 0,
    "created_at": "2025-10-31T17:55:33Z",
    "updated_at": "2025-10-31T17:55:33Z"
  },
  "events": []
}