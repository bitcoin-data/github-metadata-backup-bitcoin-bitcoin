{
  "type": "issue",
  "issue": {
    "id": 3575657299,
    "node_id": "I_kwDOABII587VIDNT",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33756",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33756/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33756/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33756/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33756",
    "number": 33756,
    "state": "open",
    "state_reason": null,
    "title": "Header-only support for waitNext()",
    "body": "I'd like to expand the `waitNext()` Mining IPC function to optionally (via `BlockWaitOptions`) return a (empty) new template as soon as we have a header with enough proof-of-work, pending block download and/or validation.\n\nhttps://github.com/bitcoin/bitcoin/blob/3cd4263bf66408760ec3b4ce6ccedcc87e0d53de/src/interfaces/mining.h#L63-L74\n\nI suspect there's little benefit if compact block reconstruction succeeds, and IIUC we hold cs_main during this process anyway so there's no way to generate a template.\n\nBut if we need a round trip to our peer because compact block construction didn't finish, it might be useful to create an empty block template and push it.\n\nThis can hopefully be implemented without touching validation code, as long as the kernel can provide a notification. Currently it only notifies us of a better tip, not a better header.\n\n---\n\nClosely related to this is the Stratum v2 concept of sending an empty (or optimistically filled) \"future\" template downstream for mining devices to load, followed by a `prevhash` messages when a new header is found. Whether that's actually more performant than the above probably depends on the details of ASIC firmware.\n\nImplementation wise, we'd need the same kernel notification for it. At the interface level it might look like a `getFuture()` method on `BlockTemplate` which could return a `FutureTemplate` interface with a `wait()` method on it. That would return a prevhash once we validated a header. The client then sends that downstream and immediately calls `waitNext()` on the original template in order to get a fresh full block template as soon as we processed the full block.\n\n---\n\nIn both cases, we'd need a way to notify the TP if it the block turned out to be invalid. That way it can revert to the previous template.",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 2,
    "created_at": "2025-10-31T16:38:26Z",
    "updated_at": "2025-11-07T11:42:31Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 3473971497,
      "node_id": "IC_kwDOABII587PEJkp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3473971497",
      "actor": {
        "login": "Fi3",
        "id": 6207037,
        "node_id": "MDQ6VXNlcjYyMDcwMzc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6207037?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Fi3",
        "html_url": "https://github.com/Fi3",
        "followers_url": "https://api.github.com/users/Fi3/followers",
        "following_url": "https://api.github.com/users/Fi3/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Fi3/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Fi3/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Fi3/subscriptions",
        "organizations_url": "https://api.github.com/users/Fi3/orgs",
        "repos_url": "https://api.github.com/users/Fi3/repos",
        "events_url": "https://api.github.com/users/Fi3/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Fi3/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-31T16:47:45Z",
      "updated_at": "2025-10-31T16:47:45Z",
      "author_association": "NONE",
      "body": "it make sense for the TP to optimistically create templates as soon as there is a possible new block since this will reduce the time that a miner waste on stale jobs. Is kinda safe since the TP can stop following the optimistic path when 2 or more consecutive invalid blocks are received. If we leave it like it is now the miner will keep mine on the old job until the block template do not provide a new job.\n\nSo worst case we waste a bunch of hundreds milliseconds mining invalid jobs, that we are still going to waste mining on old jobs.",
      "user": {
        "login": "Fi3",
        "id": 6207037,
        "node_id": "MDQ6VXNlcjYyMDcwMzc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6207037?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Fi3",
        "html_url": "https://github.com/Fi3",
        "followers_url": "https://api.github.com/users/Fi3/followers",
        "following_url": "https://api.github.com/users/Fi3/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Fi3/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Fi3/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Fi3/subscriptions",
        "organizations_url": "https://api.github.com/users/Fi3/orgs",
        "repos_url": "https://api.github.com/users/Fi3/repos",
        "events_url": "https://api.github.com/users/Fi3/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Fi3/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33756#issuecomment-3473971497",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33756"
    },
    {
      "event": "commented",
      "id": 3502079264,
      "node_id": "IC_kwDOABII587QvX0g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3502079264",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-07T11:41:50Z",
      "updated_at": "2025-11-07T11:42:31Z",
      "author_association": "MEMBER",
      "body": "> I'd like to expand the `waitNext()` Mining IPC function to optionally (via `BlockWaitOptions`) return an (empty) new template as soon as we have a header with sufficient proof-of-work, pending block download and/or validation.\n\nWhy? you should expand on the motivations behind this and what exactly you aim to achieve with this feature.\n\n> I suspect there’s little benefit if compact block reconstruction succeeds. And, if I understand correctly, we hold `cs_main` during this process anyway, so there’s no way to generate a template.\n\nEven if there is way to generate a template you haven’t validated the block, activate a new tip and evicted conflicts from the mempool yet, so generating a block template with the block assembler is likely to produce the same result as the one you’re currently working on.\n\nTo construct an empty block that builds on the header you validated, you have two options:\n\n1. Update the block assembler code to accept a custom chain tip.\n   This would require some refactoring instead I think it would be better to\n2. Isolate the header creation section of the block assembler into a function that takes the current block index and consensus parameters, then loads the next block header into the proposed block template.\n  This subroutine could then be used by the mining interface/block template manager to generate an empty block template.\n\nRe: https://github.com/bitcoin/bitcoin/issues/33389#issuecomment-3473950791\n\nYes, it is compatible. However, the approach I am aiming for in #33758 relies on non-blocking validation interface notifications, so we should simply add a new notification that is executed once a new valid header is known.\nThis notification will wake up the block template manager, which will then use the subroutine isolated in step 2 above to construct a header with an empty template and push it to subscribed clients.\n\nAs I mentioned in #33758, I would like to prune `WaitAndCreateNewBlock` and create a new `GetNext()` function on a block template manager that is decoupled from kernel notifications internals, the `cs_main` lock, and the kernel notification’s condition variable.\nThe block template manager should have its own internal locks, maintain a copy of the chain tip, and wake up its own condition variables to execute what’s needed on the scheduler thread after receiving validation interface notifications.\n\nSo subscriptions to next block template, next block header, can easily be added and tested in isolation.\n",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33756#issuecomment-3502079264",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33756"
    }
  ]
}