{
  "type": "issue",
  "issue": {
    "id": 2761037268,
    "node_id": "I_kwDOABII586kkhXU",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31573",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31573/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31573/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31573/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31573",
    "number": 31573,
    "state": "open",
    "state_reason": null,
    "title": "Running out of memory on a 2GB box - Initializing chainstate Chainstate [ibd] @ height -1 (null)",
    "body": "I have a server running a pruned bitcoind node as a Docker container with 2G RAM. There are some other services using maybe 500MB of the RAM but I got into a state where bitcoind tries to initialize the chainstate but then starts sucking up all the available RAM so it gets killed with OOM error. Docker then restarts it and it loops like this forever\r\n\r\nI tried to configure bitcoind to be constrained to low memory but it doesn't seem to have any effect\r\n\r\n```\r\n[main]\r\nprinttoconsole=1\r\nrpcallowip=::/0\r\nrpcallowip=0.0.0.0/0\r\nprune=550\r\ntxindex=0\r\nrpcport=8332\r\nrpcbind=0.0.0.0:8332\r\ndbcache=20\r\nmaxmempool=5\r\nmaxconnections=32\r\n\r\nassumevalid=00000000000000000002923a7456aa3d4adce139cd16550c3ff36d07cc45d251\r\n```\r\n\r\nThis node did successfully complete IBD at one point and it is unknown exactly why or when it got into this OOM loop. Maybe it has something to do with the assumevalid? In fact the way this docker container was constructed is that on every restart it would get the latest block hash from an esplora server and set that hash to assumevalid in bitcoin.conf before initializing. So I am theorizing that maybe this unusual behavior created some sort of data that needs to be fully loaded into memory before proceeding and so it gets killed.\r\n\r\nBelow are the logs of a typical startup of bitcoind at this point. I have tried locking the hash of assumevalid and disabled the esplora auto-update logic but it didn't have any effect.\r\n\r\nAs a last resort I will clear out the chainstate and try to do IBD again but am trying to surgically fix it if possible. Decided to open an issue here in case there is some edge case optimization to prevent bitcoind from having to eat up 1.5GB of memory.\r\n\r\nAny suggestions are appreciated and feel free to close if there is nothing actionable and this all just came down to a misuse of `assumevalid`. Thanks!\r\n\r\n```\r\nbitcoind-1  | 2024-12-27T15:00:16Z Bitcoin Core version v26.0.0 (release build)\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using the 'sse4(1way),sse41(4way),avx2(8way)' SHA256 implementation\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using RdSeed as an additional entropy source\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using RdRand as an additional entropy source\r\nbitcoind-1  | 2024-12-27T15:00:16Z Default data directory /home/bitcoin/.bitcoin\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using data directory /home/bitcoin/.bitcoin\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file: /home/bitcoin/.bitcoin/bitcoin.conf\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] assumevalid=\"00000000000000000002923a7456aa3d4adce139cd16550c3ff36d07cc45d251\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] dbcache=\"20\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] maxconnections=\"32\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] maxmempool=\"5\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] printtoconsole=\"1\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] prune=\"550\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] rpcallowip=\"::/0\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] rpcallowip=\"0.0.0.0/0\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] rpcauth=****\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] rpcbind=\"0.0.0.0:8332\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] rpcport=\"8332\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Config file arg: [main] txindex=\"0\"\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using at most 32 automatic connections (1048576 file descriptors available)\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using 16 MiB out of 16 MiB requested for signature cache, able to store 524288 elements\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using 16 MiB out of 16 MiB requested for script execution cache, able to store 524288 elements\r\nbitcoind-1  | 2024-12-27T15:00:16Z Script verification uses 0 additional threads\r\nbitcoind-1  | 2024-12-27T15:00:16Z Binding RPC on address 0.0.0.0 port 8332\r\nbitcoind-1  | 2024-12-27T15:00:16Z WARNING: the RPC server is not safe to expose to untrusted networks such as the public internet\r\nbitcoind-1  | 2024-12-27T15:00:16Z [http] creating work queue of depth 16\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using random cookie authentication.\r\nbitcoind-1  | 2024-12-27T15:00:16Z scheduler thread start\r\nbitcoind-1  | 2024-12-27T15:00:16Z Generated RPC authentication cookie /home/bitcoin/.bitcoin/.cookie\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using rpcauth authentication.\r\nbitcoind-1  | 2024-12-27T15:00:16Z [http] starting 4 worker threads\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using wallet directory /home/bitcoin/.bitcoin\r\nbitcoind-1  | 2024-12-27T15:00:16Z init message: Verifying wallet(s)…\r\nbitcoind-1  | 2024-12-27T15:00:16Z Using /16 prefix for IP bucketing\r\nbitcoind-1  | 2024-12-27T15:00:16Z init message: Loading P2P addresses…\r\nbitcoind-1  | 2024-12-27T15:00:17Z Loaded 64073 addresses from peers.dat  284ms\r\nbitcoind-1  | 2024-12-27T15:00:17Z init message: Loading banlist…\r\nbitcoind-1  | 2024-12-27T15:00:17Z SetNetworkActive: true\r\nbitcoind-1  | 2024-12-27T15:00:17Z Cache configuration:\r\nbitcoind-1  | 2024-12-27T15:00:17Z * Using 2.0 MiB for block index database\r\nbitcoind-1  | 2024-12-27T15:00:17Z * Using 8.0 MiB for chain state database\r\nbitcoind-1  | 2024-12-27T15:00:17Z * Using 10.0 MiB for in-memory UTXO set (plus up to 4.8 MiB of unused mempool space)\r\nbitcoind-1  | 2024-12-27T15:00:17Z init message: Loading block index…\r\nbitcoind-1  | 2024-12-27T15:00:17Z Assuming ancestors of block 00000000000000000002923a7456aa3d4adce139cd16550c3ff36d07cc45d251 have valid signatures.\r\nbitcoind-1  | 2024-12-27T15:00:17Z Setting nMinimumChainWork=000000000000000000000000000000000000000052b2559353df4117b7348b64\r\nbitcoind-1  | 2024-12-27T15:00:17Z Prune configured to target 550 MiB on disk for block and undo files.\r\nbitcoind-1  | 2024-12-27T15:00:17Z Opening LevelDB in /home/bitcoin/.bitcoin/blocks/index\r\nbitcoind-1  | 2024-12-27T15:00:17Z Opened LevelDB successfully\r\nbitcoind-1  | 2024-12-27T15:00:17Z Using obfuscation key for /home/bitcoin/.bitcoin/blocks/index: 0000000000000000\r\nbitcoind-1  | 2024-12-27T15:00:22Z LoadBlockIndexDB: last block file = 4657\r\nbitcoind-1  | 2024-12-27T15:00:22Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=25, size=39362654, heights=874318...874342, time=2024-12-11...2024-12-12)\r\nbitcoind-1  | 2024-12-27T15:00:22Z Checking all blk files are present...\r\nbitcoind-1  | 2024-12-27T15:00:22Z LoadBlockIndexDB(): Block files have previously been pruned\r\nbitcoind-1  | 2024-12-27T15:00:23Z Initializing chainstate Chainstate [ibd] @ height -1 (null)\r\nbitcoind-1  | 2024-12-27T15:00:23Z Opening LevelDB in /home/bitcoin/.bitcoin/chainstate\r\n```",
    "user": {
      "login": "otech47",
      "id": 4914611,
      "node_id": "MDQ6VXNlcjQ5MTQ2MTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4914611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/otech47",
      "html_url": "https://github.com/otech47",
      "followers_url": "https://api.github.com/users/otech47/followers",
      "following_url": "https://api.github.com/users/otech47/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/otech47/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/otech47/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/otech47/subscriptions",
      "organizations_url": "https://api.github.com/users/otech47/orgs",
      "repos_url": "https://api.github.com/users/otech47/repos",
      "events_url": "https://api.github.com/users/otech47/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/otech47/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 0,
    "created_at": "2024-12-27T15:55:32Z",
    "updated_at": "2024-12-27T15:55:32Z"
  },
  "events": []
}