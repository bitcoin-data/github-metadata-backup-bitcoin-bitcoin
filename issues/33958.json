{
  "type": "issue",
  "issue": {
    "id": 3669421512,
    "node_id": "I_kwDOABII587atu3I",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33958",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33958/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33958/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33958/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33958",
    "number": 33958,
    "state": "open",
    "state_reason": null,
    "title": "Net split meta issue",
    "body": "Note: This is just a thought dump for now.. an attempt at a high-level roadmap based on an initial POC and the feedback I've gathered thus far. I will edit this meta issue frequently as a real roadmap takes shape.\n\nThe goal of this project to cleanly separate the net/net_processing layers, so that neither depends on the implementation details of the other.\n\nIn order to achieve that, we'll need to de-tangle the two subsystems (namely `CConnman` and `PeerManager`) and connect them instead via abstract interfaces.\n\nAn (ugly) initial POC can be seen here: https://github.com/theuni/bitcoin/tree/multiprocess_p2p. Note that it will likely not be rebased because it was not intended to be used as-is. Instead, chunks will be extracted and PR'd separately.\n\nThe above POC takes the split even further, moving all p2p logic into a separate binary, and communicating over IPC. This is not a goal of this project, but it does highlight how useful the split is.\n\n## Major Projects:\n\n### Reduce `PeerManager`'s usage of `CNode`\nThe main hurdle for creating a clean separation between `CConnman` and `PeerManager` is the fact that `CNode` is used by both.\n\n`CNode` is an implementation detail of `CConnman`, and its leakage causes (among other things) lifetime and locking issues. The `Peer` structure was created years ago, with the [intention that it would hold the state](https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp#L219) that `PeerManager` cares about. Unfortunately, this work was never complete.\n\n**So the first chunk of work is moving the necessary state from `CNode` to `Peer`**. In many cases, the logic belongs purely at one layer or another. In others (for ex, node id, connection time, etc), both layers will keep copies.\n\nIn order to do that cleanly, some helper functions will move out of `CConnman`/`CNode` and into `PeerManager`/`Peer`, and others will be split into generic helpers used by both layers.\n\n### Move the message handling loop to `PeerManager`\n\nWhen `PeerManager`'s dependency on `CConnman`/`CNode` is reduced to a reasonably small surface, the message handling loop can be move out of `CConnman`.\nRather than iterating all `CNode`s, it will now iterate all `Peer`s. Ugliness like `ForNode`/`ForEachNode` can be removed.\n\n### Dropped usage of `CNode` in `PeerManager`\n\nWith the event loop moved and nascent interfaces beginning to take shape, `PeerManager` should be able to operate without `CNode`. At this point, all of `CConnman`'s public-facing functions will take a `NodeId` rather than `CNode` pointer.\n\n### Virtual interfaces and dropped includes\n\nLastly, the layers will be severed, includes dropped, and they will only communicate via virtual interfaces. `PeerMan`'s `NetEventsInterface` will be filled in, and `CConnman` will implement a new virtual interface.\n\n## Outstanding questions\n\n(This list will expand as the project moves along)\n\n### Unit tests and fuzzers\nIt's not immediately obvious what should happen to tests and fuzzers which rely on:\n- `CNode`'s internals\n- Assumptions about `CConnman`/`PeerManager` behavior\n- Assumptions about layer violations between the two\n\nMANY tests rely on implementation details. Those tests are in conflict with the aim of this project, which is to largely turn those subsystems into black boxes. However, this actually makes the tests _easier_ and _more functional_, because it becomes possible to test a specific behavior without having to resort to hacking the implementation.\n\nAs an example, because `PeerManager`'s `NodeConnected` interface function will now require all of the properties of the connected node, it becomes easier to specify (fake) an exact node configuration without actually creating a node with those properties.\n\nRather than modifying the existing unit tests and fuzzers to work as-is, I think it makes sense to take advantage of the new functionality. Likely as the project progresses and paradigms change, some tests will be modified and others will be dropped/rewritten entirely.",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [
      {
        "id": 64584,
        "node_id": "MDU6TGFiZWw2NDU4NA==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming",
        "name": "Brainstorming",
        "color": "ebd775",
        "default": false
      },
      {
        "id": 135961,
        "node_id": "MDU6TGFiZWwxMzU5NjE=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
        "name": "Refactoring",
        "color": "E6F6D6",
        "default": false
      },
      {
        "id": 62963516,
        "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
        "name": "Tests",
        "color": "d4c5f9",
        "default": false
      },
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      },
      {
        "id": 9432466570,
        "node_id": "LA_kwDOABII588AAAACMjgEig",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tracking%20Issue",
        "name": "Tracking Issue",
        "description": "Tracks longer-running projects and releases. Gathers TODOs, issues, PRs, and status updates.",
        "color": "dda2a6",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 3,
    "created_at": "2025-11-27T00:17:28Z",
    "updated_at": "2025-12-09T08:53:46Z"
  },
  "events": [
    {
      "event": "subscribed",
      "id": 21209598498,
      "node_id": "SE_lADOABII587atu3IzwAAAATwMMoi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21209598498",
      "actor": {
        "login": "pinheadmz",
        "id": 2084648,
        "node_id": "MDQ6VXNlcjIwODQ2NDg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2084648?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/pinheadmz",
        "html_url": "https://github.com/pinheadmz",
        "followers_url": "https://api.github.com/users/pinheadmz/followers",
        "following_url": "https://api.github.com/users/pinheadmz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/pinheadmz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/pinheadmz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/pinheadmz/subscriptions",
        "organizations_url": "https://api.github.com/users/pinheadmz/orgs",
        "repos_url": "https://api.github.com/users/pinheadmz/repos",
        "events_url": "https://api.github.com/users/pinheadmz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/pinheadmz/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T03:49:50Z"
    },
    {
      "event": "subscribed",
      "id": 21211000982,
      "node_id": "SE_lADOABII587atu3IzwAAAATwRjCW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21211000982",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T06:11:52Z"
    },
    {
      "event": "labeled",
      "id": 21213629650,
      "node_id": "LE_lADOABII587atu3IzwAAAATwbkzS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21213629650",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T08:57:01Z",
      "label": {
        "name": "Refactoring",
        "color": "E6F6D6"
      }
    },
    {
      "event": "labeled",
      "id": 21213629670,
      "node_id": "LE_lADOABII587atu3IzwAAAATwbkzm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21213629670",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T08:57:01Z",
      "label": {
        "name": "Tests",
        "color": "d4c5f9"
      }
    },
    {
      "event": "labeled",
      "id": 21213629683,
      "node_id": "LE_lADOABII587atu3IzwAAAATwbkzz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21213629683",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T08:57:01Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "labeled",
      "id": 21213629699,
      "node_id": "LE_lADOABII587atu3IzwAAAATwbk0D",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21213629699",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T08:57:01Z",
      "label": {
        "name": "Tracking Issue",
        "color": "dda2a6"
      }
    },
    {
      "event": "labeled",
      "id": 21213632889,
      "node_id": "LE_lADOABII587atu3IzwAAAATwbll5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21213632889",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T08:57:11Z",
      "label": {
        "name": "Brainstorming",
        "color": "ebd775"
      }
    },
    {
      "event": "subscribed",
      "id": 21214864135,
      "node_id": "SE_lADOABII587atu3IzwAAAATwgSMH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21214864135",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T09:57:47Z"
    },
    {
      "event": "referenced",
      "id": 21262443096,
      "node_id": "REFE_lADOABII587atu3IzwAAAATzVyJY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21262443096",
      "actor": {
        "login": "SmartDever02",
        "id": 102175066,
        "node_id": "U_kgDOBhcRWg",
        "avatar_url": "https://avatars.githubusercontent.com/u/102175066?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/SmartDever02",
        "html_url": "https://github.com/SmartDever02",
        "followers_url": "https://api.github.com/users/SmartDever02/followers",
        "following_url": "https://api.github.com/users/SmartDever02/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/SmartDever02/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/SmartDever02/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/SmartDever02/subscriptions",
        "organizations_url": "https://api.github.com/users/SmartDever02/orgs",
        "repos_url": "https://api.github.com/users/SmartDever02/repos",
        "events_url": "https://api.github.com/users/SmartDever02/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/SmartDever02/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "709bf81fe0955b55c00de700b52f15812477b35b",
      "commit_url": "https://api.github.com/repos/SmartDever02/bitcoin/commits/709bf81fe0955b55c00de700b52f15812477b35b",
      "created_at": "2025-12-01T00:30:24Z"
    },
    {
      "event": "referenced",
      "id": 21262561154,
      "node_id": "REFE_lADOABII587atu3IzwAAAATzWO-C",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21262561154",
      "actor": {
        "login": "SmartDever02",
        "id": 102175066,
        "node_id": "U_kgDOBhcRWg",
        "avatar_url": "https://avatars.githubusercontent.com/u/102175066?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/SmartDever02",
        "html_url": "https://github.com/SmartDever02",
        "followers_url": "https://api.github.com/users/SmartDever02/followers",
        "following_url": "https://api.github.com/users/SmartDever02/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/SmartDever02/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/SmartDever02/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/SmartDever02/subscriptions",
        "organizations_url": "https://api.github.com/users/SmartDever02/orgs",
        "repos_url": "https://api.github.com/users/SmartDever02/repos",
        "events_url": "https://api.github.com/users/SmartDever02/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/SmartDever02/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e8f550f9ed9dd7ce2c16c9560c71e7ae8ea98981",
      "commit_url": "https://api.github.com/repos/SmartDever02/bitcoin/commits/e8f550f9ed9dd7ce2c16c9560c71e7ae8ea98981",
      "created_at": "2025-12-01T00:37:00Z"
    },
    {
      "event": "subscribed",
      "id": 21269259658,
      "node_id": "SE_lADOABII587atu3IzwAAAATzvyWK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21269259658",
      "actor": {
        "login": "stratospher",
        "id": 44024636,
        "node_id": "MDQ6VXNlcjQ0MDI0NjM2",
        "avatar_url": "https://avatars.githubusercontent.com/u/44024636?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stratospher",
        "html_url": "https://github.com/stratospher",
        "followers_url": "https://api.github.com/users/stratospher/followers",
        "following_url": "https://api.github.com/users/stratospher/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stratospher/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stratospher/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stratospher/subscriptions",
        "organizations_url": "https://api.github.com/users/stratospher/orgs",
        "repos_url": "https://api.github.com/users/stratospher/repos",
        "events_url": "https://api.github.com/users/stratospher/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stratospher/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-01T08:29:24Z"
    },
    {
      "event": "commented",
      "id": 3601281266,
      "node_id": "IC_kwDOABII587WpzDy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3601281266",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-02T10:18:19Z",
      "updated_at": "2025-12-03T16:20:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Reduce `PeerManager`'s usage of `CNode`\n> Move the message handling loop to `PeerManager`\n\nBig fan of these aspects. I like the documentation aspect of NetManagerEvents. Would like to see the PeerManager functions move towards accepting a `Peer&` (vs a `CNode*` and looking up `GetPeerRef`, or an explicit `CNode, Peer` pair) in general too.\n\n> Dropped usage of `CNode` in `PeerManager`\n> \n> With the event loop moved and nascent interfaces beginning to take shape, `PeerManager` should be able to operate without `CNode`. At this point, all of `CConnman`'s public-facing functions will take a `NodeId` rather than `CNode` pointer.\n\nI think this part is going in the wrong direction though.\n\nIn particular, I think good goals to have here are (not in priority order):\n\n 1. simplify the codebase so it's easier to understand and update\n 2. improve robustness of the codebase, so that if there are bugs, they have less impact\n 3. make the code higher performance, so that we can have more peers, and/or run on cheaper hardware\n\nGetting a better division between `Connman` and `PeerManager` is great for the first point. I don't think it's a big improvement in the second point -- that would come if we could separate PeerManager's parsing of random data from the internet and generally complex logic from mempool/block validation.\n\nFor the last point, I think there are two main principles we should aim for: (a) minimising the movement and reparsing of data, and (b) minimising the locking and (potentially) maximising the cache performance when we send/receive data. Currently, when we send data and don't need to block, we:\n\n * encode the message as two byte streams (the msg_type as a string and the data as a byte vector)\n * take the node's `cs_vSend` mutex, move the message into a dequeue and attempt to send the message if the socket seemed idle\n * when sending the message, we do the transport encoding, potentially converting the msg_type to a number, and queue data on the socket\n * after releasing `cs_vSend`, if we actually sent data, briefly take the global lock `m_total_bytes_sent_mutex` to track total bytes sent and bytes sent in cycle  \n\nWith the POC code, we're adding extra steps between the first two points:\n\n * pass the message and the node id to the new p2pinterface\n * if there's process separation, do a capnp encode-decode cycle and moving the data to another process over IPC\n * taking the global `m_nodes_mutex` lock and doing a search for the node id through m_nodes, and getting a shared copy of the CNode\n * doing the same logic as above\n\nSo, like I said, that seems headed in the wrong direction to me. In particular introducing IPC in between the two seems like a misfeature -- it adds complexity and lowers performance (with both extra locks and extra data movement) for not really any benefit.\n\nRather than having net_processing communicate with net via either a full CNode* or just an integer NodeId, I think a better approach would be to give it an opaque handle with a bunch of inlines, something like:\n\n```c++\nclass NodeHandle\n{\nprivate:\n    std::shared_ptr<CNode> node;\npublic:\n    friend CConnman;\n    set_disconnect() { node->fDiscconnect = true; }\n};\n\nclass CConnman\n{\n    void PushMessage(CNode* pnode, CSerializedNetMsg&& msg) EXCLUSIVE_LOCKS_REQUIRED(!m_total_bytes_sent_mutex);\n    inline void PushMessage(NodeHandle& nodehandle, CSerializedNetMsg&& msg) EXCLUSIVE_LOCKS_REQUIRED(!m_total_bytes_sent_mutex)\n    {\n        PushMessage(nodehandle.node.get(), std::move(msg));\n    }\n};\n```\n\nYou've also used `NodeId` internally within net_processing; so eg `ThreadMessageHandler()` takes `node_id = peer->m_id`, then calls `ProcessMessages(node_id)` and `SendMessages(node_id)` with both immediately recovering the peer with `peer = GetPeerRef(node_id)`. Presumably that's just because those are exposed for testing but `Peer` isn't; probably could fix it by just also exposing `GetPeerRef` for testing as well, I think, and calling `if (auto p = GetPeerRef(id); p) ProcessMessages(*p);` instead of `ProcessMessages(id)`?\n\n> Lastly, the layers will be severed, includes dropped, and they will only communicate via virtual interfaces. \n\nAs above, I don't really think severing the layers is a good idea (at least for process separation reasons, maybe for testing harnesses though?), but I think you could make `NodeHandle` a virtual interface fairly reasonably if it were, while still keeping things quite fast when it's implemented as a lightweight handle to a `CNode*`.\n\nWhile thinking about this, I've been looking at two other aspects, which I'd like to mention for possible discussion:\n\n`NetMsgType::ADDR` etc are currently constant strings (with SSO they'll avoid allocations at least though), so as a result, net_processing has to sanitize them when logging, and when tracking message bytes, we use a `map<string,int>` to keep track of them, and likewise have an `unordered_map<string,uint8_t>` for the transport v2 message ids, which seems overly complex when we only actually care about the 30ish messages we know about in almost all situations. Changing this doesn't look like too bad a cleanup to me: https://github.com/ajtowns/bitcoin/commits/202511-enum-netmsgtype/\n\nWe have a lot of locks in the net/netproc subsystem these days  (eg, when I run a debug binary listening on mainnet, I get ~100% CPU usage sustained, mostly due to DEBUG_LOCKORDER; dropping DEBUG_LOCKORDER gets me down ~30% CPU), and it would be nice to work on reducing them, rather than adding more -- ie, having data be accessed by a single thread, rather than shared across threads. I've been looking whether we can change the way `PushMessage` etc works, so that the socket operations all happen in the socket handler thread, rather than also opportunistically from the sending thread. I think the two parts to making that work while still being low latency are (a) having a fast message queue in CNode that PeerMan can push to and Connman can pull from, and (b) a way of cheaply notifying Connman to wake up from its poll() and start sending newly queued data. Feels a fair bit like reinventing the wheel vs libevent/libuv/whatever, but I think as long as we give net_processing some sort of \"handle\" object, it can be made fairly simple/safe as well as being fast.\n\nI'd also like to get some cleanup of the Transport stuff -- even just separating it into its own module as a start maybe. In particular, if we introduce new one-byte BIP324 message-types, and have those negotiated over p2p rather than just decided at connection time, then I don't think we need the conversion between short id and msg_type to happen at the net_processing side of the queue, rather than the net side of the queue where it currently occurs, which probably means it's better to change `CNetMessage` and `CSerializedNetMsg` to contain a ~13 byte `SerializedNetMsgType` where v1 transport has the first byte as always 0, and netproc becomes responsible the short id encoding, rather than V2Transport. Probably should do that before any of the `NetMsgType` stuff above.\n\n(EDIT: concretely, moving the bip324 shortid logic to net_processing also requires moving the bytes{sent,rev}permsg logic to net_processing, which requires rpc/net's sendmsgtopeer to go through net_processing, which would involve additional lock juggling if net_processing were handling the msgproc thread rather than net. EDIT^2: Hey, success after 3 years: https://github.com/bitcoin/bips/pull/1378#discussion_r2585766526 . The locking isn't too bad as is, but would still improve slightly with the msgproc loop having access to PeerManagerImpl, and that could better ensure the std::promise stuff didn't get lost too)",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33958#issuecomment-3601281266",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33958"
    },
    {
      "event": "commented",
      "id": 3628282838,
      "node_id": "IC_kwDOABII587YQzPW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3628282838",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-08T17:51:02Z",
      "updated_at": "2025-12-08T17:51:02Z",
      "author_association": "MEMBER",
      "body": "\n> In particular, I think good goals to have here are (not in priority order):\n> \n>     1. simplify the codebase so it's easier to understand and update\n> \n>     2. improve robustness of the codebase, so that if there are bugs, they have less impact\n> \n>     3. make the code higher performance, so that we can have more peers, and/or run on cheaper hardware\n> \n\nGoal #1 is a logical separation of concerns. Today, the many of interactions between `CConnman` and `PeerManager` are subtle and (I'd guess) virtually unknown to all but 2 or 3 people. In particular, issues around lifetime and disconnection.\n\n> \n> Getting a better division between `Connman` and `PeerManager` is great for the first point. I don't think it's a big improvement in the second point -- that would come if we could separate PeerManager's parsing of random data from the internet and generally complex logic from mempool/block validation.\n> \n> For the last point, I think there are two main principles we should aim for: (a) minimising the movement and reparsing of data, and (b) minimising the locking and (potentially) maximising the cache performance when we send/receive data. Currently, when we send data and don't need to block, we:\n> \n>     * encode the message as two byte streams (the msg_type as a string and the data as a byte vector)\n> \n>     * take the node's `cs_vSend` mutex, move the message into a dequeue and attempt to send the message if the socket seemed idle\n> \n>     * when sending the message, we do the transport encoding, potentially converting the msg_type to a number, and queue data on the socket\n> \n>     * after releasing `cs_vSend`, if we actually sent data, briefly take the global lock `m_total_bytes_sent_mutex` to track total bytes sent and bytes sent in cycle\n> \n\nI'm all for these goals, but I consider almost all of those things to be premature optimizations compared to the real-world bottlenecks that we currently see. As two examples, I'd challenge you to demonstrate a meaningful statistical slowdown caused by `cs_vSend` as compared to:\n- the time we take to encrypt/decrypt bip324 messages. ( I have a branch which gives us a ~3x speedup here, PR coming soon)\n- The archaic ProcessMessages/SendMessages loop as compared to multi-threaded event-based message handling\n\nI realize those seem like disjointed/unrelated arguments, but I'm trying to make a larger point: I'd rather not spend time re-factoring to avoid some map/lookup inefficiencies when we have existing massive architectural logjams.\n\n> \n> With the POC code, we're adding extra steps between the first two points:\n> \n>     * pass the message and the node id to the new p2pinterface\n> \n>     * if there's process separation, do a capnp encode-decode cycle and moving the data to another process over IPC\n> \n>     * taking the global `m_nodes_mutex` lock and doing a search for the node id through m_nodes, and getting a shared copy of the CNode\n> \n>     * doing the same logic as above\n> \n> \n> So, like I said, that seems headed in the wrong direction to me. In particular introducing IPC in between the two seems like a misfeature -- it adds complexity and lowers performance (with both extra locks and extra data movement) for not really any benefit.\n\nAgain, I'd ask that you not worry too much about the map lookups and data copies. In principle I completely agree.. if we were rewriting this all from scratch I'd prefer to aim for a zero-copy and non-pipeline-stalling implementation. But the reality is that we have heaps of tech debt that overshadow these inefficiencies.\n\nAs for the process separation.. maybe I shouldn't have even brought that up. It's something that becomes possible with this architecture, but it's a very reasonable argument that it's the wrong split. Please think of it as a toy rather than an end-goal.\n\n\n> \n> Rather than having net_processing communicate with net via either a full CNode* or just an integer NodeId, I think a better approach would be to give it an opaque handle with a bunch of inlines, something like:\n> \n> class NodeHandle\n> {\n> private:\n>     std::shared_ptr<CNode> node;\n> public:\n>     friend CConnman;\n>     set_disconnect() { node->fDiscconnect = true; }\n> };\n> \n> class CConnman\n> {\n>     void PushMessage(CNode* pnode, CSerializedNetMsg&& msg) EXCLUSIVE_LOCKS_REQUIRED(!m_total_bytes_sent_mutex);\n>     inline void PushMessage(NodeHandle& nodehandle, CSerializedNetMsg&& msg) EXCLUSIVE_LOCKS_REQUIRED(!m_total_bytes_sent_mutex)\n>     {\n>         PushMessage(nodehandle.node.get(), std::move(msg));\n>     }\n> };\n\nThis reintroduces the _exact_ lifetime issues I'm trying to remove :(\n\nAgain, compared to everything else happening in these threads, I consider avoiding an uncontested lock and map lookup to be a premature optimization. Unless it can be demonstrated that these operations even show up in a flamegraph, I don't think reintroducing the complexity of shared ownership is worth the complexity.\n\nRemember that the message handling loop is now happening in `PeerManager`, so the locking of `m_nodes_mutex` is now much less interesting. And even if it does ever show up in benchmarks, because it's only ever modified when nodes are connected/disconnected, it could be made a read/write lock.. that would ensure that it's essentially never contended.\n\nHOWEVER, I did anticipate this argument and came up with a similar solution, but with a tweak to avoid the layer violations. See here for the actual impl: https://github.com/theuni/bitcoin/commit/6a9710417d29e7eab1aa5b515bfb1b1ea0ce5b9c\n\nTl;dr: It's essentially the same thing you're suggesting above, but it looks like this (simplified, missing type safety) instead:\n```c++\nstruct NodeHandle\n{\n    std::weak_ptr<void> m_node;\n    NodeId m_id;\n};\n\nclass CConnman\n{\nprivate:\n    void PushMessage(CNode* pnode, CSerializedNetMsg&& msg) EXCLUSIVE_LOCKS_REQUIRED(!m_total_bytes_sent_mutex);\npublic:\n    inline void PushMessage(const NodeHandle& nodehandle, CSerializedNetMsg&& msg) EXCLUSIVE_LOCKS_REQUIRED(!m_total_bytes_sent_mutex)\n    {\n        if (auto node = std::static_pointer_cast<CNode>(nodehandle.m_node.lock()); node) {\n            PushMessage(node.get(), std::move(msg));\n        }\n    }\n};\n```\n\nIt exploits `std::weak_ptr<void>` as an opaque handle (while keeping CNode's deleter).\n\nThe above has the same benefits you're after:\n- Avoids locking\n- No map lookups\n\nBut without the layer violations:\n- `PeerManager` doesn't influence `CNode` lifetimes (except for the duration of the weak->shared)\n- `PeerManager` sees a 100% opaque type.\n\n\nBut again, I consider this to be a last resort in the (imo incredibly unlikely) event that the read-lock + map lookup causes _any_ meaningful slowdown.\n\n> \n> You've also used `NodeId` internally within net_processing; so eg `ThreadMessageHandler()` takes `node_id = peer->m_id`, then calls `ProcessMessages(node_id)` and `SendMessages(node_id)` with both immediately recovering the peer with `peer = GetPeerRef(node_id)`. Presumably that's just because those are exposed for testing but `Peer` isn't; probably could fix it by just also exposing `GetPeerRef` for testing as well, I think, and calling `if (auto p = GetPeerRef(id); p) ProcessMessages(*p);` instead of `ProcessMessages(id)`?\n> \n\nI stopped short of optimizing these things in my branch. But sure, there's lots of room for optimizing things like that.\n\n> I'd also like to get some cleanup of the Transport stuff -- even just separating it into its own module as a start maybe. In particular, if we introduce new one-byte BIP324 message-types, and have those negotiated over p2p rather than just decided at connection time, then I don't think we need the conversion between short id and msg_type to happen at the net_processing side of the queue, rather than the net side of the queue where it currently occurs, which probably means it's better to change `CNetMessage` and `CSerializedNetMsg` to contain a ~13 byte `SerializedNetMsgType` where v1 transport has the first byte as always 0, and netproc becomes responsible the short id encoding, rather than V2Transport. Probably should do that before any of the `NetMsgType` stuff above.\n\nSure, this seems great. Seems to me it's 3 distinct layers anyway :)",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33958#issuecomment-3628282838",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33958"
    },
    {
      "event": "commented",
      "id": 3629082728,
      "node_id": "IC_kwDOABII587YT2ho",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3629082728",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-08T21:29:54Z",
      "updated_at": "2025-12-08T21:29:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "> > For the last point, I think there are two main principles we should aim for: (a) minimising the movement and reparsing of data, and (b) minimising the locking and (potentially) maximising the cache performance when we send/receive data. Currently, when we send data and don't need to block, we:\n\n> I'm all for these goals, but I consider almost all of those things to be premature optimizations compared to the real-world bottlenecks that we currently see.\n\nThe single biggest bottleneck I see today is due to `DEBUG_LOCKORDER` which takes a dev build from using ~10%-40% of a VPS core to ~100%.\n\nOtherwise, we waste a fair bit of time in `NodeSnapshot` (1.98% - mostly shuffle()), `CNodeState` lookups (1.97%), `GetPeerRef` lookups (1.01%), `GenerateWaitSockets` (3.61%), and, at least for what it does, `AccountForSentBytes` (0.11%),\n\nWe spend a lot of time doing `ProcessTransaction` (20%), `TxDownloadManager` (12.27%),`CompareInvMempoolOrder` heap ops (2.7%), `RollingBloomFilter` stuff (5.8%), and serialization and v2 en/decryption (3.06%), but at least they're all things we're actively trying to do. \n\n> As two examples, I'd challenge you to demonstrate a meaningful statistical slowdown caused by `cs_vSend` as compared to:\n\n`cs_vSend` is a per-peer lock, so I don't think it's very problematic. The main reason to look at removing it is that it's about protecting \"net\" internals and the only purpose of having the lock is to allow those internals to be touched by the msghand thread (and perhaps the rpc threads for sendmsgtopeer), rather than just the net thread, because queuing data for 50ms while waiting for the net thread to wakeup, when it could just be sent immediately is pretty lame.\n\n>     * the time we take to encrypt/decrypt bip324 messages. ( I have a branch which gives us a ~3x speedup here, PR coming soon)\n\nPresuming my percentages aren't just due to being a dev build, wow!\n \n>     * The archaic ProcessMessages/SendMessages loop as compared to multi-threaded event-based message handling\n\nI don't think ProcessMessages or SendMessages is particularly bad at present; though the NodeSnapshot and GenerateWaitSockets stuff isn't great, and maybe that's just a question of where in the stack you're assigning the blame.\n\nSwitching to a \"multi-threaded\" model is a big ask, that I think's better treated as a separate project (making tx and block processing happen async in another thread, while msg handling continues for other peers? making it possible to process multiple txs/blocks simultaneously?). But outside of changing the way we interact with validation / `cs_main`, I don't think there's a big win for the multithreaded part here, when we're only dealing with 100s of peers and maybe a few MB/s of data.\n\nMaking ProcessMessages more event oriented seems pretty plausible. :+1:\n\nMaking SendMessages more event based otoh seems somewhat more difficult; I'd like to be able to think more about that after `ThreadMessageHandler` is moved. We've got lots of `if (current_time > peer.m_next_send_feefilter)` tests which might translate well to something event based, but it seems like a lot of code movement, and doesn't seem that bad as-is, so I'm not sure.\n \n> I realize those seem like disjointed/unrelated arguments, but I'm trying to make a larger point: I'd rather not spend time re-factoring to avoid some map/lookup inefficiencies when we have existing massive architectural logjams.\n\nI look at it more the other way: it's simpler and easier to understand when functions are directly given the data they're supposed to operate on. `ProcessMessage` is meant to take a message from the wire (ie, a type and a payload) from a logical peer (ie, `Peer`) and do whatever's necessary to deal with that message. Its signature should be `ProcessMessage(Peer&, string_view, DataStream&&)` with `Peer&` giving it immediate access to everything it needs, without having to look data up, and deal with errors if that data is mysteriously unavailable.\n\nIf we're trying to simplify our net layers, we shouldn't be adding abstractions that we constantly switch between.\n\nIf we can get `ThreadMessageHandler` moved into net_processing, I think we'd be pretty close to being able make `Peer` objects private to the msghand thread -- where we currently have other threads accessing `Peer` directly (eg `UpdatedBlockTip`), I think we could change to adding to an event queue that msghand multiplexes to each (relevant) peer. (Or have the events first get multiplexed to per-msghand event queues if there are multiple msghand threads), which I think would clear up a huge bunch of locks and simplify a huge bunch of thread safety considerations, eg.\n\n> Again, I'd ask that you not worry too much about the map lookups and data copies. In principle I completely agree.. if we were rewriting this all from scratch I'd prefer to aim for a zero-copy and non-pipeline-stalling implementation. But the reality is that we have heaps of tech debt that overshadow these inefficiencies.\n> As for the process separation.. maybe I shouldn't have even brought that up. It's something that becomes possible with this architecture, but it's a very reasonable argument that it's the wrong split. Please think of it as a toy rather than an end-goal.\n\nI think passing around NodeIds instead of the actual data structures we want is adding more tech debt, and putting IPC in between message generation and sending the message on the socket would also be adding more tech debt. (Outside of the IPC POC, I think the only data copy issues are in NodeSnapshot and WaitMany, which I expect this project will improve anyway, or at least not make any worse)\n \n> > Rather than having net_processing communicate with net via either a full CNode* or just an integer NodeId, I think a better approach would be to give it an opaque handle with a bunch of inlines, something like:\n> > class NodeHandle\n> > {\n> > private:\n> > std::shared_ptr node;\n\n> This reintroduces the _exact_ lifetime issues I'm trying to remove :(\n\nI'm pretty sure if you're reworking CConnman, CNode, Peer and PeerManager you can make that arrangement work okay.\n\nWhat I was loosely thinking of is that when either PeerMan or CConnman decides it doesn't want that CNode anymore (because it's been misbehaving, or because the socket closed, eg) they set an `fDisconnect`-like flag, and when they next notice the node (whether that's due to a timeout or triggers an event), whichever hasn't already dropped it drops it now, so that the shared_ptr is freed, and CNode's various queues are released. (The socket is already closed prior to CConnman abandoning the shared_ptr)\n\nIn particular, CConnman is not invoking `NetEventsInterface::FinalizeNode(cnode)` or `m_msgproc->markNodeDisconnected(node->GetId())` in this arrangement, peerman is doing that directly when it next gets around to checking what's going on with that node, and finding that connman's already abandoned the node, and concludes it should too. It's only possible to do things that way after PeerManager has its own thread in order to iterate over its peers of course.\n\n> HOWEVER, I did anticipate this argument and came up with a similar solution, but with a tweak to avoid the layer violations. See here for the actual impl: [theuni@6a97104](https://github.com/theuni/bitcoin/commit/6a9710417d29e7eab1aa5b515bfb1b1ea0ce5b9c)\n\nI mean, that's fine, I guess, but having the `CNode` object available but closed seems better than having to check if a weak_ptr is expired. It also allows the msgproc thread to deal with any messages that were received but unprocessed at the time the socket closed. (It's especially fine if it's just an intermediate step while connman is still calling peerman's FinalizeNode)\n\n> > You've also used `NodeId` internally within net_processing; so eg `ThreadMessageHandler()` takes `node_id = peer->m_id`, then calls `ProcessMessages(node_id)` and `SendMessages(node_id)` with both immediately recovering the peer with `peer = GetPeerRef(node_id)`. Presumably that's just because those are exposed for testing but `Peer` isn't; probably could fix it by just also exposing `GetPeerRef` for testing as well, I think, and calling `if (auto p = GetPeerRef(id); p) ProcessMessages(*p);` instead of `ProcessMessages(id)`?\n> \n> I stopped short of optimizing these things in my branch. But sure, there's lots of room for optimizing things like that.\n\nDo you understand where I'm coming from when I say I don't think of that as an optimisation, but rather the natural way to write the code? If `FooClass::FuncA()` has an object `Bar b`, and `FooClass::FuncB()` wants to use that object, it should just pass it directly by calling `FuncB(b)`, rather than calling `FuncB(b.id)` and having `FuncB` have to recover it with `auto b = GetByById(id); if (!b) return;`.\n\n> > I'd also like to get some cleanup of the Transport stuff -- even just separating it into its own module as a start maybe. In particular, if we introduce new one-byte BIP324 message-types, and have those negotiated over p2p rather than just decided at connection time, then I don't think we need the conversion between short id and msg_type to happen at the net_processing side of the queue, rather than the net side of the queue where it currently occurs, which probably means it's better to change `CNetMessage` and `CSerializedNetMsg` to contain a ~13 byte `SerializedNetMsgType` where v1 transport has the first byte as always 0, and netproc becomes responsible the short id encoding, rather than V2Transport. Probably should do that before any of the `NetMsgType` stuff above.\n> \n> Sure, this seems great. Seems to me it's 3 distinct layers anyway :)\n\nI think I count five layers, fwiw:\n\n 1. socket handling: util/sock.h, b-net thread, net.h, net.cpp\n 2. wire encoding: V1Transport, V2Transport, protocol.h\n 3. message protocol: ProcessMessage / SendMessages\n 4. connection preference: ThreadOpenConnections, eviction handling\n 5. sharing policy: header/block download/announcements, TxRequestTracker, address relay\n\nMaybe 4 and 5 are both just a \"policy layer\"? I left them separate since (4) is managed by net.cpp, while (5) is exclusively net_processing.cpp; but maybe the openconnections logic should move to net_processing as well as the evictions logic? I think doing that might allow connman to stop needing NetEventsInterface entirely, and instead just use flags on CNode to communicate `markNodeDisconnected` and `markSendBufferFull(bool)`.",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33958#issuecomment-3629082728",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33958"
    },
    {
      "event": "comment_deleted",
      "id": 21447545429,
      "node_id": "CDE_lADOABII587atu3IzwAAAAT-X5JV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21447545429",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-09T08:53:46Z"
    }
  ]
}