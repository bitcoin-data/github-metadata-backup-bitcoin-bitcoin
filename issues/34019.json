{
  "type": "issue",
  "issue": {
    "id": 3699555810,
    "node_id": "I_kwDOABII587cgr3i",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34019",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34019/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34019/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34019/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/34019",
    "number": 34019,
    "state": "open",
    "state_reason": null,
    "title": "RFC: randomize over netgroups in outbound peer selection",
    "body": "The current mechanism for choosing outbound peers picks one at randoms among known-reachable addresses, with the caveat that we do not connect twice to the same netgroup (by default /16's and, if an ASmap is configured, by AS's). A more robust mechanism for preventing an attacker to control all of a node's outbound connections would first randomize over netgroups and then pick a known-reachable address within that netgroup.\n\nThis alternative mechanism would make the probability for an attacker to control all of a node's outbound connections exponentially decreasing in the number of connections, roughly $(\\frac{k}{n})^c$ with $k$ the number of netgroups controlled by the attacker, $n$ the total number of netgroups available to be chosen from, and $c$ the number of outbound connections made. There is today in the order of 5k different /16's to choose from in the network[^0]. If we were to use this method, even an adversary that introduced 1k new ones with exclusively their nodes (which would be absurdly expensive) would not be able to control all of a node's outbound peers with any relevant probability.\n\nBy contrast, the current mechanism will allow an adversary with enough node IPs to control all outbound connections of a node with a realistic probability, as long as those IPs are spread across at least as many netgroups as we make outbound connections by default. This is not merely a theoretical concern. This summer i investigated[^1] an entity that spun up hundreds of reachable nodes on the network. They have since scaled up to 3000 nodes, spread across 8 /16's boundaries (and 3 or 4 AS's). As a result, a freshly started clearnet nodes nowadays will make 3 to 5 of their outbound connections on average to this single entity, which is not even actively attacking (for instance by more aggressively sharing their own node addresses and/or not relaying other reachable nodes'). More discussions regarding this entity are available [here](https://bnoc.xyz/t/increase-in-the-number-of-reachable-ipv4-nodes-bitprojects-io) and [here](https://bnoc.xyz/t/many-connections-to-bitproject-io-nodes).\n\nOf course, switching to this mechanism for choosing outbound peers would have consequences on the network graph. Because we currently sample over all known node addresses, we will be biased towards netgroups that contain a lot of nodes (such as hosting providers). First sampling by netgroup would remove this bias, and make it significantly more likely to connect to more \"obscure\" netgroups. This could cause a resource allocation issue on the network, with the inbound connection slots of netgroups with a lesser amount of nodes getting overused (and maxed out) while tons of inbound connection slots in netgroups with a higher amount of nodes sit unused. Interestingly, this is a similar concern to that of switching to ASmap by default shared by @virtu [here](https://github.com/bitcoin/bitcoin/issues/16599#issuecomment-1917362538).\n\nNaturally a middle of the road solution could be to use the alternative mechanism for half of our connections ($c = 5$ in the formula above is more than enough) to get the local eclipse resistance benefits while minimizing the risk of global network disruption. An alternative would be to fully move to sampling by netgroups, but not uniformly. The draw could be biased toward those with more available resources.\n\nA related discussion is how we want a node to behave when its inbound connection slots are full (see https://github.com/bitcoin/bitcoin/issues/16599#issuecomment-3609099274).\n\nA related question is whether we want to keep the \"never connect to more than one netgroup\" rule if we adopt the alternative mechanism. Without the rule but with the new mechanism, could it be the case that if all connection slots in \"small\" netgroups, a large fraction of the network eventually converge towards the larger netgroups? Possibly making several connections to the same netgroups? That seems unlikely. On the other hand if it happens it would organically spread resource usage (though not with a distribution we are happy with).\n\nThis topic was discussed during yesterday's IRC meeting (which this issue is following up on). Logs available [here](https://www.erisian.com.au/bitcoin-core-dev/log-2025-12-04.html#l-469).\n\n[^0]: A conservative estimate from querying the /16's present in the tried table of a number of long-running nodes, and comparing what a number of sources (1, 2, 3) claim are the number of reachable ipv4 nodes.  The command ran to gather the number of /16's in a node's addrman is the following: `bitcoin-cli getrawaddrman |jq -r '.tried[].address | select(test(\"^[0-9]{1,3}(\\\\.[0-9]{1,3}){3}$\")) | (split(\".\")[0:2] | join(\".\"))' |uniq |wc -l`.\n[^1]: See this [blog post](https://antoinep.com/posts/misbehaving_nodes/). The investigation started because the nodes were misconfigured, and i ended up being in contact with the person running those. It appears the person is purposefully trying to optimize for the highest possible number of node addresses announced, in particular by having advertising several IPs per node.",
    "user": {
      "login": "darosior",
      "id": 22457751,
      "node_id": "MDQ6VXNlcjIyNDU3NzUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/darosior",
      "html_url": "https://github.com/darosior",
      "followers_url": "https://api.github.com/users/darosior/followers",
      "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
      "organizations_url": "https://api.github.com/users/darosior/orgs",
      "repos_url": "https://api.github.com/users/darosior/repos",
      "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/darosior/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 1,
    "created_at": "2025-12-05T16:19:39Z",
    "updated_at": "2025-12-12T01:01:36Z"
  },
  "events": [
    {
      "event": "mentioned",
      "id": 21388195467,
      "node_id": "MEE_lADOABII587cgr3izwAAAAT61faL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21388195467",
      "actor": {
        "login": "virtu",
        "id": 72414353,
        "node_id": "MDQ6VXNlcjcyNDE0MzUz",
        "avatar_url": "https://avatars.githubusercontent.com/u/72414353?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/virtu",
        "html_url": "https://github.com/virtu",
        "followers_url": "https://api.github.com/users/virtu/followers",
        "following_url": "https://api.github.com/users/virtu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/virtu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/virtu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/virtu/subscriptions",
        "organizations_url": "https://api.github.com/users/virtu/orgs",
        "repos_url": "https://api.github.com/users/virtu/repos",
        "events_url": "https://api.github.com/users/virtu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/virtu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T16:19:41Z"
    },
    {
      "event": "subscribed",
      "id": 21388195493,
      "node_id": "SE_lADOABII587cgr3izwAAAAT61fal",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21388195493",
      "actor": {
        "login": "virtu",
        "id": 72414353,
        "node_id": "MDQ6VXNlcjcyNDE0MzUz",
        "avatar_url": "https://avatars.githubusercontent.com/u/72414353?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/virtu",
        "html_url": "https://github.com/virtu",
        "followers_url": "https://api.github.com/users/virtu/followers",
        "following_url": "https://api.github.com/users/virtu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/virtu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/virtu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/virtu/subscriptions",
        "organizations_url": "https://api.github.com/users/virtu/orgs",
        "repos_url": "https://api.github.com/users/virtu/repos",
        "events_url": "https://api.github.com/users/virtu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/virtu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T16:19:41Z"
    },
    {
      "event": "labeled",
      "id": 21388221047,
      "node_id": "LE_lADOABII587cgr3izwAAAAT61lp3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21388221047",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T16:21:13Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "subscribed",
      "id": 21388269108,
      "node_id": "SE_lADOABII587cgr3izwAAAAT61xY0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21388269108",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T16:23:57Z"
    },
    {
      "event": "subscribed",
      "id": 21388543561,
      "node_id": "SE_lADOABII587cgr3izwAAAAT620ZJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21388543561",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T16:37:40Z"
    },
    {
      "event": "commented",
      "id": 3617990387,
      "node_id": "IC_kwDOABII587Xpibz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3617990387",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T18:14:00Z",
      "updated_at": "2025-12-12T01:01:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "I seem to have 7204 ipv4 nodes in my tried table with a timestamp more recent than 90 days ago, split across 3509 /16s. There are 6 /16s with between 100 and 200 tried entries, and another 23 /16s with more than 20 tried entries. At the other end of the scale, there are 2578 /16s with only one node in my tried table, 561 with two nodes, 172 with three, 58 with four, 28 with 5 and 26 with 6.\n\nThe network is able to accept 115 inbound connections per node by default (max connections = 125, minus 10 outbounds), so if I tak e my tried table as comprehensive (not really a sensible assumption), cumulatively that's:\n\n * 2578 /16s with 1 nodes: 29,647 nodes worth of inbound connections\n * +561 /16s with 2 nodes: 42,550 nodes worth of inbound connections\n * +172 /16s with 3 nodes: 48,484 nodes worth of inbound connections\n * +58 /16s with 4 nodes: 51,152 nodes worth of inbound connections\n * +28 /16s with 5 nodes: 52,762 nodes worth of inbound connections\n * +26 /16s with 6 nodes: 54,556 nodes worth of inbound connections\n * +13 /16s with 7 nodes: 55,602 nodes worth of inbound connections\n * +12 /16s with 8 nodes: 56,706 nodes worth of inbound connections\n * +8 /16s with 9 nodes: 57,534 nodes worth of inbound connections\n * +4 /16s with 10 nodes: 57,994 nodes worth of inbound connections\n * +5 /16s with 11 nodes: 58,627 nodes worth of inbound connections\n * +2 /16s with 12 nodes: 58,903 nodes worth of inbound connections\n * +3 /16s with 13 nodes: 59,351 nodes worth of inbound connections\n * +5 /16s with 14 nodes: 60,156 nodes worth of inbound connections \n * +2 /16s with 15 nodes: 60,501 nodes worth of inbound connections\n * everything: 82,846 nodes worth of inbound connections\n\n(the calculation here is just `G` /16s with N nodes each gives `G*N*115` inbound slots, and thus copes `with G*N*11.5` nodes' worth of inbound connections, since each node makes 10 outbound connections)\n\nTrying a sim with a 50/50 split and 60k total nodes seems to suggest the single-node /16s would all fill up their slots; but a 30/70 split looks like the single-node /16s would average out to 108.3/115 inbounds, which might be manageable.",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/34019#issuecomment-3617990387",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34019"
    },
    {
      "event": "subscribed",
      "id": 21511319796,
      "node_id": "SE_lADOABII587cgr3izwAAAAUCLLD0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21511319796",
      "actor": {
        "login": "iotamega",
        "id": 101424448,
        "node_id": "U_kgDOBgudQA",
        "avatar_url": "https://avatars.githubusercontent.com/u/101424448?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/iotamega",
        "html_url": "https://github.com/iotamega",
        "followers_url": "https://api.github.com/users/iotamega/followers",
        "following_url": "https://api.github.com/users/iotamega/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/iotamega/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/iotamega/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/iotamega/subscriptions",
        "organizations_url": "https://api.github.com/users/iotamega/orgs",
        "repos_url": "https://api.github.com/users/iotamega/repos",
        "events_url": "https://api.github.com/users/iotamega/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/iotamega/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T18:42:50Z"
    }
  ]
}