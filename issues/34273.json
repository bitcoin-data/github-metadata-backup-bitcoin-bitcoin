{
  "type": "issue",
  "issue": {
    "id": 3809637019,
    "node_id": "I_kwDOABII587jEnKb",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34273",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34273/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34273/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34273/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/34273",
    "number": 34273,
    "state": "open",
    "state_reason": null,
    "title": "Importing musig descriptor with identical (private) keys in tapleaf and only musig subderivation different fails",
    "body": "### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nBelow is very silly policy, that has two almost identical musig expressions in single tapleaf. Keys inside musig expressions are the same, only musig derivation is different, yielding different resulting keys.\n\n`tr($H,and_v(v:pk(musig($0,$1,$2)/<0;1>/*),pk(musig($0,$1,$2)/<2;3>/*)))`\n\nI have no issues importing descriptor from above policy with only public keys into bitcoin core. Yet when I replace with private keys I'm getting  `is not sane: contains duplicate public keys`\n\n### Expected behaviour\n\nregardless whether descriptor contains private or public keys, it should import without duplicate keys error as musig key expression should be treated as only one key and only that key should be considered for duplicate check\n\n### Steps to reproduce\n\nDescriptor with only public keys that imports no problem:\n```\ntr(tpubD6NzVbkrYhZ4WMCcYXEgDrM1AFATSGmrFyMnA2Dgx1Y551VueaE3iemHhQBxhKWjepG76Cy5QmXv8z4KwN6ARTnZ5hVuShfxL129NVGXZuE/<0;1>/*,and_v(v:pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,[bd6eb0b5/44h/1h/0h]tpubDDZuASpyXjtMrnf1rDDREY1VXt89RNS4ZHU99KSkvUYd7CcuDQMPizr1sBHEXhjDy3qU8sAK2i4vkcgAat84S2w4wMJM8BpJ9dPuQKV1Uqh,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/<0;1>/*),pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,[bd6eb0b5/44h/1h/0h]tpubDDZuASpyXjtMrnf1rDDREY1VXt89RNS4ZHU99KSkvUYd7CcuDQMPizr1sBHEXhjDy3qU8sAK2i4vkcgAat84S2w4wMJM8BpJ9dPuQKV1Uqh,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/<2;3>/*)))\n```\n\nReplace one public key with corresponding private key:\n\n```\n[{'desc': 'tr(tpubD6NzVbkrYhZ4WMCcYXEgDrM1AFATSGmrFyMnA2Dgx1Y551VueaE3iemHhQBxhKWjepG76Cy5QmXv8z4KwN6ARTnZ5hVuShfxL129NVGXZuE/0/*,and_v(v:pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,tprv8ZgxMBicQKsPd3QxqYNKLfXHkRYHSayji5qWZDLuSiDAG3S7oyhbV9VRZ4RD35LTYM11aDpvTsovP9mafLAqyCsPpwmAzt6Y6GPr8wNeHNQ/44h/1h/0h,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/0/*),pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,tprv8ZgxMBicQKsPd3QxqYNKLfXHkRYHSayji5qWZDLuSiDAG3S7oyhbV9VRZ4RD35LTYM11aDpvTsovP9mafLAqyCsPpwmAzt6Y6GPr8wNeHNQ/44h/1h/0h,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/2/*)))#vqqlj5dt', 'timestamp': 1768321595, 'active': True, 'internal': False, 'range': [0, 100]}, {'desc': 'tr(tpubD6NzVbkrYhZ4WMCcYXEgDrM1AFATSGmrFyMnA2Dgx1Y551VueaE3iemHhQBxhKWjepG76Cy5QmXv8z4KwN6ARTnZ5hVuShfxL129NVGXZuE/1/*,and_v(v:pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,tprv8ZgxMBicQKsPd3QxqYNKLfXHkRYHSayji5qWZDLuSiDAG3S7oyhbV9VRZ4RD35LTYM11aDpvTsovP9mafLAqyCsPpwmAzt6Y6GPr8wNeHNQ/44h/1h/0h,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/1/*),pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,tprv8ZgxMBicQKsPd3QxqYNKLfXHkRYHSayji5qWZDLuSiDAG3S7oyhbV9VRZ4RD35LTYM11aDpvTsovP9mafLAqyCsPpwmAzt6Y6GPr8wNeHNQ/44h/1h/0h,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/3/*)))#d20d849q', 'timestamp': 1768321595, 'active': True, 'internal': True, 'range': [0, 100]}]\n``` \n\nresults in error:\n\n```\n{'success': False, 'error': {'code': -5, 'message': 'and_v(v:pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,tpubD6NzVbkrYhZ4WWSkjC2uk5BQKT4DbvAeHPSHqjPCrz1Z6XgtSNXBfe7HjCVKqpPEnSb2LNxw2KxDeWvM22UPDoYmf7rkbdW1qc8yWJUnpFe/44h/1h/0h,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/0/*),pk(musig([0f056943/86h/1h/0h]tpubDCeEX49avtiXrBTv3JWTtco99Ka499jXdZHBRtm7va2gkMAui11ctZjqNAT9dLVNaEozt2C1kfTM88cnvZCXsWLJN2p4viGvsyGjtKVV7A1,tpubD6NzVbkrYhZ4WWSkjC2uk5BQKT4DbvAeHPSHqjPCrz1Z6XgtSNXBfe7HjCVKqpPEnSb2LNxw2KxDeWvM22UPDoYmf7rkbdW1qc8yWJUnpFe/44h/1h/0h,[18953581/44h/1h/0h]tpubDDJDF4KvHFML8KW4QCstjJaSes1D5uEcEZWTSA3ZpQPTuQTXobVBT7sGkJbLebJ88xrtvWS5fMVMNK1xTSNWNsWWc2tUybdz96HPMKA3LFV)/2/*)) is not sane: contains duplicate public keys'}}\n```\n\nSame error can be seen if one uses `getdescriptorinfo` rpc\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nusing code from PR https://github.com/bitcoin/bitcoin/pull/34141\n\n### Operating system and version\n\nLinux ... 6.14.0-37-generic #37~24.04.1-Ubuntu ... x86_64 x86_64 x86_64 GNU/Linux\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "scgbckbone",
      "id": 25349625,
      "node_id": "MDQ6VXNlcjI1MzQ5NjI1",
      "avatar_url": "https://avatars.githubusercontent.com/u/25349625?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/scgbckbone",
      "html_url": "https://github.com/scgbckbone",
      "followers_url": "https://api.github.com/users/scgbckbone/followers",
      "following_url": "https://api.github.com/users/scgbckbone/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/scgbckbone/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/scgbckbone/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/scgbckbone/subscriptions",
      "organizations_url": "https://api.github.com/users/scgbckbone/orgs",
      "repos_url": "https://api.github.com/users/scgbckbone/repos",
      "events_url": "https://api.github.com/users/scgbckbone/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/scgbckbone/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 0,
    "created_at": "2026-01-13T16:32:11Z",
    "updated_at": "2026-01-13T16:32:11Z"
  },
  "events": []
}