{
  "type": "issue",
  "issue": {
    "id": 2313580598,
    "node_id": "I_kwDOABII586J5nA2",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30163",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30163/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30163/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30163/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/30163",
    "number": 30163,
    "state": "closed",
    "state_reason": "completed",
    "title": "prune shall not delete blocks it did not download",
    "body": "### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nI operate a full node on an embedded system with datadir being on a local SSD but the blocks are stored on an external USB-HDD, which is often referred to be a well balanced compromise of speedy chainstate tracking and heavy blockchain data.\r\n\r\nWhen setting up new nodes I usually build bitcoind from source and for a quick upstart I use to attach the USB-HDD containing the blocks to it, which saves the system from the initial blockchain download.\r\n\r\nThis particular time I needed an UI version and after running into dependency issues for compiling, I installed the current (v27.0.0) snap for Ubuntu. To reuse the existing blocks, I symlinked `~/snap/bitcoin-core/common/.bitcoin/blocks` to the mounted blocks directory and allowed snap to use external mounts with `snap connect bitcoin-core:removable-media`.\r\n\r\nbitcoin-core.qt starts, re-scans the blocks and then prunes my mounted blocks directory.\r\n\r\nIf bitcoin-core assumes pruning to be enabled by default, at least it should have asked for confirmation to delete blocks it did not download.\n\n### Expected behaviour\n\nbitcoin-core should track which blocks it actually downloaded and only prune those. Blocks that were provided externally should not be deleted or at least should require a user's confirmation.\n\n### Steps to reproduce\n\n* have an external HDD containing full blockchain\r\n* install snap of latest bitcoin-core (here: v27.0.0)\r\n* allow snap using external HDD with `snap connect bitcoin-core:removable-media`\r\n* symlink  `~/snap/bitcoin-core/common/.bitcoin/blocks` to the mounted blocks directory\r\n* run bitcoin-core.qt\r\n* observe that blocks are pruned on external HDD\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPackage manager\n\n### What version of Bitcoin Core are you using?\n\nv27.0.0\n\n### Operating system and version\n\nUbuntu 24.04 LTS\n\n### Machine specifications\n\n_No response_",
    "user": {
      "login": "zefir-k",
      "id": 1355386,
      "node_id": "MDQ6VXNlcjEzNTUzODY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1355386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/zefir-k",
      "html_url": "https://github.com/zefir-k",
      "followers_url": "https://api.github.com/users/zefir-k/followers",
      "following_url": "https://api.github.com/users/zefir-k/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/zefir-k/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/zefir-k/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/zefir-k/subscriptions",
      "organizations_url": "https://api.github.com/users/zefir-k/orgs",
      "repos_url": "https://api.github.com/users/zefir-k/repos",
      "events_url": "https://api.github.com/users/zefir-k/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/zefir-k/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 219890555,
        "node_id": "MDU6TGFiZWwyMTk4OTA1NTU=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Block%20storage",
        "name": "Block storage",
        "color": "000000",
        "default": false
      },
      {
        "id": 477890092,
        "node_id": "MDU6TGFiZWw0Nzc4OTAwOTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Questions%20and%20Help",
        "name": "Questions and Help",
        "color": "006688",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 3,
    "closed_at": "2024-05-24T12:46:57Z",
    "created_at": "2024-05-23T18:26:20Z",
    "updated_at": "2024-05-30T17:26:37Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2127810175,
      "node_id": "IC_kwDOABII585-085_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2127810175",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-23T18:40:53Z",
      "updated_at": "2024-05-30T17:26:37Z",
      "author_association": "MEMBER",
      "body": "Using the same blocksdir for two different nodes is not supported. Nodes may download blocks in a different order and save them to different locations in the blocksfiles. This will lead to an error at some point, latest when one of the nodes can't find a block where it believes to be one.\r\n\r\nCurrently, I don't think what you are trying to achieve is possible without copying blocks.\r\n\r\n> If bitcoin-core assumes pruning to be enabled by default, at least it should have asked for confirmation to delete blocks it did not download.\r\n\r\nI don't think pruning is enabled by default. It would be a bug if it was.\r\n\r\nEDIT: Looks like prune is enabled by default in the GUI",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30163#issuecomment-2127810175",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30163"
    },
    {
      "event": "labeled",
      "id": 12913854963,
      "node_id": "LE_lADOABII586J5nA2zwAAAAMBucnz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12913854963",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-23T18:41:01Z",
      "label": {
        "name": "Block storage",
        "color": "000000"
      }
    },
    {
      "event": "labeled",
      "id": 12913854967,
      "node_id": "LE_lADOABII586J5nA2zwAAAAMBucn3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12913854967",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-23T18:41:01Z",
      "label": {
        "name": "Questions and Help",
        "color": "006688"
      }
    },
    {
      "event": "commented",
      "id": 2129025083,
      "node_id": "IC_kwDOABII585-5lg7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2129025083",
      "actor": {
        "login": "zefir-k",
        "id": 1355386,
        "node_id": "MDQ6VXNlcjEzNTUzODY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1355386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zefir-k",
        "html_url": "https://github.com/zefir-k",
        "followers_url": "https://api.github.com/users/zefir-k/followers",
        "following_url": "https://api.github.com/users/zefir-k/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/zefir-k/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/zefir-k/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/zefir-k/subscriptions",
        "organizations_url": "https://api.github.com/users/zefir-k/orgs",
        "repos_url": "https://api.github.com/users/zefir-k/repos",
        "events_url": "https://api.github.com/users/zefir-k/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/zefir-k/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-24T09:09:09Z",
      "updated_at": "2024-05-24T09:09:09Z",
      "author_association": "NONE",
      "body": "> Using the same blocksdir for two different nodes is not supported. Nodes may download blocks in a different order and save them to different locations in the blocksfiles. This will lead to an error at some point, latest when one of the nodes can't find a block where it believes to be one.\r\n> \r\n> Currently, I don't think what you are trying to achieve is possible without copying blocks.\r\n> \r\nHm, my experience differs: using this regularly and never ran into issues. Since the external HDD contains fully downloaded and validated blockchain, there is not much to dissent between different nodes besides the very last potentially incomplete block. There is this tool (https://github.com/bitcoin-core/bitcoin-maintainer-tools/blob/main/fastcopy-chaindata.py) which works with hardlinks but can't be used over filesystem boundaries - but generally it is possible.\r\n\r\n> > If bitcoin-core assumes pruning to be enabled by default, at least it should have asked for confirmation to delete blocks it did not download.\r\n> \r\n> I don't think pruning is enabled by default. It would be a bug if it was.\r\n\r\nMaybe problem is, I started bitcoin-core.qt first, which found my local SSD has insufficient space for the full blockchain and hence wrote a prune-enabled config, which I did not check when softlinking to my external blockchain. So I learned something for the price of a 2-day-IBD.\r\n\r\nProposal: don't prune if blocksdir is defined - or at least document that if pruning is enabled your externally kept blockchain will get deleted.",
      "user": {
        "login": "zefir-k",
        "id": 1355386,
        "node_id": "MDQ6VXNlcjEzNTUzODY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1355386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zefir-k",
        "html_url": "https://github.com/zefir-k",
        "followers_url": "https://api.github.com/users/zefir-k/followers",
        "following_url": "https://api.github.com/users/zefir-k/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/zefir-k/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/zefir-k/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/zefir-k/subscriptions",
        "organizations_url": "https://api.github.com/users/zefir-k/orgs",
        "repos_url": "https://api.github.com/users/zefir-k/repos",
        "events_url": "https://api.github.com/users/zefir-k/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/zefir-k/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30163#issuecomment-2129025083",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30163"
    },
    {
      "event": "commented",
      "id": 2129349133,
      "node_id": "IC_kwDOABII585-60oN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2129349133",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-24T11:55:32Z",
      "updated_at": "2024-05-24T11:55:32Z",
      "author_association": "MEMBER",
      "body": "> > Using the same blocksdir for two different nodes is not supported. Nodes may download blocks in a different order and save them to different locations in the blocksfiles. This will lead to an error at some point, latest when one of the nodes can't find a block where it believes to be one.\r\n> > Currently, I don't think what you are trying to achieve is possible without copying blocks.\r\n> \r\n> Hm, my experience differs: using this regularly and never ran into issues. Since the external HDD contains fully downloaded and validated blockchain, there is not much to dissent between different nodes besides the very last potentially incomplete block. There is this tool (https://github.com/bitcoin-core/bitcoin-maintainer-tools/blob/main/fastcopy-chaindata.py) which works with hardlinks but can't be used over filesystem boundaries - but generally it is possible.\r\n\r\nSure, but the script also intends to correctly handle `blocks/index`, as well as the last block file. I don't see where your approach does it.\r\n\r\n> Proposal: don't prune if blocksdir is defined - or at least document that if pruning is enabled your externally kept blockchain will get deleted.\r\n\r\nAgain, what you described so far isn't a supported use case right now.",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/30163#issuecomment-2129349133",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30163"
    },
    {
      "event": "closed",
      "id": 12924604687,
      "node_id": "CE_lADOABII586J5nA2zwAAAAMCXdEP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12924604687",
      "actor": {
        "login": "zefir-k",
        "id": 1355386,
        "node_id": "MDQ6VXNlcjEzNTUzODY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1355386?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/zefir-k",
        "html_url": "https://github.com/zefir-k",
        "followers_url": "https://api.github.com/users/zefir-k/followers",
        "following_url": "https://api.github.com/users/zefir-k/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/zefir-k/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/zefir-k/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/zefir-k/subscriptions",
        "organizations_url": "https://api.github.com/users/zefir-k/orgs",
        "repos_url": "https://api.github.com/users/zefir-k/repos",
        "events_url": "https://api.github.com/users/zefir-k/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/zefir-k/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-24T12:46:57Z"
    }
  ]
}