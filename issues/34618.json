{
  "type": "issue",
  "issue": {
    "id": 3959509636,
    "node_id": "I_kwDOABII587sAVKE",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34618",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34618/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34618/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34618/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/34618",
    "number": 34618,
    "state": "open",
    "state_reason": null,
    "title": "test: cmpctblock: No coverage for fRevertToHeaderProcessing in compact block message handling.",
    "body": "### At a glance\n\nThe following diff causes no tests to fail:\n\n```diff\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\nindex e5b4bc7772..d9b0b46733 100644\n--- a/src/net_processing.cpp\n+++ b/src/net_processing.cpp\n@@ -4576,10 +4576,6 @@ void PeerManagerImpl::ProcessMessage(Peer& peer, CNode& pfrom, const std::string\n\n         bool fProcessBLOCKTXN = false;\n\n-        // If we end up treating this as a plain headers message, call that as well\n-        // without cs_main.\n-        bool fRevertToHeaderProcessing = false;\n-\n         // Keep a CBlock for \"optimistic\" compactblock reconstructions (see\n         // below)\n         std::shared_ptr<CBlock> pblock = std::make_shared<CBlock>();\n@@ -4713,18 +4709,6 @@ void PeerManagerImpl::ProcessMessage(Peer& peer, CNode& pfrom, const std::string\n                     fBlockReconstructed = true;\n                 }\n             }\n-        } else {\n-            if (requested_block_from_this_peer) {\n-                // We requested this block, but its far into the future, so our\n-                // mempool will probably be useless - request the block normally\n-                std::vector<CInv> vInv(1);\n-                vInv[0] = CInv(MSG_BLOCK | GetFetchFlags(peer), blockhash);\n-                MakeAndPushMessage(pfrom, NetMsgType::GETDATA, vInv);\n-                return;\n-            } else {\n-                // If this was an announce-cmpctblock, we want the same treatment as a header message\n-                fRevertToHeaderProcessing = true;\n-            }\n         }\n         } // cs_main\n\n@@ -4734,15 +4718,6 @@ void PeerManagerImpl::ProcessMessage(Peer& peer, CNode& pfrom, const std::string\n             return ProcessCompactBlockTxns(pfrom, peer, txn);\n         }\n\n-        if (fRevertToHeaderProcessing) {\n-            // Headers received from HB compact block peers are permitted to be\n-            // relayed before full validation (see BIP 152), so we don't want to disconnect\n-            // the peer if the header turns out to be for an invalid block.\n-            // Note that if a peer tries to build on an invalid chain, that\n-            // will be detected and the peer will be disconnected/discouraged.\n-            return ProcessHeadersMessage(pfrom, peer, {cmpctblock.header}, /*via_compact_block=*/true);\n-        }\n-\n         if (fBlockReconstructed) {\n             // If we got here, we were able to optimistically reconstruct a\n             // block that is in flight from some other peer.\n```\n\n---\n\nIn some circumstances, a node might receive a [`CMPCTBLOCK`](https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki) [message](https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki#headerandshortids) which for one reason or another that there is no hope of being able to successfully reconstruct the block from the CMPCTBLOCK. \n\nOne case that is covered in existing code, is if a `CMPCTBLOCK` is received that has a height `>= ActiveChain().Height() + 2`:\nhttps://github.com/bitcoin/bitcoin/blob/9e4567b17a285a266fa540b4141e0db5781cc228/src/net_processing.cpp#L4637 `                // [Process the block bla bla bla...]`\nhttps://github.com/bitcoin/bitcoin/blob/9e4567b17a285a266fa540b4141e0db5781cc228/src/net_processing.cpp#L4716-L4728\n\nIn this case, our mempool is not very likely to be helpful but a header exists with valid PoW, so it's worth it for us to work hard to try to get the block from our peer, so we revert to treating it as a headers message. My assumption is that the reason for checking if we already have requested the block is to be able to break out of a loop where we request a block and get a CMPCTBLOCK response, but can't process the CMPCTBLOCK message.\n\nThat all seems reasonable, and we should probably have functional test cases for it, but I want to also ask if it makes sense to do this at all? It's worth noting that above in the CMPCTBLOCK messages, we have already processed the header as part of our anti-dos checks:\n\nhttps://github.com/bitcoin/bitcoin/blob/9e4567b17a285a266fa540b4141e0db5781cc228/src/net_processing.cpp#L4564\n\nand we've updated our state for the peer to indicate that they have this block:\n\nhttps://github.com/bitcoin/bitcoin/blob/9e4567b17a285a266fa540b4141e0db5781cc228/src/net_processing.cpp#L4590\n\nSo what is the difference between doing those two things and calling ProcessHeadersMessage? As far as I can tell the only difference is that ProcessHeadersMessage will send a request for the block immediately. But I'm pretty sure that by learning the header, and marking the peer as knowing about the header, we'll send a `GETDATA` for the block on the next tick of `SendMessages` for this peer:\n\nhttps://github.com/bitcoin/bitcoin/blob/9e4567b17a285a266fa540b4141e0db5781cc228/src/net_processing.cpp#L6113-L6148\n\nSo maybe this code can be safely deleted, since it's mostly a no-op.",
    "user": {
      "login": "davidgumberg",
      "id": 2257631,
      "node_id": "MDQ6VXNlcjIyNTc2MzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/davidgumberg",
      "html_url": "https://github.com/davidgumberg",
      "followers_url": "https://api.github.com/users/davidgumberg/followers",
      "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
      "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
      "repos_url": "https://api.github.com/users/davidgumberg/repos",
      "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 1,
    "created_at": "2026-02-18T19:49:14Z",
    "updated_at": "2026-02-20T13:44:52Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 3934786810,
      "node_id": "IC_kwDOABII587qiBT6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3934786810",
      "actor": {
        "login": "Crypt-iQ",
        "id": 15145615,
        "node_id": "MDQ6VXNlcjE1MTQ1NjE1",
        "avatar_url": "https://avatars.githubusercontent.com/u/15145615?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Crypt-iQ",
        "html_url": "https://github.com/Crypt-iQ",
        "followers_url": "https://api.github.com/users/Crypt-iQ/followers",
        "following_url": "https://api.github.com/users/Crypt-iQ/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Crypt-iQ/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Crypt-iQ/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Crypt-iQ/subscriptions",
        "organizations_url": "https://api.github.com/users/Crypt-iQ/orgs",
        "repos_url": "https://api.github.com/users/Crypt-iQ/repos",
        "events_url": "https://api.github.com/users/Crypt-iQ/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Crypt-iQ/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-20T13:44:52Z",
      "updated_at": "2026-02-20T13:44:52Z",
      "author_association": "CONTRIBUTOR",
      "body": "This makes sense to me. I also noticed that there are no tests for this branch. I could not figure out via the git history why this check was introduced. I think some tests here would also be nice to add.",
      "user": {
        "login": "Crypt-iQ",
        "id": 15145615,
        "node_id": "MDQ6VXNlcjE1MTQ1NjE1",
        "avatar_url": "https://avatars.githubusercontent.com/u/15145615?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Crypt-iQ",
        "html_url": "https://github.com/Crypt-iQ",
        "followers_url": "https://api.github.com/users/Crypt-iQ/followers",
        "following_url": "https://api.github.com/users/Crypt-iQ/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Crypt-iQ/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Crypt-iQ/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Crypt-iQ/subscriptions",
        "organizations_url": "https://api.github.com/users/Crypt-iQ/orgs",
        "repos_url": "https://api.github.com/users/Crypt-iQ/repos",
        "events_url": "https://api.github.com/users/Crypt-iQ/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Crypt-iQ/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/34618#issuecomment-3934786810",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34618"
    }
  ]
}