{
  "type": "issue",
  "issue": {
    "id": 231806885,
    "node_id": "MDU6SXNzdWUyMzE4MDY4ODU=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10468",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10468/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10468/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10468/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/10468",
    "number": 10468,
    "state": "open",
    "state_reason": null,
    "title": "listreceivedbyaddress incorrectly shows watchonly addresses as empty",
    "body": "The arguments are minconf, include_empty, and include_watchonly. If include_empty is true then watchonly addresses are returned as having a 0 balance even if they have a positive balance. Only when include_watchonly is also true do watchonly addresses with a balance return with their correct balance.\r\n\r\nWhen include_empty is true and include_watchonly is false then the watchonly addresses should not be returned at all.\r\n\r\nExample:\r\n$ ./bitcoin-cli listreceivedbyaddress 1 true\r\n[\r\n  {\r\n    \"address\": \"watch only\",\r\n    \"account\": \"\",\r\n    \"amount\": 0.00000000,\r\n    \"confirmations\": 0,\r\n    \"label\": \"\",\r\n    \"txids\": [\r\n    ]\r\n  }, \r\n  {\r\n    \"address\": \"address with privkey\",\r\n    \"account\": \"\",\r\n    \"amount\": 0.00000000,\r\n    \"confirmations\": 0,\r\n    \"label\": \"\",\r\n    \"txids\": [\r\n    ]\r\n  }\r\n]\r\n\r\n$ ./bitcoin-cli listreceivedbyaddress 1 true true\r\n[\r\n  {\r\n    \"address\": \"address with privkey\",\r\n    \"account\": \"\",\r\n    \"amount\": 0.00000000,\r\n    \"confirmations\": 0,\r\n    \"label\": \"\",\r\n    \"txids\": [\r\n    ]\r\n  },\r\n  {\r\n    \"address\": \"watch only\",\r\n    \"account\": \"\",\r\n    \"amount\": 1.0000000,\r\n    \"confirmations\": 1234,\r\n    \"txids\": [\r\n         ...\r\n    ]\r\n  }\r\n]\r\n",
    "user": {
      "login": "keystrike",
      "id": 2402779,
      "node_id": "MDQ6VXNlcjI0MDI3Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2402779?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/keystrike",
      "html_url": "https://github.com/keystrike",
      "followers_url": "https://api.github.com/users/keystrike/followers",
      "following_url": "https://api.github.com/users/keystrike/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/keystrike/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/keystrike/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/keystrike/subscriptions",
      "organizations_url": "https://api.github.com/users/keystrike/orgs",
      "repos_url": "https://api.github.com/users/keystrike/repos",
      "events_url": "https://api.github.com/users/keystrike/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/keystrike/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98279177,
        "node_id": "MDU6TGFiZWw5ODI3OTE3Nw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ",
        "name": "RPC/REST/ZMQ",
        "color": "0052cc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 3,
    "created_at": "2017-05-27T15:05:00Z",
    "updated_at": "2022-09-20T17:05:40Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 1100055810,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDExMDAwNTU4MTA=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1100055810",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-05-28T02:10:54Z",
      "label": {
        "name": "RPC/REST/ZMQ",
        "color": "0052cc"
      }
    },
    {
      "event": "commented",
      "id": 403857917,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQwMzg1NzkxNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/403857917",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-07-10T15:10:03Z",
      "updated_at": "2018-07-10T15:10:03Z",
      "author_association": "MEMBER",
      "body": "Just noticed this while reviewing #9662. It's quite weird:\r\n\r\n```\r\n$ src/bitcoin-cli -rpcwallet=\"hi\" listreceivedbyaddress 0 true\r\n[\r\n  {\r\n    \"address\": \"mzDWjPWzsNr7Nbd5rhC73MnmJt9L1Vd9CH\",\r\n    \"account\": \"\",\r\n    \"amount\": 0.00000000,\r\n    \"confirmations\": 0,\r\n    \"label\": \"\",\r\n    \"txids\": [\r\n    ]\r\n  }\r\n]\r\n\r\n$ src/bitcoin-cli -rpcwallet=\"hi\" listreceivedbyaddress 0 true true\r\n[\r\n  {\r\n    \"involvesWatchonly\": true,\r\n    \"address\": \"mzDWjPWzsNr7Nbd5rhC73MnmJt9L1Vd9CH\",\r\n    \"account\": \"\",\r\n    \"amount\": 0.01000000,\r\n    \"confirmations\": 0,\r\n    \"label\": \"\",\r\n    \"txids\": [\r\n      \"e710f6f7f1c9cd9e4cd86ec345d7058dd8236c717caf0e0088ad018c231cfa92\"\r\n    ]\r\n  }\r\n]\r\n```",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/10468#issuecomment-403857917",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10468"
    },
    {
      "event": "commented",
      "id": 1204165996,
      "node_id": "IC_kwDOABII585Hxh1s",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1204165996",
      "actor": {
        "login": "kouloumos",
        "id": 18506343,
        "node_id": "MDQ6VXNlcjE4NTA2MzQz",
        "avatar_url": "https://avatars.githubusercontent.com/u/18506343?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kouloumos",
        "html_url": "https://github.com/kouloumos",
        "followers_url": "https://api.github.com/users/kouloumos/followers",
        "following_url": "https://api.github.com/users/kouloumos/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kouloumos/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kouloumos/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kouloumos/subscriptions",
        "organizations_url": "https://api.github.com/users/kouloumos/orgs",
        "repos_url": "https://api.github.com/users/kouloumos/repos",
        "events_url": "https://api.github.com/users/kouloumos/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kouloumos/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-08-03T16:11:13Z",
      "updated_at": "2022-08-03T16:11:13Z",
      "author_association": "MEMBER",
      "body": "The expected behavior with `listreceivedbyaddress` is that when `include_empty=true` and `include_watchonly=false` the watchonly addresses should not be returned at all. \r\n\r\nWhat has been reported and what I was able to reproduce is that when watchonly addresses are not supposed to be included (`include_watchonly=false`), they are included if `include_empty=true` and are always returned as having 0 balance even if they have a positive balance. \r\n\r\nI was able to reproduced this using legacy wallets on regtest.\r\n   - Preparation\r\n     ```shell\r\n     # create directories for nodes\r\n     mkdir -p /tmp/node1-datadir\r\n     mkdir -p /tmp/node2-datadir\r\n     \r\n     # run node1\r\n     src/bitcoind -regtest -datadir=/tmp/node1-datadir\r\n      \r\n     # run node2\r\n     src/bitcoind -regtest -datadir=/tmp/node2-datadir -rpcport=18300 -port=18400\r\n     \r\n     # (using variables for productivity)\r\n     NODE1=\"src/bitcoin-cli -regtest -datadir=/tmp/node1-datadir\"\r\n     NODE2=\"src/bitcoin-cli -regtest -datadir=/tmp/node2-datadir -rpcport=18300\"\r\n\r\n     # create wallets (legacy) \r\n     $NODE1 -named createwallet wallet_name=wallet1 descriptors=false\r\n     $NODE2 -named createwallet wallet_name=wallet2 descriptors=false\r\n\r\n     watch_address=$($NODE1 getnewaddress) # generate address on node1\r\n     $NODE2 importaddress $watch_address # add address as watchonly on node2\r\n\r\n     ```\r\n   - Observe issue when **there is no balance in $watch_address**. \r\n     ```shell\r\n     #  This returns nothing, **as expected**.\r\n     $NODE2 -named listreceivedbyaddress include_empty=false include_watchonly={false,true}\r\n     []\r\n\r\n     # This should also return nothing, but it returns the empty $watch_address\r\n     $NODE2 -named listreceivedbyaddress include_empty=true include_watchonly=false\r\n     [\r\n       {\r\n         \"address\": $watch_address,\r\n         \"amount\": 0.00000000,\r\n         \"confirmations\": 0,\r\n         \"label\": \"\",\r\n         \"txids\": [\r\n         ]\r\n       }\r\n     ]\r\n     ``` \r\n   - Observe issue **with balance in $watch_address**.\r\n     ```shell\r\n     $NODE1 addnode 127.0.0.1:18400 \"add\"  # connect nodes 1->2\r\n     $NODE1 generatetoaddress 101 $watch_address # mine blocks to address \r\n\r\n     # Correctly returns the watchonly address\r\n     $NODE2 -named listreceivedbyaddress include_empty={false,true} include_watchonly=true\r\n     [\r\n       {\r\n         \"involvesWatchonly\": true,\r\n         \"address\": $watch_address,\r\n         \"amount\": 50.00000000,\r\n         \"confirmations\": 101,\r\n         \"label\": \"\",\r\n         \"txids\": [\r\n           \"c0be670898b208f156a7be5776b97f2c459e7056450ff10c66e0a2058352c319\"\r\n         ]\r\n       }\r\n     ]\r\n     \r\n     # Correctly returns nothing\r\n     $NODE2 -named listreceivedbyaddress include_empty=false include_watchonly=false\r\n     []\r\n     \r\n     # This should also return nothing , but it returns the empty $watch_address\r\n     $NODE2 -named listreceivedbyaddress include_empty=true include_watchonly=false\r\n     [\r\n       {\r\n         \"address\": $watch_address,\r\n         \"amount\": 0.00000000,\r\n         \"confirmations\": 0,\r\n         \"label\": \"\",\r\n         \"txids\": [\r\n         ]\r\n       }\r\n     ]\r\n     ```\r\n\r\nNote: The same behavior can also reproduced for the `listreceivedbylabel` RPC.",
      "user": {
        "login": "kouloumos",
        "id": 18506343,
        "node_id": "MDQ6VXNlcjE4NTA2MzQz",
        "avatar_url": "https://avatars.githubusercontent.com/u/18506343?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kouloumos",
        "html_url": "https://github.com/kouloumos",
        "followers_url": "https://api.github.com/users/kouloumos/followers",
        "following_url": "https://api.github.com/users/kouloumos/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kouloumos/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kouloumos/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kouloumos/subscriptions",
        "organizations_url": "https://api.github.com/users/kouloumos/orgs",
        "repos_url": "https://api.github.com/users/kouloumos/repos",
        "events_url": "https://api.github.com/users/kouloumos/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kouloumos/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/10468#issuecomment-1204165996",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10468"
    },
    {
      "event": "commented",
      "id": 1252647812,
      "node_id": "IC_kwDOABII585KqeOE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1252647812",
      "actor": {
        "login": "aureleoules",
        "id": 22493292,
        "node_id": "MDQ6VXNlcjIyNDkzMjky",
        "avatar_url": "https://avatars.githubusercontent.com/u/22493292?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/aureleoules",
        "html_url": "https://github.com/aureleoules",
        "followers_url": "https://api.github.com/users/aureleoules/followers",
        "following_url": "https://api.github.com/users/aureleoules/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/aureleoules/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/aureleoules/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/aureleoules/subscriptions",
        "organizations_url": "https://api.github.com/users/aureleoules/orgs",
        "repos_url": "https://api.github.com/users/aureleoules/repos",
        "events_url": "https://api.github.com/users/aureleoules/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/aureleoules/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-09-20T17:05:40Z",
      "updated_at": "2022-09-20T17:05:40Z",
      "author_association": "MEMBER",
      "body": "https://github.com/bitcoin/bitcoin/blob/375ebadbf8f4bc9568c5280a75a20faa8cf9c31b/src/wallet/rpc/transactions.cpp#L148-L150\r\n\r\nthese values are never set because the loop above it\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/375ebadbf8f4bc9568c5280a75a20faa8cf9c31b/src/wallet/rpc/transactions.cpp#L97-L131\r\nis never called because `wallet.mapWallet` is empty.",
      "user": {
        "login": "aureleoules",
        "id": 22493292,
        "node_id": "MDQ6VXNlcjIyNDkzMjky",
        "avatar_url": "https://avatars.githubusercontent.com/u/22493292?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/aureleoules",
        "html_url": "https://github.com/aureleoules",
        "followers_url": "https://api.github.com/users/aureleoules/followers",
        "following_url": "https://api.github.com/users/aureleoules/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/aureleoules/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/aureleoules/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/aureleoules/subscriptions",
        "organizations_url": "https://api.github.com/users/aureleoules/orgs",
        "repos_url": "https://api.github.com/users/aureleoules/repos",
        "events_url": "https://api.github.com/users/aureleoules/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/aureleoules/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/10468#issuecomment-1252647812",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10468"
    }
  ]
}