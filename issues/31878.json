{
  "type": "issue",
  "issue": {
    "id": 2855472840,
    "node_id": "I_kwDOABII586qMw7I",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31878",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31878/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31878/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31878/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31878",
    "number": 31878,
    "state": "open",
    "state_reason": null,
    "title": "kernel: feedback on using kernel in alternative implementations",
    "body": "After talking about this with many core devs offline, and being told every time to open an issue with this, I'm opening this to spark some discussion about the viability and optimal implementation of a `libbitcoinkernel`-like lib to help consensus-compatible implementations. This could be useful for other experimental projects like [2][3].\n\n## Goals\n\nBitcoin doesn’t have a formal spec for its base protocol. It operates with the “reference implementation” model, where Bitcoin\nCore dictates what Bitcoin actually is. Bitcoin Core is a mission critical software, the backbone of a 2 trillion \ndollars industry. And as such, it has the highest standards when it comes to adding new features, and experimentations. \nHowever, Bitcoin is a new completelly novel experiment, with many prospective ideas out there that can’t be implemented in Core due \nto it’s incipience, but also can’t be implemented in an alternative client (or at least not trivially) due to the constant \nrisk of falling out of consensus with Bitcoin Core. This tradeoff has stopped or slowed down some ideas like Utreexo and \nProof of Work fraud proofs because, to implement them, you need to reimplement a bug-compatible Bitcoin Core rewrite \n(possibly in other languages). This is also a problem for projects that don’t operate directly with the consensus layer, \nlike wallets and Layer two software, that might misinterpret some paramentes and end up putting user’s funds in risk.\n\nFor new deployments, such as segwit and taproot, we have a very well thought description and standardization. We also have \nabundant test-vectores and sometimes even self-contained reference implementations. That makes reimplementations much easier.\nHowever, unless we can hard-fork the network to remove all undefined behavior and get a formal specification, building complex \nsoftware on top of Bitcoin without a way to re-use Bitcoin Core code will always be a non-trivial process.\n  \n## Utreexo light clients\n\nWith utreexo[1] we can have extremely small clients, both in code footprint and actual resource usage. We currently have\ntwo implementations of such ideas: utreexod[2] and floresta[3]. The former is written in Golang, and the latter in Rust.\nWhile they are well-tested and have a high quality standard, reimplementing Bitcoin’s consensus logic is a complex problem, \nthat oftentimes can fail you in the most unexpected ways.\n\nThe vast majority of consensus failures comes from implementing the low-level checks of blocks and transactions, \nlike script evaluation and locktimes. The implementation of those parts inside Bitcoin Core is battle-tested and overly \noptimized already, making any meaningful improvement almost impossible. So it would make sense for other projects to reuse \nthem, reducing the chances of a consensus failure and using the state-of-the-art validation logic. The goal isn't, in any way, \nreplace Bitcoin Core. Rather, to allow for inovation and research in parts that wouldn't be inside Core's scope, but without\nre-inventing the weel every single time. For this we have two possible approaches, `libbitcoinconsensus` and `libbitcoinkernel`.\n\n### libbitcoinconsensus\n\nThis was one the earliest attempts to make the validation code for bitcoin reusable. This lib, however, only exposes script\nvalidation. All other checks must be implemented by consumers. Although it have such limited context, it turns out that most\nof the complexity inside Bitcoin’s validation comes from script validation. It is over a thousand lines, and has many known\nand unknown undefined behaviors that are extremely hard to get right in other languages, like Rust or Go. For instance, the \nlast consensus failure found on btcd is related to `FindAndDelete`, a function used inside the script evaluation.\n\nFloresta uses `libbitcoinconsensus` since it’s very beginning, and has never had any failure of this kind. The API is\nsimple and hard-to-misuse. However, this limited scope prevents it from being used in more advanced use-cases. \nFor instance, all layer two applications need to re-implement core’s mempool policies inside the implementation, \nsometimes needing a simplified script evaluation logic. This is useful because they need to learn in advance whether a \ntransaction will be confirmed or not, without broadcasting it. If core’s internal policy was exposed as a lib, that would \nhelp reducing potential risks on layer two’s software and make them simpler and easier to maintain.\n\n### libbitcoinkernel\n\nKernel on the other hand, is a more complete tool that can even run an embedded Bitcoin Core on your application. \nIt exposes core’s internal storage, the peers logic and lets you replace some parts of a node. It is perfect for \napplications that needs to consume blocks in a high-bandwidth  way, since you can read blocks and transaction straight \nfrom disk, without going through the RPC. In the version implemented in [4], it even brings the old libbitcoinconsensus’s \nAPI, making it a drop-in replacement for the latter. \n\nAs currently designed, however. It can’t get past of libbitcoinconsensus’s context for alternative implementations or \nlayer two software. The reason being that it depends on core’s UTXO set and blocks store. For floresta and utreexod, \nhaving the UTXO set doesn’t make sense, since we are utreexo CSN nodes. For L2, sometimes they need to check for chains of \nunconfirmed transactions, spending UTXOs that doesn’t exist in the UTXO set nor mempool. The ideal workflow for such \napplications would be a method (or a series of) that takes a serialized block, a list of UTXOs, the current MTP, block \nheight (and hash?); then returns whether that block is valid or not (returning the error if possible). This would be \nclose to the SANS-IO model, where all data needed will be provided by the caller, and the function would only operate on them.\nA similar interface to validate transactions would also be very useful.\n\nThe main con of this approach is that now libbitcoinkernel will technically not be fully-consensus compatible. This happens \nbecause whether a UTXO exists or not is completely tied to the database that core uses, in some cases it might be a problem \nthat only happens if they appear in a block. We already have a track record of a chain split caused by a database upgrade[5]. \nEven if we’ve implemented utreexo validation inside Bitcoin Core, leveldb would still be required. The best we could do is require that a UTXO is recognized by both utreexo and leveldb  (that would be a soft-fork, technically). \nEliminating leveldb would only be possible if Bitcoin Core worked only as a utreexo node, using leveldb only as a way to keep \nUTXO data. Although this would be a huge improvement on defining bitcoin’s consensus, and preventing future failures like [5],\nthat is impractical both politically and probably technically, as implementing this risks a consensus failure.\n\nA good compromise would be if libbitcoinkernel (or another subset of thereof with another name for clarity) would allow an \n“unsafe” mode, where not all consensus parts are provided (e.g. leveldb) and you still **could** create a failure. This project\ncould live under a new namespace to not confuse with `libbitcoinkernel`.\n\n\nSources\n[1] https://eprint.iacr.org/2019/611\n[2] https://github.com/utreexo/utreexod\n[3] https://github.com/vinteumorg/floresta\n[4] https://github.com/bitcoin/bitcoin/pull/30595\n[5] https://github.com/bitcoin/bips/blob/master/bip-0050.mediawiki",
    "user": {
      "login": "Davidson-Souza",
      "id": 40968167,
      "node_id": "MDQ6VXNlcjQwOTY4MTY3",
      "avatar_url": "https://avatars.githubusercontent.com/u/40968167?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Davidson-Souza",
      "html_url": "https://github.com/Davidson-Souza",
      "followers_url": "https://api.github.com/users/Davidson-Souza/followers",
      "following_url": "https://api.github.com/users/Davidson-Souza/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Davidson-Souza/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Davidson-Souza/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Davidson-Souza/subscriptions",
      "organizations_url": "https://api.github.com/users/Davidson-Souza/orgs",
      "repos_url": "https://api.github.com/users/Davidson-Souza/repos",
      "events_url": "https://api.github.com/users/Davidson-Souza/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Davidson-Souza/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 64584,
        "node_id": "MDU6TGFiZWw2NDU4NA==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming",
        "name": "Brainstorming",
        "color": "ebd775",
        "default": false
      },
      {
        "id": 97470796,
        "node_id": "MDU6TGFiZWw5NzQ3MDc5Ng==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/UTXO%20Db%20and%20Indexes",
        "name": "UTXO Db and Indexes",
        "color": "fbca04",
        "default": false
      },
      {
        "id": 241832923,
        "node_id": "MDU6TGFiZWwyNDE4MzI5MjM=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs",
        "name": "Utils/log/libs",
        "description": "",
        "color": "5319e7",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 0,
    "created_at": "2025-02-15T13:23:10Z",
    "updated_at": "2025-02-17T07:52:36Z"
  },
  "events": [
    {
      "event": "subscribed",
      "id": 16321639889,
      "node_id": "SE_lADOABII586qMw7IzwAAAAPM2HXR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16321639889",
      "actor": {
        "login": "luisschwab",
        "id": 97608688,
        "node_id": "U_kgDOBdFj8A",
        "avatar_url": "https://avatars.githubusercontent.com/u/97608688?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luisschwab",
        "html_url": "https://github.com/luisschwab",
        "followers_url": "https://api.github.com/users/luisschwab/followers",
        "following_url": "https://api.github.com/users/luisschwab/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luisschwab/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luisschwab/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luisschwab/subscriptions",
        "organizations_url": "https://api.github.com/users/luisschwab/orgs",
        "repos_url": "https://api.github.com/users/luisschwab/repos",
        "events_url": "https://api.github.com/users/luisschwab/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luisschwab/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-15T13:31:34Z"
    },
    {
      "event": "subscribed",
      "id": 16321642720,
      "node_id": "SE_lADOABII586qMw7IzwAAAAPM2IDg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16321642720",
      "actor": {
        "login": "storopoli",
        "id": 43353831,
        "node_id": "MDQ6VXNlcjQzMzUzODMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/43353831?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/storopoli",
        "html_url": "https://github.com/storopoli",
        "followers_url": "https://api.github.com/users/storopoli/followers",
        "following_url": "https://api.github.com/users/storopoli/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/storopoli/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/storopoli/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/storopoli/subscriptions",
        "organizations_url": "https://api.github.com/users/storopoli/orgs",
        "repos_url": "https://api.github.com/users/storopoli/repos",
        "events_url": "https://api.github.com/users/storopoli/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/storopoli/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-15T13:33:04Z"
    },
    {
      "event": "subscribed",
      "id": 16326310722,
      "node_id": "SE_lADOABII586qMw7IzwAAAAPNH7tC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16326310722",
      "actor": {
        "login": "spacebear21",
        "id": 144076611,
        "node_id": "U_kgDOCJZvQw",
        "avatar_url": "https://avatars.githubusercontent.com/u/144076611?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/spacebear21",
        "html_url": "https://github.com/spacebear21",
        "followers_url": "https://api.github.com/users/spacebear21/followers",
        "following_url": "https://api.github.com/users/spacebear21/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/spacebear21/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/spacebear21/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/spacebear21/subscriptions",
        "organizations_url": "https://api.github.com/users/spacebear21/orgs",
        "repos_url": "https://api.github.com/users/spacebear21/repos",
        "events_url": "https://api.github.com/users/spacebear21/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/spacebear21/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-17T02:10:41Z"
    },
    {
      "event": "labeled",
      "id": 16329069527,
      "node_id": "LE_lADOABII586qMw7IzwAAAAPNSdPX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16329069527",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-17T07:52:20Z",
      "label": {
        "name": "UTXO Db and Indexes",
        "color": "fbca04"
      }
    },
    {
      "event": "labeled",
      "id": 16329070371,
      "node_id": "LE_lADOABII586qMw7IzwAAAAPNSdcj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16329070371",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-17T07:52:25Z",
      "label": {
        "name": "Brainstorming",
        "color": "ebd775"
      }
    },
    {
      "event": "labeled",
      "id": 16329072791,
      "node_id": "LE_lADOABII586qMw7IzwAAAAPNSeCX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16329072791",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-17T07:52:36Z",
      "label": {
        "name": "Utils/log/libs",
        "color": "5319e7"
      }
    }
  ]
}