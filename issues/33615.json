{
  "type": "issue",
  "issue": {
    "id": 3510872152,
    "node_id": "I_kwDOABII587RQ6hY",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33615",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33615/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33615/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33615/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33615",
    "number": 33615,
    "state": "open",
    "state_reason": null,
    "title": "ASAN use-after-free in `m_reconnections`",
    "body": "I ran into this while shutting my node down during IBD. I think it's benign.\n\nWhat happens:\n- `CConnman` is started [here](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/init.cpp#L2183).\n  - This initializes `semOutbound` [here](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/net.cpp#L3361).\n- While `CConnman` is active, `m_reconnections` is added to in `DisconnectNodes` [here](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/net.cpp#L1981).\n- `CConnman` is stopped [here](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/init.cpp#L315)\n  - The call to `Stop` will call `StopNodes` which will reset `semOutbound` [here](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/net.cpp#L3511).\n- `~CConnman` is invoked a few lines below [here](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/init.cpp#L328).\n  - In addition to calling `Stop` a second time, it also destructs a possibly non-empty `m_reconnections` (a list of `ReconnectionInfo` which contains a [pointer to the memory](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/net.h#L1690) that `semOutbound` also pointed to) by calling `clear()`. To destroy each element of `m_reconnections`, it looks like it accesses the `grant` field but that memory was already freed.\n\nI haven't been able to reproduce this reliably, it appears timing-dependent. I think this can be fixed by calling `WITH_LOCK(m_reconnections_mutex, m_reconnections.clear())` before [this line](https://github.com/bitcoin/bitcoin/blob/64a7c7cbb975cb3c3f25a3f784779f32cd95ebaa/src/net.cpp#L3511).\n\nASAN output:\n```\n=================================================================\n==22244==ERROR: AddressSanitizer: heap-use-after-free on address 0x6020018ba9d0 at pc 0x000100837e58 bp 0x00016f826280 sp 0x00016f826278\nWRITE of size 8 at 0x6020018ba9d0 thread T0\n==22244==WARNING: Can't write to symbolizer at fd 5\n    #0 0x100837e54 in void std::__1::__destroy_at[abi:ne180100]<CConnman::ReconnectionInfo, 0>(CConnman::ReconnectionInfo*) construct_at.h:67\n    #1 0x100837754 in std::__1::__list_imp<CConnman::ReconnectionInfo, std::__1::allocator<CConnman::ReconnectionInfo>>::clear() list:635\n    #2 0x1008202b8 in CConnman::~CConnman() net.cpp:3526\n    #3 0x10075802c in Shutdown(node::NodeContext&) init.cpp:328\n    #4 0x1005decc0 in main bitcoind.cpp:292\n    #5 0x1937bab48  (<unknown module>)\n\n0x6020018ba9d0 is located 0 bytes inside of 8-byte region [0x6020018ba9d0,0x6020018ba9d8)\nfreed by thread T0 here:\n    #0 0x1034ed2e4 in _ZdlPv+0x6c (libclang_rt.asan_osx_dynamic.dylib:arm64+0x612e4)\n    #1 0x10081fe9c in CConnman::StopNodes() net.cpp:3511\n    #2 0x100757ebc in Shutdown(node::NodeContext&) init.cpp:315\n    #3 0x1005decc0 in main bitcoind.cpp:292\n    #4 0x1937bab48  (<unknown module>)\n\npreviously allocated by thread T0 here:\n    #0 0x1034ececc in _Znwm+0x6c (libclang_rt.asan_osx_dynamic.dylib:arm64+0x60ecc)\n    #1 0x10081c77c in CConnman::Start(CScheduler&, CConnman::Options const&) net.cpp:3361\n    #2 0x10077d364 in AppInitMain(node::NodeContext&, interfaces::BlockAndHeaderTipInfo*) init.cpp:2183\n    #3 0x1005debd0 in main bitcoind.cpp:288\n    #4 0x1937bab48  (<unknown module>)\n\nSUMMARY: AddressSanitizer: heap-use-after-free construct_at.h:67 in void std::__1::__destroy_at[abi:ne180100]<CConnman::ReconnectionInfo, 0>(CConnman::ReconnectionInfo*)\nShadow bytes around the buggy address:\n  0x6020018ba700: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa\n  0x6020018ba780: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa\n  0x6020018ba800: fa fa fd fd fa fa fd fa fa fa fa fa fa fa fa fa\n  0x6020018ba880: fa fa 00 00 fa fa fa fa fa fa fa fa fa fa 00 00\n  0x6020018ba900: fa fa fd fa fa fa fd fd fa fa fd fa fa fa fd fd\n=>0x6020018ba980: fa fa fd fd fa fa fd fd fa fa[fd]fa fa fa fd fa\n  0x6020018baa00: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa\n  0x6020018baa80: fa fa fd fa fa fa fd fd fa fa fa fa fa fa fa fa\n  0x6020018bab00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x6020018bab80: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x6020018bac00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07 \n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n==22244==ABORTING\n```",
    "user": {
      "login": "Crypt-iQ",
      "id": 15145615,
      "node_id": "MDQ6VXNlcjE1MTQ1NjE1",
      "avatar_url": "https://avatars.githubusercontent.com/u/15145615?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Crypt-iQ",
      "html_url": "https://github.com/Crypt-iQ",
      "followers_url": "https://api.github.com/users/Crypt-iQ/followers",
      "following_url": "https://api.github.com/users/Crypt-iQ/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Crypt-iQ/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Crypt-iQ/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Crypt-iQ/subscriptions",
      "organizations_url": "https://api.github.com/users/Crypt-iQ/orgs",
      "repos_url": "https://api.github.com/users/Crypt-iQ/repos",
      "events_url": "https://api.github.com/users/Crypt-iQ/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Crypt-iQ/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      },
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 0,
    "created_at": "2025-10-13T17:23:46Z",
    "updated_at": "2025-10-14T06:42:48Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 20261980263,
      "node_id": "LE_lADOABII587RQ6hYzwAAAAS3tUhn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20261980263",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T06:42:29Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "labeled",
      "id": 20261986343,
      "node_id": "LE_lADOABII587RQ6hYzwAAAAS3tWAn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20261986343",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T06:42:48Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    }
  ]
}