{
  "type": "issue",
  "issue": {
    "id": 1955198666,
    "node_id": "I_kwDOABII5850ifbK",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28699",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28699/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28699/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28699/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/28699",
    "number": 28699,
    "state": "open",
    "state_reason": null,
    "title": "[brainstorm] replacement cache to optimize miners block templates",
    "body": "Second-layers with time-sensitive transactions might see their propagation tampered by their counterparties in opportunistic or adversarial environments. Additionally, non-cooperatively fee-bumped chain of transactions might produce suboptimal miners block templates.\r\n\r\n## Motivation\r\n\r\nCurrently, replaced or evicted transactions out of the mempool are not kept in archive. Later transaction reception might invalidate again the replacement candidate letting a spend utxo free to be spent by the original replaced transaction.\r\n\r\nIt is possible to keep in bounded memory a list of all seen transactions, which have entered our mempool at least once at current mempool min fee (or weight-based mempool min fee on the last X period of time).\r\n\r\n- A transaction issuer on the network might broadcast a batch payout transaction paying many users outputs to user-selected wallets scriptpubkeys. Fee bumping responbility might be shared between the initial broadcaster RBF or payouts users CPFP. Current in-mempool chain package limits might prevent a higher-fee RBF than the sum of CPFP of replacing the chain of transactions or at th contrary the sum of CPFP entering the mempool after the RBF might be higher due to lack of coordination between the set of multi-party transactions participants.\r\n\r\n- Recently, p2p replacement attacks have come to awareness affecting second-layers with time-sensitive transactions where a counterparty can delay the confirmation of time-sensitive states until a more favorable ones become consensus final at the advantage of the attacker. In such situations the initial spend candidate of the channel funding output might be the best fee proposal after a full sequence of replacement have played out.\r\n\r\n## Design Questions\r\n\r\n### What Denial-of-Service vectors to consider ?\r\n\r\nA cache of replacement transaction will have to be DoS-resistant. Traversal of the cache should be efficient to avoid being a source of new DoS vectors, both memory and CPU validation. Transactions signatuters in the replacement cache could stay in a new cache we have already (like built from `CuckooCache` primitives) or existent one. New cluster-based algorithms can be leveraged to make traversal of replacement cache more efficient.\r\n\r\nReconciliation between replacement caches due to asymmetric transaction-relay network topology of block templates builders shouldnâ€™t hamper on compact block validation.\r\n\r\n### What replacement cache expiration delay to consider ?\r\n\r\nAfter an epoch-based or height-based delay, transactions in the replacement cache might be definitively pruned out of node memory, until a subsequent automatic or manual re-broadcast by the transaction issuer. Currently, core's mempool expiration delay (`DEFAULT_MEMPOOL_EXPIRY_HOURS=336`) so 14 days time at max during which a transaction might stay in network mempools.\r\n\r\nExpiration delay value of the replacement cache might let opportunistic behavior happen in function of mempool cycles, where transaction issuers might delay a fee-bumping (RBF or CPFP) to trigger a \"resurrection\" of the cached transactions back in miners block templates, saving on the RBF penalty.\r\n\r\n### How to handle reorgs consistently ?\r\n\r\nIf we have one or two blocks of reorgs, which happen sometimes on mainnet, some transactions laying in the replacement cache might become stale, i.e a spent output does not exist anymore. In that situation, the replacement cache should be pruned in consequence to remove the staled transactions. Pruning parameters should be selected carefully to avoid low-hashrate miners provoking shallow reorgs to optimize their block templates, in a variant of a \"selffish\" miner attack.",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 64584,
        "node_id": "MDU6TGFiZWw2NDU4NA==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming",
        "name": "Brainstorming",
        "color": "ebd775",
        "default": false
      },
      {
        "id": 164208572,
        "node_id": "MDU6TGFiZWwxNjQyMDg1NzI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Mempool",
        "name": "Mempool",
        "color": "fef2c0",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 0,
    "created_at": "2023-10-21T01:33:47Z",
    "updated_at": "2024-01-24T21:39:10Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 11589913683,
      "node_id": "LE_lADOABII5850ifbKzwAAAAKy0AxT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11589913683",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-24T21:39:10Z",
      "label": {
        "name": "Brainstorming",
        "color": "ebd775"
      }
    },
    {
      "event": "labeled",
      "id": 11589913688,
      "node_id": "LE_lADOABII5850ifbKzwAAAAKy0AxY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11589913688",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-24T21:39:10Z",
      "label": {
        "name": "Mempool",
        "color": "fef2c0"
      }
    }
  ]
}