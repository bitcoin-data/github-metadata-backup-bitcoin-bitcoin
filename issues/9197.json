{
  "type": "issue",
  "issue": {
    "id": 190843889,
    "node_id": "MDU6SXNzdWUxOTA4NDM4ODk=",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9197",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9197/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9197/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9197/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/9197",
    "number": 9197,
    "state": "open",
    "state_reason": null,
    "title": "RPC idempotency and RPC request replay protection",
    "body": "I noticed [pull request 128 to python-bitcoinlib](https://github.com/petertodd/python-bitcoinlib/pull/128) where an RPC client retry wrapper is proposed. The retry wrapper would retry in the event of an `IOError` exception. However, this does not seem particularly safe for RPC calls like `sendmany` because it could be possible to experience a socket or connection timeout even though bitcoind satisfied the original RPC request. In some cases, auto retrying could result in duplicate spending.\r\n\r\nRPC requests should have at least a nonce in every request. It should maybe be a nonce and sequence pair, per @gmaxwell's suggestion in below chat logs. It would be good to have RPC request replay protection in bitcoind.\r\n\r\nConcurrent writes should require locks. Applications should have some sense of guarantees around isolation of competing concurrent and also replayed RPC calls. It's not enough to \"check state\" over RPC with `listtransactions` because you can check state as much as you like, the state still might change between the time you check state and the time you resend the original RPC command, especially in distributed systems.\r\n\r\nhttps://botbot.me/freenode/bitcoin-core-dev/2016-11-21/?msg=76819688&page=2",
    "user": {
      "login": "kanzure",
      "id": 101238,
      "node_id": "MDQ6VXNlcjEwMTIzOA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/101238?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kanzure",
      "html_url": "https://github.com/kanzure",
      "followers_url": "https://api.github.com/users/kanzure/followers",
      "following_url": "https://api.github.com/users/kanzure/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/kanzure/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/kanzure/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/kanzure/subscriptions",
      "organizations_url": "https://api.github.com/users/kanzure/orgs",
      "repos_url": "https://api.github.com/users/kanzure/repos",
      "events_url": "https://api.github.com/users/kanzure/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/kanzure/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98279177,
        "node_id": "MDU6TGFiZWw5ODI3OTE3Nw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ",
        "name": "RPC/REST/ZMQ",
        "color": "0052cc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 3,
    "created_at": "2016-11-21T21:43:54Z",
    "updated_at": "2021-07-04T13:13:09Z"
  },
  "events": [
    {
      "event": "mentioned",
      "id": 867281717,
      "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50ODY3MjgxNzE3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/867281717",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-11-21T21:43:54Z"
    },
    {
      "event": "subscribed",
      "id": 867281718,
      "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDg2NzI4MTcxOA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/867281718",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-11-21T21:43:54Z"
    },
    {
      "event": "labeled",
      "id": 867389378,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDg2NzM4OTM3OA==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/867389378",
      "actor": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2016-11-21T23:07:38Z",
      "label": {
        "name": "RPC/REST/ZMQ",
        "color": "0052cc"
      }
    },
    {
      "event": "commented",
      "id": 612974002,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYxMjk3NDAwMg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612974002",
      "actor": {
        "login": "brakmic",
        "id": 56779,
        "node_id": "MDQ6VXNlcjU2Nzc5",
        "avatar_url": "https://avatars.githubusercontent.com/u/56779?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brakmic",
        "html_url": "https://github.com/brakmic",
        "followers_url": "https://api.github.com/users/brakmic/followers",
        "following_url": "https://api.github.com/users/brakmic/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brakmic/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brakmic/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brakmic/subscriptions",
        "organizations_url": "https://api.github.com/users/brakmic/orgs",
        "repos_url": "https://api.github.com/users/brakmic/repos",
        "events_url": "https://api.github.com/users/brakmic/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brakmic/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-13T16:27:29Z",
      "updated_at": "2020-04-13T16:29:51Z",
      "author_association": "CONTRIBUTOR",
      "body": "Hi,\r\n\r\nI've experimented a bit and implemented something that could maybe offer a solution to the problem with sending of identical requests. \r\n\r\nThe changes are located in:\r\n\r\n* **httprpc.cpp** - where we check incoming nonces and keep track of previous ones. There are two ways to get a nonce: the client generates **X-Nonce** header, or we create one on-the-fly based on the JSON-request object content (a Hash160 will be generated)\r\n\r\n* **bitcoin-cli.cpp** - here we generate nonces by using the `std::random_device`+ `std::mt19937`\r\n\r\n* **rpc/server.cpp** - here we use a new method `isDangerousCommand` which tells if a particular RPC-command belongs to `dangerous ones`. A command is `dangerous` when it can change the wallet, manipulate UTXOs, change wallet state etc. \r\n\r\n* **rpcwallet.cpp** - the RPC **commands[]** table was updated to contain the boolean flag *dangerous* that indicates if a command is `destructive`.\r\n\r\n-----   \r\n\r\nA client request will be rejected when either of the following problems occur:\r\n\r\n* **Client sends a request containing a *dangerous* command together with `X-Nonce` that is already known**. That is: the server has already seen and (maybe) executed this command. A client that keeps on sending the same request without changing X-Nonce is not functioning properly, regardless how meaningful the command is.\r\n\r\n* **Client sends a request containing a *dangerous* command without X-Nonce but with identical JSON content**. Here the client is repeating the same command again and again.\r\n\r\nIn the first case the nonce will be used to reject the request immediately. \r\nIn the second case the server would first generate a nonce based on the JSON data from the request and then check if this once is already known.\r\n\r\nThere is another, *harmless* case, when a client is sending requests containing non-dangerous commands. In such cases the server would continue answering requests as those commands aren't changing anything on the server. However, they too could be handled more strictly, for example to *throttle requests* or similar tasks.\r\n\r\nWhen a requests is blocked the following entry will be logged:\r\n\r\n![reject](https://raw.githubusercontent.com/brakmic/bazaar/master/images/random/reject_replay_request.png)\r\n\r\nAlthough very interesting to implement and also a nice way to learn more about Bitcoin internals, I am not sure if this approach is really useful and resilient enough to be used in real environments.\r\n\r\nThe changes are located [in my repo](https://github.com/brakmic/bitcoin/commit/763bf6053610c5c3b1be951ce21a8ddffbae7c7e). I don't think that at this stage a PR should be opened.\r\n\r\nRegards,",
      "user": {
        "login": "brakmic",
        "id": 56779,
        "node_id": "MDQ6VXNlcjU2Nzc5",
        "avatar_url": "https://avatars.githubusercontent.com/u/56779?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brakmic",
        "html_url": "https://github.com/brakmic",
        "followers_url": "https://api.github.com/users/brakmic/followers",
        "following_url": "https://api.github.com/users/brakmic/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brakmic/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brakmic/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brakmic/subscriptions",
        "organizations_url": "https://api.github.com/users/brakmic/orgs",
        "repos_url": "https://api.github.com/users/brakmic/repos",
        "events_url": "https://api.github.com/users/brakmic/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brakmic/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9197#issuecomment-612974002",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9197"
    },
    {
      "event": "commented",
      "id": 612984066,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYxMjk4NDA2Ng==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612984066",
      "actor": {
        "login": "kanzure",
        "id": 101238,
        "node_id": "MDQ6VXNlcjEwMTIzOA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/101238?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kanzure",
        "html_url": "https://github.com/kanzure",
        "followers_url": "https://api.github.com/users/kanzure/followers",
        "following_url": "https://api.github.com/users/kanzure/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kanzure/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kanzure/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kanzure/subscriptions",
        "organizations_url": "https://api.github.com/users/kanzure/orgs",
        "repos_url": "https://api.github.com/users/kanzure/repos",
        "events_url": "https://api.github.com/users/kanzure/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kanzure/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-13T16:50:06Z",
      "updated_at": "2020-04-13T16:50:06Z",
      "author_association": "CONTRIBUTOR",
      "body": "My first concern is that it will be difficult (and perhaps even non-intuitive) which commands are considered \"dangerous\" and \"harmless\". Are there any harmless commands at all?\r\n\r\nI would also like to bring up that there are many databases out there in the world that deal with this problem all the time, using transaction isolation: https://www.postgresql.org/docs/current/transaction-iso.html\r\n\r\n",
      "user": {
        "login": "kanzure",
        "id": 101238,
        "node_id": "MDQ6VXNlcjEwMTIzOA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/101238?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kanzure",
        "html_url": "https://github.com/kanzure",
        "followers_url": "https://api.github.com/users/kanzure/followers",
        "following_url": "https://api.github.com/users/kanzure/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kanzure/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kanzure/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kanzure/subscriptions",
        "organizations_url": "https://api.github.com/users/kanzure/orgs",
        "repos_url": "https://api.github.com/users/kanzure/repos",
        "events_url": "https://api.github.com/users/kanzure/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kanzure/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9197#issuecomment-612984066",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9197"
    },
    {
      "event": "commented",
      "id": 612997257,
      "node_id": "MDEyOklzc3VlQ29tbWVudDYxMjk5NzI1Nw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612997257",
      "actor": {
        "login": "brakmic",
        "id": 56779,
        "node_id": "MDQ6VXNlcjU2Nzc5",
        "avatar_url": "https://avatars.githubusercontent.com/u/56779?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brakmic",
        "html_url": "https://github.com/brakmic",
        "followers_url": "https://api.github.com/users/brakmic/followers",
        "following_url": "https://api.github.com/users/brakmic/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brakmic/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brakmic/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brakmic/subscriptions",
        "organizations_url": "https://api.github.com/users/brakmic/orgs",
        "repos_url": "https://api.github.com/users/brakmic/repos",
        "events_url": "https://api.github.com/users/brakmic/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brakmic/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2020-04-13T17:19:03Z",
      "updated_at": "2020-04-13T17:19:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "Maybe we could also give users an option to define which methods they consider `dangerous`. Via config option. \r\n\r\nLike:\r\n\r\n`dangerous=sendmany,sendtoaddress`\r\nAnd maybe also: `dangerous=all` to declare them all dangerous.\r\n\r\nBut if we go the postgres way, it'd mean implementing a much more sophisticated structure that's way beyond my knowledge. But it would be a good way to learn something new. :)  ",
      "user": {
        "login": "brakmic",
        "id": 56779,
        "node_id": "MDQ6VXNlcjU2Nzc5",
        "avatar_url": "https://avatars.githubusercontent.com/u/56779?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brakmic",
        "html_url": "https://github.com/brakmic",
        "followers_url": "https://api.github.com/users/brakmic/followers",
        "following_url": "https://api.github.com/users/brakmic/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brakmic/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brakmic/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brakmic/subscriptions",
        "organizations_url": "https://api.github.com/users/brakmic/orgs",
        "repos_url": "https://api.github.com/users/brakmic/repos",
        "events_url": "https://api.github.com/users/brakmic/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brakmic/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/9197#issuecomment-612997257",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9197"
    },
    {
      "event": "subscribed",
      "id": 8318592374,
      "node_id": "SE_lADOABII584LYAvxzwAAAAHv06V2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/8318592374",
      "actor": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-01-20T06:18:21Z"
    }
  ]
}