{
  "type": "issue",
  "issue": {
    "id": 2159614620,
    "node_id": "I_kwDOABII586AuRqc",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/29506",
    "number": 29506,
    "state": "open",
    "state_reason": null,
    "title": "Since 0.16 Bitcoin can be stuck connected to adversarial/3rdparty node",
    "body": "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Current behaviour\r\n\r\nThere is a bug in net_processing.cpp logic.\r\nWe might be m_protect=true because that feature sees us as unsynced (easy to simulate/spoof by an adversary)\r\nOr this is actually possible:\r\n```\r\n             if (state == nullptr) return; // shouldn't be possible, but just in case\r\n```\r\nSecondly something sets fDisconnect=true (could be anything)\r\nSo basically we kind of accumulate 200 remote bitcoins connected to us which want to disconnect from us but simultaneously can't.\r\nI mean on the live network we have 200 uploader slots so 200 bitcoins become connected to us who really can't disconnect from us.\r\nKind of silly bug in bitcoin.\r\nfDisconnect=true kills any messages to us except ping.\r\nm_protect=true (theoretically kills the actual disconnect)\r\n\r\n### Expected behaviour\r\n\r\nEventually the remote bitcoin should disconnect from us anyway, as we consume it's slot forever.\r\n\r\n### Steps to reproduce\r\n\r\n1. Adversary connects to Bitcoin\r\n2. Stays connected to bitcoin forever.\r\n\r\n\r\n### Relevant log output\r\n\r\n_No response_\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nCompiled from source\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\n25\r\n\r\n### Operating system and version\r\n\r\nubuntu\r\n\r\n### Machine specifications\r\n\r\n_No response_",
    "user": {
      "login": "litecomb",
      "id": 121376577,
      "node_id": "U_kgDOBzwPQQ",
      "avatar_url": "https://avatars.githubusercontent.com/u/121376577?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/litecomb",
      "html_url": "https://github.com/litecomb",
      "followers_url": "https://api.github.com/users/litecomb/followers",
      "following_url": "https://api.github.com/users/litecomb/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/litecomb/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/litecomb/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/litecomb/subscriptions",
      "organizations_url": "https://api.github.com/users/litecomb/orgs",
      "repos_url": "https://api.github.com/users/litecomb/repos",
      "events_url": "https://api.github.com/users/litecomb/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/litecomb/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 5,
    "created_at": "2024-02-28T18:44:20Z",
    "updated_at": "2024-02-29T08:38:36Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 1969648412,
      "node_id": "IC_kwDOABII5851ZnMc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1969648412",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-28T18:58:22Z",
      "updated_at": "2024-02-28T19:50:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "I don't understand this. A node sets `m_protect=true` for a a maximum of 4 outbound peers (`MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT`) that have announced headers to us that have at least the work of our tip. See [here](https://github.com/bitcoin/bitcoin/blob/ba907f96ad37c09c49c0e1532fad118fcb8dd4a8/src/net_processing.cpp#L2880-L2886) for the code on master.\r\nIt is also never set for inbound peers, so if an \"Adversary connects to Bitcoin\" it won't be protected by it.\r\n\r\nMoreover, even if it `m_protect` was set it only protects from being disconnected due to not keeping up with the best chain (`PeerManagerImpl::ConsiderEviction`). It doesn't protect against disconnections for other reasons.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29506#issuecomment-1969648412",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506"
    },
    {
      "event": "commented",
      "id": 1969776450,
      "node_id": "IC_kwDOABII5851aGdC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1969776450",
      "actor": {
        "login": "litecomb",
        "id": 121376577,
        "node_id": "U_kgDOBzwPQQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/121376577?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/litecomb",
        "html_url": "https://github.com/litecomb",
        "followers_url": "https://api.github.com/users/litecomb/followers",
        "following_url": "https://api.github.com/users/litecomb/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/litecomb/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/litecomb/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/litecomb/subscriptions",
        "organizations_url": "https://api.github.com/users/litecomb/orgs",
        "repos_url": "https://api.github.com/users/litecomb/repos",
        "events_url": "https://api.github.com/users/litecomb/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/litecomb/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-28T20:04:42Z",
      "updated_at": "2024-02-28T20:20:31Z",
      "author_association": "NONE",
      "body": "I understand what do you mean. I take back that it's caused by m_protect, but this bug behaves identically to m_protect =?= true and fDisconnect=?=true. Also in our tests it applies to both inbound and outbound peers, the bitcoin core peer stays connected, is pinging/ponging and never disconnects (but doesn't respond to any packets).",
      "user": {
        "login": "litecomb",
        "id": 121376577,
        "node_id": "U_kgDOBzwPQQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/121376577?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/litecomb",
        "html_url": "https://github.com/litecomb",
        "followers_url": "https://api.github.com/users/litecomb/followers",
        "following_url": "https://api.github.com/users/litecomb/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/litecomb/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/litecomb/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/litecomb/subscriptions",
        "organizations_url": "https://api.github.com/users/litecomb/orgs",
        "repos_url": "https://api.github.com/users/litecomb/repos",
        "events_url": "https://api.github.com/users/litecomb/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/litecomb/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29506#issuecomment-1969776450",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506"
    },
    {
      "event": "commented",
      "id": 1969884504,
      "node_id": "IC_kwDOABII5851ag1Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1969884504",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-28T20:42:24Z",
      "updated_at": "2024-02-28T20:42:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Also in our tests it applies to both inbound and outbound peers\r\n\r\nInbound eviction only happens when the node is full, replacing existing peers. There is a rather complicated algorithm for that protecting peers with respect to certain criteria to establish a good diversity of inbound peers, see `CConnman::AttemptToEvictConnection()`.\r\nBut when the node is not at capacity, no inbound peer gets disconnected, which is intentional.\r\n\r\nAutomatic outbound peers get disconnected if they fall behind our tip (`PeerManagerImpl::ConsiderEviction`).\r\nOf course, that requires you to have gotten a new tip from someone else in the meantime.\r\nManually chosen outbound peers (\"addnode\") are not disconnected this way.\r\n\r\nSee https://github.com/bitcoin-core/bitcoin-devwiki/wiki/P2P-Design-Philosophy for a more in-depth essay on that.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29506#issuecomment-1969884504",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506"
    },
    {
      "event": "commented",
      "id": 1969897729,
      "node_id": "IC_kwDOABII5851akEB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1969897729",
      "actor": {
        "login": "litecomb",
        "id": 121376577,
        "node_id": "U_kgDOBzwPQQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/121376577?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/litecomb",
        "html_url": "https://github.com/litecomb",
        "followers_url": "https://api.github.com/users/litecomb/followers",
        "following_url": "https://api.github.com/users/litecomb/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/litecomb/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/litecomb/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/litecomb/subscriptions",
        "organizations_url": "https://api.github.com/users/litecomb/orgs",
        "repos_url": "https://api.github.com/users/litecomb/repos",
        "events_url": "https://api.github.com/users/litecomb/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/litecomb/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-28T20:52:03Z",
      "updated_at": "2024-02-28T20:56:34Z",
      "author_association": "NONE",
      "body": ">  But when the node is not at capacity, no inbound peer gets disconnected, which is intentional.\r\n\r\nOkay, not a bug for inbound case. Still, the bad outbound case remains.\r\n\r\nEssay says:\r\n> so we won't stay connected to 9 peers for long, in theory\r\n\r\nMy tests show otherwise. You stay connected to an adversary (i.e. not Bitcoin Core) while not communicating new blocks or anything (except pings pongs) indefinitely. On Bitcoin Core - Bitcoin Core (the honest case) this bug doesn't manifest.\r\n\r\n",
      "user": {
        "login": "litecomb",
        "id": 121376577,
        "node_id": "U_kgDOBzwPQQ",
        "avatar_url": "https://avatars.githubusercontent.com/u/121376577?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/litecomb",
        "html_url": "https://github.com/litecomb",
        "followers_url": "https://api.github.com/users/litecomb/followers",
        "following_url": "https://api.github.com/users/litecomb/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/litecomb/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/litecomb/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/litecomb/subscriptions",
        "organizations_url": "https://api.github.com/users/litecomb/orgs",
        "repos_url": "https://api.github.com/users/litecomb/repos",
        "events_url": "https://api.github.com/users/litecomb/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/litecomb/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29506#issuecomment-1969897729",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506"
    },
    {
      "event": "commented",
      "id": 1970659409,
      "node_id": "IC_kwDOABII5851deBR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1970659409",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-29T08:38:28Z",
      "updated_at": "2024-02-29T08:38:28Z",
      "author_association": "MEMBER",
      "body": "> My tests show otherwise.\r\n\r\nCan you share your tests? Ideally as a python functional test with the P2P interface mock, or otherwise exact steps to reproduce?",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/29506#issuecomment-1970659409",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29506"
    },
    {
      "event": "labeled",
      "id": 11962582090,
      "node_id": "LE_lADOABII586AuRqczwAAAALJBoRK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11962582090",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-29T08:38:36Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    }
  ]
}