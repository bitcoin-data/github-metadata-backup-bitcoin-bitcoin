{
  "type": "issue",
  "issue": {
    "id": 3812548980,
    "node_id": "I_kwDOABII587jPuF0",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34280",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34280/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34280/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34280/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/34280",
    "number": 34280,
    "state": "open",
    "state_reason": null,
    "title": "Coins Cache Cleanup checklist",
    "body": "The coins cache (the `CCoinsView*` stack, `CCoinsViewCache`, and friends) is a correctness and performance critical part of validation, IBD, and assumeutxo.\nOver time it has accumulated subtle invariants and legacy states (for example around cache entry flags, spent coin handling, and error catching), and we have been chipping away at it through focused refactors, bugfixes, tests, and performance work.\n\nThis issue tracks coins-cache-related work with two goals:\n\n* Make the coins cache layering and contracts easier to reason about (fewer implicit assumptions, fewer impossible states in tests).\n* Unlock and de-risk follow-up performance work (especially IBD) by tightening invariants and simplifying hot-path code.\n\nIRC context: https://bitcoin-irc.chaincode.com/bitcoin-core-dev/2026-01-08\n\n## PRs needing review\n\n### Coins cache cleanup and validation refactors\n\n* [ ] https://github.com/bitcoin/bitcoin/pull/34165 - add `PeekCoin()` and a non-mutating view so invalid block connects cannot pollute the main cache; prerequisite for multi-threaded input fetching.\n* [ ] https://github.com/bitcoin/bitcoin/pull/34164 - add `CCoinsViewCache::Reset()` and a reusable `m_connect_block_view` cache to reduce allocations and cheaply discard failed connects.\n* [ ] https://github.com/bitcoin/bitcoin/pull/34125 - tiny refactor to keep the `Sync()` vs `Flush()` decision consistent (no behavior change).\n* [ ] https://github.com/bitcoin/bitcoin/pull/34124 - replace implicit no-op behavior with explicit `CCoinsViewEmpty`, tightening the coins-view interface contract.\n* [ ] https://github.com/bitcoin/bitcoin/pull/34132 - simplify DB read error handling and remove wrapper layers on the hot `GetCoin()` path.\n* [ ] https://github.com/bitcoin/bitcoin/pull/31132 - introduce `CoinsViewCacheAsync` to prefetch input coins during `ConnectBlock` (includes reviewable subsets in #34164 and #34165).\n* [ ] https://github.com/bitcoin/bitcoin/pull/34207 - assert production invariants and align unit/fuzz tests to avoid impossible spent-coin states.\n* [ ] https://github.com/bitcoin/bitcoin/pull/33018 - remove the unreachable FRESH-but-not-DIRTY state to simplify cache entry semantics and tests.\n* [ ] https://github.com/bitcoin/bitcoin/pull/33680 - split FORCE_SYNC vs FORCE_FLUSH and keep the cache warm for `scantxoutset`, `gettxoutsetinfo`, and snapshot creation.\n* [ ] https://github.com/bitcoin/bitcoin/pull/33512 - track `dirty_count` so flush progress/warnings reflect actual disk writes after non-wiping flush changes.\n- [ ] https://github.com/bitcoin/bitcoin/pull/33854 - fix assumevalid being ignored during reindex when best header chainwork is below minimumchainwork (see https://github.com/bitcoin/bitcoin/issues/31494).\n* [ ] https://github.com/bitcoin/bitcoin/pull/32317 - move UTXO access/spending out of `ConnectBlock` into `SpendBlock` (kernel API, Utreexo, SwiftSync).\n\n### Adjacent IBD and performance work (related)\n\n* [ ] https://github.com/bitcoin/bitcoin/pull/34253 - make IBD checks a lock-free atomic read to reduce `cs_main` contention (enables scheduler-thread IBD gating like #34054).\n* [ ] https://github.com/bitcoin/bitcoin/pull/34054 - skip orphanage filter maintenance during IBD to save scheduler CPU.\n* [ ] https://github.com/bitcoin/bitcoin/pull/32497 - pre-reserve Merkle leaves to prevent reallocs with odd vtx count.\n* [ ] https://github.com/bitcoin/bitcoin/pull/32427 - concept/approach discussion for simplifying node storage backends (kernelization adjacent).\n* [ ] https://github.com/bitcoin/bitcoin/pull/33324 - resumable maintenance tool to (de)obfuscate existing block/undo files without resync.\n* [ ] https://github.com/bitcoin/bitcoin/pull/34083 - SIMD speedups (not coins-specific, but part of broader performance work).\n* [ ] https://github.com/bitcoin/bitcoin/pull/31682 - speed up consensus-critical duplicate-input and related checks (focused change, needs careful review).\n* [ ] https://github.com/bitcoin/bitcoin/pull/31868 - specialize block serialization to reduce generic serialization overhead (draft).\n* [ ] https://github.com/bitcoin/bitcoin/pull/34004 - prototype to reduce disk interactions during IBD by aggregating outpoint adds/spends and using an external hints file.\n\n### Bench and tooling (supporting work)\n\n* [ ] https://github.com/bitcoin/bitcoin/pull/32554 - remove hardcoded 1.1MB benchmark block and enable flexible benchmark scenarios.\n* [ ] https://github.com/bitcoin/bitcoin/pull/34208 - simplify benchmark setup/reset patterns.\n\n## Merged PRs\n\n* https://github.com/bitcoin/bitcoin/pull/33866 - simplify cache flush plumbing by removing an always-true return value (also `Sync()` and `Flush()`).\n* https://github.com/bitcoin/bitcoin/pull/30214 - make `Chainstate` objects more self-contained and clarify assumeutxo terminology (maintainability groundwork).\n* https://github.com/bitcoin/bitcoin/pull/33657 - allow reading partial block data from storage for REST, enabling fetching specific transactions via an external index (useful for tools like bindex).\n* https://github.com/bitcoin/bitcoin/pull/32414 - reduce reindex progress loss risk with large `-dbcache`.\n* https://github.com/bitcoin/bitcoin/pull/30442 - precalculate SipHash constant salt XORs (hot-path hashing micro-optimization).\n* https://github.com/bitcoin/bitcoin/pull/33602 - reduce redundant map lookups/hashes in `BatchWrite`, improving cache flush performance.\n* https://github.com/bitcoin/bitcoin/pull/33042 - shrink wrapper code and clarify call sites (no behavior change).\n* https://github.com/bitcoin/bitcoin/pull/31645 - tune flush batching for better performance on large flushes (still configurable via `-dbbatchsize`).\n* https://github.com/bitcoin/bitcoin/pull/32313 - fix under/over-counting that triggered UBSan overflow and tighten cache accounting correctness.\n* https://github.com/bitcoin/bitcoin/pull/33333 - add a startup warning when configured `-dbcache` exceeds a RAM-based cap to reduce OOM/swapping surprises.\n* https://github.com/bitcoin/bitcoin/pull/33154 - avoid mutating shared state and fix a reported data race in tests.\n* https://github.com/bitcoin/bitcoin/pull/33021 - ensure cache size state transitions remain covered after refactors.\n* https://github.com/bitcoin/bitcoin/pull/32279 - reduce dynamic allocations and improve locality for common script sizes.\n* https://github.com/bitcoin/bitcoin/pull/32827 - avoid needless vtx iteration during IBD.\n* https://github.com/bitcoin/bitcoin/pull/31144 - speed up block/undo obfuscation by batching XOR operations.\n* https://github.com/bitcoin/bitcoin/pull/32638 - make on-disk block reads validate hashes now that header hashing is cheap (pairs with #32487).\n* https://github.com/bitcoin/bitcoin/pull/32487 - reuse header hash for PoW and optional integrity checks, saving CPU per read.\n* https://github.com/bitcoin/bitcoin/pull/30611 - increase periodic flush frequency now that non-wiping flush cost scales with dirty entries.\n* https://github.com/bitcoin/bitcoin/pull/31551 - reduce syscall overhead and enable faster obfuscation during block/undo IO.\n* https://github.com/bitcoin/bitcoin/pull/32185 - use the native `WriteBatch` size estimator for accuracy and maintainability.\n* https://github.com/bitcoin/bitcoin/pull/31490 - reduce redundant serialization work and simplify disk-write code paths.\n* https://github.com/bitcoin/bitcoin/pull/31534 - make long shutdown flushes visible to users.\n* https://github.com/bitcoin/bitcoin/pull/30906 - de-risk coins cache refactors by tightening/cleaning the cache-entry interface.\n* https://github.com/bitcoin/bitcoin/pull/30039 - reduce LevelDB writes/compactions/open files by bumping LevelDB max file size to 32 MiB.\n* https://github.com/bitcoin/bitcoin/pull/31064 - avoid unnecessary coins DB reopen and cache reallocation on startup.\n* https://github.com/bitcoin/bitcoin/pull/30849 - clarify API semantics and align tests with reachable cache states.\n* https://github.com/bitcoin/bitcoin/pull/30884 - cache file position within `AutoFile` (Windows regression fix).\n* https://github.com/bitcoin/bitcoin/pull/28358 - allow the full UTXO set to fit into memory by dropping the `-dbcache` limit.\n* https://github.com/bitcoin/bitcoin/pull/30326 - avoid double lookups by using `try_emplace()`.\n* https://github.com/bitcoin/bitcoin/pull/28280 - keep the coins cache warm across prune flushes for faster block connection.\n* https://github.com/bitcoin/bitcoin/pull/28233 - keep the coins cache warm across periodic flushes.\n* https://github.com/bitcoin/bitcoin/pull/26326 - reduce validation lock contention by moving disk reads out of `cs_main`.\n* https://github.com/bitcoin/bitcoin/pull/26415 - avoid deserializing when serving raw block data (`getblock` verbosity 0, REST bin/hex, ZMQ).\n* https://github.com/bitcoin/bitcoin/pull/25325 - use a pool-based memory resource for the in-memory cache (large IBD speedup at the time).\n\n## Related context and superseded attempts (reference)\n\n  * https://github.com/bitcoin/bitcoin/pull/32043 - [IBD] Tracking PR for speeding up Initial Block Download (draft umbrella PR).\n  * https://github.com/bitcoin/bitcoin/pull/30673 - spent-and-FRESH and non-DIRTY entry cleanup attempt (closed, superseded by follow-ups like #33018 and #34207).\n  * https://github.com/bitcoin/bitcoin/pull/32885 - cache finished-IBD state near `SetTip` (closed; follow-up is https://github.com/bitcoin/bitcoin/pull/34253).\n  * https://github.com/bitcoin/bitcoin/pull/31102 - try to evict clean entries instead of wiping the whole coins cache when full (draft/closed).\n  * https://github.com/bitcoin/bitcoin/pull/28945 - preallocate memory for recreated caches (closed).\n  * https://github.com/bitcoin/bitcoin/pull/32457 - replace benchmark block with a more representative one (draft/closed; superseded by https://github.com/bitcoin/bitcoin/pull/32554).\n  * https://github.com/bitcoin/bitcoin/pull/32128 - exploratory CCoinMap experiments (draft/closed).\n",
    "user": {
      "login": "l0rinc",
      "id": 1841944,
      "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/l0rinc",
      "html_url": "https://github.com/l0rinc",
      "followers_url": "https://api.github.com/users/l0rinc/followers",
      "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
      "organizations_url": "https://api.github.com/users/l0rinc/orgs",
      "repos_url": "https://api.github.com/users/l0rinc/repos",
      "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/l0rinc/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 0,
    "created_at": "2026-01-14T10:23:16Z",
    "updated_at": "2026-01-14T13:04:17Z"
  },
  "events": [
    {
      "event": "renamed",
      "id": 22040270230,
      "node_id": "RTE_lADOABII587jPuF0zwAAAAUhs9WW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22040270230",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-14T10:57:11Z",
      "rename": {
        "from": "Coins Cache Cleanup tracking issue",
        "to": "Coins Cache Cleanup checklist"
      }
    }
  ]
}