{
  "type": "issue",
  "issue": {
    "id": 2596991903,
    "node_id": "I_kwDOABII586ayvOf",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31111",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31111/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31111/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31111/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/31111",
    "number": 31111,
    "state": "open",
    "state_reason": null,
    "title": "Trouble fuzzing on macos",
    "body": "I've got a Apple M2 Max macbook pro, running sequoia 15.0.1.  I'm trying to follow the instructions for fuzzing on macos, but I'm running into trouble.\r\n\r\nI reinstalled llvm via `brew install`, as the instructions indicated:\r\n\r\n```\r\n$ clang --version\r\nHomebrew clang version 19.1.2\r\nTarget: arm64-apple-darwin24.0.0\r\nThread model: posix\r\nInstalledDir: /opt/homebrew/Cellar/llvm/19.1.2/bin\r\n$ clang++ --version\r\nHomebrew clang version 19.1.2\r\nTarget: arm64-apple-darwin24.0.0\r\nThread model: posix\r\nInstalledDir: /opt/homebrew/Cellar/llvm/19.1.2/bin\r\n```\r\n\r\nI've got our master branch checked out at e8f72aefd20049eac81b150e7f0d33709acd18ed:\r\n\r\n```\r\n$ git log --oneline -1\r\ne8f72aefd20 (HEAD -> 2024-10-master, origin/master, origin/HEAD) Merge bitcoin/bitcoin#29877: tracing: explicitly cast block_connected duration to nanoseconds\r\n```\r\n\r\nAnd when I try to fuzz with the instructed preset, I get this:\r\n\r\n```\r\n$ cmake --preset=libfuzzer-nosan\r\nPreset CMake variables:\r\n\r\n  BUILD_FOR_FUZZING=\"ON\"\r\n  CMAKE_CXX_COMPILER=\"clang++\"\r\n  CMAKE_C_COMPILER=\"clang\"\r\n  SANITIZERS=\"fuzzer\"\r\n\r\n-- The CXX compiler identification is Clang 19.1.2\r\n-- Detecting CXX compiler ABI info\r\n-- Detecting CXX compiler ABI info - done\r\n-- Check for working CXX compiler: /opt/homebrew/opt/llvm/bin/clang++ - skipped\r\n-- Detecting CXX compile features\r\n-- Detecting CXX compile features - done\r\n-- Found SQLite3: /Library/Developer/CommandLineTools/SDKs/MacOSX15.0.sdk/usr/include (found suitable version \"3.43.2\", minimum required is \"3.7.17\")\r\nCMake Warning at CMakeLists.txt:227 (message):\r\n  BUILD_FOR_FUZZING=ON will disable all other targets and force\r\n  BUILD_FUZZ_BINARY=ON.\r\n\r\n\r\n-- Performing Test CXX_SUPPORTS__WERROR\r\n-- Performing Test CXX_SUPPORTS__WERROR - Success\r\n-- Setting build type to \"RelWithDebInfo\" as none was specified\r\n-- Performing Test CXX_SUPPORTS__G3\r\n-- Performing Test CXX_SUPPORTS__G3 - Success\r\n-- Performing Test LINKER_SUPPORTS__G3\r\n-- Performing Test LINKER_SUPPORTS__G3 - Success\r\n-- Performing Test CXX_SUPPORTS__FTRAPV\r\n-- Performing Test CXX_SUPPORTS__FTRAPV - Success\r\n-- Performing Test LINKER_SUPPORTS__FTRAPV\r\n-- Performing Test LINKER_SUPPORTS__FTRAPV - Success\r\n-- Performing Test LINKER_SUPPORTS__WL__FATAL_WARNINGS\r\n-- Performing Test LINKER_SUPPORTS__WL__FATAL_WARNINGS - Success\r\n-- Performing Test LINKER_SUPPORTS__WL__DEAD_STRIP\r\n-- Performing Test LINKER_SUPPORTS__WL__DEAD_STRIP - Success\r\n-- Performing Test LINKER_SUPPORTS__WL__DEAD_STRIP_DYLIBS\r\n-- Performing Test LINKER_SUPPORTS__WL__DEAD_STRIP_DYLIBS - Success\r\n-- Performing Test LINKER_SUPPORTS__WL__HEADERPAD_MAX_INSTALL_NAMES\r\n-- Performing Test LINKER_SUPPORTS__WL__HEADERPAD_MAX_INSTALL_NAMES - Success\r\n-- Performing Test CMAKE_HAVE_LIBC_PTHREAD\r\n-- Performing Test CMAKE_HAVE_LIBC_PTHREAD - Success\r\n-- Found Threads: TRUE\r\n-- Performing Test CXX_SUPPORTS__FSANITIZE_FUZZER\r\n-- Performing Test CXX_SUPPORTS__FSANITIZE_FUZZER - Success\r\n-- Performing Test LINKER_SUPPORTS__FSANITIZE_FUZZER_a797\r\n-- Performing Test LINKER_SUPPORTS__FSANITIZE_FUZZER_a797 - Failed\r\nCMake Error at CMakeLists.txt:377 (message):\r\n  Linker did not accept requested flags, you are missing required libraries.\r\n\r\n\r\n-- Configuring incomplete, errors occurred!\r\n```\r\n\r\nAny suggestions for what I should try next?\r\n",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 3,
    "created_at": "2024-10-18T09:33:35Z",
    "updated_at": "2024-10-19T10:44:04Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 2421978663,
      "node_id": "IC_kwDOABII586QXHYn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2421978663",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-18T09:37:13Z",
      "updated_at": "2024-10-18T09:46:11Z",
      "author_association": "MEMBER",
      "body": "From https://github.com/bitcoin/bitcoin/blob/master/doc/fuzzing.md#macos-hints-for-libfuzzer:\n\n> brew install llvm\n\n...\n\n> $ cmake --preset=libfuzzer -DCMAKE_C_COMPILER=\"$(brew --prefix llvm)/bin/clang\" -DCMAKE_CXX_COMPILER=\"$(brew --prefix llvm)/bin/clang++\" -DAPPEND_LDFLAGS=-Wl,-no_warn_duplicate_libraries\n\n",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31111#issuecomment-2421978663",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31111"
    },
    {
      "event": "commented",
      "id": 2423719604,
      "node_id": "IC_kwDOABII586Qdwa0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2423719604",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-19T09:31:14Z",
      "updated_at": "2024-10-19T09:31:14Z",
      "author_association": "MEMBER",
      "body": "Thanks, I actually had tried that but got some kind of failure as well.  Starting over and trying that step now, I see that the first step of setting up the build_fuzz directory succeeds, but when I try to build, I get this linker error:\r\n```\r\n$ cmake --build build_fuzz/ -j12\r\n<snip>\r\n[ 99%] Building CXX object src/test/fuzz/CMakeFiles/fuzz.dir/__/__/wallet/test/fuzz/scriptpubkeyman.cpp.o\r\n[ 99%] Building CXX object src/test/fuzz/CMakeFiles/fuzz.dir/__/__/wallet/test/fuzz/wallet_bdb_parser.cpp.o\r\n[100%] Linking CXX executable fuzz\r\nld: multiple errors: invalid r_symbolnum=1 in '/Users/sdaftuar/projects/bitcoin/2024-10-master/build_fuzz/src/test/fuzz/CMakeFiles/fuzz.dir/addition_overflow.cpp.o'; invalid r_symbolnum=1 in '/Users/sdaftuar/projects/bitcoin/2024-10-master/build_fuzz/src/test/fuzz/CMakeFiles/fuzz.dir/fees.cpp.o'; invalid r_symbolnum=1 in '/Users/sdaftuar/projects/bitcoin/2024-10-master/build_fuzz/src/test/fuzz/CMakeFiles/fuzz.dir/float.cpp.o'; invalid r_symbolnum=1 in '/Users/sdaftuar/projects/bitcoin/2024-10-master/build_fuzz/src/test/fuzz/CMakeFiles/fuzz.dir/multiplication_overflow.cpp.o'; invalid r_symbolnum=1 in '../../libbitcoin_cli.a[2](stdin.cpp.o)'; invalid r_symbolnum=1 in '../../../libcrc32c.a[3](crc32c_portable.cc.o)'; invalid r_symbolnum=1 in '../../../libcrc32c.a[2](crc32c.cc.o)'; invalid r_symbolnum=1 in '../../../libcrc32c_arm64.a[2](crc32c_arm64.cc.o)'; invalid r_symbolnum=18 in '../../crypto/libbitcoin_crypto_arm_shani.a[2](sha256_arm_shani.cpp.o)'; invalid r_symbolnum=1 in '../../crypto/libbitcoin_crypto.a[15](sha3.cpp.o)'; invalid r_symbolnum=1 in '../../../libleveldb.a[37](logging.cc.o)'; invalid r_symbolnum=1 in '../../../libleveldb.a[35](hash.cc.o)'; invalid r_symbolnum=1 in '../../crypto/libbitcoin_crypto.a[10](poly1305.cpp.o)'; invalid r_symbolnum=1 in '../../crypto/libbitcoin_crypto.a[5](hex_base.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_consensus.a[11](script_error.cpp.o)'; invalid r_symbolnum=1 in '../util/libtest_util.a[12](str.cpp.o)'; invalid r_symbolnum=1 in '../../../libleveldb.a[31](crc32c.cc.o)'; invalid r_symbolnum=1 in '../../../libleveldb.a[27](bloom.cc.o)'; invalid r_symbolnum=1 in '../../libbitcoin_consensus.a[5](hash.cpp.o)'; invalid r_symbolnum=5 in '../../util/libbitcoin_util.a[29](randomenv.cpp.o)'; invalid r_symbolnum=1 in '../../util/libbitcoin_util.a[27](logging.cpp.o)'; invalid r_symbolnum=1 in '../util/libtest_util.a[4](index.cpp.o)'; invalid r_symbolnum=1 in '../util/libtest_util.a[3](coins.cpp.o)'; invalid r_symbolnum=1 in '../../../libleveldb.a[8](filename.cc.o)'; invalid r_symbolnum=1 in '../../util/libbitcoin_util.a[24](threadnames.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[47](parsing.cpp.o)'; invalid r_symbolnum=1 in '../../../libleveldb.a[2](builder.cc.o)'; invalid r_symbolnum=1 in '../../util/libbitcoin_util.a[16](serfloat.cpp.o)'; invalid r_symbolnum=1 in '../../util/libbitcoin_util.a[15](readwritefile.cpp.o)'; invalid r_symbolnum=1 in '../../util/libbitcoin_util.a[14](rbf.cpp.o)'; invalid r_symbolnum=1 in '../../util/libbitcoin_util.a[9](feefrac.cpp.o)'; invalid r_symbolnum=1 in '../../util/libbitcoin_util.a[6](chaintype.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[42](request.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[41](rawtransaction_util.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[84](torcontrol.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[79](server_util.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[30](merkleblock.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[29](key_io.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[24](deploymentinfo.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[21](compressor.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[20](url.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_common.a[16](run_command.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[68](pow.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[63](fees_args.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[55](psbt.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[54](peerman_args.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[51](miner.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[50](mempool_persist_args.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[43](database_args.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[41](connection_types.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[40](coins_view_args.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[39](coin.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[36](caches.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[34](blockmanager_args.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[31](net_processing.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[28](mempool_removal_reason.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[23](checks.cpp.o)'; invalid r_symbolnum=1 in '../../libbitcoin_node.a[22](chain.cpp.o)'\r\nclang++: error: linker command failed with exit code 1 (use -v to see invocation)\r\nmake[2]: *** [src/test/fuzz/fuzz] Error 1\r\nmake[1]: *** [src/test/fuzz/CMakeFiles/fuzz.dir/all] Error 2\r\nmake: *** [all] Error 2\r\n```\r\n\r\nHowever, I am able to successfully build the fuzzer with the libfuzzer-nosan preset.\r\n\r\nIs my llvm installation messed up somehow, in some way that prevents the sanitizers from working?  Not sure how to diagnose.",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31111#issuecomment-2423719604",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31111"
    },
    {
      "event": "commented",
      "id": 2423755158,
      "node_id": "IC_kwDOABII586Qd5GW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2423755158",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-19T10:44:02Z",
      "updated_at": "2024-10-19T10:44:02Z",
      "author_association": "MEMBER",
      "body": "I think this is an issue with latest LLVM and Apples ld, see #31049.  You could `brew install llvm@18` (and sub that in for however you'd got clang/clang++ available), and that will work for now, until we fix the incompatibilty.",
      "user": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/31111#issuecomment-2423755158",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31111"
    }
  ]
}