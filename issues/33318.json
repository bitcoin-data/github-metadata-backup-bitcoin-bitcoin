{
  "type": "issue",
  "issue": {
    "id": 3387137862,
    "node_id": "I_kwDOABII587J459G",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33318",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33318/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33318/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33318/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/33318",
    "number": 33318,
    "state": "open",
    "state_reason": null,
    "title": "test: intermittent issue in p2p_1p1c_network.py",
    "body": "Timeout failure in the TSAN job here https://github.com/bitcoin/bitcoin/actions/runs/17489459842/job/49675712585?pr=33317:\n```bash\n2025-09-05T10:51:37.2200865Z \u001b[0;33m node3 2025-09-05T10:51:30.541244Z [httpworker.7] [rpc/request.cpp:243] [void JSONRPCRequest::parse(const UniValue &)] [rpc] ThreadRPCServer method=getpeerinfo user=__cookie__ \u001b[0m\n2025-09-05T10:51:37.2201033Z \u001b[0;36m test  2025-09-05T10:51:31.542469Z TestFramework (ERROR): Unexpected exception \u001b[0m\n2025-09-05T10:51:37.2201165Z \u001b[0;36m                                   Traceback (most recent call last):\u001b[0m\n2025-09-05T10:51:37.2201494Z \u001b[0;36m                                     File \"/home/admin/actions-runner/_work/_temp/test/functional/test_framework/test_framework.py\", line 195, in main\u001b[0m\n2025-09-05T10:51:37.2201593Z \u001b[0;36m                                       self.run_test()\u001b[0m\n2025-09-05T10:51:37.2201851Z \u001b[0;36m                                     File \"/home/admin/actions-runner/_work/_temp/build/test/functional/p2p_1p1c_network.py\", line 155, in run_test\u001b[0m\n2025-09-05T10:51:37.2201964Z \u001b[0;36m                                       self.sync_mempools()\u001b[0m\n2025-09-05T10:51:37.2202246Z \u001b[0;36m                                     File \"/home/admin/actions-runner/_work/_temp/test/functional/test_framework/test_framework.py\", line 811, in sync_mempools\u001b[0m\n2025-09-05T10:51:37.2202421Z \u001b[0;36m                                       raise AssertionError(\"Mempool sync timed out after {}s:{}\".format(\u001b[0m\n2025-09-05T10:51:37.2202566Z \u001b[0;36m                                   AssertionError: Mempool sync timed out after 2400s:\u001b[0m\n2025-09-05T10:51:37.2216842Z \u001b[0;36m                                     {'74c951d3e1bc27437394377a48d6ff7f11b49c1e0bd05e169d54c5138deea7f2', '77708ea74fbffa47e192e5be99b03a72e830f22a8b60d02e262ba8cfbc3e9b47', '233c3760167a81cd6ffccae81bcb650bdbd9c84b72cf87bf329940d2ac97b8ee', '390ec58b4c5b017f557e30ead39f9921b3fec5729b07ff89415c5570275a87dc', 'c8ca64cb3da89905b3ccfc5423d908a17273f90c4893373af9354e61f3bd651c', \n```",
    "user": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "labels": [
      {
        "id": 62963516,
        "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
        "name": "Tests",
        "color": "d4c5f9",
        "default": false
      },
      {
        "id": 5334691551,
        "node_id": "LA_kwDOABII588AAAABPfju3w",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
        "name": "CI failed",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 3,
    "created_at": "2025-09-05T10:56:58Z",
    "updated_at": "2025-10-13T12:37:53Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 19526700611,
      "node_id": "LE_lADOABII587J459GzwAAAASL4c5D",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19526700611",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-05T10:56:59Z",
      "label": {
        "name": "Tests",
        "color": "d4c5f9"
      }
    },
    {
      "event": "labeled",
      "id": 19526700653,
      "node_id": "LE_lADOABII587J459GzwAAAASL4c5t",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19526700653",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-05T10:56:59Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "subscribed",
      "id": 19851021407,
      "node_id": "SE_lADOABII587J459GzwAAAASfNoxf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19851021407",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-22T21:21:41Z"
    },
    {
      "event": "commented",
      "id": 3391409712,
      "node_id": "IC_kwDOABII587KJM4w",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3391409712",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-10T17:31:19Z",
      "updated_at": "2025-10-10T17:50:21Z",
      "author_association": "MEMBER",
      "body": "I think I've nailed down what's happening from logs:\n\n1. test peer sends child to node1\n2. node1 has parent resolved normally, it's above minfee\n3. test peer is picked as unique peer to schedule resolution of child during test peer's next \"turn\" in networking thread\n4. node0 advertises child by wtxid (it's ignored currently because it's in orphanage and has no parents, test peer is already the unique reconsideration peer so that's fairly immaterial?)\n5. test peer disconnects before ProcessOrphanTx is called (and we never reconsider the orphan again because all parents are known!)\n6. now any peer can advertise the child again but in this test only node0 can, and it already has, so the transaction never makes it\n\nThe test does the disconnect earlier but from socket closing to clearing of peer state, this race can occur.\n\ndue to https://github.com/bitcoin/bitcoin/pull/31829 node1's orphanage will actually empty out on disconnect, so it's not actually testing much anymore, so that can be cleaned up and I expect the test to work better (especially if you assert the orphanage of each node is in the expected state)\n\nOverall, I think this is a vote in favor of forcing ProcessOrphanTx on disconnect by peer, or having the reconsiderable slot reassigned to a new peer to disallow them from playing similar games. Seems like it only effects \"catch up\" orphanage usage, not 1p1c, and relies on some incredible timing to disrupt it successfully\n\nSome discussion of this DoS strategy here: https://github.com/bitcoin/bitcoin/pull/31829#issuecomment-3001627814",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33318#issuecomment-3391409712",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33318"
    },
    {
      "event": "commented",
      "id": 3392126924,
      "node_id": "IC_kwDOABII587KL7_M",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3392126924",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-10T19:52:08Z",
      "updated_at": "2025-10-10T19:52:08Z",
      "author_association": "MEMBER",
      "body": "> The test does the disconnect earlier but from socket closing to clearing of peer state, this race can occur.\n\nIf it's a race, then this should go away if we make node3 the one that pre-receives orphans?\n\n\n```diff\n\ndiff --git a/test/functional/p2p_1p1c_network.py b/test/functional/p2p_1p1c_network.py\nindex e4d3b738c19..5567b4e7002 100755\n--- a/test/functional/p2p_1p1c_network.py\n+++ b/test/functional/p2p_1p1c_network.py\n@@ -109,14 +109,14 @@ class PackageRelayTest(BitcoinTestFramework):\n         # Assemble return results\n         packages_to_submit = [package_hex_1, package_hex_2, package_hex_3, package_hex_4]\n         # node0: sender\n-        # node1: pre-received the children (orphan)\n-        # node3: pre-received the parents (too low fee)\n+        # node2: pre-received the parents (too low fee)\n+        # node3: pre-received the children (orphan)\n         # All nodes receive parent_31 ahead of time.\n         txns_to_send = [\n             [],\n-            [child_1, child_2, parent_31, child_3, child_4],\n             [parent_31],\n-            [parent_1, parent_2, parent_31, parent_4]\n+            [parent_1, parent_2, parent_31, parent_4],\n+            [child_1, child_2, parent_31, child_3, child_4]\n         ]\n \n         return packages_to_submit, txns_to_send\n\n```",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33318#issuecomment-3392126924",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33318"
    },
    {
      "event": "commented",
      "id": 3397358091,
      "node_id": "IC_kwDOABII587Kf5IL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3397358091",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-13T12:37:53Z",
      "updated_at": "2025-10-13T12:37:53Z",
      "author_association": "MEMBER",
      "body": "I don't think the pre-received child peer(s) make sense anymore, as we intentionally zero these out of the orphanage when all the announcing peers disconnect.\n\nIf we want to keep this part just to exercise that state space, we could make sure that we wait until all the node's orphan slots are empty via rpc before continuing with the ultimate submitpackage?",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/33318#issuecomment-3397358091",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33318"
    }
  ]
}