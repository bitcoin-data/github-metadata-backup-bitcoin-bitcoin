{
  "type": "issue",
  "issue": {
    "id": 3968865126,
    "node_id": "I_kwDOABII587skBNm",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34637",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34637/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34637/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34637/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/34637",
    "number": 34637,
    "state": "open",
    "state_reason": null,
    "title": "\"txospenderindex_tests/txospenderindex_initial_sync\": critical check tx_spender->has_value() has failed",
    "body": "https://github.com/bitcoin/bitcoin/actions/runs/22227876457/job/64299801435?pr=34615#step:8:652\n```bash\n\n./test/txospenderindex_tests.cpp(15): Entering test case \"txospenderindex_initial_sync\"\n./test/txospenderindex_tests.cpp(60): fatal error: in \"txospenderindex_tests/txospenderindex_initial_sync\": critical check tx_spender->has_value() has failed\nCommand '['./bin/test_bitcoin.exe', '-l', 'test_suite']' returned non-zero exit status 3221225477.\n\n```",
    "user": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [],
    "assignees": [],
    "author_association": "MEMBER",
    "milestone": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/74",
      "html_url": "https://github.com/bitcoin/bitcoin/milestone/74",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/74/labels",
      "id": 12610874,
      "node_id": "MI_kwDOABII584AwG06",
      "number": 74,
      "state": "open",
      "title": "31.0",
      "creator": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "open_issues": 20,
      "closed_issues": 62,
      "created_at": "2025-03-25T18:44:16Z",
      "updated_at": "2026-02-22T00:31:54Z"
    },
    "locked": false,
    "comments": 3,
    "created_at": "2026-02-20T14:38:17Z",
    "updated_at": "2026-02-22T03:09:18Z"
  },
  "events": [
    {
      "event": "milestoned",
      "id": 22950609735,
      "node_id": "MIE_lADOABII587skBNmzwAAAAVX9oNH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22950609735",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-20T14:38:17Z",
      "milestone": {
        "title": "31.0"
      }
    },
    {
      "event": "subscribed",
      "id": 22950796387,
      "node_id": "SE_lADOABII587skBNmzwAAAAVX-Vxj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22950796387",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-20T14:45:13Z"
    },
    {
      "event": "commented",
      "id": 3935644369,
      "node_id": "IC_kwDOABII587qlSrR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3935644369",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-20T15:38:36Z",
      "updated_at": "2026-02-20T15:38:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "Notable that it only happens on Windows UCRT in the linked run, indicating probable insufficient synchronization between txospenderindex and the new block in chainstate. Maybe we should move `SyncWithValidationInterfaceQueue()` before the failing check?",
      "user": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/34637#issuecomment-3935644369",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34637"
    },
    {
      "event": "commented",
      "id": 3935792416,
      "node_id": "IC_kwDOABII587ql20g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3935792416",
      "actor": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-20T16:10:19Z",
      "updated_at": "2026-02-20T16:10:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Maybe we should move SyncWithValidationInterfaceQueue() before the failing check?\n\n`BlockUntilSyncedToCurrentChain()` should already be doing that. It's a bit puzzling, I also couldn't reproduce a failure after 10'000 test runs. ",
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/34637#issuecomment-3935792416",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34637"
    },
    {
      "event": "commented",
      "id": 3940013120,
      "node_id": "IC_kwDOABII587q19RA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3940013120",
      "actor": {
        "login": "w0xlt",
        "id": 94266259,
        "node_id": "U_kgDOBZ5jkw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94266259?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/w0xlt",
        "html_url": "https://github.com/w0xlt",
        "followers_url": "https://api.github.com/users/w0xlt/followers",
        "following_url": "https://api.github.com/users/w0xlt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/w0xlt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/w0xlt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/w0xlt/subscriptions",
        "organizations_url": "https://api.github.com/users/w0xlt/orgs",
        "repos_url": "https://api.github.com/users/w0xlt/repos",
        "events_url": "https://api.github.com/users/w0xlt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/w0xlt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-22T03:08:41Z",
      "updated_at": "2026-02-22T03:09:18Z",
      "author_association": "CONTRIBUTOR",
      "body": "`BlockUntilSyncedToCurrentChain()` wouldn't catch this. After `Sync()`, both `best_block_index` and `chain_tip` are at block 151, so it takes the early return without draining the queue:\n\n```cpp\n  if (best_block_index->GetAncestor(chain_tip->nHeight) == chain_tip) {\n      return true;  // skips SyncWithValidationInterfaceQueue()\n  }\n```\n\nThe issue looks to be that 51 `BlockConnected` callbacks (for blocks mined between `Init()` and `Sync()`) are still pending in the validation interface queue. When the scheduler delivers the stale callbacks and `BlockConnected` sees `best_block_index=151` but receives a notification for `pindex=101`, it interprets this as: \"_I'm at 151, but I need to  process block 101 â€” I must have missed something, let me rewind to block 100 and re-index from there._\" That rewind erases the spending entries for blocks 101-151.\n\n```cpp\nif (best_block_index != pindex->pprev && !Rewind(best_block_index, pindex->pprev)) {\n```\n\nOn Linux the scheduler seems to drain those callbacks before `Sync()` sets `m_synced = true`. But the error can be deterministically triggered by firing a stale `BlockConnected` directly after `Sync()`:\n\n<details>\n  <summary>diff</summary>\n\n```diff\ndiff --git a/src/test/txospenderindex_tests.cpp b/src/test/txospenderindex_tests.cpp\nindex 889ef7ff8a..fef331afe4 100644\n--- a/src/test/txospenderindex_tests.cpp\n+++ b/src/test/txospenderindex_tests.cpp\n@@ -4,7 +4,10 @@\n \n #include <chainparams.h>\n #include <index/txospenderindex.h>\n+#include <kernel/types.h>\n+#include <node/blockstorage.h>\n #include <test/util/setup_common.h>\n+#include <test/util/validation.h>\n #include <util/time.h>\n #include <validation.h>\n \n@@ -54,6 +57,24 @@ BOOST_FIXTURE_TEST_CASE(txospenderindex_initial_sync, TestChain100Setup)\n     BOOST_CHECK(!txospenderindex.BlockUntilSyncedToCurrentChain());\n \n     txospenderindex.Sync();\n+\n+    // Simulate a stale BlockConnected callback: fire BlockConnected for block\n+    // 101, which Sync() already indexed. Since m_synced is now true, this\n+    // triggers Rewind(tip, 100), erasing spending entries for blocks 101-tip.\n+    // This reproduces the race in issue #34637 deterministically.\n+    {\n+        const CBlockIndex* stale_pindex;\n+        {\n+            LOCK(cs_main);\n+            stale_pindex = m_node.chainman->ActiveChain()[101];\n+        }\n+        CBlock stale_block;\n+        m_node.chainman->ActiveChainstate().m_blockman.ReadBlock(stale_block, *stale_pindex);\n+        auto shared_block = std::make_shared<CBlock>(stale_block);\n+        ValidationInterfaceTest::BlockConnected(\n+            kernel::ChainstateRole{}, txospenderindex, shared_block, stale_pindex);\n+    }\n+\n     for (size_t i = 0; i < spent.size(); i++) {\n         const auto tx_spender{txospenderindex.FindSpender(spent[i])};\n         BOOST_REQUIRE(tx_spender.has_value());\n```\n</details>\n\nAdding `SyncWithValidationInterfaceQueue()` after `Sync()` to unconditionally drain the stale callbacks before querying the index should work, as observed by @hodlinator .\n\n<details>\n  <summary>diff</summary>\n\n```diff\ndiff --git a/src/test/txospenderindex_tests.cpp b/src/test/txospenderindex_tests.cpp\nindex 889ef7ff8a..4aaa5513de 100644\n--- a/src/test/txospenderindex_tests.cpp\n+++ b/src/test/txospenderindex_tests.cpp\n@@ -54,6 +54,12 @@ BOOST_FIXTURE_TEST_CASE(txospenderindex_initial_sync, TestChain100Setup)\n     BOOST_CHECK(!txospenderindex.BlockUntilSyncedToCurrentChain());\n \n     txospenderindex.Sync();\n+\n+    // Drain stale BlockConnected callbacks that were enqueued for blocks created\n+    // between Init() and Sync(). After Sync() sets m_synced = true, these\n+    // callbacks can trigger unnecessary rewinds until fully processed.\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+\n     for (size_t i = 0; i < spent.size(); i++) {\n         const auto tx_spender{txospenderindex.FindSpender(spent[i])};\n         BOOST_REQUIRE(tx_spender.has_value());\n```\n</details>",
      "user": {
        "login": "w0xlt",
        "id": 94266259,
        "node_id": "U_kgDOBZ5jkw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94266259?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/w0xlt",
        "html_url": "https://github.com/w0xlt",
        "followers_url": "https://api.github.com/users/w0xlt/followers",
        "following_url": "https://api.github.com/users/w0xlt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/w0xlt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/w0xlt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/w0xlt/subscriptions",
        "organizations_url": "https://api.github.com/users/w0xlt/orgs",
        "repos_url": "https://api.github.com/users/w0xlt/repos",
        "events_url": "https://api.github.com/users/w0xlt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/w0xlt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/34637#issuecomment-3940013120",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34637"
    },
    {
      "event": "mentioned",
      "id": 22975567786,
      "node_id": "MEE_lADOABII587skBNmzwAAAAVZc1eq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22975567786",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-22T03:08:42Z"
    },
    {
      "event": "subscribed",
      "id": 22975567796,
      "node_id": "SE_lADOABII587skBNmzwAAAAVZc1e0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22975567796",
      "actor": {
        "login": "hodlinator",
        "id": 172445034,
        "node_id": "U_kgDOCkdNag",
        "avatar_url": "https://avatars.githubusercontent.com/u/172445034?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hodlinator",
        "html_url": "https://github.com/hodlinator",
        "followers_url": "https://api.github.com/users/hodlinator/followers",
        "following_url": "https://api.github.com/users/hodlinator/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hodlinator/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hodlinator/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hodlinator/subscriptions",
        "organizations_url": "https://api.github.com/users/hodlinator/orgs",
        "repos_url": "https://api.github.com/users/hodlinator/repos",
        "events_url": "https://api.github.com/users/hodlinator/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hodlinator/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-02-22T03:08:42Z"
    }
  ]
}