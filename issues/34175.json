{
  "type": "issue",
  "issue": {
    "id": 3768084891,
    "node_id": "I_kwDOABII587gmGmb",
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34175",
    "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
    "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34175/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34175/comments",
    "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34175/events",
    "html_url": "https://github.com/bitcoin/bitcoin/issues/34175",
    "number": 34175,
    "state": "closed",
    "state_reason": "completed",
    "title": "qa: `feature_pruning.py` fails when built `ENABLE_WALLET=OFF`",
    "body": "Below are the steps to reproduce the bug:\n```\n$ cmake -B build -DENABLE_WALLET=OFF\n$ cmake --build build\n$ ./build/test/functional/feature_pruning.py --tmpdir $(pwd)/tmp\n2025-12-29T18:31:27.385714Z TestFramework (INFO): PRNG seed is: 6842027149269818275\n2025-12-29T18:31:27.386337Z TestFramework (INFO): Initializing test directory /home/hebasto/dev/bitcoin/tmp\n2025-12-29T18:31:28.135416Z TestFramework (INFO): Warning! This test requires 4GB of disk space\n2025-12-29T18:31:28.135533Z TestFramework (INFO): Mining a big blockchain of 995 blocks\n2025-12-29T18:31:49.087269Z TestFramework (INFO): Check that we haven't started pruning yet because we're below PruneAfterHeight\n2025-12-29T18:31:49.087331Z TestFramework (INFO): Success\n2025-12-29T18:31:49.087425Z TestFramework (INFO): Though we're already using more than 550MiB, current usage: 592.1861515045166\n2025-12-29T18:31:49.087446Z TestFramework (INFO): Mining 25 more blocks should cause the first block file to be pruned\n2025-12-29T18:31:49.917042Z TestFramework (INFO): Success\n2025-12-29T18:31:49.917238Z TestFramework (INFO): Usage should be below target: 480.3139057159424\n2025-12-29T18:31:49.917265Z TestFramework (INFO): Check that we'll exceed disk space target if we have a very high stale block rate\n2025-12-29T18:31:49.917287Z TestFramework (INFO): Mine 24 (stale) blocks on Node 1, followed by 25 (main chain) block reorg from Node 0, for 12 rounds\n2025-12-29T18:32:23.946016Z TestFramework (INFO): Usage can be over target because of high stale rate: 640.085205078125\n2025-12-29T18:32:23.947212Z TestFramework (INFO): Check that we can survive a 288 block reorg still\n2025-12-29T18:32:23.947673Z TestFramework (INFO): Current block height: 1320\n2025-12-29T18:32:23.948098Z TestFramework (INFO): Invalidating block 170863767faea392ccf9ff5b962cc758ebe9991b2562af2f3aa044c321d175e2 at height 1033\n2025-12-29T18:32:24.322179Z TestFramework (INFO): New best height: 1032\n2025-12-29T18:32:24.429004Z TestFramework (INFO): Generating new longer chain of 300 more blocks\n2025-12-29T18:32:24.562884Z TestFramework (INFO): Reconnect nodes\n2025-12-29T18:32:25.769411Z TestFramework (INFO): Verify height on node 2: 1332\n2025-12-29T18:32:25.769654Z TestFramework (INFO): Usage possibly still high because of stale blocks in block files: 640.085205078125\n2025-12-29T18:32:25.769682Z TestFramework (INFO): Mine 220 more large blocks so we have requisite history\n2025-12-29T18:32:32.175362Z TestFramework (INFO): Usage should be below target: 448.4003086090088\n2025-12-29T18:32:32.175530Z TestFramework (INFO): Test that we can rerequest a block we previously pruned if needed for a reorg\n2025-12-29T18:32:33.817865Z TestFramework (INFO): Will need to redownload block 1033\n2025-12-29T18:32:33.938875Z TestFramework (INFO): Rewind node 0 to prev main chain to mine longer chain to trigger redownload. Blocks needed: 233\n2025-12-29T18:32:35.807399Z TestFramework (INFO): Verify node 2 reorged back to the main chain, some blocks of which it had to redownload\n2025-12-29T18:32:38.244340Z TestFramework (INFO): Test manual pruning with block indices\n2025-12-29T18:32:39.327901Z TestFramework (INFO): Success\n2025-12-29T18:32:39.327948Z TestFramework (INFO): Test manual pruning with timestamps\n2025-12-29T18:32:40.410622Z TestFramework (INFO): Success\n2025-12-29T18:32:40.410722Z TestFramework (INFO): Test invalid pruning command line options\n2025-12-29T18:32:40.580461Z TestFramework (INFO): Test scanblocks can not return pruned data\n2025-12-29T18:32:40.583664Z TestFramework (ERROR): Unexpected exception\nTraceback (most recent call last):\n  File \"/home/hebasto/dev/bitcoin/test/functional/test_framework/test_framework.py\", line 142, in main\n    self.run_test()\n    ~~~~~~~~~~~~~^^\n  File \"/home/hebasto/dev/bitcoin/./build/test/functional/feature_pruning.py\", line 481, in run_test\n    self.test_scanblocks_pruned()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/home/hebasto/dev/bitcoin/./build/test/functional/feature_pruning.py\", line 496, in test_scanblocks_pruned\n    assert_raises_rpc_error(-1, \"Block not available (pruned data)\", node.scanblocks,\n    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        \"start\", [{\"desc\": f\"raw({false_positive_spk.hex()})\"}], 0, 0, \"basic\", {\"filter_false_positives\": True})\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/hebasto/dev/bitcoin/test/functional/test_framework/util.py\", line 157, in assert_raises_rpc_error\n    assert try_rpc(code, message, fun, *args, **kwds), \"No exception raised\"\n           ~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: No exception raised\n2025-12-29T18:32:40.636711Z TestFramework (INFO): Not stopping nodes as test failed. The dangling processes will be cleaned up later.\n2025-12-29T18:32:40.636826Z TestFramework (WARNING): Not cleaning up dir /home/hebasto/dev/bitcoin/tmp\n2025-12-29T18:32:40.636857Z TestFramework (ERROR): Test failed. Test logging available at /home/hebasto/dev/bitcoin/tmp/test_framework.log\n2025-12-29T18:32:40.636939Z TestFramework (ERROR): \n2025-12-29T18:32:40.637012Z TestFramework (ERROR): Hint: Call /home/hebasto/dev/bitcoin/test/functional/combine_logs.py '/home/hebasto/dev/bitcoin/tmp' to consolidate all logs\n2025-12-29T18:32:40.637031Z TestFramework (ERROR): \n2025-12-29T18:32:40.637048Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\n2025-12-29T18:32:40.637086Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\n2025-12-29T18:32:40.637103Z TestFramework (ERROR): \n[node 5] Cleaning up leftover process\n[node 4] Cleaning up leftover process\n[node 3] Cleaning up leftover process\n[node 2] Cleaning up leftover process\n[node 1] Cleaning up leftover process\n```\n\nThe combined log appears to be too large to upload to GitHub.\n\nThis was initially observed on NetBSD and was later reproduced on Fedora 43.",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "labels": [
      {
        "id": 62963516,
        "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
        "name": "Tests",
        "color": "d4c5f9",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 2,
    "closed_at": "2026-01-14T20:58:57Z",
    "closed_by": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "created_at": "2025-12-29T18:46:08Z",
    "updated_at": "2026-01-14T20:58:57Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 21782769087,
      "node_id": "LE_lADOABII587gmGmbzwAAAAUSWq2_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21782769087",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-29T18:46:20Z",
      "label": {
        "name": "Tests",
        "color": "d4c5f9"
      }
    },
    {
      "event": "commented",
      "id": 3700577726,
      "node_id": "IC_kwDOABII587cklW-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3700577726",
      "actor": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-30T21:12:54Z",
      "updated_at": "2025-12-30T21:12:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "I was able to reproduce it on macOS 14.3:\n\n```\ncmake -B build_no_wallet -DENABLE_IPC=OFF -DENABLE_WALLET=OFF && cmake --build build_no_wallet -j 10 && ./build_no_wallet/test/functional/feature_pruning.py --tmpdir $(pwd)/tmp\n```\n\n```sh\n2025-12-30T21:10:45.025328Z TestFramework (INFO): Test manual pruning with block indices\n2025-12-30T21:10:46.286682Z TestFramework (INFO): Success\n2025-12-30T21:10:46.286738Z TestFramework (INFO): Test manual pruning with timestamps\n2025-12-30T21:10:47.544538Z TestFramework (INFO): Success\n2025-12-30T21:10:47.544656Z TestFramework (INFO): Test invalid pruning command line options\n2025-12-30T21:10:47.686153Z TestFramework (INFO): Test scanblocks can not return pruned data\n2025-12-30T21:10:47.688006Z TestFramework (ERROR): Unexpected exception\nTraceback (most recent call last):\n  File \"/Users/brunogarcia/projects/bitcoin-core-dev/test/functional/test_framework/test_framework.py\", line 142, in main\n    self.run_test()\n    ~~~~~~~~~~~~~^^\n  File \"/Users/brunogarcia/projects/bitcoin-core-dev/./build_no_wallet/test/functional/feature_pruning.py\", line 481, in run_test\n    self.test_scanblocks_pruned()\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/Users/brunogarcia/projects/bitcoin-core-dev/./build_no_wallet/test/functional/feature_pruning.py\", line 496, in test_scanblocks_pruned\n    assert_raises_rpc_error(-1, \"Block not available (pruned data)\", node.scanblocks,\n    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        \"start\", [{\"desc\": f\"raw({false_positive_spk.hex()})\"}], 0, 0, \"basic\", {\"filter_false_positives\": True})\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/brunogarcia/projects/bitcoin-core-dev/test/functional/test_framework/util.py\", line 157, in assert_raises_rpc_error\n    assert try_rpc(code, message, fun, *args, **kwds), \"No exception raised\"\n           ~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nAssertionError: No exception raised\n2025-12-30T21:10:47.742645Z TestFramework (INFO): Not stopping nodes as test failed. The dangling processes will be cleaned up later.\n2025-12-30T21:10:47.742746Z TestFramework (WARNING): Not cleaning up dir /Users/brunogarcia/projects/bitcoin-core-dev/tmp\n2025-12-30T21:10:47.742778Z TestFramework (ERROR): Test failed. Test logging available at /Users/brunogarcia/projects/bitcoin-core-dev/tmp/test_framework.log\n2025-12-30T21:10:47.742868Z TestFramework (ERROR):\n2025-12-30T21:10:47.742948Z TestFramework (ERROR): Hint: Call /Users/brunogarcia/projects/bitcoin-core-dev/test/functional/combine_logs.py '/Users/brunogarcia/projects/bitcoin-core-dev/tmp' to consolidate all logs\n2025-12-30T21:10:47.742973Z TestFramework (ERROR):\n2025-12-30T21:10:47.742996Z TestFramework (ERROR): If this failure happened unexpectedly or intermittently, please file a bug and provide a link or upload of the combined log.\n2025-12-30T21:10:47.743040Z TestFramework (ERROR): https://github.com/bitcoin/bitcoin/issues\n2025-12-30T21:10:47.743061Z TestFramework (ERROR):\n[node 5] Cleaning up leftover process\n[node 4] Cleaning up leftover process\n[node 3] Cleaning up leftover process\n[node 2] Cleaning up leftover process\n[node 1] Cleaning up leftover process\n```",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/34175#issuecomment-3700577726",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34175"
    },
    {
      "event": "commented",
      "id": 3700610506,
      "node_id": "IC_kwDOABII587cktXK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3700610506",
      "actor": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-30T21:33:28Z",
      "updated_at": "2025-12-30T23:17:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "I did not investigate it in depth, but I think we shouldn't test the behavior of `scanblocks` for a pruned node, especially filtering false positives, with the genesis block since it has no undo data. Also, without wallet, the `wallet_test` is skipped so node5 isn't synced with node0 and the prune isn't done?",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/issues/34175#issuecomment-3700610506",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34175"
    },
    {
      "event": "closed",
      "id": 22053289094,
      "node_id": "CE_lADOABII587gmGmbzwAAAAUienyG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22053289094",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "cd0959ce9b7c5b80ebd45b652d557630b4dc604b",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cd0959ce9b7c5b80ebd45b652d557630b4dc604b",
      "created_at": "2026-01-14T20:58:57Z"
    }
  ]
}